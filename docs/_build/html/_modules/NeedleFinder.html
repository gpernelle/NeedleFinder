<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>NeedleFinder &mdash; NeedleFinder 1.0 documentation</title>
    
    <link rel="stylesheet" href="../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="https://c328740.ssl.cf1.rackcdn.com/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="NeedleFinder 1.0 documentation" href="../index.html" />
    <link rel="up" title="Module code" href="index.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../index.html">NeedleFinder 1.0 documentation</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for NeedleFinder</h1><div class="highlight"><pre>
<span class="c"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;**NeedleFinder Documentation**</span>

<span class="sd">Guillaume Pernelle,  Andre Mastmeyer</span>

<span class="sd">.. moduleauthor:: gpernelle &lt;gpernelle@gmail.com&gt;</span>

<span class="sd">.. image:: ../../_static/algo-figure-high_res.png</span>
<span class="sd">           :height: 300px</span>
<span class="sd">           :width: 1000 px</span>
<span class="sd">           :scale: 100 %</span>
<span class="sd">           :alt: alternate text</span>
<span class="sd">           :align: center</span>

<span class="sd">Links</span>
<span class="sd">-----</span>
<span class="sd">    * Validation of Catheter Segmentation for MR-guided Gynecologic Cancer Brachytherapy [1]_</span>

<span class="sd">    * Labeled Needle Rendering Solution for Image Guided Brachytherapy [2]_</span>

<span class="sd">  .. [1] https://www.spl.harvard.edu/publications/item/view/2459</span>
<span class="sd">  .. [2] https://www.spl.harvard.edu/publications/item/view/2316</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">unittest</span>
<span class="kn">import</span> <span class="nn">math</span><span class="o">,</span><span class="nn">time</span><span class="o">,</span> <span class="nn">functools</span><span class="o">,</span> <span class="nn">operator</span>
<span class="kn">import</span> <span class="nn">EditorLib</span>
<span class="kn">import</span> <span class="nn">string</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">thread</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">import</span> <span class="nn">ConfigParser</span>
<span class="kn">from</span> <span class="nn">__main__</span> <span class="kn">import</span> <span class="n">vtk</span><span class="p">,</span> <span class="n">qt</span><span class="p">,</span> <span class="n">ctk</span><span class="p">,</span> <span class="n">slicer</span>

<span class="n">profiling</span><span class="o">=</span><span class="bp">True</span>
<span class="n">frequent</span><span class="o">=</span><span class="bp">False</span>
<div class="viewcode-block" id="msgbox"><a class="viewcode-back" href="../NeedleFinder.html#NeedleFinder.msgbox">[docs]</a><span class="k">def</span> <span class="nf">msgbox</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
  <span class="n">qt</span><span class="o">.</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">about</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&#39;Profiling:&#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span></div>
<span class="k">if</span> <span class="n">profiling</span><span class="p">:</span> <span class="n">msgbox</span><span class="p">(</span><span class="s">&quot;turned on&quot;</span><span class="p">)</span>

<span class="c">#</span>
<span class="c"># NeedleFinder</span>
<span class="c">#</span>

<div class="viewcode-block" id="NeedleFinder"><a class="viewcode-back" href="../NeedleFinder.html#NeedleFinder.NeedleFinder">[docs]</a><span class="k">class</span> <span class="nc">NeedleFinder</span><span class="p">:</span>
  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    init&#39;s the class</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#productive</span>
    <span class="k">if</span> <span class="n">profiling</span><span class="p">:</span> <span class="k">print</span> <span class="s">&quot;NeedleFinder __init__&quot;</span><span class="p">;</span>
    <span class="n">parent</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s">&quot;NeedleFinder&quot;</span>
    <span class="n">parent</span><span class="o">.</span><span class="n">categories</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;IGT&quot;</span><span class="p">]</span>
    <span class="n">parent</span><span class="o">.</span><span class="n">dependencies</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">parent</span><span class="o">.</span><span class="n">contributors</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;Guillaume Pernelle&quot;</span><span class="p">,</span>  <span class="s">&quot;Alireza Mehrtash&quot;</span><span class="p">,</span> <span class="s">&quot;Lauren Barber&quot;</span><span class="p">,</span> <span class="s">&quot;Nabgha Fahrat&quot;</span><span class="p">,</span> <span class="s">&quot;Sandy Wells&quot;</span><span class="p">,</span> <span class="s">&quot;Yi Gao&quot;</span><span class="p">,</span> <span class="s">&quot;Antonio Damato&quot;</span><span class="p">,</span> <span class="s">&quot;Tina Kapur&quot;</span><span class="p">,</span> <span class="s">&quot;Akila Viswanathan&quot;</span><span class="p">]</span>
    <span class="n">parent</span><span class="o">.</span><span class="n">helpText</span> <span class="o">=</span> <span class="s">&quot;https://github.com/gpernelle/NeedleFinder/wiki&quot;</span><span class="p">;</span>
    <span class="n">parent</span><span class="o">.</span><span class="n">acknowledgementText</span> <span class="o">=</span> <span class="s">&quot; Version : &quot;</span> <span class="o">+</span> <span class="s">&quot;NeedleFinder v1.0.&quot;</span>
    
    <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="n">slicer</span><span class="o">.</span><span class="n">selfTests</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="n">slicer</span><span class="o">.</span><span class="n">selfTests</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">slicer</span><span class="o">.</span><span class="n">selfTests</span><span class="p">[</span><span class="s">&#39;NeedleFinder&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runTest</span>

<div class="viewcode-block" id="NeedleFinder.runTest"><a class="viewcode-back" href="../NeedleFinder.html#NeedleFinder.NeedleFinder.runTest">[docs]</a>  <span class="k">def</span> <span class="nf">runTest</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">print</span> <span class="s">&quot;runTest&quot;</span>
    <span class="n">tester</span> <span class="o">=</span> <span class="n">NeedleFinderTest</span><span class="p">()</span>
    <span class="n">tester</span><span class="o">.</span><span class="n">runTest</span><span class="p">()</span>

<span class="c">#</span>
<span class="c"># NeedleFinderWidget</span>
<span class="c">#</span>
</div></div>
<div class="viewcode-block" id="NeedleFinderWidget"><a class="viewcode-back" href="../NeedleFinder.html#NeedleFinder.NeedleFinderWidget">[docs]</a><span class="k">class</span> <span class="nc">NeedleFinderWidget</span><span class="p">:</span>
  
  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    init&#39;s the class</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#productive</span>
    <span class="k">if</span> <span class="n">profiling</span><span class="p">:</span> <span class="k">print</span> <span class="s">&quot;NeedleFinderWidget __init__&quot;</span><span class="p">;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">parent</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">qMRMLWidget</span><span class="p">()</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">setLayout</span><span class="p">(</span><span class="n">qt</span><span class="o">.</span><span class="n">QVBoxLayout</span><span class="p">())</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">setMRMLScene</span><span class="p">(</span><span class="n">slicer</span><span class="o">.</span><span class="n">mrmlScene</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">layout2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">layout</span> <span class="o">=</span> <span class="n">qt</span><span class="o">.</span><span class="n">QFormLayout</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">parent</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">analysisGroupBox</span>       <span class="o">=</span> <span class="bp">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">buttonsGroupBox</span>        <span class="o">=</span> <span class="bp">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">interactorObserverTags</span> <span class="o">=</span> <span class="p">[]</span>    
    <span class="bp">self</span><span class="o">.</span><span class="n">styleObserverTags</span>      <span class="o">=</span> <span class="p">[]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">axialSegmentationLimit</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="c"># class var</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">validationNeedleNumber</span>    <span class="o">=</span> <span class="mi">1</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">stepNeedle</span>                <span class="o">=</span> <span class="mi">0</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fileName</span>     <span class="o">=</span> <span class="bp">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fileDialog</span>   <span class="o">=</span> <span class="bp">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">logic</span>                  <span class="o">=</span> <span class="n">NeedleFinderLogic</span><span class="p">()</span> 
    <span class="bp">self</span><span class="o">.</span><span class="n">needleValidationClicks</span><span class="o">=</span><span class="mi">1</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">addManualTipClicks</span><span class="o">=</span><span class="mi">2</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">obturatorNeedleTipClicks</span><span class="o">=</span><span class="mi">3</span>

<div class="viewcode-block" id="NeedleFinderWidget.setup"><a class="viewcode-back" href="../NeedleFinder.html#NeedleFinder.NeedleFinderWidget.setup">[docs]</a>  <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Instantiate and connect widgets</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#productive</span>
    <span class="k">if</span> <span class="n">profiling</span><span class="p">:</span> <span class="k">print</span> <span class="s">&quot;setup&quot;</span><span class="p">;</span>
    <span class="c">#-----------------------------------------------------------------------------</span>
    <span class="c"># Needle Finder Logic</span>
    <span class="n">logic</span> <span class="o">=</span> <span class="n">NeedleFinderLogic</span><span class="p">()</span>

    <span class="c">#Report Frame</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__reportFrame</span> <span class="o">=</span> <span class="n">ctk</span><span class="o">.</span><span class="n">ctkCollapsibleButton</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__reportFrame</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s">&quot;Segmentation Report&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__reportFrame</span><span class="o">.</span><span class="n">collapsed</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">reportFrame</span> <span class="o">=</span> <span class="n">qt</span><span class="o">.</span><span class="n">QFormLayout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__reportFrame</span><span class="p">)</span>

    <span class="c"># segmentation report</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">analysisGroupBox</span> <span class="o">=</span> <span class="n">qt</span><span class="o">.</span><span class="n">QGroupBox</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">analysisGroupBox</span><span class="o">.</span><span class="n">setFixedHeight</span><span class="p">(</span><span class="mi">330</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">analysisGroupBox</span><span class="o">.</span><span class="n">setTitle</span><span class="p">(</span> <span class="s">&#39;Segmentation Report&#39;</span> <span class="p">)</span>
    <span class="n">reportFrame</span><span class="o">.</span><span class="n">addRow</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysisGroupBox</span> <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">analysisGroupBoxLayout</span> <span class="o">=</span> <span class="n">qt</span><span class="o">.</span><span class="n">QFormLayout</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysisGroupBox</span> <span class="p">)</span>

    <span class="c">#-----------------------------------------------------------------------------</span>

    <span class="c">#Segmentation Frame</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__segmentationFrame</span> <span class="o">=</span> <span class="n">ctk</span><span class="o">.</span><span class="n">ctkCollapsibleButton</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__segmentationFrame</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s">&quot;Segmentation&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__segmentationFrame</span><span class="o">.</span><span class="n">collapsed</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">segmentationFrame</span> <span class="o">=</span> <span class="n">qt</span><span class="o">.</span><span class="n">QFormLayout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__segmentationFrame</span><span class="p">)</span>

    <span class="c"># give needle tips</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fiducialButton</span> <span class="o">=</span> <span class="n">qt</span><span class="o">.</span><span class="n">QPushButton</span><span class="p">(</span><span class="s">&#39;Start Giving Needle Tips&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fiducialButton</span><span class="o">.</span><span class="n">checkable</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">segmentationFrame</span><span class="o">.</span><span class="n">addRow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fiducialButton</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fiducialButton</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&#39;toggled(bool)&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">onStartStopGivingNeedleTipsToggled</span><span class="p">)</span>

    <span class="c"># Obturator needle tips</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fiducialObturatorButton</span> <span class="o">=</span> <span class="n">qt</span><span class="o">.</span><span class="n">QPushButton</span><span class="p">(</span><span class="s">&#39;Start Giving Obturator Needle Tips&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fiducialObturatorButton</span><span class="o">.</span><span class="n">checkable</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">segmentationFrame</span><span class="o">.</span><span class="n">addRow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fiducialObturatorButton</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fiducialObturatorButton</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&#39;toggled(bool)&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">onStartStopGivingObturatorNeedleTipsToggled</span><span class="p">)</span>

    <span class="c"># #Segment Needle Button </span>
    <span class="c"># self.needleButton = qt.QPushButton(&#39;Segment Needles&#39;)</span>
    <span class="c"># segmentationFrame.addRow(self.needleButton)</span>
    <span class="c"># self.needleButton.connect(&#39;clicked()&#39;, self.needleSegmentation)</span>
    <span class="c"># self.needleButton.setEnabled(0)</span>

    <span class="c">#Segment Needle Button </span>
    <span class="c"># self.needleButton2 = qt.QPushButton(&#39;Segment/Update Needles - Python&#39;)</span>
    <span class="c"># segmentationFrame.addRow(self.needleButton2)</span>
    <span class="c"># self.needleButton2.connect(&#39;clicked()&#39;, self.needleDetection)</span>

    <span class="c">#New insertion - create new round of needles with different colors</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">newInsertionButton</span> <span class="o">=</span> <span class="n">qt</span><span class="o">.</span><span class="n">QPushButton</span><span class="p">(</span><span class="s">&#39;New Insertion Needle&#39;</span><span class="p">)</span>
    <span class="n">segmentationFrame</span><span class="o">.</span><span class="n">addRow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">newInsertionButton</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">newInsertionButton</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&#39;clicked()&#39;</span><span class="p">,</span> <span class="n">logic</span><span class="o">.</span><span class="n">newInsertionNeedle</span><span class="p">)</span>

    <span class="c">#Delete Needles Button </span>
    <span class="bp">self</span><span class="o">.</span><span class="n">deleteNeedleButton</span> <span class="o">=</span> <span class="n">qt</span><span class="o">.</span><span class="n">QPushButton</span><span class="p">(</span><span class="s">&#39;Delete Segmented Needles&#39;</span><span class="p">)</span>
    <span class="n">segmentationFrame</span><span class="o">.</span><span class="n">addRow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deleteNeedleButton</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">deleteNeedleButton</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&#39;clicked()&#39;</span><span class="p">,</span> <span class="n">logic</span><span class="o">.</span><span class="n">deleteSegmentedNeedle</span><span class="p">)</span>

    <span class="c">#Reset Needle Detection Button </span>
    <span class="bp">self</span><span class="o">.</span><span class="n">resetDetectionButton</span> <span class="o">=</span> <span class="n">qt</span><span class="o">.</span><span class="n">QPushButton</span><span class="p">(</span><span class="s">&#39;Reset Needle Detection&#39;</span><span class="p">)</span>
    <span class="n">segmentationFrame</span><span class="o">.</span><span class="n">addRow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resetDetectionButton</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">resetDetectionButton</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&#39;clicked()&#39;</span><span class="p">,</span> <span class="n">logic</span><span class="o">.</span><span class="n">resetNeedleDetection</span><span class="p">)</span>

    <span class="c">#Define template</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">templateSliceButton</span> <span class="o">=</span>  <span class="n">qt</span><span class="o">.</span><span class="n">QPushButton</span><span class="p">(</span><span class="s">&#39;Select Current Axial Slice as seg. limit (current: None)&#39;</span><span class="p">)</span>
    <span class="n">segmentationFrame</span><span class="o">.</span><span class="n">addRow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">templateSliceButton</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">templateSliceButton</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&#39;clicked()&#39;</span><span class="p">,</span> <span class="n">logic</span><span class="o">.</span><span class="n">selectCurrentAxialSlice</span><span class="p">)</span>
      
    <span class="c">#Validation Frame</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__validationFrame</span> <span class="o">=</span> <span class="n">ctk</span><span class="o">.</span><span class="n">ctkCollapsibleButton</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__validationFrame</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s">&quot;Validation&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__validationFrame</span><span class="o">.</span><span class="n">collapsed</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">validationFrame</span> <span class="o">=</span> <span class="n">qt</span><span class="o">.</span><span class="n">QFormLayout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__validationFrame</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">startGivingControlPointsButton</span> <span class="o">=</span> <span class="n">qt</span><span class="o">.</span><span class="n">QPushButton</span><span class="p">(</span><span class="s">&#39;Start Giving Control Points&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">startGivingControlPointsButton</span><span class="o">.</span><span class="n">checkable</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">validationFrame</span><span class="o">.</span><span class="n">addRow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">startGivingControlPointsButton</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">startGivingControlPointsButton</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&#39;toggled(bool)&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">onStartStopGivingValidationControlPointsToggled</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">validationNeedleButton</span> <span class="o">=</span> <span class="n">qt</span><span class="o">.</span><span class="n">QPushButton</span><span class="p">(</span><span class="s">&#39;Next Validation Needle: (1)-&gt;(2)&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">validationNeedleButton</span><span class="o">.</span><span class="n">toolTip</span> <span class="o">=</span>   <span class="s">&quot;By clicking on this button, you will increment the number of the needle&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">validationNeedleButton</span><span class="o">.</span><span class="n">toolTip</span> <span class="o">+=</span>   <span class="s">&quot;that you want to manually segment. Thus, the points you will add will be used to draw a new needle.&lt;br/&gt;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">validationNeedleButton</span><span class="o">.</span><span class="n">toolTip</span> <span class="o">+=</span>   <span class="s">&quot;&lt;b&gt;Warning:&lt;b&gt; You can/&#39;t add any more points to the current needle after clicking here&quot;</span>
    <span class="n">validationFrame</span><span class="o">.</span><span class="n">addRow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">validationNeedleButton</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">validationNeedleButton</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&#39;clicked()&#39;</span><span class="p">,</span> <span class="n">logic</span><span class="o">.</span><span class="n">validationNeedle</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">drawValidationNeedlesButton</span> <span class="o">=</span> <span class="n">qt</span><span class="o">.</span><span class="n">QPushButton</span><span class="p">(</span><span class="s">&#39;Draw Needle 3D Models&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">drawValidationNeedlesButton</span><span class="o">.</span><span class="n">toolTip</span> <span class="o">=</span> <span class="s">&quot;Redraw every manually segmented needles. This is usefull for example if you moved a control point, or after you added a new needle&quot;</span>
    <span class="n">validationFrame</span><span class="o">.</span><span class="n">addRow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">drawValidationNeedlesButton</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">drawValidationNeedlesButton</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&#39;clicked()&#39;</span><span class="p">,</span> <span class="n">logic</span><span class="o">.</span><span class="n">drawValidationNeedles</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">startValidationButton</span> <span class="o">=</span> <span class="n">qt</span><span class="o">.</span><span class="n">QPushButton</span><span class="p">(</span><span class="s">&#39;Start Evaluation&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">startValidationButton</span><span class="o">.</span><span class="n">toolTip</span> <span class="o">=</span> <span class="s">&quot;Launch tracking algo. from the tip of the manually segmented needles&quot;</span>
    <span class="n">validationFrame</span><span class="o">.</span><span class="n">addRow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">startValidationButton</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">startValidationButton</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&#39;clicked()&#39;</span><span class="p">,</span> <span class="n">logic</span><span class="o">.</span><span class="n">startValidation</span><span class="p">)</span>

    <span class="c">#Reset Needle Validation Button </span>
    <span class="bp">self</span><span class="o">.</span><span class="n">resetDetectionButton</span> <span class="o">=</span> <span class="n">qt</span><span class="o">.</span><span class="n">QPushButton</span><span class="p">(</span><span class="s">&#39;Reset Needles from Manual Segmention&#39;</span><span class="p">)</span>
    <span class="n">validationFrame</span><span class="o">.</span><span class="n">addRow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resetDetectionButton</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">resetDetectionButton</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&#39;clicked()&#39;</span><span class="p">,</span> <span class="n">logic</span><span class="o">.</span><span class="n">resetNeedleValidation</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">editNeedleTxtBox</span> <span class="o">=</span> <span class="n">qt</span><span class="o">.</span><span class="n">QSpinBox</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">editNeedleTxtBox</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&quot;valueChanged(int)&quot;</span><span class="p">,</span><span class="n">logic</span><span class="o">.</span><span class="n">changeValue</span><span class="p">)</span>
    <span class="n">editLabel</span><span class="o">=</span> <span class="n">qt</span><span class="o">.</span><span class="n">QLabel</span><span class="p">(</span><span class="s">&#39;Choose Needle for Ctrl Pt scrolling:&#39;</span><span class="p">)</span>
    <span class="n">validationFrame</span><span class="o">.</span><span class="n">addRow</span><span class="p">(</span><span class="n">editLabel</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">editNeedleTxtBox</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">scrollPointButton</span> <span class="o">=</span> <span class="n">qt</span><span class="o">.</span><span class="n">QPushButton</span><span class="p">(</span><span class="s">&#39;Scroll Ctrl Pt for Needle &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">editNeedleTxtBox</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>
    <span class="n">validationFrame</span><span class="o">.</span><span class="n">addRow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scrollPointButton</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">scrollPointButton</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&#39;clicked()&#39;</span><span class="p">,</span> <span class="n">logic</span><span class="o">.</span><span class="n">scrollPoint</span><span class="p">)</span>

    <span class="c">#Filter Needles Button</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__filterFrame</span> <span class="o">=</span> <span class="n">ctk</span><span class="o">.</span><span class="n">ctkCollapsibleButton</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__filterFrame</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s">&quot;Filter Needles&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__filterFrame</span><span class="o">.</span><span class="n">collapsed</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">filterFrame</span> <span class="o">=</span> <span class="n">qt</span><span class="o">.</span><span class="n">QFormLayout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__filterFrame</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">displayFiducialButton</span> <span class="o">=</span> <span class="n">qt</span><span class="o">.</span><span class="n">QPushButton</span><span class="p">(</span><span class="s">&#39;Display Labels On Needles&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">displayFiducialButton</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&#39;clicked()&#39;</span><span class="p">,</span><span class="n">logic</span><span class="o">.</span><span class="n">displayFiducial</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">displayContourButton</span> <span class="o">=</span> <span class="n">qt</span><span class="o">.</span><span class="n">QPushButton</span><span class="p">(</span><span class="s">&#39;Draw Isosurfaces&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">displayContourButton</span><span class="o">.</span><span class="n">checkable</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">displayContourButton</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&#39;clicked()&#39;</span><span class="p">,</span><span class="n">logic</span><span class="o">.</span><span class="n">drawIsoSurfaces</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">hideContourButton</span> <span class="o">=</span> <span class="n">qt</span><span class="o">.</span><span class="n">QPushButton</span><span class="p">(</span><span class="s">&#39;Hide Isosurfaces&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">hideContourButton</span><span class="o">.</span><span class="n">checkable</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">hideContourButton</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&#39;clicked()&#39;</span><span class="p">,</span><span class="n">logic</span><span class="o">.</span><span class="n">hideIsoSurfaces</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">hideContourButton</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    
    <span class="c"># segmentationFrame.addRow(self.displayFiducialButton)</span>
    <span class="n">segmentationFrame</span><span class="o">.</span><span class="n">addRow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">displayContourButton</span><span class="p">)</span>
    <span class="n">segmentationFrame</span><span class="o">.</span><span class="n">addRow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hideContourButton</span><span class="p">)</span>
    
    <span class="c"># Bending parameters</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__bendingFrame</span> <span class="o">=</span> <span class="n">ctk</span><span class="o">.</span><span class="n">ctkCollapsibleButton</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__bendingFrame</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s">&quot;Needle Detection Parameters&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__bendingFrame</span><span class="o">.</span><span class="n">collapsed</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">bendingFrame</span> <span class="o">=</span> <span class="n">qt</span><span class="o">.</span><span class="n">QFormLayout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__bendingFrame</span><span class="p">)</span>
    
    <span class="c"># Save/Load/Reset parameters</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">configFrame</span> <span class="o">=</span> <span class="n">qt</span><span class="o">.</span><span class="n">QFrame</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">configFrame</span><span class="o">.</span><span class="n">setLayout</span><span class="p">(</span><span class="n">qt</span><span class="o">.</span><span class="n">QHBoxLayout</span><span class="p">())</span>
    <span class="n">bendingFrame</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span><span class="o">.</span><span class="n">addRow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">configFrame</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">loadButton</span> <span class="o">=</span> <span class="n">qt</span><span class="o">.</span><span class="n">QPushButton</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">loadButton</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s">&quot;Load Parameters&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">loadButton</span><span class="o">.</span><span class="n">checkable</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">loadButton</span><span class="o">.</span><span class="n">toolTip</span> <span class="o">=</span> <span class="s">&quot;Click to load parameters from a configuration file.&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">loadButton</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&#39;clicked()&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">onLoad</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">saveButton</span> <span class="o">=</span> <span class="n">qt</span><span class="o">.</span><span class="n">QPushButton</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">saveButton</span><span class="o">.</span><span class="n">checkable</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">saveButton</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s">&quot;Save Parameters&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">saveButton</span><span class="o">.</span><span class="n">toolTip</span> <span class="o">=</span> <span class="s">&quot;Click to save the parameters in a configuration file.&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">saveButton</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&#39;clicked()&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">onSave</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">resetParametersButton</span> <span class="o">=</span> <span class="n">qt</span><span class="o">.</span><span class="n">QPushButton</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">resetParametersButton</span><span class="o">.</span><span class="n">checkable</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">resetParametersButton</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s">&quot;Reset Default Parameters&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">resetParametersButton</span><span class="o">.</span><span class="n">toolTip</span> <span class="o">=</span> <span class="s">&quot;Click to reset the default parameters from default.cfg&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">resetParametersButton</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&#39;clicked()&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">onReset</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">configFrame</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">loadButton</span> <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">configFrame</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">saveButton</span> <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">configFrame</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">resetParametersButton</span> <span class="p">)</span>

    <span class="c"># Auto correct tip position?</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">autoCorrectTip</span> <span class="o">=</span> <span class="n">qt</span><span class="o">.</span><span class="n">QCheckBox</span><span class="p">(</span><span class="s">&#39;Auto correct tip position?&#39;</span><span class="p">)</span>
    <span class="n">bendingFrame</span><span class="o">.</span><span class="n">addRow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">autoCorrectTip</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">autoCorrectTip</span><span class="o">.</span><span class="n">setChecked</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="c"># Look for needles in CT?</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">invertedContrast</span> <span class="o">=</span> <span class="n">qt</span><span class="o">.</span><span class="n">QCheckBox</span><span class="p">(</span><span class="s">&#39;Search for bright needles (CT)?&#39;</span><span class="p">)</span>
    <span class="n">bendingFrame</span><span class="o">.</span><span class="n">addRow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">invertedContrast</span><span class="p">)</span>
    <span class="c"># Compute gradient?</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">gradient</span><span class="o">=</span><span class="n">qt</span><span class="o">.</span><span class="n">QCheckBox</span><span class="p">(</span><span class="s">&#39;Compute gradient?&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">gradient</span><span class="o">.</span><span class="n">setChecked</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">bendingFrame</span><span class="o">.</span><span class="n">addRow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gradient</span><span class="p">)</span>

    <span class="c"># Filter ControlPoints?</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">filterControlPoints</span><span class="o">=</span><span class="n">qt</span><span class="o">.</span><span class="n">QCheckBox</span><span class="p">(</span><span class="s">&#39;Filter Control Points?&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">filterControlPoints</span><span class="o">.</span><span class="n">setChecked</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="c"># bendingFrame.addRow(self.filterControlPoints)</span>

    <span class="c"># Draw Fiducial Points?</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">drawFiducialPoints</span><span class="o">=</span><span class="n">qt</span><span class="o">.</span><span class="n">QCheckBox</span><span class="p">(</span><span class="s">&#39;Draw Control Points?&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">drawFiducialPoints</span><span class="o">.</span><span class="n">setChecked</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">bendingFrame</span><span class="o">.</span><span class="n">addRow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">drawFiducialPoints</span><span class="p">)</span>

    <span class="c"># Auto find Tips: Tracking in +z and -z direction</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">autoStopTip</span> <span class="o">=</span> <span class="n">qt</span><span class="o">.</span><span class="n">QCheckBox</span><span class="p">(</span><span class="s">&#39;Tracking in both directions&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">autoStopTip</span><span class="o">.</span><span class="n">setChecked</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">bendingFrame</span><span class="o">.</span><span class="n">addRow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">autoStopTip</span><span class="p">)</span>

    <span class="c"># Extend Needle to the wanted value</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">extendNeedle</span> <span class="o">=</span> <span class="n">qt</span><span class="o">.</span><span class="n">QCheckBox</span><span class="p">(</span><span class="s">&#39;Extend Needle&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">extendNeedle</span><span class="o">.</span><span class="n">setChecked</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">bendingFrame</span><span class="o">.</span><span class="n">addRow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">extendNeedle</span><span class="p">)</span>

    <span class="c"># Real Needle Value (used to extend the needle)</span>
    <span class="n">realNeedleLengthLabel</span> <span class="o">=</span> <span class="n">qt</span><span class="o">.</span><span class="n">QLabel</span><span class="p">(</span><span class="s">&#39;Real Needle Length (mm):&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">realNeedleLength</span> <span class="o">=</span> <span class="n">qt</span><span class="o">.</span><span class="n">QSpinBox</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">realNeedleLength</span><span class="o">.</span><span class="n">setMinimum</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">realNeedleLength</span><span class="o">.</span><span class="n">setMaximum</span><span class="p">(</span><span class="mi">1500</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">realNeedleLength</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mi">240</span><span class="p">)</span>
    <span class="n">bendingFrame</span><span class="o">.</span><span class="n">addRow</span><span class="p">(</span><span class="n">realNeedleLengthLabel</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">realNeedleLength</span><span class="p">)</span>

    <span class="c"># Max Needle Length?</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">maxLength</span><span class="o">=</span><span class="n">qt</span><span class="o">.</span><span class="n">QCheckBox</span><span class="p">(</span><span class="s">&#39;Max Needle Length?&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">maxLength</span><span class="o">.</span><span class="n">setChecked</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">bendingFrame</span><span class="o">.</span><span class="n">addRow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">maxLength</span><span class="p">)</span>

    <span class="c"># Add Gaussian Estimation?</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">gaussianAttenuationButton</span> <span class="o">=</span> <span class="n">qt</span><span class="o">.</span><span class="n">QCheckBox</span><span class="p">(</span><span class="s">&#39;Add Gaussian Prob. Attenuation?&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">gaussianAttenuationButton</span><span class="o">.</span><span class="n">setChecked</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">bendingFrame</span><span class="o">.</span><span class="n">addRow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gaussianAttenuationButton</span><span class="p">)</span>

    <span class="c"># nb points per line spin box</span>
    <span class="c">### previously 4 - try with 20</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">sigmaValue</span> <span class="o">=</span> <span class="n">qt</span><span class="o">.</span><span class="n">QSpinBox</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">sigmaValue</span><span class="o">.</span><span class="n">setMinimum</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">sigmaValue</span><span class="o">.</span><span class="n">setMaximum</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">sigmaValue</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">sigmaValueLabel</span> <span class="o">=</span> <span class="n">qt</span><span class="o">.</span><span class="n">QLabel</span><span class="p">(</span><span class="s">&quot;Sigma Value (exp(-x^2/(2*(sigma/10)^2))): &quot;</span><span class="p">)</span>
    <span class="n">bendingFrame</span><span class="o">.</span><span class="n">addRow</span><span class="p">(</span> <span class="n">sigmaValueLabel</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigmaValue</span><span class="p">)</span>

    <span class="c"># nb points per line spin box</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">gradientPonderation</span> <span class="o">=</span> <span class="n">qt</span><span class="o">.</span><span class="n">QSpinBox</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">gradientPonderation</span><span class="o">.</span><span class="n">setMinimum</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">gradientPonderation</span><span class="o">.</span><span class="n">setMaximum</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">gradientPonderation</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">gradientPonderationLabel</span> <span class="o">=</span> <span class="n">qt</span><span class="o">.</span><span class="n">QLabel</span><span class="p">(</span><span class="s">&quot;Neighborhood Ponderation: &quot;</span><span class="p">)</span>
    <span class="n">bendingFrame</span><span class="o">.</span><span class="n">addRow</span><span class="p">(</span> <span class="n">gradientPonderationLabel</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">gradientPonderation</span><span class="p">)</span>

    <span class="c"># center accuentuation</span>
    <span class="c">### previously 1, try with 2 ( avoids exiting catheter track)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">exponent</span> <span class="o">=</span> <span class="n">qt</span><span class="o">.</span><span class="n">QSpinBox</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">exponent</span><span class="o">.</span><span class="n">setMinimum</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">exponent</span><span class="o">.</span><span class="n">setMaximum</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">exponent</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">exponentLabel</span> <span class="o">=</span> <span class="n">qt</span><span class="o">.</span><span class="n">QLabel</span><span class="p">(</span><span class="s">&quot;Center Ponderation: &quot;</span><span class="p">)</span>
    <span class="n">bendingFrame</span><span class="o">.</span><span class="n">addRow</span><span class="p">(</span> <span class="n">exponentLabel</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">exponent</span><span class="p">)</span>

    <span class="c"># nb points per line spin box</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">nbPointsPerLine</span> <span class="o">=</span> <span class="n">qt</span><span class="o">.</span><span class="n">QSpinBox</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">nbPointsPerLine</span><span class="o">.</span><span class="n">setMinimum</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">nbPointsPerLine</span><span class="o">.</span><span class="n">setMaximum</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">nbPointsPerLine</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">nbPointsPerLineLabel</span> <span class="o">=</span> <span class="n">qt</span><span class="o">.</span><span class="n">QLabel</span><span class="p">(</span><span class="s">&quot;Number of points per line: &quot;</span><span class="p">)</span>
    <span class="c"># bendingFrame.addRow( nbPointsPerLineLabel, self.nbPointsPerLine)</span>

    <span class="c"># nb radius iteration spin box</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">nbRadiusIterations</span> <span class="o">=</span> <span class="n">qt</span><span class="o">.</span><span class="n">QSpinBox</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">nbRadiusIterations</span><span class="o">.</span><span class="n">setMinimum</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">nbRadiusIterations</span><span class="o">.</span><span class="n">setMaximum</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">nbRadiusIterations</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mi">13</span><span class="p">)</span>
    <span class="n">nbRadiusIterationsLabel</span> <span class="o">=</span> <span class="n">qt</span><span class="o">.</span><span class="n">QLabel</span><span class="p">(</span><span class="s">&quot;Number of distance iterations: &quot;</span><span class="p">)</span>
    <span class="c"># bendingFrame.addRow( nbRadiusIterationsLabel, self.nbRadiusIterations)</span>
    
    <span class="c"># distance max spin box</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">distanceMax</span> <span class="o">=</span> <span class="n">qt</span><span class="o">.</span><span class="n">QSpinBox</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">distanceMax</span><span class="o">.</span><span class="n">setMinimum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">distanceMax</span><span class="o">.</span><span class="n">setMaximum</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">distanceMax</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">distanceMaxLabel</span> <span class="o">=</span> <span class="n">qt</span><span class="o">.</span><span class="n">QLabel</span><span class="p">(</span><span class="s">&quot;Radius of cone base (mm): &quot;</span><span class="p">)</span>
    <span class="n">bendingFrame</span><span class="o">.</span><span class="n">addRow</span><span class="p">(</span> <span class="n">distanceMaxLabel</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">distanceMax</span><span class="p">)</span>
    
    <span class="c"># nb rotating iterations spin box</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">nbRotatingIterations</span> <span class="o">=</span> <span class="n">qt</span><span class="o">.</span><span class="n">QSpinBox</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">nbRotatingIterations</span><span class="o">.</span><span class="n">setMinimum</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">nbRotatingIterations</span><span class="o">.</span><span class="n">setMaximum</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">nbRotatingIterations</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mi">35</span><span class="p">)</span>
    <span class="n">nbRotatingIterationsLabel</span> <span class="o">=</span> <span class="n">qt</span><span class="o">.</span><span class="n">QLabel</span><span class="p">(</span><span class="s">&quot;Number of rotating steps: &quot;</span><span class="p">)</span>
    <span class="n">bendingFrame</span><span class="o">.</span><span class="n">addRow</span><span class="p">(</span> <span class="n">nbRotatingIterationsLabel</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nbRotatingIterations</span><span class="p">)</span>
    
    <span class="c"># nb heights per needle spin box</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">numberOfPointsPerNeedle</span> <span class="o">=</span> <span class="n">qt</span><span class="o">.</span><span class="n">QSpinBox</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">numberOfPointsPerNeedle</span><span class="o">.</span><span class="n">setMinimum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">numberOfPointsPerNeedle</span><span class="o">.</span><span class="n">setMaximum</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">numberOfPointsPerNeedle</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
    <span class="n">numberOfPointsPerNeedleLabel</span> <span class="o">=</span> <span class="n">qt</span><span class="o">.</span><span class="n">QLabel</span><span class="p">(</span><span class="s">&quot;Number of Control Points: &quot;</span><span class="p">)</span>
    <span class="n">bendingFrame</span><span class="o">.</span><span class="n">addRow</span><span class="p">(</span> <span class="n">numberOfPointsPerNeedleLabel</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">numberOfPointsPerNeedle</span><span class="p">)</span>
    
    <span class="c"># nb heights per needle spin box</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">stepsize</span> <span class="o">=</span> <span class="n">qt</span><span class="o">.</span><span class="n">QSpinBox</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">stepsize</span><span class="o">.</span><span class="n">setMinimum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">stepsize</span><span class="o">.</span><span class="n">setMaximum</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">stepsize</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">stepsizeLabel</span> <span class="o">=</span> <span class="n">qt</span><span class="o">.</span><span class="n">QLabel</span><span class="p">(</span><span class="s">&quot;Stepsize: &quot;</span><span class="p">)</span>
    <span class="c"># bendingFrame.addRow( stepsizeLabel, self.stepsize)</span>

    <span class="c">#lenghtNeedle</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">lenghtNeedleParameter</span> <span class="o">=</span> <span class="n">qt</span><span class="o">.</span><span class="n">QSpinBox</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">lenghtNeedleParameter</span><span class="o">.</span><span class="n">setMinimum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">lenghtNeedleParameter</span><span class="o">.</span><span class="n">setMaximum</span><span class="p">(</span><span class="mi">10000</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">lenghtNeedleParameter</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">stepsizeLabel</span> <span class="o">=</span> <span class="n">qt</span><span class="o">.</span><span class="n">QLabel</span><span class="p">(</span><span class="s">&quot;Lenght of the needles (mm): &quot;</span><span class="p">)</span>
    <span class="n">bendingFrame</span><span class="o">.</span><span class="n">addRow</span><span class="p">(</span> <span class="n">stepsizeLabel</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lenghtNeedleParameter</span><span class="p">)</span>

    <span class="c">#radius</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">radiusNeedleParameter</span> <span class="o">=</span> <span class="n">qt</span><span class="o">.</span><span class="n">QSpinBox</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">radiusNeedleParameter</span><span class="o">.</span><span class="n">setMinimum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">radiusNeedleParameter</span><span class="o">.</span><span class="n">setMaximum</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">radiusNeedleParameter</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">radiusLabel</span> <span class="o">=</span> <span class="n">qt</span><span class="o">.</span><span class="n">QLabel</span><span class="p">(</span><span class="s">&quot;Radius of the needles (mm): &quot;</span><span class="p">)</span>
    <span class="n">bendingFrame</span><span class="o">.</span><span class="n">addRow</span><span class="p">(</span> <span class="n">radiusLabel</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">radiusNeedleParameter</span><span class="p">)</span>
    
    <span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">addRow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__reportFrame</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">addRow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__segmentationFrame</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">addRow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__validationFrame</span><span class="p">)</span>
    <span class="c"># self.layout.addRow(self.__filterFrame)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">addRow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__bendingFrame</span><span class="p">)</span>
    <span class="c"># reset module</span>
    
    <span class="n">resetButton</span> <span class="o">=</span> <span class="n">qt</span><span class="o">.</span><span class="n">QPushButton</span><span class="p">(</span> <span class="s">&#39;Reset Module&#39;</span> <span class="p">)</span>
    <span class="n">resetButton</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span> <span class="s">&#39;clicked()&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">onReload</span> <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">widget</span> <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">qMRMLWidget</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">widget</span><span class="o">.</span><span class="n">setLayout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">layout2</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">widget</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">onReset</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="NeedleFinderWidget.cleanup"><a class="viewcode-back" href="../NeedleFinder.html#NeedleFinder.NeedleFinderWidget.cleanup">[docs]</a>  <span class="k">def</span> <span class="nf">cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    clean up memory</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#productive</span>
    <span class="k">if</span> <span class="n">profiling</span><span class="p">:</span> <span class="k">print</span> <span class="s">&quot;cleanup&quot;</span><span class="p">;</span>
    <span class="k">pass</span>
</div>
<div class="viewcode-block" id="NeedleFinderWidget.onReload"><a class="viewcode-back" href="../NeedleFinder.html#NeedleFinder.NeedleFinderWidget.onReload">[docs]</a>  <span class="k">def</span> <span class="nf">onReload</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">moduleName</span><span class="o">=</span><span class="s">&quot;NeedleFinder&quot;</span><span class="p">):</span>
    <span class="k">print</span> <span class="s">&quot;onReload&quot;</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generic reload method for any scripted module.</span>
<span class="sd">    ModuleWizard will subsitute correct default moduleName.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">globals</span><span class="p">()[</span><span class="n">moduleName</span><span class="p">]</span> <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">reloadScriptedModule</span><span class="p">(</span><span class="n">moduleName</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="NeedleFinderWidget.onReloadAndTest"><a class="viewcode-back" href="../NeedleFinder.html#NeedleFinder.NeedleFinderWidget.onReloadAndTest">[docs]</a>  <span class="k">def</span> <span class="nf">onReloadAndTest</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">moduleName</span><span class="o">=</span><span class="s">&quot;NeedleFinder&quot;</span><span class="p">):</span>
    <span class="k">print</span> <span class="s">&quot;onReloadAndTest&quot;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">onReload</span><span class="p">()</span>
      <span class="n">evalString</span> <span class="o">=</span> <span class="s">&#39;globals()[&quot;</span><span class="si">%s</span><span class="s">&quot;].</span><span class="si">%s</span><span class="s">Test()&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">moduleName</span><span class="p">,</span> <span class="n">moduleName</span><span class="p">)</span>
      <span class="n">tester</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">evalString</span><span class="p">)</span>
      <span class="n">tester</span><span class="o">.</span><span class="n">runTest</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
      <span class="kn">import</span> <span class="nn">traceback</span>
      <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
      <span class="n">qt</span><span class="o">.</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">slicer</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">mainWindow</span><span class="p">(),</span>
          <span class="s">&quot;Reload and Test&quot;</span><span class="p">,</span> <span class="s">&#39;Exception!</span><span class="se">\n\n</span><span class="s">&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\n\n</span><span class="s">See Python Console for Stack Trace&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="NeedleFinderWidget.onStartStopGivingNeedleTipsToggled"><a class="viewcode-back" href="../NeedleFinder.html#NeedleFinder.NeedleFinderWidget.onStartStopGivingNeedleTipsToggled">[docs]</a>  <span class="k">def</span> <span class="nf">onStartStopGivingNeedleTipsToggled</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">checked</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Start/stop giving needle tips</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#productive</span>
    <span class="k">if</span> <span class="n">profiling</span><span class="p">:</span> <span class="k">print</span> <span class="s">&quot;onStartStopGivingNeedleTipsToggled&quot;</span><span class="p">;</span>
    <span class="k">if</span> <span class="n">checked</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">startGivingControlPointsButton</span><span class="o">.</span><span class="n">checked</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">fiducialObturatorButton</span><span class="o">.</span><span class="n">checked</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">fiducialButton</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s">&quot;Stop Giving Tips&quot;</span>  
    <span class="k">else</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">fiducialButton</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s">&quot;Start Giving Needle Tips&quot;</span>
</div>
<div class="viewcode-block" id="NeedleFinderWidget.onStartStopGivingObturatorNeedleTipsToggled"><a class="viewcode-back" href="../NeedleFinder.html#NeedleFinder.NeedleFinderWidget.onStartStopGivingObturatorNeedleTipsToggled">[docs]</a>  <span class="k">def</span> <span class="nf">onStartStopGivingObturatorNeedleTipsToggled</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">checked</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Start/stop giving obturator needle tips</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#productive</span>
    <span class="k">if</span> <span class="n">profiling</span><span class="p">:</span> <span class="k">print</span> <span class="s">&quot;onStartStopGivingObturatorNeedleTipsToggled&quot;</span><span class="p">;</span>
    <span class="k">if</span> <span class="n">checked</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">fiducialButton</span><span class="o">.</span><span class="n">checked</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">fiducialButton</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s">&quot;Start Giving Needle Tips&quot;</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">startGivingControlPointsButton</span><span class="o">.</span><span class="n">checked</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obturatorNeedleTipClicks</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">fiducialObturatorButton</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s">&quot;Stop Giving Obturator Needle Tips&quot;</span>  
    <span class="k">else</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">fiducialObturatorButton</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s">&quot;Start Giving Obturator Needle Tips&quot;</span>
</div>
<div class="viewcode-block" id="NeedleFinderWidget.onStartStopGivingValidationControlPointsToggled"><a class="viewcode-back" href="../NeedleFinder.html#NeedleFinder.NeedleFinderWidget.onStartStopGivingValidationControlPointsToggled">[docs]</a>  <span class="k">def</span> <span class="nf">onStartStopGivingValidationControlPointsToggled</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">checked</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Start/stop needle validation control points. When checked is true, the mouse clicks are observed and leads to an action</span>
<span class="sd">    (here a new control point for a validation needle)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#productive</span>
    <span class="k">if</span> <span class="n">profiling</span><span class="p">:</span> <span class="k">print</span> <span class="s">&quot;onStartStopGivingValidationControlPointsToggled&quot;</span><span class="p">;</span>
    <span class="k">if</span> <span class="n">checked</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">fiducialObturatorButton</span><span class="o">.</span><span class="n">checked</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">fiducialButton</span><span class="o">.</span><span class="n">checked</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">fiducialButton</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s">&quot;Start Giving Needle Tips&quot;</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">needleValidationClicks</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">startGivingControlPointsButton</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s">&quot;Stop Giving Control Points&quot;</span>  
    <span class="k">else</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">startGivingControlPointsButton</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s">&quot;Start Giving Control Points&quot;</span>
</div>
<div class="viewcode-block" id="NeedleFinderWidget.start"><a class="viewcode-back" href="../NeedleFinder.html#NeedleFinder.NeedleFinderWidget.start">[docs]</a>  <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">process</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Start to observe the mouse clicks given by user (clicks on needle tips)</span>
<span class="sd">    &quot;&quot;&quot;</span>   
    <span class="c">#productive</span>
    <span class="k">if</span> <span class="n">profiling</span><span class="p">:</span> <span class="k">print</span> <span class="s">&quot;start&quot;</span><span class="p">;</span>
    <span class="n">logic</span> <span class="o">=</span> <span class="n">NeedleFinderLogic</span><span class="p">()</span>
    <span class="n">logic</span><span class="o">.</span><span class="n">changeCursor</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">removeObservers</span><span class="p">()</span>
    <span class="c"># get new slice nodes</span>
    <span class="n">layoutManager</span> <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">layoutManager</span><span class="p">()</span>
    <span class="n">sliceNodeCount</span> <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">mrmlScene</span><span class="o">.</span><span class="n">GetNumberOfNodesByClass</span><span class="p">(</span><span class="s">&#39;vtkMRMLSliceNode&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">nodeIndex</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">sliceNodeCount</span><span class="p">):</span>
      <span class="c"># find the widget for each node in scene</span>
      <span class="n">sliceNode</span> <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">mrmlScene</span><span class="o">.</span><span class="n">GetNthNodeByClass</span><span class="p">(</span><span class="n">nodeIndex</span><span class="p">,</span> <span class="s">&#39;vtkMRMLSliceNode&#39;</span><span class="p">)</span>
      <span class="n">sliceWidget</span> <span class="o">=</span> <span class="n">layoutManager</span><span class="o">.</span><span class="n">sliceWidget</span><span class="p">(</span><span class="n">sliceNode</span><span class="o">.</span><span class="n">GetLayoutName</span><span class="p">())</span>      
      <span class="k">if</span> <span class="n">sliceWidget</span><span class="p">:</span>     
        <span class="c"># add obserservers and keep track of tags</span>
        <span class="n">style</span> <span class="o">=</span> <span class="n">sliceWidget</span><span class="o">.</span><span class="n">sliceView</span><span class="p">()</span><span class="o">.</span><span class="n">interactorStyle</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sliceWidgetsPerStyle</span><span class="p">[</span><span class="n">style</span><span class="p">]</span> <span class="o">=</span> <span class="n">sliceWidget</span>
        <span class="n">events</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;LeftButtonPressEvent&quot;</span><span class="p">,</span><span class="s">&quot;LeftButtonReleaseEvent&quot;</span><span class="p">,</span> <span class="s">&quot;EnterEvent&quot;</span><span class="p">,</span> <span class="s">&quot;LeaveEvent&quot;</span><span class="p">,</span><span class="s">&quot;KeyPressEvent&quot;</span><span class="p">,</span><span class="s">&quot;KeyReleaseEvent&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
          <span class="k">if</span> <span class="n">process</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">needleValidationClicks</span><span class="p">:</span>
            <span class="n">tag</span> <span class="o">=</span> <span class="n">style</span><span class="o">.</span><span class="n">AddObserver</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">processEventNeedleValidation</span><span class="p">)</span>
          <span class="k">elif</span> <span class="n">process</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">addManualTipClicks</span><span class="p">:</span>
            <span class="n">tag</span> <span class="o">=</span> <span class="n">style</span><span class="o">.</span><span class="n">AddObserver</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">processEventAddManualTips</span><span class="p">)</span>
          <span class="k">elif</span> <span class="n">process</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">obturatorNeedleTipClicks</span><span class="p">:</span>
            <span class="n">tag</span> <span class="o">=</span> <span class="n">style</span><span class="o">.</span><span class="n">AddObserver</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">processEventAddObturatorNeedleTips</span><span class="p">)</span>
            <span class="n">dn</span> <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">layoutManager</span><span class="p">()</span><span class="o">.</span><span class="n">sliceWidget</span><span class="p">(</span><span class="s">&quot;Red&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sliceLogic</span><span class="p">()</span><span class="o">.</span><span class="n">GetBackgroundLayer</span><span class="p">()</span><span class="o">.</span><span class="n">GetVolumeNode</span><span class="p">()</span><span class="o">.</span><span class="n">GetDisplayNode</span><span class="p">()</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">dn</span><span class="o">.</span><span class="n">GetWindow</span><span class="p">()</span>
            <span class="n">l</span> <span class="o">=</span> <span class="n">dn</span><span class="o">.</span><span class="n">GetLevel</span><span class="p">()</span>
            <span class="n">dn</span><span class="o">.</span><span class="n">AddObserver</span><span class="p">(</span><span class="n">vtk</span><span class="o">.</span><span class="n">vtkCommand</span><span class="o">.</span><span class="n">ModifiedEvent</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">c</span><span class="p">,</span><span class="n">e</span> <span class="p">:</span> <span class="n">logic</span><span class="o">.</span><span class="n">setWL</span><span class="p">(</span><span class="n">dn</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">l</span><span class="p">))</span>
          <span class="k">else</span><span class="p">:</span>
            <span class="n">tag</span> <span class="o">=</span> <span class="n">style</span><span class="o">.</span><span class="n">AddObserver</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">processEvent</span><span class="p">)</span>   
          <span class="bp">self</span><span class="o">.</span><span class="n">styleObserverTags</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">style</span><span class="p">,</span><span class="n">tag</span><span class="p">])</span>
</div>
<div class="viewcode-block" id="NeedleFinderWidget.stop"><a class="viewcode-back" href="../NeedleFinder.html#NeedleFinder.NeedleFinderWidget.stop">[docs]</a>  <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Stop to observe the mouse clicks given by user</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#productive</span>
    <span class="k">if</span> <span class="n">profiling</span><span class="p">:</span> <span class="k">print</span> <span class="s">&quot;stop&quot;</span><span class="p">;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">logic</span><span class="o">.</span><span class="n">changeCursor</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">removeObservers</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fiducialObturatorButton</span><span class="o">.</span><span class="n">checked</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fiducialButton</span><span class="o">.</span><span class="n">checked</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">validationNeedleButton</span><span class="o">.</span><span class="n">checked</span> <span class="o">=</span> <span class="mi">0</span>
</div>
<div class="viewcode-block" id="NeedleFinderWidget.removeObservers"><a class="viewcode-back" href="../NeedleFinder.html#NeedleFinder.NeedleFinderWidget.removeObservers">[docs]</a>  <span class="k">def</span> <span class="nf">removeObservers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Remove observers and reset</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#productive #framework</span>
    <span class="k">if</span> <span class="n">profiling</span><span class="p">:</span> <span class="k">print</span> <span class="s">&quot;removeObservers&quot;</span><span class="p">;</span>
    <span class="k">for</span> <span class="n">observee</span><span class="p">,</span><span class="n">tag</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">styleObserverTags</span><span class="p">:</span>
      <span class="n">observee</span><span class="o">.</span><span class="n">RemoveObserver</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">styleObserverTags</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">sliceWidgetsPerStyle</span> <span class="o">=</span> <span class="p">{}</span>
</div>
<div class="viewcode-block" id="NeedleFinderWidget.processEvent"><a class="viewcode-back" href="../NeedleFinder.html#NeedleFinder.NeedleFinderWidget.processEvent">[docs]</a>  <span class="k">def</span> <span class="nf">processEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">observee</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the mouse clicks and create a fiducial node at this position. Used later for the fiducial registration</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#productive #frequent #event-handler</span>
    <span class="k">if</span> <span class="n">profiling</span> <span class="ow">and</span> <span class="n">frequent</span><span class="p">:</span> <span class="k">print</span> <span class="s">&quot;processEvent&quot;</span><span class="p">;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sliceWidgetsPerStyle</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">observee</span><span class="p">)</span> <span class="ow">and</span> <span class="n">event</span> <span class="o">==</span> <span class="s">&quot;KeyPressEvent&quot;</span><span class="p">:</span>
      <span class="n">sliceWidget</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sliceWidgetsPerStyle</span><span class="p">[</span><span class="n">observee</span><span class="p">]</span>
      <span class="n">style</span> <span class="o">=</span> <span class="n">sliceWidget</span><span class="o">.</span><span class="n">sliceView</span><span class="p">()</span><span class="o">.</span><span class="n">interactorStyle</span><span class="p">()</span>
      <span class="n">key</span> <span class="o">=</span> <span class="n">style</span><span class="o">.</span><span class="n">GetInteractor</span><span class="p">()</span><span class="o">.</span><span class="n">GetKeySym</span><span class="p">()</span>
      <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s">&#39;o&#39;</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">numberOfPointsPerNeedle</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sliceWidgetsPerStyle</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">observee</span><span class="p">)</span> <span class="ow">and</span> <span class="n">event</span> <span class="o">==</span> <span class="s">&quot;KeyReleaseEvent&quot;</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">numberOfPointsPerNeedle</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sliceWidgetsPerStyle</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">observee</span><span class="p">)</span> <span class="ow">and</span> <span class="n">event</span> <span class="o">==</span> <span class="s">&quot;LeftButtonPressEvent&quot;</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">slicer</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">repositoryRevision</span><span class="o">&lt;=</span> <span class="mi">21022</span><span class="p">:</span>
        <span class="n">sliceWidget</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sliceWidgetsPerStyle</span><span class="p">[</span><span class="n">observee</span><span class="p">]</span>
        <span class="n">style</span> <span class="o">=</span> <span class="n">sliceWidget</span><span class="o">.</span><span class="n">sliceView</span><span class="p">()</span><span class="o">.</span><span class="n">interactorStyle</span><span class="p">()</span>          
        <span class="n">xy</span> <span class="o">=</span> <span class="n">style</span><span class="o">.</span><span class="n">GetInteractor</span><span class="p">()</span><span class="o">.</span><span class="n">GetEventPosition</span><span class="p">()</span>
        <span class="n">xyz</span> <span class="o">=</span> <span class="n">sliceWidget</span><span class="o">.</span><span class="n">convertDeviceToXYZ</span><span class="p">(</span><span class="n">xy</span><span class="p">)</span>
        <span class="n">ras</span> <span class="o">=</span> <span class="n">sliceWidget</span><span class="o">.</span><span class="n">convertXYZToRAS</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">sliceWidget</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sliceWidgetsPerStyle</span><span class="p">[</span><span class="n">observee</span><span class="p">]</span>
        <span class="n">sliceLogic</span> <span class="o">=</span> <span class="n">sliceWidget</span><span class="o">.</span><span class="n">sliceLogic</span><span class="p">()</span>
        <span class="n">sliceNode</span> <span class="o">=</span> <span class="n">sliceWidget</span><span class="o">.</span><span class="n">mrmlSliceNode</span><span class="p">()</span>
        <span class="n">interactor</span> <span class="o">=</span> <span class="n">observee</span><span class="o">.</span><span class="n">GetInteractor</span><span class="p">()</span>
        <span class="n">xy</span> <span class="o">=</span> <span class="n">interactor</span><span class="o">.</span><span class="n">GetEventPosition</span><span class="p">()</span>
        <span class="n">xyz</span> <span class="o">=</span> <span class="n">sliceWidget</span><span class="o">.</span><span class="n">sliceView</span><span class="p">()</span><span class="o">.</span><span class="n">convertDeviceToXYZ</span><span class="p">(</span><span class="n">xy</span><span class="p">);</span>
        <span class="n">ras</span> <span class="o">=</span> <span class="n">sliceWidget</span><span class="o">.</span><span class="n">sliceView</span><span class="p">()</span><span class="o">.</span><span class="n">convertXYZToRAS</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span>
      
      <span class="n">colorVar</span>    <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
      <span class="n">volumeNode</span>  <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">layoutManager</span><span class="p">()</span><span class="o">.</span><span class="n">sliceWidget</span><span class="p">(</span><span class="s">&quot;Red&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sliceLogic</span><span class="p">()</span><span class="o">.</span><span class="n">GetBackgroundLayer</span><span class="p">()</span><span class="o">.</span><span class="n">GetVolumeNode</span><span class="p">()</span>
      <span class="n">imageData</span>   <span class="o">=</span> <span class="n">volumeNode</span><span class="o">.</span><span class="n">GetImageData</span><span class="p">()</span>
      <span class="n">spacing</span>     <span class="o">=</span> <span class="n">volumeNode</span><span class="o">.</span><span class="n">GetSpacing</span><span class="p">()</span>
      <span class="n">ijk</span>         <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">logic</span><span class="o">.</span><span class="n">ras2ijk</span><span class="p">(</span><span class="n">ras</span><span class="p">)</span>
      
      <span class="bp">self</span><span class="o">.</span><span class="n">logic</span><span class="o">.</span><span class="n">t0</span>     <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">clock</span><span class="p">()</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">logic</span><span class="o">.</span><span class="n">needleDetectionThread</span><span class="p">(</span><span class="n">ijk</span><span class="p">,</span> <span class="n">imageData</span><span class="p">,</span> <span class="n">colorVar</span><span class="p">,</span><span class="n">spacing</span><span class="p">)</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">autoStopTip</span><span class="o">.</span><span class="n">isChecked</span><span class="p">():</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logic</span><span class="o">.</span><span class="n">needleDetectionUPThread</span><span class="p">(</span><span class="n">ijk</span><span class="p">,</span> <span class="n">imageData</span><span class="p">,</span> <span class="n">colorVar</span><span class="p">,</span><span class="n">spacing</span><span class="p">)</span>
      
</div>
<div class="viewcode-block" id="NeedleFinderWidget.processEventNeedleValidation"><a class="viewcode-back" href="../NeedleFinder.html#NeedleFinder.NeedleFinderWidget.processEventNeedleValidation">[docs]</a>  <span class="k">def</span> <span class="nf">processEventNeedleValidation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">observee</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the mouse clicks and create a fiducial node at this position. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#productive #frequent #event-handler</span>
    <span class="k">if</span> <span class="n">profiling</span> <span class="ow">and</span> <span class="n">frequent</span><span class="p">:</span> <span class="k">print</span> <span class="s">&quot;processEventNeedleValidation&quot;</span><span class="p">;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sliceWidgetsPerStyle</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">observee</span><span class="p">)</span> <span class="ow">and</span> <span class="n">event</span> <span class="o">==</span> <span class="s">&quot;LeftButtonPressEvent&quot;</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">slicer</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">repositoryRevision</span><span class="o">&lt;=</span> <span class="mi">21022</span><span class="p">:</span>
        <span class="n">sliceWidget</span>   <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sliceWidgetsPerStyle</span><span class="p">[</span><span class="n">observee</span><span class="p">]</span>
        <span class="n">style</span>         <span class="o">=</span> <span class="n">sliceWidget</span><span class="o">.</span><span class="n">sliceView</span><span class="p">()</span><span class="o">.</span><span class="n">interactorStyle</span><span class="p">()</span>          
        <span class="n">xy</span>            <span class="o">=</span> <span class="n">style</span><span class="o">.</span><span class="n">GetInteractor</span><span class="p">()</span><span class="o">.</span><span class="n">GetEventPosition</span><span class="p">()</span>
        <span class="n">xyz</span>           <span class="o">=</span> <span class="n">sliceWidget</span><span class="o">.</span><span class="n">convertDeviceToXYZ</span><span class="p">(</span><span class="n">xy</span><span class="p">)</span>
        <span class="n">ras</span>           <span class="o">=</span> <span class="n">sliceWidget</span><span class="o">.</span><span class="n">convertXYZToRAS</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">sliceWidget</span>   <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sliceWidgetsPerStyle</span><span class="p">[</span><span class="n">observee</span><span class="p">]</span>
        <span class="n">sliceLogic</span>    <span class="o">=</span> <span class="n">sliceWidget</span><span class="o">.</span><span class="n">sliceLogic</span><span class="p">()</span>
        <span class="n">sliceNode</span>     <span class="o">=</span> <span class="n">sliceWidget</span><span class="o">.</span><span class="n">mrmlSliceNode</span><span class="p">()</span>
        <span class="n">interactor</span>    <span class="o">=</span> <span class="n">observee</span><span class="o">.</span><span class="n">GetInteractor</span><span class="p">()</span>
        <span class="n">xy</span>            <span class="o">=</span> <span class="n">interactor</span><span class="o">.</span><span class="n">GetEventPosition</span><span class="p">()</span>
        <span class="n">xyz</span>           <span class="o">=</span> <span class="n">sliceWidget</span><span class="o">.</span><span class="n">sliceView</span><span class="p">()</span><span class="o">.</span><span class="n">convertDeviceToXYZ</span><span class="p">(</span><span class="n">xy</span><span class="p">);</span>
        <span class="n">ras</span>           <span class="o">=</span> <span class="n">sliceWidget</span><span class="o">.</span><span class="n">sliceView</span><span class="p">()</span><span class="o">.</span><span class="n">convertXYZToRAS</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span>
      
      <span class="n">colorVar</span>      <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
      <span class="n">volumeNode</span>    <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">layoutManager</span><span class="p">()</span><span class="o">.</span><span class="n">sliceWidget</span><span class="p">(</span><span class="s">&quot;Red&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sliceLogic</span><span class="p">()</span><span class="o">.</span><span class="n">GetBackgroundLayer</span><span class="p">()</span><span class="o">.</span><span class="n">GetVolumeNode</span><span class="p">()</span>
      <span class="n">imageData</span>     <span class="o">=</span> <span class="n">volumeNode</span><span class="o">.</span><span class="n">GetImageData</span><span class="p">()</span>
      <span class="n">spacing</span>       <span class="o">=</span> <span class="n">volumeNode</span><span class="o">.</span><span class="n">GetSpacing</span><span class="p">()</span>
      <span class="n">ijk</span>           <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">logic</span><span class="o">.</span><span class="n">ras2ijk</span><span class="p">(</span><span class="n">ras</span><span class="p">)</span>
      
      <span class="bp">self</span><span class="o">.</span><span class="n">logic</span><span class="o">.</span><span class="n">t0</span>         <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">clock</span><span class="p">()</span>
      <span class="n">slicer</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">NeedleFinderWidget</span><span class="o">.</span><span class="n">stepNeedle</span> <span class="o">+=</span> <span class="mi">1</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">logic</span><span class="o">.</span><span class="n">needleValidation</span><span class="p">(</span><span class="n">ijk</span><span class="p">,</span> <span class="n">imageData</span><span class="p">,</span> <span class="n">colorVar</span><span class="p">,</span><span class="n">spacing</span><span class="p">)</span>

    <span class="c"># if self.sliceWidgetsPerStyle.has_key(observee) and event == &quot;LeaveEvent&quot;:</span>
      <span class="c"># self.stop()</span>

</div>
<div class="viewcode-block" id="NeedleFinderWidget.processEventAddObturatorNeedleTips"><a class="viewcode-back" href="../NeedleFinder.html#NeedleFinder.NeedleFinderWidget.processEventAddObturatorNeedleTips">[docs]</a>  <span class="k">def</span> <span class="nf">processEventAddObturatorNeedleTips</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">observee</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the mouse clicks and create a fiducial node at this position. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#productive</span>
    <span class="k">if</span> <span class="n">profiling</span><span class="p">:</span> <span class="k">print</span> <span class="s">&quot;processEventAddObturatorNeedleTips&quot;</span><span class="p">;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sliceWidgetsPerStyle</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">observee</span><span class="p">)</span> <span class="ow">and</span> <span class="n">event</span> <span class="o">==</span> <span class="s">&quot;LeftButtonPressEvent&quot;</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">slicer</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">repositoryRevision</span><span class="o">&lt;=</span> <span class="mi">21022</span><span class="p">:</span>
        <span class="n">sliceWidget</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sliceWidgetsPerStyle</span><span class="p">[</span><span class="n">observee</span><span class="p">]</span>
        <span class="n">style</span>       <span class="o">=</span> <span class="n">sliceWidget</span><span class="o">.</span><span class="n">sliceView</span><span class="p">()</span><span class="o">.</span><span class="n">interactorStyle</span><span class="p">()</span>          
        <span class="n">xy</span>          <span class="o">=</span> <span class="n">style</span><span class="o">.</span><span class="n">GetInteractor</span><span class="p">()</span><span class="o">.</span><span class="n">GetEventPosition</span><span class="p">()</span>
        <span class="n">xyz</span>         <span class="o">=</span> <span class="n">sliceWidget</span><span class="o">.</span><span class="n">convertDeviceToXYZ</span><span class="p">(</span><span class="n">xy</span><span class="p">)</span>
        <span class="n">ras</span>         <span class="o">=</span> <span class="n">sliceWidget</span><span class="o">.</span><span class="n">convertXYZToRAS</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">sliceWidget</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sliceWidgetsPerStyle</span><span class="p">[</span><span class="n">observee</span><span class="p">]</span>
        <span class="n">sliceLogic</span>  <span class="o">=</span> <span class="n">sliceWidget</span><span class="o">.</span><span class="n">sliceLogic</span><span class="p">()</span>
        <span class="n">sliceNode</span>   <span class="o">=</span> <span class="n">sliceWidget</span><span class="o">.</span><span class="n">mrmlSliceNode</span><span class="p">()</span>
        <span class="n">interactor</span>  <span class="o">=</span> <span class="n">observee</span><span class="o">.</span><span class="n">GetInteractor</span><span class="p">()</span>
        <span class="n">xy</span>          <span class="o">=</span> <span class="n">interactor</span><span class="o">.</span><span class="n">GetEventPosition</span><span class="p">()</span>
        <span class="n">xyz</span>         <span class="o">=</span> <span class="n">sliceWidget</span><span class="o">.</span><span class="n">sliceView</span><span class="p">()</span><span class="o">.</span><span class="n">convertDeviceToXYZ</span><span class="p">(</span><span class="n">xy</span><span class="p">);</span>
        <span class="n">ras</span>         <span class="o">=</span> <span class="n">sliceWidget</span><span class="o">.</span><span class="n">sliceView</span><span class="p">()</span><span class="o">.</span><span class="n">convertXYZToRAS</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span>
      
      <span class="n">colorVar</span>      <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
      <span class="n">volumeNode</span>    <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">layoutManager</span><span class="p">()</span><span class="o">.</span><span class="n">sliceWidget</span><span class="p">(</span><span class="s">&quot;Red&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sliceLogic</span><span class="p">()</span><span class="o">.</span><span class="n">GetBackgroundLayer</span><span class="p">()</span><span class="o">.</span><span class="n">GetVolumeNode</span><span class="p">()</span>
      <span class="n">imageData</span>     <span class="o">=</span> <span class="n">volumeNode</span><span class="o">.</span><span class="n">GetImageData</span><span class="p">()</span>
      <span class="n">spacing</span>       <span class="o">=</span> <span class="n">volumeNode</span><span class="o">.</span><span class="n">GetSpacing</span><span class="p">()</span>
      <span class="n">ijk</span>           <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">logic</span><span class="o">.</span><span class="n">ras2ijk</span><span class="p">(</span><span class="n">ras</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">logic</span><span class="o">.</span><span class="n">t0</span>       <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">clock</span><span class="p">()</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">logic</span><span class="o">.</span><span class="n">obturatorNeedle</span><span class="p">(</span><span class="n">ijk</span><span class="p">,</span> <span class="n">imageData</span><span class="p">,</span> <span class="n">colorVar</span><span class="p">,</span><span class="n">spacing</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">logic</span><span class="o">.</span><span class="n">obtuNeedle</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sliceWidgetsPerStyle</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">observee</span><span class="p">)</span> <span class="ow">and</span> <span class="n">event</span> <span class="o">==</span> <span class="s">&quot;LeaveEvent&quot;</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="NeedleFinderWidget.processEventAddManualTips"><a class="viewcode-back" href="../NeedleFinder.html#NeedleFinder.NeedleFinderWidget.processEventAddManualTips">[docs]</a>  <span class="k">def</span> <span class="nf">processEventAddManualTips</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">observee</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the mouse clicks and create a fiducial node at this position. Used later for the fiducial registration</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">print</span> <span class="s">&quot;processEventAddManualTips&quot;</span>
    <span class="n">msgbox</span><span class="p">(</span><span class="s">&quot;processEventAddManualTips&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sliceWidgetsPerStyle</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">observee</span><span class="p">)</span> <span class="ow">and</span> <span class="n">event</span> <span class="o">==</span> <span class="s">&quot;LeftButtonPressEvent&quot;</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">slicer</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">repositoryRevision</span><span class="o">&lt;=</span> <span class="mi">21022</span><span class="p">:</span>
        <span class="n">sliceWidget</span>   <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sliceWidgetsPerStyle</span><span class="p">[</span><span class="n">observee</span><span class="p">]</span>
        <span class="n">style</span>         <span class="o">=</span> <span class="n">sliceWidget</span><span class="o">.</span><span class="n">sliceView</span><span class="p">()</span><span class="o">.</span><span class="n">interactorStyle</span><span class="p">()</span>          
        <span class="n">xy</span>            <span class="o">=</span> <span class="n">style</span><span class="o">.</span><span class="n">GetInteractor</span><span class="p">()</span><span class="o">.</span><span class="n">GetEventPosition</span><span class="p">()</span>
        <span class="n">xyz</span>           <span class="o">=</span> <span class="n">sliceWidget</span><span class="o">.</span><span class="n">convertDeviceToXYZ</span><span class="p">(</span><span class="n">xy</span><span class="p">)</span>
        <span class="n">ras</span>           <span class="o">=</span> <span class="n">sliceWidget</span><span class="o">.</span><span class="n">convertXYZToRAS</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">sliceWidget</span>   <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sliceWidgetsPerStyle</span><span class="p">[</span><span class="n">observee</span><span class="p">]</span>
        <span class="n">sliceLogic</span>    <span class="o">=</span> <span class="n">sliceWidget</span><span class="o">.</span><span class="n">sliceLogic</span><span class="p">()</span>
        <span class="n">sliceNode</span>     <span class="o">=</span> <span class="n">sliceWidget</span><span class="o">.</span><span class="n">mrmlSliceNode</span><span class="p">()</span>
        <span class="n">interactor</span>    <span class="o">=</span> <span class="n">observee</span><span class="o">.</span><span class="n">GetInteractor</span><span class="p">()</span>
        <span class="n">xy</span>            <span class="o">=</span> <span class="n">interactor</span><span class="o">.</span><span class="n">GetEventPosition</span><span class="p">()</span>
        <span class="n">xyz</span>           <span class="o">=</span> <span class="n">sliceWidget</span><span class="o">.</span><span class="n">sliceView</span><span class="p">()</span><span class="o">.</span><span class="n">convertDeviceToXYZ</span><span class="p">(</span><span class="n">xy</span><span class="p">);</span>
        <span class="n">ras</span>           <span class="o">=</span> <span class="n">sliceWidget</span><span class="o">.</span><span class="n">sliceView</span><span class="p">()</span><span class="o">.</span><span class="n">convertXYZToRAS</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span>
      
      <span class="n">volumeNode</span>      <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">layoutManager</span><span class="p">()</span><span class="o">.</span><span class="n">sliceWidget</span><span class="p">(</span><span class="s">&quot;Red&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sliceLogic</span><span class="p">()</span><span class="o">.</span><span class="n">GetBackgroundLayer</span><span class="p">()</span><span class="o">.</span><span class="n">GetVolumeNode</span><span class="p">()</span>
      <span class="n">imageData</span>       <span class="o">=</span> <span class="n">volumeNode</span><span class="o">.</span><span class="n">GetImageData</span><span class="p">()</span>
      <span class="n">spacing</span>         <span class="o">=</span> <span class="n">volumeNode</span><span class="o">.</span><span class="n">GetSpacing</span><span class="p">()</span>
      <span class="c"># ijk=self.ras2ijk(ras)</span>
      <span class="c"># self.t0=time.clock()</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">logic</span><span class="o">.</span><span class="n">addManualTip</span><span class="p">(</span><span class="n">ras</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="NeedleFinderWidget.onSave"><a class="viewcode-back" href="../NeedleFinder.html#NeedleFinder.NeedleFinderWidget.onSave">[docs]</a>  <span class="k">def</span> <span class="nf">onSave</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    show file dialog to save parameters</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#productive #onButton</span>
    <span class="k">if</span> <span class="n">profiling</span><span class="p">:</span> <span class="k">print</span> <span class="s">&quot;onSave&quot;</span><span class="p">;</span>
    
    <span class="bp">self</span><span class="o">.</span><span class="n">fileDialog</span> <span class="o">=</span> <span class="n">qt</span><span class="o">.</span><span class="n">QFileDialog</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fileDialog</span><span class="o">.</span><span class="n">setDirectory</span><span class="p">(</span><span class="n">slicer</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">needlefinder</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;NeedleFinder.py&quot;</span><span class="p">,</span><span class="s">&quot;Config&quot;</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fileDialog</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileDialog</span><span class="o">.</span><span class="n">DontUseNativeDialog</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fileDialog</span><span class="o">.</span><span class="n">acceptMode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileDialog</span><span class="o">.</span><span class="n">AcceptSave</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fileDialog</span><span class="o">.</span><span class="n">defaultSuffix</span> <span class="o">=</span> <span class="s">&quot;cfg&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fileDialog</span><span class="o">.</span><span class="n">setNameFilter</span><span class="p">(</span><span class="s">&quot;Configuration file (*.cfg)&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fileDialog</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&quot;fileSelected(QString)&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">saveFileSelected</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fileDialog</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="NeedleFinderWidget.saveFileSelected"><a class="viewcode-back" href="../NeedleFinder.html#NeedleFinder.NeedleFinderWidget.saveFileSelected">[docs]</a>  <span class="k">def</span> <span class="nf">saveFileSelected</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fileName</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    save parameters</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#productive #callback</span>
    <span class="k">if</span> <span class="n">profiling</span><span class="p">:</span> <span class="k">print</span> <span class="s">&quot;saveFileSelected&quot;</span><span class="p">;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">logic</span><span class="o">.</span><span class="n">saveParameters</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="NeedleFinderWidget.onLoad"><a class="viewcode-back" href="../NeedleFinder.html#NeedleFinder.NeedleFinderWidget.onLoad">[docs]</a>  <span class="k">def</span> <span class="nf">onLoad</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    show file dialogue to load parameter file</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#productive #onButton</span>
    <span class="k">if</span> <span class="n">profiling</span><span class="p">:</span> <span class="k">print</span> <span class="s">&quot;onLoad&quot;</span><span class="p">;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fileDialog</span> <span class="o">=</span> <span class="n">qt</span><span class="o">.</span><span class="n">QFileDialog</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fileDialog</span><span class="o">.</span><span class="n">setDirectory</span><span class="p">(</span><span class="n">slicer</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">needlefinder</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;NeedleFinder.py&quot;</span><span class="p">,</span><span class="s">&quot;Config&quot;</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fileDialog</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileDialog</span><span class="o">.</span><span class="n">DontUseNativeDialog</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fileDialog</span><span class="o">.</span><span class="n">acceptMode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileDialog</span><span class="o">.</span><span class="n">AcceptOpen</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fileDialog</span><span class="o">.</span><span class="n">defaultSuffix</span> <span class="o">=</span> <span class="s">&quot;cfg&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fileDialog</span><span class="o">.</span><span class="n">setNameFilter</span><span class="p">(</span><span class="s">&quot;Configuration File (*.cfg)&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fileDialog</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&quot;fileSelected(QString)&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">onLoadFileSelected</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fileDialog</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="NeedleFinderWidget.onLoadFileSelected"><a class="viewcode-back" href="../NeedleFinder.html#NeedleFinder.NeedleFinderWidget.onLoadFileSelected">[docs]</a>  <span class="k">def</span> <span class="nf">onLoadFileSelected</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fileName</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    load parameters</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#productive #callback</span>
    <span class="k">if</span> <span class="n">profiling</span><span class="p">:</span> <span class="k">print</span> <span class="s">&quot;onLoadFileSelected&quot;</span><span class="p">;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">logic</span><span class="o">.</span><span class="n">loadParameters</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="NeedleFinderWidget.onReset"><a class="viewcode-back" href="../NeedleFinder.html#NeedleFinder.NeedleFinderWidget.onReset">[docs]</a>  <span class="k">def</span> <span class="nf">onReset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    load default parameter file</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#productive</span>
    <span class="k">if</span> <span class="n">profiling</span><span class="p">:</span> <span class="k">print</span> <span class="s">&quot;onReset&quot;</span><span class="p">;</span>
    <span class="n">fileName</span> <span class="o">=</span> <span class="n">pathToScene</span> <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">needlefinder</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;NeedleFinder.py&quot;</span><span class="p">,</span><span class="s">&quot;Config/default.cfg&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">logic</span><span class="o">.</span><span class="n">loadParameters</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
</div></div>
<span class="sd">&quot;&quot;&quot;</span>

<span class="sd">########################################################################################################################</span>
<span class="sd">NEEDLEFINDER LOGIC</span>
<span class="sd">########################################################################################################################</span>

<span class="sd">&quot;&quot;&quot;</span>

<div class="viewcode-block" id="NeedleFinderLogic"><a class="viewcode-back" href="../NeedleFinder.html#NeedleFinder.NeedleFinderLogic">[docs]</a><span class="k">class</span> <span class="nc">NeedleFinderLogic</span><span class="p">:</span>
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  This class implements all the actual</span>
<span class="sd">  computation done by the module.  The interface</span>
<span class="sd">  is such that other python code can import</span>
<span class="sd">  this class and make use of the functionality without</span>
<span class="sd">  requiring an instance of the Widget</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="c">#productive</span>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    init&#39;s the class</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#productive</span>
    <span class="k">if</span> <span class="n">profiling</span><span class="p">:</span> <span class="k">print</span> <span class="s">&quot;NeedleFinderLogic __init__&quot;</span><span class="p">;</span>
    <span class="c"># initialisation of global variables</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">option</span>             <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setLabels</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color</span>              <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setColors</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span>           <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setColors255</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span>                  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setHolesCoordinates</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">t0</span>                 <span class="o">=</span> <span class="mi">0</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">obtuNeedle</span>         <span class="o">=</span> <span class="mi">0</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">row</span>                <span class="o">=</span> <span class="mi">0</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">round</span>              <span class="o">=</span> <span class="mi">1</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fiducialNode</span>       <span class="o">=</span> <span class="bp">None</span>
    <span class="c"># widget.stepNeedle         = 0</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ptNumber</span>           <span class="o">=</span> <span class="mi">0</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">table</span>              <span class="o">=</span> <span class="bp">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">view</span>               <span class="o">=</span> <span class="bp">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">contourNode</span>        <span class="o">=</span> <span class="bp">None</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">previousValues</span>         <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">tableValueCtrPt</span>        <span class="o">=</span> <span class="p">[[[</span><span class="mi">999</span><span class="p">,</span><span class="mi">999</span><span class="p">,</span><span class="mi">999</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">)]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">)]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">obtuNeedleValueCtrPt</span>   <span class="o">=</span> <span class="p">[[[</span><span class="mi">999</span><span class="p">,</span><span class="mi">999</span><span class="p">,</span><span class="mi">999</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">obtuNeedlePt</span>           <span class="o">=</span> <span class="p">[[[</span><span class="mi">999</span><span class="p">,</span><span class="mi">999</span><span class="p">,</span><span class="mi">999</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)]</span>
   
<div class="viewcode-block" id="NeedleFinderLogic.hasImageData"><a class="viewcode-back" href="../NeedleFinder.html#NeedleFinder.NeedleFinderLogic.hasImageData">[docs]</a>  <span class="k">def</span> <span class="nf">hasImageData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">volumeNode</span><span class="p">):</span>
    <span class="k">print</span> <span class="s">&quot;hasImageData&quot;</span>
    <span class="n">msgbox</span><span class="p">(</span><span class="s">&quot;hasImageData&quot;</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is a dummy logic method that</span>
<span class="sd">    returns true if the passed in volume</span>
<span class="sd">    node has valid image data</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">volumeNode</span><span class="p">:</span>
      <span class="k">print</span><span class="p">(</span><span class="s">&#39;no volume node&#39;</span><span class="p">)</span>
      <span class="k">return</span> <span class="bp">False</span>
    <span class="k">if</span> <span class="n">volumeNode</span><span class="o">.</span><span class="n">GetImageData</span><span class="p">()</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
      <span class="k">print</span><span class="p">(</span><span class="s">&#39;no image data&#39;</span><span class="p">)</span>
      <span class="k">return</span> <span class="bp">False</span>
    <span class="k">return</span> <span class="bp">True</span>
</div>
<div class="viewcode-block" id="NeedleFinderLogic.delayDisplay"><a class="viewcode-back" href="../NeedleFinder.html#NeedleFinder.NeedleFinderLogic.delayDisplay">[docs]</a>  <span class="k">def</span> <span class="nf">delayDisplay</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">message</span><span class="p">,</span><span class="n">msec</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
    <span class="k">print</span> <span class="s">&quot;delayDisplay&quot;</span>
    <span class="n">msgbox</span><span class="p">(</span><span class="s">&#39;hasImageData&#39;</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    logic version of delay display</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">print</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">qt</span><span class="o">.</span><span class="n">QDialog</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">infoLayout</span> <span class="o">=</span> <span class="n">qt</span><span class="o">.</span><span class="n">QVBoxLayout</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">setLayout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">infoLayout</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">qt</span><span class="o">.</span><span class="n">QLabel</span><span class="p">(</span><span class="n">message</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">infoLayout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
    <span class="n">qt</span><span class="o">.</span><span class="n">QTimer</span><span class="o">.</span><span class="n">singleShot</span><span class="p">(</span><span class="n">msec</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">exec_</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="NeedleFinderLogic.takeScreenshot"><a class="viewcode-back" href="../NeedleFinder.html#NeedleFinder.NeedleFinderLogic.takeScreenshot">[docs]</a>  <span class="k">def</span> <span class="nf">takeScreenshot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">description</span><span class="p">,</span><span class="nb">type</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
    <span class="k">print</span> <span class="s">&quot;takeScreenshot&quot;</span>
    <span class="n">msgbox</span><span class="p">(</span><span class="s">&#39;takeScreenshot&#39;</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    show the message even if not taking a screen shot</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">delayDisplay</span><span class="p">(</span><span class="n">description</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enableScreenshots</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
      <span class="k">return</span>

    <span class="n">lm</span> <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">layoutManager</span><span class="p">()</span>
    <span class="c"># switch on the type to get the requested window</span>
    <span class="n">widget</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
      <span class="c"># full window</span>
      <span class="n">widget</span> <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">mainWindow</span><span class="p">()</span>
    <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="n">slicer</span><span class="o">.</span><span class="n">qMRMLScreenShotDialog</span><span class="p">()</span><span class="o">.</span><span class="n">FullLayout</span><span class="p">:</span>
      <span class="c"># full layout</span>
      <span class="n">widget</span> <span class="o">=</span> <span class="n">lm</span><span class="o">.</span><span class="n">viewport</span><span class="p">()</span>
    <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="n">slicer</span><span class="o">.</span><span class="n">qMRMLScreenShotDialog</span><span class="p">()</span><span class="o">.</span><span class="n">ThreeD</span><span class="p">:</span>
      <span class="c"># just the 3D window</span>
      <span class="n">widget</span> <span class="o">=</span> <span class="n">lm</span><span class="o">.</span><span class="n">threeDWidget</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">threeDView</span><span class="p">()</span>
    <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="n">slicer</span><span class="o">.</span><span class="n">qMRMLScreenShotDialog</span><span class="p">()</span><span class="o">.</span><span class="n">Red</span><span class="p">:</span>
      <span class="c"># red slice window</span>
      <span class="n">widget</span> <span class="o">=</span> <span class="n">lm</span><span class="o">.</span><span class="n">sliceWidget</span><span class="p">(</span><span class="s">&quot;Red&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="n">slicer</span><span class="o">.</span><span class="n">qMRMLScreenShotDialog</span><span class="p">()</span><span class="o">.</span><span class="n">Yellow</span><span class="p">:</span>
      <span class="c"># yellow slice window</span>
      <span class="n">widget</span> <span class="o">=</span> <span class="n">lm</span><span class="o">.</span><span class="n">sliceWidget</span><span class="p">(</span><span class="s">&quot;Yellow&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="n">slicer</span><span class="o">.</span><span class="n">qMRMLScreenShotDialog</span><span class="p">()</span><span class="o">.</span><span class="n">Green</span><span class="p">:</span>
      <span class="c"># green slice window</span>
      <span class="n">widget</span> <span class="o">=</span> <span class="n">lm</span><span class="o">.</span><span class="n">sliceWidget</span><span class="p">(</span><span class="s">&quot;Green&quot;</span><span class="p">)</span>

    <span class="c"># grab and convert to vtk image data</span>
    <span class="n">qpixMap</span> <span class="o">=</span> <span class="n">qt</span><span class="o">.</span><span class="n">QPixmap</span><span class="p">()</span><span class="o">.</span><span class="n">grabWidget</span><span class="p">(</span><span class="n">widget</span><span class="p">)</span>
    <span class="n">qimage</span> <span class="o">=</span> <span class="n">qpixMap</span><span class="o">.</span><span class="n">toImage</span><span class="p">()</span>
    <span class="n">imageData</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkImageData</span><span class="p">()</span>
    <span class="n">slicer</span><span class="o">.</span><span class="n">qMRMLUtils</span><span class="p">()</span><span class="o">.</span><span class="n">qImageToVtkImageData</span><span class="p">(</span><span class="n">qimage</span><span class="p">,</span><span class="n">imageData</span><span class="p">)</span>

    <span class="n">annotationLogic</span> <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">annotations</span><span class="o">.</span><span class="n">logic</span><span class="p">()</span>
    <span class="n">annotationLogic</span><span class="o">.</span><span class="n">CreateSnapShot</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">screenshotScaleFactor</span><span class="p">,</span> <span class="n">imageData</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="NeedleFinderLogic.run"><a class="viewcode-back" href="../NeedleFinder.html#NeedleFinder.NeedleFinderLogic.run">[docs]</a>  <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">inputVolume</span><span class="p">,</span><span class="n">outputVolume</span><span class="p">,</span><span class="n">enableScreenshots</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">screenshotScaleFactor</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="k">print</span> <span class="s">&quot;run&quot;</span>
    <span class="n">msgbox</span><span class="p">(</span><span class="s">&#39;run&#39;</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run the actual algorithm</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">delayDisplay</span><span class="p">(</span><span class="s">&#39;Running the aglorithm&#39;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">enableScreenshots</span> <span class="o">=</span> <span class="n">enableScreenshots</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">screenshotScaleFactor</span> <span class="o">=</span> <span class="n">screenshotScaleFactor</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">takeScreenshot</span><span class="p">(</span><span class="s">&#39;NeedleFinder-Start&#39;</span><span class="p">,</span><span class="s">&#39;Start&#39;</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">True</span>
</div>
<div class="viewcode-block" id="NeedleFinderLogic.drawIsoSurfaces"><a class="viewcode-back" href="../NeedleFinder.html#NeedleFinder.NeedleFinderLogic.drawIsoSurfaces">[docs]</a>  <span class="k">def</span> <span class="nf">drawIsoSurfaces</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Draw isosurfaces from models of the visible needles only.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#productive</span>
    <span class="k">if</span> <span class="n">profiling</span><span class="p">:</span> <span class="k">print</span> <span class="s">&quot;drawIsoSurfaces&quot;</span><span class="p">;</span>

    <span class="n">slicer</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">NeedleFinderWidget</span><span class="o">.</span><span class="n">hideContourButton</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">modelNodes</span> <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">getNodes</span><span class="p">(</span><span class="s">&#39;vtkMRMLModelNode*&#39;</span><span class="p">)</span>
       
    <span class="n">v</span><span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkAppendPolyData</span><span class="p">()</span>
    <span class="n">canContinue</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">modelNode</span> <span class="ow">in</span> <span class="n">modelNodes</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
      <span class="k">print</span> <span class="s">&quot;for&quot;</span>
      <span class="k">if</span> <span class="n">modelNode</span><span class="o">.</span><span class="n">GetAttribute</span><span class="p">(</span><span class="s">&quot;nth&quot;</span><span class="p">)</span><span class="o">!=</span><span class="bp">None</span> <span class="ow">and</span> <span class="n">modelNode</span><span class="o">.</span><span class="n">GetDisplayVisibility</span><span class="p">()</span><span class="o">==</span><span class="mi">1</span> <span class="p">:</span>
        <span class="n">canContinue</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">v</span><span class="o">.</span><span class="n">AddInputData</span><span class="p">(</span><span class="n">modelNode</span><span class="o">.</span><span class="n">GetPolyData</span><span class="p">())</span>
       
    <span class="k">if</span> <span class="n">canContinue</span> <span class="o">==</span><span class="mi">1</span><span class="p">:</span>
      <span class="n">modeller</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkImplicitModeller</span><span class="p">()</span>
      <span class="n">modeller</span><span class="o">.</span><span class="n">SetInputConnection</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">GetOutputPort</span><span class="p">())</span>
      <span class="n">modeller</span><span class="o">.</span><span class="n">SetSampleDimensions</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span><span class="mi">60</span><span class="p">,</span><span class="mi">60</span><span class="p">)</span>
      <span class="n">modeller</span><span class="o">.</span><span class="n">SetCapping</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
      <span class="n">modeller</span><span class="o">.</span><span class="n">AdjustBoundsOn</span><span class="p">()</span>
      <span class="n">modeller</span><span class="o">.</span><span class="n">SetProcessModeToPerVoxel</span><span class="p">()</span> 
      <span class="n">modeller</span><span class="o">.</span><span class="n">SetAdjustDistance</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
      <span class="n">modeller</span><span class="o">.</span><span class="n">SetMaximumDistance</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
      <span class="n">modeller</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>
      
      <span class="n">contourFilter</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkContourFilter</span><span class="p">()</span>
      <span class="n">contourFilter</span><span class="o">.</span><span class="n">SetNumberOfContours</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
      <span class="n">contourFilter</span><span class="o">.</span><span class="n">SetInputConnection</span><span class="p">(</span><span class="n">modeller</span><span class="o">.</span><span class="n">GetOutputPort</span><span class="p">())</span>    
      <span class="n">contourFilter</span><span class="o">.</span><span class="n">ComputeNormalsOn</span><span class="p">()</span>
      <span class="n">contourFilter</span><span class="o">.</span><span class="n">ComputeScalarsOn</span><span class="p">()</span>
      <span class="n">contourFilter</span><span class="o">.</span><span class="n">UseScalarTreeOn</span><span class="p">()</span>
      <span class="n">contourFilter</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
      <span class="c"># contourFilter.SetValue(2,13)</span>
      <span class="c"># contourFilter.SetValue(3,15)</span>
      <span class="c"># contourFilter.SetValue(4,20)</span>
      <span class="c"># contourFilter.SetValue(5,25)</span>
      <span class="n">contourFilter</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>
      <span class="n">isoSurface</span> <span class="o">=</span> <span class="n">contourFilter</span><span class="o">.</span><span class="n">GetOutputDataObject</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

      <span class="bp">self</span><span class="o">.</span><span class="n">AddContour</span><span class="p">(</span><span class="n">isoSurface</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="NeedleFinderLogic.hideIsoSurfaces"><a class="viewcode-back" href="../NeedleFinder.html#NeedleFinder.NeedleFinderLogic.hideIsoSurfaces">[docs]</a>  <span class="k">def</span> <span class="nf">hideIsoSurfaces</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Hide isosurfaces from models of the visible needles only</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#productive</span>
    <span class="k">if</span> <span class="n">profiling</span><span class="p">:</span> <span class="k">print</span> <span class="s">&quot;hideIsoSurfaces&quot;</span><span class="p">;</span>
    <span class="n">contourNode</span> <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">getNode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">contourNode</span><span class="p">)</span>
    <span class="n">widget</span> <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">NeedleFinderWidget</span>
    <span class="k">if</span> <span class="n">contourNode</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">contourNode</span><span class="o">.</span><span class="n">SetDisplayVisibility</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">widget</span><span class="o">.</span><span class="n">hideContourButton</span><span class="o">.</span><span class="n">isChecked</span><span class="p">()</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
      <span class="n">contourNode</span><span class="o">.</span><span class="n">GetModelDisplayNode</span><span class="p">()</span><span class="o">.</span><span class="n">SetSliceIntersectionVisibility</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">widget</span><span class="o">.</span><span class="n">hideContourButton</span><span class="o">.</span><span class="n">isChecked</span><span class="p">()</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="NeedleFinderLogic.displayNeedleTube"><a class="viewcode-back" href="../NeedleFinder.html#NeedleFinder.NeedleFinderLogic.displayNeedleTube">[docs]</a>  <span class="k">def</span> <span class="nf">displayNeedleTube</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">ID</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    from segmentation report, show/hide needle tube</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#productive #onButton #report</span>
    <span class="k">if</span> <span class="n">profiling</span><span class="p">:</span> <span class="k">print</span> <span class="s">&quot;displayNeedleTube&quot;</span><span class="p">;</span>
    <span class="n">modelNode</span> <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">getNode</span><span class="p">(</span><span class="s">&#39;vtkMRMLModelNode&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ID</span><span class="p">))</span>
    <span class="n">displayNode</span> <span class="o">=</span> <span class="n">modelNode</span><span class="o">.</span><span class="n">GetModelDisplayNode</span><span class="p">()</span>
    <span class="n">nVisibility</span> <span class="o">=</span> <span class="n">displayNode</span><span class="o">.</span><span class="n">GetVisibility</span><span class="p">()</span>
    <span class="c"># print nVisibility</span>
    <span class="k">if</span> <span class="n">nVisibility</span><span class="p">:</span>
      <span class="n">displayNode</span><span class="o">.</span><span class="n">SliceIntersectionVisibilityOff</span><span class="p">()</span>
      <span class="n">displayNode</span><span class="o">.</span><span class="n">SetVisibility</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">displayNode</span><span class="o">.</span><span class="n">SliceIntersectionVisibilityOn</span><span class="p">()</span>
      <span class="n">displayNode</span><span class="o">.</span><span class="n">SetVisibility</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="NeedleFinderLogic.reformatSagittalView4Needle"><a class="viewcode-back" href="../NeedleFinder.html#NeedleFinder.NeedleFinderLogic.reformatSagittalView4Needle">[docs]</a>  <span class="k">def</span> <span class="nf">reformatSagittalView4Needle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">ID</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    reformat sagittal view to be tangent to needle and display a 3D plane</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#productive #onButton #report</span>
    <span class="k">if</span> <span class="n">profiling</span><span class="p">:</span> <span class="k">print</span> <span class="s">&quot;reformatSagittalView4Needle&quot;</span><span class="p">;</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>  
      <span class="n">modelNode</span> <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">getNode</span><span class="p">(</span><span class="s">&#39;vtkMRMLModelNode&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ID</span><span class="p">))</span>
      <span class="n">polyData</span> <span class="o">=</span> <span class="n">modelNode</span><span class="o">.</span><span class="n">GetPolyData</span><span class="p">()</span>
      <span class="n">nb</span> <span class="o">=</span> <span class="n">polyData</span><span class="o">.</span><span class="n">GetNumberOfPoints</span><span class="p">()</span>
      <span class="n">base</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
      <span class="n">tip</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
      <span class="n">polyData</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="n">nb</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">tip</span><span class="p">)</span>
      <span class="n">polyData</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">base</span><span class="p">)</span>
      <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span> <span class="o">=</span> <span class="n">tip</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">base</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">tip</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">base</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">tip</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">base</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
      
      <span class="n">sYellow</span> <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">mrmlScene</span><span class="o">.</span><span class="n">GetNodeByID</span><span class="p">(</span><span class="s">&quot;vtkMRMLSliceNodeYellow&quot;</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">sYellow</span> <span class="o">==</span><span class="bp">None</span> <span class="p">:</span>
        <span class="n">sYellow</span> <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">mrmlScene</span><span class="o">.</span><span class="n">GetNodeByID</span><span class="p">(</span><span class="s">&quot;vtkMRMLSliceNode2&quot;</span><span class="p">)</span>        
      <span class="n">reformatLogic</span> <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">vtkSlicerReformatLogic</span><span class="p">()</span>
      <span class="n">sYellow</span><span class="o">.</span><span class="n">SetSliceVisible</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
      <span class="n">reformatLogic</span><span class="o">.</span><span class="n">SetSliceNormal</span><span class="p">(</span><span class="n">sYellow</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="n">a</span><span class="o">/</span><span class="n">b</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
      <span class="n">m</span><span class="o">=</span> <span class="n">sYellow</span><span class="o">.</span><span class="n">GetSliceToRAS</span><span class="p">()</span>
      <span class="n">m</span><span class="o">.</span><span class="n">SetElement</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">base</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
      <span class="n">m</span><span class="o">.</span><span class="n">SetElement</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">base</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
      <span class="n">m</span><span class="o">.</span><span class="n">SetElement</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">base</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
      <span class="n">sYellow</span><span class="o">.</span><span class="n">Modified</span><span class="p">()</span>
                 </div>
<div class="viewcode-block" id="NeedleFinderLogic.findLabelNeedleID"><a class="viewcode-back" href="../NeedleFinder.html#NeedleFinder.NeedleFinderLogic.findLabelNeedleID">[docs]</a>  <span class="k">def</span> <span class="nf">findLabelNeedleID</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">ID</span><span class="p">):</span>
    <span class="k">print</span> <span class="s">&quot;findLabelNeedleID&quot;</span>
    <span class="n">msgbox</span><span class="p">(</span><span class="s">&#39;findLabelNeedleID&#39;</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Takes the needle (vtkMRMLModelNode) with the right ID</span>
<span class="sd">    Evaluates the z-position of every 20 points of the vtkPolyData</span>
<span class="sd">    Takes the closest one to the surface of the template holes</span>
<span class="sd">    Find the closest hole to the needle and assign the label to the needle </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">volumeNode</span> <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">layoutManager</span><span class="p">()</span><span class="o">.</span><span class="n">sliceWidget</span><span class="p">(</span><span class="s">&quot;Red&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sliceLogic</span><span class="p">()</span><span class="o">.</span><span class="n">GetBackgroundLayer</span><span class="p">()</span><span class="o">.</span><span class="n">GetVolumeNode</span><span class="p">()</span>
    <span class="n">imageData</span> <span class="o">=</span> <span class="n">volumeNode</span><span class="o">.</span><span class="n">GetImageData</span><span class="p">()</span>
    <span class="n">imageDimensions</span> <span class="o">=</span> <span class="n">imageData</span><span class="o">.</span><span class="n">GetDimensions</span><span class="p">()</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkMatrix4x4</span><span class="p">()</span>
    <span class="n">minZ</span><span class="o">=</span><span class="bp">None</span>
    <span class="n">mindist</span><span class="o">=</span><span class="bp">None</span>
    <span class="n">volumeNode</span><span class="o">.</span><span class="n">GetIJKToRASMatrix</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
    <span class="n">Z</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">GetElement</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">needleNode</span> <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">mrmlScene</span><span class="o">.</span><span class="n">GetNodeByID</span><span class="p">(</span><span class="n">ID</span><span class="p">)</span>
    <span class="n">polydata</span> <span class="o">=</span> <span class="n">needleNode</span><span class="o">.</span><span class="n">GetPolyData</span><span class="p">()</span>
    <span class="n">nb</span> <span class="o">=</span> <span class="n">polydata</span><span class="o">.</span><span class="n">GetNumberOfPoints</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nb</span><span class="p">):</span>
      <span class="k">if</span> <span class="mi">20</span><span class="o">*</span><span class="n">i</span><span class="o">&lt;</span><span class="n">nb</span><span class="p">:</span>
        <span class="n">pt</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">polydata</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="mi">20</span><span class="o">*</span><span class="n">i</span><span class="p">,</span><span class="n">pt</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pt</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">Z</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">&lt;</span><span class="n">minZ</span> <span class="ow">or</span> <span class="n">minZ</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
          <span class="n">minZ</span> <span class="o">=</span> <span class="p">(</span><span class="n">pt</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">Z</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
          <span class="n">bestNB</span> <span class="o">=</span> <span class="mi">20</span><span class="o">*</span><span class="n">i</span>
    <span class="n">hole</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setNeedleCoordinates</span><span class="p">()</span>
    <span class="c">#print bestNB</span>
    <span class="n">A</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">polydata</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="n">bestNB</span><span class="p">,</span><span class="n">A</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">63</span><span class="p">):</span>
      <span class="n">delta</span> <span class="o">=</span> <span class="p">((</span><span class="n">hole</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">-</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">hole</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">-</span><span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">delta</span> <span class="o">&lt;</span> <span class="n">mindist</span> <span class="ow">or</span> <span class="n">mindist</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">bestmatch</span> <span class="o">=</span> <span class="n">j</span>
        <span class="n">mindist</span> <span class="o">=</span> <span class="n">delta</span>
        
    <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">bestmatch</span><span class="p">,</span><span class="n">mindist</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">result</span>
</div>
<div class="viewcode-block" id="NeedleFinderLogic.computerPolydataAndMatrix"><a class="viewcode-back" href="../NeedleFinder.html#NeedleFinder.NeedleFinderLogic.computerPolydataAndMatrix">[docs]</a>  <span class="k">def</span> <span class="nf">computerPolydataAndMatrix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">print</span> <span class="s">&quot;computerPolydataAndMatrix&quot;</span>
    <span class="n">msgbox</span><span class="p">(</span><span class="s">&#39;computerPolydataAndMatrix&#39;</span><span class="p">)</span>
    <span class="n">Cylinder</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkCylinderSource</span><span class="p">()</span>

    <span class="n">Cylinder</span><span class="o">.</span><span class="n">SetResolution</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
    <span class="n">Cylinder</span><span class="o">.</span><span class="n">SetCapping</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> 
    <span class="n">Cylinder</span><span class="o">.</span><span class="n">SetHeight</span><span class="p">(</span> <span class="nb">float</span><span class="p">(</span><span class="mf">200.0</span><span class="p">)</span> <span class="p">)</span>
    <span class="n">Cylinder</span><span class="o">.</span><span class="n">SetRadius</span><span class="p">(</span> <span class="nb">float</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span> <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">m_polyCylinder</span><span class="o">=</span><span class="n">Cylinder</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span>
    
    <span class="n">quad</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkQuadric</span><span class="p">()</span>
    <span class="n">quad</span><span class="o">.</span><span class="n">SetCoefficients</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">sample</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkSampleFunction</span><span class="p">()</span>
    <span class="n">sample</span><span class="o">.</span><span class="n">SetModelBounds</span><span class="p">(</span><span class="o">-</span><span class="mi">30</span><span class="p">,</span><span class="mi">30</span><span class="p">,</span><span class="o">-</span><span class="mi">60</span><span class="p">,</span><span class="mi">60</span><span class="p">,</span><span class="o">-</span><span class="mi">30</span><span class="p">,</span><span class="mi">30</span><span class="p">)</span>
    <span class="n">sample</span><span class="o">.</span><span class="n">SetCapping</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">sample</span><span class="o">.</span><span class="n">SetComputeNormals</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">sample</span><span class="o">.</span><span class="n">SetSampleDimensions</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span><span class="mi">50</span><span class="p">,</span><span class="mi">50</span><span class="p">)</span>
    <span class="n">sample</span><span class="o">.</span><span class="n">SetImplicitFunction</span><span class="p">(</span><span class="n">quad</span><span class="p">)</span>
    <span class="n">contour</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkContourFilter</span><span class="p">()</span>
    <span class="n">contour</span><span class="o">.</span><span class="n">SetInputConnection</span><span class="p">(</span><span class="n">sample</span><span class="o">.</span><span class="n">GetOutputPort</span><span class="p">())</span>
    <span class="n">contour</span><span class="o">.</span><span class="n">ComputeNormalsOn</span><span class="p">()</span>
    <span class="n">contour</span><span class="o">.</span><span class="n">ComputeScalarsOn</span><span class="p">()</span>
    <span class="n">contour</span><span class="o">.</span><span class="n">GenerateValues</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">100</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">m_polyRadiation</span> <span class="o">=</span> <span class="n">contour</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">m_vtkmat</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkMatrix4x4</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">m_vtkmat</span><span class="o">.</span><span class="n">Identity</span><span class="p">()</span>

    <span class="n">RestruMatrix</span><span class="o">=</span><span class="n">vtk</span><span class="o">.</span><span class="n">vtkMatrix4x4</span><span class="p">()</span>
    <span class="n">WorldMatrix</span><span class="o">=</span><span class="n">vtk</span><span class="o">.</span><span class="n">vtkMatrix4x4</span><span class="p">()</span>
    <span class="n">Restru2WorldMatrix</span><span class="o">=</span><span class="n">vtk</span><span class="o">.</span><span class="n">vtkMatrix4x4</span><span class="p">()</span>

    <span class="n">RestruMatrix</span><span class="o">.</span><span class="n">SetElement</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">RestruMatrix</span><span class="o">.</span><span class="n">SetElement</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">RestruMatrix</span><span class="o">.</span><span class="n">SetElement</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">RestruMatrix</span><span class="o">.</span><span class="n">SetElement</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">RestruMatrix</span><span class="o">.</span><span class="n">SetElement</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">RestruMatrix</span><span class="o">.</span><span class="n">SetElement</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">RestruMatrix</span><span class="o">.</span><span class="n">SetElement</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">RestruMatrix</span><span class="o">.</span><span class="n">SetElement</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">RestruMatrix</span><span class="o">.</span><span class="n">SetElement</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">RestruMatrix</span><span class="o">.</span><span class="n">SetElement</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">RestruMatrix</span><span class="o">.</span><span class="n">SetElement</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">RestruMatrix</span><span class="o">.</span><span class="n">SetElement</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">RestruMatrix</span><span class="o">.</span><span class="n">SetElement</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">RestruMatrix</span><span class="o">.</span><span class="n">SetElement</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">RestruMatrix</span><span class="o">.</span><span class="n">SetElement</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">RestruMatrix</span><span class="o">.</span><span class="n">SetElement</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">WorldMatrix</span><span class="o">.</span><span class="n">SetElement</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">WorldMatrix</span><span class="o">.</span><span class="n">SetElement</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">WorldMatrix</span><span class="o">.</span><span class="n">SetElement</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">WorldMatrix</span><span class="o">.</span><span class="n">SetElement</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">WorldMatrix</span><span class="o">.</span><span class="n">SetElement</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">WorldMatrix</span><span class="o">.</span><span class="n">SetElement</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">WorldMatrix</span><span class="o">.</span><span class="n">SetElement</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">WorldMatrix</span><span class="o">.</span><span class="n">SetElement</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">WorldMatrix</span><span class="o">.</span><span class="n">SetElement</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">WorldMatrix</span><span class="o">.</span><span class="n">SetElement</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">WorldMatrix</span><span class="o">.</span><span class="n">SetElement</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">WorldMatrix</span><span class="o">.</span><span class="n">SetElement</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">WorldMatrix</span><span class="o">.</span><span class="n">SetElement</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">WorldMatrix</span><span class="o">.</span><span class="n">SetElement</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">WorldMatrix</span><span class="o">.</span><span class="n">SetElement</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">WorldMatrix</span><span class="o">.</span><span class="n">SetElement</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">WorldMatrix</span><span class="o">.</span><span class="n">Invert</span><span class="p">()</span>
    <span class="n">Restru2WorldMatrix</span><span class="o">.</span><span class="n">Multiply4x4</span><span class="p">(</span><span class="n">RestruMatrix</span><span class="p">,</span><span class="n">WorldMatrix</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">m_vtkmat</span><span class="p">)</span>
  </div>
<div class="viewcode-block" id="NeedleFinderLogic.AddContour"><a class="viewcode-back" href="../NeedleFinder.html#NeedleFinder.NeedleFinderLogic.AddContour">[docs]</a>  <span class="k">def</span> <span class="nf">AddContour</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">polyData</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add caculated isosurfaces (self.drawIsoSurfaces) around visible needles to the scene</span>
<span class="sd">    and add opacity, color...</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#productive</span>
    <span class="c"># called by drawIsoSurfaces</span>
    <span class="k">if</span> <span class="n">profiling</span><span class="p">:</span> <span class="k">print</span> <span class="s">&quot;AddContour&quot;</span><span class="p">;</span>
    <span class="c"># print polyData</span>
    <span class="n">scene</span> <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">mrmlScene</span>
    <span class="n">modelNodes</span> <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">getNodes</span><span class="p">(</span><span class="s">&#39;vtkMRMLModelNode*&#39;</span><span class="p">)</span>
    <span class="c">#??? i suppose here is a bug:</span>
    <span class="k">print</span> <span class="s">&#39;modelNodes: &#39;</span><span class="p">,</span><span class="n">modelNodes</span>
    <span class="k">print</span> <span class="s">&#39;self.ContourNode: &#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">contourNode</span>
    <span class="c">#!!! self.contourNode is None</span>
    
    <span class="c">#bugfix&gt;&gt;&gt;&gt;</span>
    <span class="n">modelNode</span> <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">vtkMRMLModelNode</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">contourNode</span> <span class="o">=</span> <span class="n">modelNode</span><span class="o">.</span><span class="n">GetID</span><span class="p">()</span>
    <span class="k">print</span> <span class="s">&#39;self.ContourNode: &#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">contourNode</span> 
    <span class="c">#&lt;&lt;&lt;bugfix</span>
    
    <span class="n">contourNode</span> <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">getNode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">contourNode</span><span class="p">)</span>
    <span class="k">print</span> <span class="s">&#39;contourNode: &#39;</span><span class="p">,</span><span class="n">contourNode</span>
    <span class="k">if</span> <span class="n">contourNode</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">slicer</span><span class="o">.</span><span class="n">mrmlScene</span><span class="o">.</span><span class="n">RemoveNode</span><span class="p">(</span><span class="n">contourNode</span><span class="o">.</span><span class="n">GetStorageNode</span><span class="p">())</span>
      <span class="n">contourNode</span><span class="o">.</span><span class="n">RemoveAllDisplayNodeIDs</span><span class="p">()</span>
      <span class="n">slicer</span><span class="o">.</span><span class="n">mrmlScene</span><span class="o">.</span><span class="n">RemoveNode</span><span class="p">(</span><span class="n">contourNode</span><span class="p">)</span>
      
    <span class="c">#modelNode = slicer.vtkMRMLModelNode()</span>
    <span class="n">modelNode</span><span class="o">.</span><span class="n">SetScene</span><span class="p">(</span><span class="n">scene</span><span class="p">)</span>
    <span class="n">modelNode</span><span class="o">.</span><span class="n">SetAndObservePolyData</span><span class="p">(</span><span class="n">polyData</span><span class="p">)</span>
    <span class="c"># display node</span>
    <span class="n">displayNode</span> <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">vtkMRMLModelDisplayNode</span><span class="p">()</span>
 
    <span class="n">modelNode</span><span class="o">.</span><span class="n">SetName</span><span class="p">(</span><span class="s">&#39;Contours&#39;</span><span class="p">)</span>
    
    <span class="n">scene</span><span class="o">.</span><span class="n">AddNode</span><span class="p">(</span><span class="n">displayNode</span><span class="p">)</span>
    <span class="n">scene</span><span class="o">.</span><span class="n">AddNode</span><span class="p">(</span><span class="n">modelNode</span><span class="p">)</span>
     
    <span class="n">displayNode</span><span class="o">.</span><span class="n">SetVisibility</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">displayNode</span><span class="o">.</span><span class="n">SetOpacity</span><span class="p">(</span><span class="mf">0.06</span><span class="p">)</span>
    <span class="n">displayNode</span><span class="o">.</span><span class="n">SetSliceIntersectionVisibility</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">displayNode</span><span class="o">.</span><span class="n">SetScalarVisibility</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">displayNode</span><span class="o">.</span><span class="n">SetActiveScalarName</span><span class="p">(</span><span class="s">&#39;ImageScalars&#39;</span><span class="p">)</span> 
    <span class="n">displayNode</span><span class="o">.</span><span class="n">SetAndObserveColorNodeID</span><span class="p">(</span><span class="s">&#39;vtkMRMLColorTableNodeFileHotToColdRainbow2.txt&#39;</span><span class="p">)</span>
    <span class="n">displayNode</span><span class="o">.</span><span class="n">SetScalarRange</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">40</span><span class="p">)</span>
    <span class="n">displayNode</span><span class="o">.</span><span class="n">SetBackfaceCulling</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">displayNode</span><span class="o">.</span><span class="n">SetScene</span><span class="p">(</span><span class="n">scene</span><span class="p">)</span>
    <span class="n">scene</span><span class="o">.</span><span class="n">AddNode</span><span class="p">(</span><span class="n">displayNode</span><span class="p">)</span>
    <span class="n">modelNode</span><span class="o">.</span><span class="n">SetAndObserveDisplayNodeID</span><span class="p">(</span><span class="n">displayNode</span><span class="o">.</span><span class="n">GetID</span><span class="p">())</span>
    <span class="c"># add to scene</span>
    <span class="n">displayNode</span><span class="o">.</span><span class="n">SetInputPolyData</span><span class="p">(</span><span class="n">modelNode</span><span class="o">.</span><span class="n">GetPolyData</span><span class="p">())</span>
    <span class="n">scene</span><span class="o">.</span><span class="n">AddNode</span><span class="p">(</span><span class="n">modelNode</span><span class="p">)</span>

    <span class="c">#self.contourNode = modelNode.GetID()</span>

    <span class="n">qt</span><span class="o">.</span><span class="n">QApplication</span><span class="o">.</span><span class="n">processEvents</span><span class="p">()</span>

  <span class="c">#----------------------------------------------------------------------------------------------</span></div>
  <span class="sd">&quot;&quot;&quot; Needle Detection&quot;&quot;&quot;</span>
  <span class="c">#----------------------------------------------------------------------------------------------</span>

<div class="viewcode-block" id="NeedleFinderLogic.array2"><a class="viewcode-back" href="../NeedleFinder.html#NeedleFinder.NeedleFinderLogic.array2">[docs]</a>  <span class="k">def</span> <span class="nf">array2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">print</span> <span class="s">&quot;array2&quot;</span>
    <span class="n">msgbox</span><span class="p">(</span><span class="s">&#39;array2&#39;</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Used if needle tips input is given trough a labelmap.</span>
<span class="sd">    Extract the coordinates of each labels (after IslandEffect)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">inputLabelID</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__needleLabelSelector</span><span class="o">.</span><span class="n">currentNode</span><span class="p">()</span><span class="o">.</span><span class="n">GetID</span><span class="p">()</span>
    <span class="n">labelnode</span><span class="o">=</span><span class="n">slicer</span><span class="o">.</span><span class="n">mrmlScene</span><span class="o">.</span><span class="n">GetNodeByID</span><span class="p">(</span><span class="n">inputLabelID</span><span class="p">)</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">labelnode</span><span class="o">.</span><span class="n">GetImageData</span><span class="p">()</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">GetDimensions</span><span class="p">())</span>
    <span class="n">shape</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">numpy_support</span><span class="o">.</span><span class="n">vtk_to_numpy</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">GetScalars</span><span class="p">())</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">labels</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">val</span><span class="o">=</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">a</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
      <span class="n">w</span> <span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">a</span><span class="o">==</span><span class="n">i</span><span class="p">))</span>
      <span class="c"># labels.append(w.mean(axis=0))</span>
      <span class="n">val</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
      <span class="n">val</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">w</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">))][</span><span class="mi">2</span><span class="p">]</span>
      <span class="n">val</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">w</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">))][</span><span class="mi">1</span><span class="p">]</span>
      <span class="n">val</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">w</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">))][</span><span class="mi">0</span><span class="p">]</span>
      <span class="k">if</span> <span class="n">val</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">previousValues</span><span class="p">:</span>
        <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">previousValues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">labels</span>
</div>
<div class="viewcode-block" id="NeedleFinderLogic.factorial"><a class="viewcode-back" href="../NeedleFinder.html#NeedleFinder.NeedleFinderLogic.factorial">[docs]</a>  <span class="k">def</span> <span class="nf">factorial</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">n</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    factorial(n): return the factorial of the integer n.</span>
<span class="sd">    factorial(0) = 1</span>
<span class="sd">    factorial(n) with n&lt;0 is -factorial(abs(n))</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#productive #frequent #math</span>
    <span class="k">if</span> <span class="n">profiling</span> <span class="ow">and</span> <span class="n">frequent</span><span class="p">:</span> <span class="k">print</span> <span class="s">&quot;factorial&quot;</span><span class="p">;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">abs</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
     <span class="n">result</span> <span class="o">*=</span> <span class="n">i</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">result</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">return</span> <span class="o">-</span><span class="n">result</span>
      </div>
<div class="viewcode-block" id="NeedleFinderLogic.binomial"><a class="viewcode-back" href="../NeedleFinder.html#NeedleFinder.NeedleFinderLogic.binomial">[docs]</a>  <span class="k">def</span> <span class="nf">binomial</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">n</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    calc&#39;s binomial coefficient</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#productive #frequent #math</span>
    <span class="k">if</span> <span class="n">profiling</span> <span class="ow">and</span> <span class="n">frequent</span><span class="p">:</span> <span class="k">print</span> <span class="s">&quot;binomial&quot;</span><span class="p">;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">k</span> <span class="o">&lt;=</span> <span class="n">n</span><span class="p">:</span>
      <span class="k">return</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">k</span> <span class="o">==</span> <span class="n">n</span><span class="p">:</span>
      <span class="k">return</span> <span class="mi">1</span>
    <span class="c"># calculate n!/k! as one product, avoiding factors that </span>
    <span class="c"># just get canceled</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">k</span><span class="o">+</span><span class="mi">1</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
      <span class="n">P</span> <span class="o">*=</span> <span class="n">i</span>
    <span class="c"># if you are paranoid:</span>
    <span class="c"># C, rem = divmod(P, factorial(n-k))</span>
    <span class="c"># assert rem == 0</span>
    <span class="c"># return C</span>
    <span class="k">return</span> <span class="n">P</span><span class="o">//</span><span class="bp">self</span><span class="o">.</span><span class="n">factorial</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="n">k</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="NeedleFinderLogic.Fibonacci"><a class="viewcode-back" href="../NeedleFinder.html#NeedleFinder.NeedleFinderLogic.Fibonacci">[docs]</a>  <span class="k">def</span> <span class="nf">Fibonacci</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">n</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    calc&#39;s Fibonacci #</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#productive #frequent #math</span>
    <span class="k">if</span> <span class="n">profiling</span> <span class="ow">and</span> <span class="n">frequent</span><span class="p">:</span> <span class="k">print</span> <span class="s">&quot;Fibonacci&quot;</span><span class="p">;</span>
    <span class="n">F</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
      <span class="n">F</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">F</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">F</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">F</span>
</div>
<div class="viewcode-block" id="NeedleFinderLogic.stepSize"><a class="viewcode-back" href="../NeedleFinder.html#NeedleFinder.NeedleFinderLogic.stepSize">[docs]</a>  <span class="k">def</span> <span class="nf">stepSize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">l</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The size of the step depends on:</span>
<span class="sd">    - the length of the needle</span>
<span class="sd">    - how many control points per needle </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#productive</span>
    <span class="n">F</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Fibonacci</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
    <span class="n">s</span> <span class="o">=</span><span class="n">F</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Fibonacci</span><span class="p">(</span><span class="n">l</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">s</span>
</div>
<div class="viewcode-block" id="NeedleFinderLogic.sortTable"><a class="viewcode-back" href="../NeedleFinder.html#NeedleFinder.NeedleFinderLogic.sortTable">[docs]</a>  <span class="k">def</span> <span class="nf">sortTable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">cols</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">    sort a table by multiple columns</span>
<span class="sd">        table: a list of lists (or tuple of tuples) where each inner list </span>
<span class="sd">               represents a row</span>
<span class="sd">        cols:  a list (or tuple) specifying the column numbers to sort by</span>
<span class="sd">               e.g. (1,0) would sort by column 1, then by column 0</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#productive</span>
    <span class="k">if</span> <span class="n">profiling</span><span class="p">:</span> <span class="k">print</span> <span class="s">&quot;sortTable&quot;</span><span class="p">;</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">cols</span><span class="p">):</span>
      <span class="n">table</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">operator</span><span class="o">.</span><span class="n">itemgetter</span><span class="p">(</span><span class="n">col</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">table</span>
</div>
<div class="viewcode-block" id="NeedleFinderLogic.sortTableReverse"><a class="viewcode-back" href="../NeedleFinder.html#NeedleFinder.NeedleFinderLogic.sortTableReverse">[docs]</a>  <span class="k">def</span> <span class="nf">sortTableReverse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">cols</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">    sort a table by multiple columns</span>
<span class="sd">        table: a list of lists (or tuple of tuples) where each inner list </span>
<span class="sd">               represents a row</span>
<span class="sd">        cols:  a list (or tuple) specifying the column numbers to sort by</span>
<span class="sd">               e.g. (1,0) would sort by column 1, then by column 0</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#productive</span>
    <span class="k">if</span> <span class="n">profiling</span><span class="p">:</span> <span class="k">print</span> <span class="s">&quot;sortTableReverse&quot;</span><span class="p">;</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">cols</span><span class="p">):</span>
      <span class="n">table</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">operator</span><span class="o">.</span><span class="n">itemgetter</span><span class="p">(</span><span class="n">col</span><span class="p">),</span> <span class="n">reverse</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">table</span>
</div>
<div class="viewcode-block" id="NeedleFinderLogic.ijk2ras"><a class="viewcode-back" href="../NeedleFinder.html#NeedleFinder.NeedleFinderLogic.ijk2ras">[docs]</a>  <span class="k">def</span> <span class="nf">ijk2ras</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">A</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert IJK coordinates to RAS coordinates. The transformation matrix is the one </span>
<span class="sd">    of the active volume on the red slice</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#productive #math #coordinate-space-conversion</span>
    <span class="k">if</span> <span class="n">profiling</span><span class="p">:</span> <span class="k">print</span> <span class="s">&quot;ijk2ras&quot;</span><span class="p">;</span>
    <span class="n">m</span><span class="o">=</span><span class="n">vtk</span><span class="o">.</span><span class="n">vtkMatrix4x4</span><span class="p">()</span>
    <span class="n">volumeNode</span> <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">layoutManager</span><span class="p">()</span><span class="o">.</span><span class="n">sliceWidget</span><span class="p">(</span><span class="s">&quot;Red&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sliceLogic</span><span class="p">()</span><span class="o">.</span><span class="n">GetBackgroundLayer</span><span class="p">()</span><span class="o">.</span><span class="n">GetVolumeNode</span><span class="p">()</span>
    <span class="n">volumeNode</span><span class="o">.</span><span class="n">GetIJKToRASMatrix</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
    <span class="n">imageData</span> <span class="o">=</span> <span class="n">volumeNode</span><span class="o">.</span><span class="n">GetImageData</span><span class="p">()</span>
    <span class="n">ras</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">k</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkMatrix4x4</span><span class="p">()</span>
    <span class="n">o</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkMatrix4x4</span><span class="p">()</span>
    <span class="n">k</span><span class="o">.</span><span class="n">SetElement</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">k</span><span class="o">.</span><span class="n">SetElement</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">k</span><span class="o">.</span><span class="n">SetElement</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">k</span><span class="o">.</span><span class="n">Multiply4x4</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">o</span><span class="p">)</span>
    <span class="n">ras</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="n">GetElement</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">ras</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="n">GetElement</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">ras</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="n">GetElement</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ras</span>
</div>
<div class="viewcode-block" id="NeedleFinderLogic.ras2ijk"><a class="viewcode-back" href="../NeedleFinder.html#NeedleFinder.NeedleFinderLogic.ras2ijk">[docs]</a>  <span class="k">def</span> <span class="nf">ras2ijk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">A</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert RAS coordinates to IJK coordinates. The transformation matrix is the one </span>
<span class="sd">    of the active volume on the red slice</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#productive #math #coordinate-space-conversion</span>
    <span class="k">if</span> <span class="n">profiling</span><span class="p">:</span> <span class="k">print</span> <span class="s">&quot;ras2ijk&quot;</span><span class="p">;</span>
    <span class="n">m</span><span class="o">=</span><span class="n">vtk</span><span class="o">.</span><span class="n">vtkMatrix4x4</span><span class="p">()</span>
    <span class="n">volumeNode</span> <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">layoutManager</span><span class="p">()</span><span class="o">.</span><span class="n">sliceWidget</span><span class="p">(</span><span class="s">&quot;Red&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sliceLogic</span><span class="p">()</span><span class="o">.</span><span class="n">GetBackgroundLayer</span><span class="p">()</span><span class="o">.</span><span class="n">GetVolumeNode</span><span class="p">()</span>
    <span class="n">volumeNode</span><span class="o">.</span><span class="n">GetIJKToRASMatrix</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
    <span class="n">m</span><span class="o">.</span><span class="n">Invert</span><span class="p">()</span>
    <span class="n">imageData</span> <span class="o">=</span> <span class="n">volumeNode</span><span class="o">.</span><span class="n">GetImageData</span><span class="p">()</span>
    <span class="n">ijk</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">k</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkMatrix4x4</span><span class="p">()</span>
    <span class="n">o</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkMatrix4x4</span><span class="p">()</span>
    <span class="n">k</span><span class="o">.</span><span class="n">SetElement</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">k</span><span class="o">.</span><span class="n">SetElement</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">k</span><span class="o">.</span><span class="n">SetElement</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">k</span><span class="o">.</span><span class="n">Multiply4x4</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">o</span><span class="p">)</span>
    <span class="n">ijk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="n">GetElement</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">ijk</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="n">GetElement</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">ijk</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="n">GetElement</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ijk</span>
  </div>
<div class="viewcode-block" id="NeedleFinderLogic.needleDetection"><a class="viewcode-back" href="../NeedleFinder.html#NeedleFinder.NeedleFinderLogic.needleDetection">[docs]</a>  <span class="k">def</span> <span class="nf">needleDetection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">print</span> <span class="s">&quot;needleDetection&quot;</span>
    <span class="n">msgbox</span><span class="p">(</span><span class="s">&#39;needleDetection&#39;</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This solution is optional but not used anymore in the workflow. </span>
<span class="sd">    Use the label map of the needle tips</span>
<span class="sd">    Apply the island effect</span>
<span class="sd">    Extract the coordinates of the islands (self.array2)</span>
<span class="sd">    Start a detection for each island (self.needleDetectionThread)</span>
<span class="sd">    TODO: multi-processing</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># Apply Island Effect</span>
    <span class="n">editUtil</span> <span class="o">=</span> <span class="n">EditorLib</span><span class="o">.</span><span class="n">EditUtil</span><span class="o">.</span><span class="n">EditUtil</span><span class="p">()</span>
    <span class="n">parameterNode</span> <span class="o">=</span> <span class="n">editUtil</span><span class="o">.</span><span class="n">getParameterNode</span><span class="p">()</span>
    <span class="n">sliceLogic</span> <span class="o">=</span> <span class="n">editUtil</span><span class="o">.</span><span class="n">getSliceLogic</span><span class="p">()</span>
    <span class="n">lm</span> <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">layoutManager</span><span class="p">()</span>
    <span class="n">sliceWidget</span> <span class="o">=</span> <span class="n">lm</span><span class="o">.</span><span class="n">sliceWidget</span><span class="p">(</span><span class="s">&#39;Red&#39;</span><span class="p">)</span>
    <span class="n">islandsEffect</span> <span class="o">=</span> <span class="n">EditorLib</span><span class="o">.</span><span class="n">IdentifyIslandsEffectOptions</span><span class="p">()</span>
    <span class="n">islandsEffect</span><span class="o">.</span><span class="n">setMRMLDefaults</span><span class="p">()</span>
    <span class="n">islandsEffect</span><span class="o">.</span><span class="n">__del__</span><span class="p">()</span>
    <span class="n">islandTool</span> <span class="o">=</span> <span class="n">EditorLib</span><span class="o">.</span><span class="n">IdentifyIslandsEffectLogic</span><span class="p">(</span><span class="n">sliceLogic</span><span class="p">)</span>
    <span class="n">parameterNode</span><span class="o">.</span><span class="n">SetParameter</span><span class="p">(</span><span class="s">&quot;IslandEffect,minimumSize&quot;</span><span class="p">,</span><span class="s">&#39;0&#39;</span><span class="p">)</span>
    <span class="n">islandTool</span><span class="o">.</span><span class="n">removeIslands</span><span class="p">()</span>
    <span class="c"># select the image node from the Red slice viewer</span>
    <span class="n">m</span><span class="o">=</span><span class="n">vtk</span><span class="o">.</span><span class="n">vtkMatrix4x4</span><span class="p">()</span>
    <span class="n">volumeNode</span> <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">layoutManager</span><span class="p">()</span><span class="o">.</span><span class="n">sliceWidget</span><span class="p">(</span><span class="s">&quot;Red&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sliceLogic</span><span class="p">()</span><span class="o">.</span><span class="n">GetBackgroundLayer</span><span class="p">()</span><span class="o">.</span><span class="n">GetVolumeNode</span><span class="p">()</span>
    <span class="n">volumeNode</span><span class="o">.</span><span class="n">GetIJKToRASMatrix</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
    <span class="n">imageData</span> <span class="o">=</span> <span class="n">volumeNode</span><span class="o">.</span><span class="n">GetImageData</span><span class="p">()</span>
    <span class="n">spacing</span> <span class="o">=</span> <span class="n">volumeNode</span><span class="o">.</span><span class="n">GetSpacing</span><span class="p">()</span>
    <span class="c"># chrono starts</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">clock</span><span class="p">()</span>
    <span class="c"># get the coordinates from the label map</span>
    <span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">array2</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">I</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">label</span><span class="p">)):</span>
      <span class="n">A</span><span class="o">=</span><span class="n">label</span><span class="p">[</span><span class="n">I</span><span class="p">]</span>
      <span class="n">colorVar</span> <span class="o">=</span> <span class="n">I</span><span class="o">/</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">label</span><span class="p">))</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">needleDetectionThread</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">imageData</span><span class="p">,</span> <span class="n">colorVar</span><span class="p">,</span><span class="n">spacing</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">slicer</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">NeedleFinderWidget</span><span class="o">.</span><span class="n">autoStopTip</span><span class="o">.</span><span class="n">isChecked</span><span class="p">():</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">needleDetectionUPThread</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">imageData</span><span class="p">,</span> <span class="n">colorVar</span><span class="p">,</span><span class="n">spacing</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="NeedleFinderLogic.needleValidation"><a class="viewcode-back" href="../NeedleFinder.html#NeedleFinder.NeedleFinderLogic.needleValidation">[docs]</a>  <span class="k">def</span> <span class="nf">needleValidation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">A</span><span class="p">,</span> <span class="n">imageData</span><span class="p">,</span><span class="n">colorVar</span><span class="p">,</span><span class="n">spacing</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add a fiducial point to the vtkMRMLScence, where the mouse click was triggered. The fiducial points reprents a control</span>
<span class="sd">    point for a manually segmented needle (validation needle)</span>

<span class="sd">    :param A: RAS coordinates of the mouse click</span>
<span class="sd">    :param imageData: volumeNode.GetImageDate()</span>
<span class="sd">    :param colorVar: color of the fiducial point</span>
<span class="sd">    :param spacing: volumeNode.GetSpacing()</span>
<span class="sd">    :return: tableValueCtrPt : table containing control points of every validation needle</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#productive #onClick</span>
    <span class="k">if</span> <span class="n">profiling</span><span class="p">:</span> <span class="k">print</span> <span class="s">&quot;needleValidation&quot;</span><span class="p">;</span>
    <span class="n">widget</span> <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">NeedleFinderWidget</span>
    <span class="n">fiducial</span> <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">mrmlScene</span><span class="o">.</span><span class="n">CreateNodeByClass</span><span class="p">(</span><span class="s">&#39;vtkMRMLAnnotationFiducialNode&#39;</span><span class="p">)</span>
    <span class="n">fiducial</span><span class="o">.</span><span class="n">SetName</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">widget</span><span class="o">.</span><span class="n">validationNeedleNumber</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;-&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">widget</span><span class="o">.</span><span class="n">stepNeedle</span><span class="p">))</span> 
    <span class="n">fiducial</span><span class="o">.</span><span class="n">Initialize</span><span class="p">(</span><span class="n">slicer</span><span class="o">.</span><span class="n">mrmlScene</span><span class="p">)</span>
    <span class="n">fiducial</span><span class="o">.</span><span class="n">SetFiducialCoordinates</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ijk2ras</span><span class="p">(</span><span class="n">A</span><span class="p">))</span>
    <span class="n">fiducial</span><span class="o">.</span><span class="n">SetAttribute</span><span class="p">(</span><span class="s">&#39;ValidationNeedle&#39;</span><span class="p">,</span><span class="s">&#39;1&#39;</span><span class="p">)</span>
    <span class="n">fiducial</span><span class="o">.</span><span class="n">SetAttribute</span><span class="p">(</span><span class="s">&#39;NeedleNumber&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">widget</span><span class="o">.</span><span class="n">validationNeedleNumber</span><span class="p">))</span>
    <span class="n">fiducial</span><span class="o">.</span><span class="n">SetAttribute</span><span class="p">(</span><span class="s">&#39;NeedleStep&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">widget</span><span class="o">.</span><span class="n">stepNeedle</span><span class="p">))</span>
    
    <span class="n">nth</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">widget</span><span class="o">.</span><span class="n">validationNeedleNumber</span><span class="p">)</span>
    <span class="c"># print nth</span>

    <span class="n">displayNode</span><span class="o">=</span><span class="n">fiducial</span><span class="o">.</span><span class="n">GetDisplayNode</span><span class="p">()</span>
    <span class="n">displayNode</span><span class="o">.</span><span class="n">SetGlyphScale</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">displayNode</span><span class="o">.</span><span class="n">SetColor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">color</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">nth</span><span class="p">)][</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">color</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">nth</span><span class="p">)][</span><span class="mi">1</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">color</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">nth</span><span class="p">)][</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">textNode</span><span class="o">=</span><span class="n">fiducial</span><span class="o">.</span><span class="n">GetAnnotationTextDisplayNode</span><span class="p">()</span>
    <span class="n">textNode</span><span class="o">.</span><span class="n">SetTextScale</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">textNode</span><span class="o">.</span><span class="n">SetColor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">color</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">nth</span><span class="p">)][</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">color</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">nth</span><span class="p">)][</span><span class="mi">1</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">color</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">nth</span><span class="p">)][</span><span class="mi">2</span><span class="p">])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">tableValueCtrPt</span><span class="p">[</span><span class="n">widget</span><span class="o">.</span><span class="n">validationNeedleNumber</span><span class="p">][</span><span class="n">widget</span><span class="o">.</span><span class="n">stepNeedle</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ijk2ras</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="NeedleFinderLogic.obturatorNeedle"><a class="viewcode-back" href="../NeedleFinder.html#NeedleFinder.NeedleFinderLogic.obturatorNeedle">[docs]</a>  <span class="k">def</span> <span class="nf">obturatorNeedle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">A</span><span class="p">,</span> <span class="n">imageData</span><span class="p">,</span><span class="n">colorVar</span><span class="p">,</span><span class="n">spacing</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Use the mouse click coordinates to draw obturator needles:</span>
<span class="sd">    * For the first obturator needle, two points are necessary: give both extremities of an obturator needle</span>
<span class="sd">    * For the following needles, only give the tip of the needle. It will draw parallel to the first obturator needle</span>
<span class="sd">    and having the same length</span>

<span class="sd">    :param A: RAS coordinates of the mouse click</span>
<span class="sd">    :param imageData: volumeNode.GetImageDate()</span>
<span class="sd">    :param colorVar: color of the fiducial point</span>
<span class="sd">    :param spacing: volumeNode.GetSpacing()</span>
<span class="sd">    :return: obturator needle</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#productive</span>
    <span class="k">if</span> <span class="n">profiling</span><span class="p">:</span> <span class="k">print</span> <span class="s">&quot;obturatorNeedle&quot;</span><span class="p">;</span>
    <span class="n">widget</span> <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">NeedleFinderWidget</span>

    <span class="n">fiducial</span> <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">mrmlScene</span><span class="o">.</span><span class="n">CreateNodeByClass</span><span class="p">(</span><span class="s">&#39;vtkMRMLAnnotationFiducialNode&#39;</span><span class="p">)</span>
    
    <span class="n">fiducial</span><span class="o">.</span><span class="n">Initialize</span><span class="p">(</span><span class="n">slicer</span><span class="o">.</span><span class="n">mrmlScene</span><span class="p">)</span>
    <span class="n">fiducial</span><span class="o">.</span><span class="n">SetFiducialCoordinates</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ijk2ras</span><span class="p">(</span><span class="n">A</span><span class="p">))</span>
    <span class="n">fiducial</span><span class="o">.</span><span class="n">SetAttribute</span><span class="p">(</span><span class="s">&#39;ObturatorNeedle&#39;</span><span class="p">,</span><span class="s">&#39;1&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">obtuNeedle</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
      <span class="n">needleNumber</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">needleNumber</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">obtuNeedle</span><span class="o">-</span><span class="mi">1</span>
      <span class="n">needleStep</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">obtuNeedle</span> <span class="o">==</span><span class="mi">1</span><span class="p">:</span>
      <span class="n">needleStep</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">obtuNeedle</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
      <span class="n">needleStep</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">fiducial</span><span class="o">.</span><span class="n">SetAttribute</span><span class="p">(</span><span class="s">&#39;NeedleNumber&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">needleNumber</span><span class="p">))</span>
    <span class="n">fiducial</span><span class="o">.</span><span class="n">SetAttribute</span><span class="p">(</span><span class="s">&#39;NeedleStep&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">needleStep</span><span class="p">))</span>
    <span class="n">fiducial</span><span class="o">.</span><span class="n">SetName</span><span class="p">(</span><span class="s">&quot;.obtu-&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">needleNumber</span><span class="p">))</span> 
    
    <span class="n">nth</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">needleNumber</span><span class="p">)</span>

    <span class="n">displayNode</span><span class="o">=</span><span class="n">fiducial</span><span class="o">.</span><span class="n">GetDisplayNode</span><span class="p">()</span>
    <span class="n">displayNode</span><span class="o">.</span><span class="n">SetGlyphScale</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">displayNode</span><span class="o">.</span><span class="n">SetColor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">color</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">nth</span><span class="p">)][</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">color</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">nth</span><span class="p">)][</span><span class="mi">1</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">color</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">nth</span><span class="p">)][</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">textNode</span><span class="o">=</span><span class="n">fiducial</span><span class="o">.</span><span class="n">GetAnnotationTextDisplayNode</span><span class="p">()</span>
    <span class="n">textNode</span><span class="o">.</span><span class="n">SetTextScale</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">textNode</span><span class="o">.</span><span class="n">SetColor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">color</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">nth</span><span class="p">)][</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">color</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">nth</span><span class="p">)][</span><span class="mi">1</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">color</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">nth</span><span class="p">)][</span><span class="mi">2</span><span class="p">])</span>
    
    <span class="bp">self</span><span class="o">.</span><span class="n">obtuNeedleValueCtrPt</span><span class="p">[</span><span class="n">needleNumber</span><span class="p">][</span><span class="n">needleStep</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ijk2ras</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="c"># print self.ijk2ras(A)</span>
    <span class="c">#print &quot;ctr pt: &quot;,self.obtuNeedleValueCtrPt</span>

    <span class="k">if</span> <span class="n">needleNumber</span><span class="o">&gt;=</span><span class="mi">1</span><span class="p">:</span>
      <span class="n">Vx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">obtuNeedleValueCtrPt</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">obtuNeedleValueCtrPt</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
      <span class="n">Vy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">obtuNeedleValueCtrPt</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">obtuNeedleValueCtrPt</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
      <span class="n">Vz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">obtuNeedleValueCtrPt</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">obtuNeedleValueCtrPt</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>

      <span class="n">L</span><span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">Vx</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">Vy</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">Vz</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span>

      <span class="n">E</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ijk2ras</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
      <span class="n">Ex</span> <span class="o">=</span> <span class="n">E</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">100</span><span class="o">*</span><span class="n">Vx</span><span class="o">/</span><span class="n">L</span>
      <span class="n">Ey</span> <span class="o">=</span> <span class="n">E</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">100</span><span class="o">*</span><span class="n">Vy</span><span class="o">/</span><span class="n">L</span>
      <span class="n">Ez</span> <span class="o">=</span> <span class="n">E</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="mi">100</span><span class="o">*</span><span class="n">Vz</span><span class="o">/</span><span class="n">L</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">obtuNeedleValueCtrPt</span><span class="p">[</span><span class="n">needleNumber</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">Ex</span><span class="p">,</span><span class="n">Ey</span><span class="p">,</span><span class="n">Ez</span><span class="p">]</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">drawObturatorNeedles</span><span class="p">()</span>
    <span class="n">widget</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
    <span class="n">widget</span><span class="o">.</span><span class="n">fiducialObturatorButton</span><span class="o">.</span><span class="n">checked</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">widget</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="NeedleFinderLogic.objectiveFunction"><a class="viewcode-back" href="../NeedleFinder.html#NeedleFinder.NeedleFinderLogic.objectiveFunction">[docs]</a>  <span class="k">def</span> <span class="nf">objectiveFunction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">imageData</span><span class="p">,</span> <span class="n">ijk</span><span class="p">,</span> <span class="n">radiusNeedleParameter</span><span class="p">,</span> <span class="n">spacing</span><span class="p">,</span> <span class="n">gradientPonderation</span><span class="p">):</span>
    <span class="k">print</span> <span class="s">&quot;objectiveFunction&quot;</span>
    <span class="n">msgbox</span><span class="p">(</span><span class="s">&quot;objectiveFunction&quot;</span><span class="p">)</span>
    <span class="n">radiusNeedle</span>        <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">radiusNeedleParameter</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">spacing</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
    <span class="n">radiusNeedleCorner</span>  <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="n">radiusNeedleParameter</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">spacing</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="mf">1.414</span><span class="p">)))</span>
    <span class="n">ijk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">ijk</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">ijk</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">ijk</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">ijk</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">ijk</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="n">center</span> <span class="o">=</span> <span class="n">imageData</span><span class="o">.</span><span class="n">GetScalarComponentAsDouble</span><span class="p">(</span><span class="n">ijk</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">center</span> <span class="o">+=</span> <span class="n">imageData</span><span class="o">.</span><span class="n">GetScalarComponentAsDouble</span><span class="p">(</span><span class="n">ijk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">center</span> <span class="o">+=</span> <span class="n">imageData</span><span class="o">.</span><span class="n">GetScalarComponentAsDouble</span><span class="p">(</span><span class="n">ijk</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">center</span> <span class="o">+=</span> <span class="n">imageData</span><span class="o">.</span><span class="n">GetScalarComponentAsDouble</span><span class="p">(</span><span class="n">ijk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">center</span> <span class="o">+=</span> <span class="n">imageData</span><span class="o">.</span><span class="n">GetScalarComponentAsDouble</span><span class="p">(</span><span class="n">ijk</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">gradientPonderation</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
      <span class="n">g1</span> <span class="o">=</span> <span class="n">imageData</span><span class="o">.</span><span class="n">GetScalarComponentAsDouble</span><span class="p">(</span><span class="n">ijk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">radiusNeedle</span><span class="p">,</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
      <span class="n">g2</span> <span class="o">=</span> <span class="n">imageData</span><span class="o">.</span><span class="n">GetScalarComponentAsDouble</span><span class="p">(</span><span class="n">ijk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">radiusNeedle</span><span class="p">,</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
      <span class="n">g3</span> <span class="o">=</span> <span class="n">imageData</span><span class="o">.</span><span class="n">GetScalarComponentAsDouble</span><span class="p">(</span><span class="n">ijk</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">radiusNeedle</span><span class="p">,</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
      <span class="n">g4</span> <span class="o">=</span> <span class="n">imageData</span><span class="o">.</span><span class="n">GetScalarComponentAsDouble</span><span class="p">(</span><span class="n">ijk</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">radiusNeedle</span><span class="p">,</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
      <span class="n">g5</span> <span class="o">=</span> <span class="n">imageData</span><span class="o">.</span><span class="n">GetScalarComponentAsDouble</span><span class="p">(</span><span class="n">ijk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">radiusNeedleCorner</span><span class="p">,</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">radiusNeedleCorner</span><span class="p">,</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>                    
      <span class="n">g6</span> <span class="o">=</span> <span class="n">imageData</span><span class="o">.</span><span class="n">GetScalarComponentAsDouble</span><span class="p">(</span><span class="n">ijk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">radiusNeedleCorner</span><span class="p">,</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">radiusNeedleCorner</span><span class="p">,</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
      <span class="n">g7</span> <span class="o">=</span> <span class="n">imageData</span><span class="o">.</span><span class="n">GetScalarComponentAsDouble</span><span class="p">(</span><span class="n">ijk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">radiusNeedleCorner</span><span class="p">,</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">radiusNeedleCorner</span><span class="p">,</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
      <span class="n">g8</span> <span class="o">=</span> <span class="n">imageData</span><span class="o">.</span><span class="n">GetScalarComponentAsDouble</span><span class="p">(</span><span class="n">ijk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">radiusNeedleCorner</span><span class="p">,</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">radiusNeedleCorner</span><span class="p">,</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>

      <span class="n">total</span> <span class="o">=</span> <span class="n">center</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">-</span> <span class="p">((</span><span class="n">g1</span><span class="o">+</span><span class="n">g2</span><span class="o">+</span><span class="n">g3</span><span class="o">+</span><span class="n">g4</span><span class="o">+</span><span class="n">g5</span><span class="o">+</span><span class="n">g6</span><span class="o">+</span><span class="n">g7</span><span class="o">+</span><span class="n">g8</span><span class="p">)</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span><span class="o">*</span><span class="n">gradientPonderation</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">total</span> <span class="o">=</span> <span class="n">center</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">total</span>
</div>
<div class="viewcode-block" id="NeedleFinderLogic.objectiveFunctionLOG"><a class="viewcode-back" href="../NeedleFinder.html#NeedleFinder.NeedleFinderLogic.objectiveFunctionLOG">[docs]</a>  <span class="k">def</span> <span class="nf">objectiveFunctionLOG</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">imageData</span><span class="p">,</span> <span class="n">ijk</span><span class="p">,</span> <span class="n">radiusNeedleParameter</span><span class="p">,</span> <span class="n">spacing</span><span class="p">,</span> <span class="n">gradientPonderation</span><span class="p">):</span>
    <span class="k">print</span> <span class="s">&quot;objectiveFunctionLOG&quot;</span>
    <span class="n">msgbox</span><span class="p">(</span><span class="s">&#39;objectiveFunctionLOG&#39;</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    not used.</span>
<span class="sd">    idea was to test a different objective function</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">radiusNeedle</span>        <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">radiusNeedleParameter</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">spacing</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
    <span class="n">radiusNeedleCorner</span>  <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="n">radiusNeedleParameter</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">spacing</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="mf">1.414</span><span class="p">)))</span>
    
    <span class="n">center</span> <span class="o">=</span> <span class="n">imageData</span><span class="o">.</span><span class="n">GetScalarComponentAsDouble</span><span class="p">(</span><span class="n">ijk</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">center</span> <span class="o">+=</span> <span class="n">imageData</span><span class="o">.</span><span class="n">GetScalarComponentAsDouble</span><span class="p">(</span><span class="n">ijk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">center</span> <span class="o">+=</span> <span class="n">imageData</span><span class="o">.</span><span class="n">GetScalarComponentAsDouble</span><span class="p">(</span><span class="n">ijk</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">center</span> <span class="o">+=</span> <span class="n">imageData</span><span class="o">.</span><span class="n">GetScalarComponentAsDouble</span><span class="p">(</span><span class="n">ijk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">center</span> <span class="o">+=</span> <span class="n">imageData</span><span class="o">.</span><span class="n">GetScalarComponentAsDouble</span><span class="p">(</span><span class="n">ijk</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">gradientPonderation</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
      <span class="n">g1</span> <span class="o">=</span> <span class="n">imageData</span><span class="o">.</span><span class="n">GetScalarComponentAsDouble</span><span class="p">(</span><span class="n">ijk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">radiusNeedle</span><span class="p">,</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
      <span class="n">g2</span> <span class="o">=</span> <span class="n">imageData</span><span class="o">.</span><span class="n">GetScalarComponentAsDouble</span><span class="p">(</span><span class="n">ijk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">radiusNeedle</span><span class="p">,</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
      <span class="n">g3</span> <span class="o">=</span> <span class="n">imageData</span><span class="o">.</span><span class="n">GetScalarComponentAsDouble</span><span class="p">(</span><span class="n">ijk</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">radiusNeedle</span><span class="p">,</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
      <span class="n">g4</span> <span class="o">=</span> <span class="n">imageData</span><span class="o">.</span><span class="n">GetScalarComponentAsDouble</span><span class="p">(</span><span class="n">ijk</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">radiusNeedle</span><span class="p">,</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
      <span class="n">g5</span> <span class="o">=</span> <span class="n">imageData</span><span class="o">.</span><span class="n">GetScalarComponentAsDouble</span><span class="p">(</span><span class="n">ijk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">radiusNeedleCorner</span><span class="p">,</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">radiusNeedleCorner</span><span class="p">,</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>                    
      <span class="n">g6</span> <span class="o">=</span> <span class="n">imageData</span><span class="o">.</span><span class="n">GetScalarComponentAsDouble</span><span class="p">(</span><span class="n">ijk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">radiusNeedleCorner</span><span class="p">,</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">radiusNeedleCorner</span><span class="p">,</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
      <span class="n">g7</span> <span class="o">=</span> <span class="n">imageData</span><span class="o">.</span><span class="n">GetScalarComponentAsDouble</span><span class="p">(</span><span class="n">ijk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">radiusNeedleCorner</span><span class="p">,</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">radiusNeedleCorner</span><span class="p">,</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
      <span class="n">g8</span> <span class="o">=</span> <span class="n">imageData</span><span class="o">.</span><span class="n">GetScalarComponentAsDouble</span><span class="p">(</span><span class="n">ijk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">radiusNeedleCorner</span><span class="p">,</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">radiusNeedleCorner</span><span class="p">,</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>

      <span class="n">total</span> <span class="o">=</span> <span class="n">center</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">-</span> <span class="p">((</span><span class="n">g1</span><span class="o">+</span><span class="n">g2</span><span class="o">+</span><span class="n">g3</span><span class="o">+</span><span class="n">g4</span><span class="o">+</span><span class="n">g5</span><span class="o">+</span><span class="n">g6</span><span class="o">+</span><span class="n">g7</span><span class="o">+</span><span class="n">g8</span><span class="p">)</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">total</span> <span class="o">=</span> <span class="n">center</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">total</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span><span class="o">+</span><span class="mf">0.1</span><span class="p">)</span>

    
  <span class="c">#------------------------------------------------------------------------------ </span>
  <span class="c">#</span>
  <span class="c">#</span>
  <span class="c">## FIND THE OPTIMAL TIP IN A CIRCLE (center = mouse click)</span>
  <span class="c">#</span>
  <span class="c">#</span>
  <span class="c">#------------------------------------------------------------------------------</span>
</div>
<div class="viewcode-block" id="NeedleFinderLogic.findTip"><a class="viewcode-back" href="../NeedleFinder.html#NeedleFinder.NeedleFinderLogic.findTip">[docs]</a>  <span class="k">def</span> <span class="nf">findTip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">imageData</span><span class="p">,</span> <span class="n">radiusNeedle</span><span class="p">,</span> <span class="n">coeff</span><span class="p">,</span> <span class="n">sigmaValue</span><span class="p">,</span> <span class="n">gradientPonderation</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">Z</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find tip</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#productive #onClick</span>
    <span class="k">if</span> <span class="n">profiling</span><span class="p">:</span> <span class="k">print</span> <span class="s">&quot;findTip&quot;</span><span class="p">;</span>
    <span class="n">A</span><span class="o">=</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="nb">int</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="nb">int</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="p">])]</span>
    <span class="n">minTotalTip</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">X</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>
    <span class="n">Z</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">Z</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">I</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="n">X</span><span class="p">,</span><span class="n">X</span><span class="p">):</span>
      <span class="n">i</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">I</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">coeff</span><span class="p">))</span>
      <span class="k">for</span> <span class="n">J</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="n">Y</span><span class="p">,</span><span class="n">Y</span><span class="p">):</span>
        <span class="n">j</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">J</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">coeff</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
          <span class="n">v0</span><span class="o">=</span><span class="mi">0</span>
          <span class="n">totalTip</span><span class="o">=</span><span class="mi">0</span>
          <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span> <span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">v0</span> <span class="o">=</span> <span class="mi">8</span><span class="o">*</span><span class="n">imageData</span><span class="o">.</span><span class="n">GetScalarComponentAsDouble</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">i</span><span class="p">,</span> <span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">j</span><span class="p">,</span> <span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">k</span><span class="o">+</span><span class="n">l</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            
            <span class="n">v1</span> <span class="o">=</span> <span class="n">imageData</span><span class="o">.</span><span class="n">GetScalarComponentAsDouble</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">radiusNeedle</span><span class="o">+</span><span class="n">i</span><span class="p">,</span> <span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">j</span><span class="p">,</span> <span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">k</span><span class="o">+</span><span class="n">l</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">v2</span> <span class="o">=</span> <span class="n">imageData</span><span class="o">.</span><span class="n">GetScalarComponentAsDouble</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">radiusNeedle</span><span class="o">+</span><span class="n">i</span><span class="p">,</span> <span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">j</span><span class="p">,</span> <span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">k</span><span class="o">+</span><span class="n">l</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">v3</span> <span class="o">=</span> <span class="n">imageData</span><span class="o">.</span><span class="n">GetScalarComponentAsDouble</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">i</span><span class="p">,</span> <span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">radiusNeedle</span><span class="o">+</span><span class="n">j</span><span class="p">,</span> <span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">k</span><span class="o">+</span><span class="n">l</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">v4</span> <span class="o">=</span> <span class="n">imageData</span><span class="o">.</span><span class="n">GetScalarComponentAsDouble</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">i</span><span class="p">,</span> <span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">radiusNeedle</span><span class="o">+</span><span class="n">j</span><span class="p">,</span> <span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">k</span><span class="o">+</span><span class="n">l</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            
            <span class="n">totalTip</span> <span class="o">+=</span> <span class="n">v0</span><span class="o">-</span><span class="p">((</span><span class="n">v1</span><span class="o">+</span><span class="n">v2</span><span class="o">+</span><span class="n">v3</span><span class="o">+</span><span class="n">v4</span><span class="p">)</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span><span class="o">*</span><span class="n">gradientPonderation</span>
          
          <span class="n">rgauss</span>      <span class="o">=</span> <span class="p">(</span>  <span class="n">i</span><span class="o">**</span><span class="mi">2</span> 
                            <span class="o">+</span><span class="n">j</span><span class="o">**</span><span class="mi">2</span>
                            <span class="o">+</span><span class="n">k</span><span class="o">**</span><span class="mi">2</span> <span class="p">)</span><span class="o">**</span><span class="mf">0.5</span>

          <span class="n">gaussianAttenuation</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">rgauss</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="nb">float</span><span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">sigmaValue</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)))</span>
          <span class="n">totalTip</span> <span class="o">=</span> <span class="n">gaussianAttenuation</span> <span class="o">*</span> <span class="n">totalTip</span> 
          
          <span class="c">#totalTip = v0</span>
          <span class="k">if</span> <span class="n">totalTip</span><span class="o">&lt;</span><span class="n">minTotalTip</span> <span class="ow">or</span> <span class="n">minTotalTip</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">minTotalTip</span> <span class="o">=</span> <span class="n">totalTip</span>
            <span class="n">IBest</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">i</span>
            <span class="n">JBest</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">j</span>
            <span class="n">KBest</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">k</span>
            <span class="n">P</span><span class="o">=</span><span class="p">[</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">)]</span>
            <span class="n">P</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">i</span><span class="p">,</span> <span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">j</span><span class="p">,</span> <span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">k</span><span class="o">+</span><span class="n">l</span><span class="p">]</span>
            <span class="n">P</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">radiusNeedle</span><span class="o">+</span><span class="n">i</span><span class="p">,</span> <span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">j</span><span class="p">,</span> <span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">k</span><span class="o">+</span><span class="n">l</span><span class="p">]</span>
            <span class="n">P</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">radiusNeedle</span><span class="o">+</span><span class="n">i</span><span class="p">,</span> <span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">j</span><span class="p">,</span> <span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">k</span><span class="o">+</span><span class="n">l</span><span class="p">]</span>
            <span class="n">P</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">i</span><span class="p">,</span> <span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">radiusNeedle</span><span class="o">+</span><span class="n">j</span><span class="p">,</span> <span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">k</span><span class="o">+</span><span class="n">l</span><span class="p">]</span>
            <span class="n">P</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">i</span><span class="p">,</span> <span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">radiusNeedle</span><span class="o">+</span><span class="n">j</span><span class="p">,</span> <span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">k</span><span class="o">+</span><span class="n">l</span><span class="p">]</span>
              
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    # Draw template</span>
<span class="sd">    for pi in range(5):</span>
<span class="sd">      fiducial = slicer.mrmlScene.CreateNodeByClass(&#39;vtkMRMLAnnotationFiducialNode&#39;)</span>
<span class="sd">      fiducial.Initialize(slicer.mrmlScene)</span>
<span class="sd">      fiducial.SetName(str(pi))</span>
<span class="sd">      fiducial.SetFiducialCoordinates(self.ijk2ras(P[pi]))</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#print &quot;bestTip:&quot;,IBest,JBest,KBest, minTotalTip</span>
    <span class="c">#print &quot;initialtip:&quot;, A</span>
    <span class="n">AInit</span><span class="o">=</span><span class="n">A</span>

    <span class="n">A</span><span class="o">=</span><span class="p">[</span><span class="n">IBest</span><span class="p">,</span><span class="n">JBest</span><span class="p">,</span><span class="n">KBest</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">A</span>
  
  <span class="c">#------------------------------------------------------------------------------ </span>
  <span class="c">#</span>
  <span class="c">#</span>
  <span class="c">## TRACKING NEEDLE IN -Z DIRECTION</span>
  <span class="c">#</span>
  <span class="c">#</span>
  <span class="c">#------------------------------------------------------------------------------</span>

</div>
<div class="viewcode-block" id="NeedleFinderLogic.needleDetectionThread"><a class="viewcode-back" href="../NeedleFinder.html#NeedleFinder.NeedleFinderLogic.needleDetectionThread">[docs]</a>  <span class="k">def</span> <span class="nf">needleDetectionThread</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">A</span><span class="p">,</span> <span class="n">imageData</span><span class="p">,</span><span class="n">colorVar</span><span class="p">,</span><span class="n">spacing</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    From the needle tip, the algorithm looks for a direction maximizing the &quot;needle likelihood&quot; of a small segment in a conic region. </span>
<span class="sd">    The second extremity of this segment is saved as a control point (in controlPoints), used later. </span>
<span class="sd">    Then, this step is iterated, replacing the needle tip by the latest control point. </span>
<span class="sd">    The height of the new conic region (stepsize) is increased as well as its base diameter (rMax) and its normal is collinear to the previous computed segment. (cf. C0) </span>
<span class="sd">    NbStepsNeedle iterations give NbStepsNeedle-1 control points, the last one being used as an extremity as well as the needle tip. </span>
<span class="sd">    From these NbStepsNeedle-1 control points and 2 extremities a Bezier curve is computed, approximating the needle path.</span>
<span class="sd">    ??? is this a threaded function -&gt; no it is not yet unfortunately, but the idea was to do it</span>

<span class="sd">    :param A: RAS coordinates of the needle tip</span>
<span class="sd">    :param imageData: volumeNode.GetImageData()</span>
<span class="sd">    :param colorVar: color of the needle</span>
<span class="sd">    :param spacing: volumneNode.GetSpacing()</span>
<span class="sd">    :return: a needle in 3D!!</span>





<span class="sd">    &quot;&quot;&quot;</span>


    <span class="c">#productive</span>
    <span class="k">if</span> <span class="n">profiling</span><span class="p">:</span> <span class="k">print</span> <span class="s">&quot;needleDetectionThread&quot;</span><span class="p">;</span>
    <span class="c">### initialisation of the parameters</span>
    <span class="n">ijk</span>         <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">bestPoint</span>   <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">mode</span>        <span class="o">=</span> <span class="s">&quot;circle&quot;</span>

    <span class="c">### load parameters from GUI</span>

    <span class="n">widget</span> <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">NeedleFinderWidget</span>

    <span class="n">distanceMax</span>                 <span class="o">=</span> <span class="n">widget</span><span class="o">.</span><span class="n">distanceMax</span><span class="o">.</span><span class="n">value</span>
    <span class="n">gradientPonderation</span>         <span class="o">=</span> <span class="n">widget</span><span class="o">.</span><span class="n">gradientPonderation</span><span class="o">.</span><span class="n">value</span>
    <span class="n">sigmaValue</span>                  <span class="o">=</span> <span class="n">widget</span><span class="o">.</span><span class="n">sigmaValue</span><span class="o">.</span><span class="n">value</span>
    <span class="n">stepsize</span>                    <span class="o">=</span> <span class="n">widget</span><span class="o">.</span><span class="n">stepsize</span><span class="o">.</span><span class="n">value</span>
    <span class="n">gaussianAttenuationChecked</span>  <span class="o">=</span> <span class="n">widget</span><span class="o">.</span><span class="n">gaussianAttenuationButton</span><span class="o">.</span><span class="n">isChecked</span><span class="p">()</span>
    <span class="n">lookNeighborhood</span>            <span class="o">=</span> <span class="n">widget</span><span class="o">.</span><span class="n">gradient</span><span class="o">.</span><span class="n">isChecked</span><span class="p">()</span>
    <span class="n">numberOfPointsPerNeedle</span>     <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">widget</span><span class="o">.</span><span class="n">numberOfPointsPerNeedle</span><span class="o">.</span><span class="n">value</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">nbRotatingIterations</span>        <span class="o">=</span> <span class="n">widget</span><span class="o">.</span><span class="n">nbRotatingIterations</span><span class="o">.</span><span class="n">value</span>
    <span class="n">radiusNeedleParameter</span>       <span class="o">=</span> <span class="n">widget</span><span class="o">.</span><span class="n">radiusNeedleParameter</span><span class="o">.</span><span class="n">value</span>
    <span class="n">axialSegmentationLimit</span>      <span class="o">=</span> <span class="n">widget</span><span class="o">.</span><span class="n">axialSegmentationLimit</span>
    <span class="n">lenghtNeedleParameter</span>       <span class="o">=</span> <span class="n">widget</span><span class="o">.</span><span class="n">lenghtNeedleParameter</span><span class="o">.</span><span class="n">value</span><span class="o">/</span><span class="p">(</span><span class="n">spacing</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">autoCorrectTip</span>              <span class="o">=</span> <span class="n">widget</span><span class="o">.</span><span class="n">autoCorrectTip</span><span class="o">.</span><span class="n">isChecked</span><span class="p">()</span>
    <span class="n">exponent</span>                    <span class="o">=</span> <span class="n">widget</span><span class="o">.</span><span class="n">exponent</span><span class="o">.</span><span class="n">value</span>
    <span class="n">drawFiducialPoints</span>          <span class="o">=</span> <span class="n">widget</span><span class="o">.</span><span class="n">drawFiducialPoints</span><span class="o">.</span><span class="n">isChecked</span><span class="p">()</span>
    <span class="n">autoStopTip</span>                 <span class="o">=</span> <span class="n">widget</span><span class="o">.</span><span class="n">autoStopTip</span><span class="o">.</span><span class="n">isChecked</span><span class="p">()</span>

    <span class="c">### length needle = distance Aijk[2]*0.9</span>
    <span class="c"># lenghtNeedle = abs(self.ijk2ras(A)[2]*0.9)</span>
    <span class="n">A</span><span class="o">=</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="nb">int</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="nb">int</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="p">])]</span>
    <span class="k">if</span> <span class="n">axialSegmentationLimit</span><span class="o">!=</span><span class="bp">None</span><span class="p">:</span>
      <span class="n">lenghtNeedle</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">axialSegmentationLimit</span><span class="p">)</span><span class="o">*</span><span class="mf">1.15</span><span class="o">*</span><span class="n">spacing</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">axialSegmentationLimit</span><span class="o">==</span><span class="bp">None</span> <span class="ow">and</span> <span class="n">widget</span><span class="o">.</span><span class="n">maxLength</span><span class="o">.</span><span class="n">isChecked</span><span class="p">():</span>
      <span class="n">axialSegmentationLimit</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="n">lenghtNeedle</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">axialSegmentationLimit</span><span class="p">)</span><span class="o">*</span><span class="mf">1.15</span><span class="o">*</span><span class="n">spacing</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">lenghtNeedle</span> <span class="o">=</span> <span class="n">lenghtNeedleParameter</span>
    
    <span class="n">rMax</span>            <span class="o">=</span> <span class="n">distanceMax</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">spacing</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">NbStepsNeedle</span>   <span class="o">=</span> <span class="n">numberOfPointsPerNeedle</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">nbRotatingStep</span>  <span class="o">=</span> <span class="n">nbRotatingIterations</span>

    <span class="n">dims</span>            <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">imageData</span><span class="o">.</span><span class="n">GetDimensions</span><span class="p">(</span><span class="n">dims</span><span class="p">)</span>
    <span class="n">pixelValue</span>      <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">dims</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    
    <span class="n">A0</span>              <span class="o">=</span> <span class="n">A</span>
    <span class="c">#print A0</span>
    
    <span class="bp">self</span><span class="o">.</span><span class="n">controlPoints</span>       <span class="o">=</span> <span class="p">[]</span>
    <span class="n">controlPointsIJK</span>    <span class="o">=</span> <span class="p">[]</span>
    <span class="n">bestControlPoints</span>   <span class="o">=</span> <span class="p">[]</span>

    <span class="n">radiusNeedle</span>        <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">radiusNeedleParameter</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">spacing</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
    <span class="n">radiusNeedleCorner</span>  <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="n">radiusNeedleParameter</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">spacing</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="mf">1.414</span><span class="p">)))</span>
    
    <span class="c">#---------------------------------------------------------------------------------</span>
    <span class="c"># look for the best tip in the neighboorhood of the mouse click</span>
    <span class="n">coeff</span> <span class="o">=</span> <span class="mi">1</span> <span class="c"># to look every 0.2mm</span>
    <span class="n">radiusSphere</span><span class="o">=</span><span class="mi">5</span>
    <span class="n">X</span><span class="o">=</span><span class="n">coeff</span><span class="o">*</span><span class="n">radiusSphere</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">spacing</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">Y</span><span class="o">=</span><span class="n">coeff</span><span class="o">*</span><span class="n">radiusSphere</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">spacing</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">Z</span><span class="o">=</span><span class="mi">5</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">spacing</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="c">#print &quot;X,Y,Z&quot;,X,Y,Z</span>
    <span class="c">#---------------------------------------------------------------------------------</span>
    <span class="c"># find the tip in a circle</span>
    <span class="k">if</span> <span class="n">autoCorrectTip</span><span class="p">:</span>
      <span class="n">A</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">findTip</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">imageData</span><span class="p">,</span> <span class="n">radiusNeedle</span><span class="p">,</span> <span class="n">coeff</span><span class="p">,</span> <span class="n">sigmaValue</span><span class="p">,</span> <span class="n">gradientPonderation</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">Z</span><span class="p">)</span>
    <span class="c"># keep the first control point as A0</span>
    <span class="n">A0</span><span class="o">=</span><span class="n">A</span>
    <span class="c">#---------------------------------------------------------------------------------</span>
    <span class="c"># Add points to the control point list    </span>

    <span class="bp">self</span><span class="o">.</span><span class="n">controlPoints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ijk2ras</span><span class="p">(</span><span class="n">A</span><span class="p">))</span>
    <span class="n">controlPointsIJK</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="n">bestControlPoints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ijk2ras</span><span class="p">(</span><span class="n">A</span><span class="p">))</span>
    <span class="c">#---------------------------------------------------------------------------------</span>
    <span class="c"># Draw fiducial points initial tip and found tip</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    fiducial = slicer.mrmlScene.CreateNodeByClass(&#39;vtkMRMLAnnotationFiducialNode&#39;)</span>
<span class="sd">    fiducial.Initialize(slicer.mrmlScene)</span>
<span class="sd">    fiducial.SetName(&#39;Best tip&#39;)</span>
<span class="sd">    fiducial.SetFiducialCoordinates(self.ijk2ras(A))</span>
<span class="sd">    fiducial = slicer.mrmlScene.CreateNodeByClass(&#39;vtkMRMLAnnotationFiducialNode&#39;)</span>
<span class="sd">    fiducial.Initialize(slicer.mrmlScene)</span>
<span class="sd">    fiducial.SetName(&#39;A init&#39;)</span>
<span class="sd">    fiducial.SetFiducialCoordinates(self.ijk2ras(AInit))</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">NbStepsNeedle</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
      
      <span class="c">#step 0</span>
      <span class="c">#------------------------------------------------------------------------------</span>
      <span class="k">if</span> <span class="n">step</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>

        <span class="n">stepSize</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stepSize</span><span class="p">(</span><span class="n">step</span><span class="p">,</span><span class="n">NbStepsNeedle</span><span class="p">)</span><span class="o">*</span><span class="n">lenghtNeedle</span>

        <span class="n">Vx</span>        <span class="o">=</span> <span class="mi">0</span>
        <span class="n">Vy</span>        <span class="o">=</span> <span class="mi">0</span>
        <span class="n">Vz</span>        <span class="o">=</span> <span class="o">-</span> <span class="n">stepSize</span>

        <span class="n">rMax</span>    <span class="o">=</span> <span class="n">distanceMax</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">spacing</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">rIter</span>   <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">rMax</span><span class="p">))</span>
        <span class="n">tIter</span>   <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">stepSize</span><span class="p">)))</span>

        <span class="c">#print &quot;stepsize 0:&quot;,stepSize</span>
        
        <span class="n">tot</span>     <span class="o">=</span> <span class="n">stepSize</span>

      <span class="k">else</span><span class="p">:</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">          step 1,2,...</span>
<span class="sd">          ------------------------------------------------------------------------------</span>
<span class="sd">                 [   vector V   ]</span>
<span class="sd">                 *--------------*---------------------X   -&gt; direction of tracking</span>
<span class="sd">                tip0            A                    C0</span>

<span class="sd">                then, for the following step:</span>
<span class="sd">                                              tip0&lt;-A, A&lt;-C, C0 = A + K.V</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        stepSize = self.stepSize(step+1,NbStepsNeedle+1)*lenghtNeedle</span>
<span class="sd">        #print &#39;\nstepsize&#39;,step, &#39;:&#39;,stepSize</span>
<span class="sd">        </span>

<span class="sd">        C0      = [ 2*A[0]-tip0[0],</span>
<span class="sd">                    2*A[1]-tip0[1],</span>
<span class="sd">                    A[2]-stepSize   ]</span>
<span class="sd">        &quot;&quot;&quot;</span>


        <span class="n">stepSize</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stepSize</span><span class="p">(</span><span class="n">step</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">NbStepsNeedle</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">lenghtNeedle</span>
        <span class="n">rMax</span>    <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">stepSize</span><span class="p">,</span><span class="n">distanceMax</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">spacing</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">rIter</span>   <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="nb">min</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="n">rMax</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">spacing</span><span class="p">[</span><span class="mi">0</span><span class="p">]))))</span>
        <span class="n">tIter</span>   <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">stepSize</span><span class="p">)))</span>
      
        <span class="c"># Vector V    </span>
        <span class="n">Vx</span>        <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">tip0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">Vy</span>        <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">tip0</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">Vz</span>        <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">tip0</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

      <span class="n">coeffSize</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">stepSize</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">Vz</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">:</span>
        <span class="n">K</span>         <span class="o">=</span> <span class="n">coeffSize</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">Vz</span><span class="p">))</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="k">break</span>

      <span class="n">P0</span>        <span class="o">=</span> <span class="n">A</span>
      <span class="n">C0</span>        <span class="o">=</span> <span class="p">[</span> <span class="n">P0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">K</span> <span class="o">*</span> <span class="n">Vx</span><span class="p">,</span>
                    <span class="n">P0</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">K</span> <span class="o">*</span> <span class="n">Vy</span><span class="p">,</span>
                    <span class="n">P0</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">K</span> <span class="o">*</span> <span class="n">Vz</span> <span class="p">]</span>
        
      <span class="n">estimator</span>     <span class="o">=</span> <span class="mi">0</span>
      <span class="n">minEstimator</span>  <span class="o">=</span> <span class="mi">0</span>  

      <span class="c">#radius variation</span>
      <span class="k">for</span> <span class="n">R</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rIter</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>

        <span class="n">r</span><span class="o">=</span><span class="n">R</span><span class="o">*</span><span class="p">(</span><span class="n">rMax</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">rIter</span><span class="p">))</span>
        
        <span class="c">### angle variation from 0 to 360</span>
        <span class="k">for</span> <span class="n">thetaStep</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">nbRotatingStep</span> <span class="p">):</span>
          
          <span class="n">angleInDegree</span> <span class="o">=</span> <span class="p">(</span><span class="n">thetaStep</span><span class="o">*</span><span class="mi">360</span><span class="p">)</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">nbRotatingStep</span><span class="p">)</span>
          <span class="n">theta</span>         <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">angleInDegree</span><span class="p">)</span>

          <span class="n">C</span>             <span class="o">=</span> <span class="p">[</span> <span class="n">C0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">r</span><span class="o">*</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)),</span>
                            <span class="n">C0</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">r</span><span class="o">*</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)),</span>
                            <span class="n">C0</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>

          <span class="n">total</span>     <span class="o">=</span> <span class="mi">0</span>
          <span class="n">M</span>         <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">tIter</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>
          
         
          <span class="c"># calculates tIter = number of points per segment </span>
          <span class="c">#print tIter</span>
          <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">tIter</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>

            <span class="n">tt</span>  <span class="o">=</span> <span class="n">t</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">tIter</span><span class="p">)</span>
            
            <span class="c"># x,y,z coordinates</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
              
              <span class="n">M</span><span class="p">[</span><span class="n">t</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>   <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">tt</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">tt</span><span class="o">*</span><span class="n">C</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
              <span class="n">ijk</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>    <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="n">t</span><span class="p">][</span><span class="n">i</span><span class="p">]))</span>
              
            <span class="c"># first, test if points are in the image space </span>
            <span class="k">if</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span> <span class="ow">and</span>  <span class="n">ijk</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">&lt;</span><span class="n">dims</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">and</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
              
              <span class="n">center</span>    <span class="o">=</span>   <span class="n">imageData</span><span class="o">.</span><span class="n">GetScalarComponentAsDouble</span><span class="p">(</span><span class="n">ijk</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
              <span class="n">center</span>    <span class="o">+=</span>  <span class="n">imageData</span><span class="o">.</span><span class="n">GetScalarComponentAsDouble</span><span class="p">(</span><span class="n">ijk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
              <span class="n">center</span>    <span class="o">+=</span>  <span class="n">imageData</span><span class="o">.</span><span class="n">GetScalarComponentAsDouble</span><span class="p">(</span><span class="n">ijk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
              <span class="n">center</span>    <span class="o">+=</span>  <span class="n">imageData</span><span class="o">.</span><span class="n">GetScalarComponentAsDouble</span><span class="p">(</span><span class="n">ijk</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
              <span class="n">center</span>    <span class="o">+=</span>  <span class="n">imageData</span><span class="o">.</span><span class="n">GetScalarComponentAsDouble</span><span class="p">(</span><span class="n">ijk</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
              <span class="n">center</span>    <span class="o">+=</span>  <span class="n">imageData</span><span class="o">.</span><span class="n">GetScalarComponentAsDouble</span><span class="p">(</span><span class="n">ijk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
              <span class="n">center</span>    <span class="o">+=</span>  <span class="n">imageData</span><span class="o">.</span><span class="n">GetScalarComponentAsDouble</span><span class="p">(</span><span class="n">ijk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
              <span class="n">center</span>    <span class="o">+=</span>  <span class="n">imageData</span><span class="o">.</span><span class="n">GetScalarComponentAsDouble</span><span class="p">(</span><span class="n">ijk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
              <span class="n">center</span>    <span class="o">+=</span>  <span class="n">imageData</span><span class="o">.</span><span class="n">GetScalarComponentAsDouble</span><span class="p">(</span><span class="n">ijk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>

              <span class="n">total</span>     <span class="o">+=</span> <span class="n">center</span> <span class="o">**</span> <span class="n">exponent</span>
              <span class="k">if</span> <span class="n">lookNeighborhood</span> <span class="o">==</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">mode</span> <span class="o">==</span> <span class="s">&quot;circle&quot;</span> <span class="p">:</span>
                
                <span class="n">g1</span> <span class="o">=</span> <span class="n">imageData</span><span class="o">.</span><span class="n">GetScalarComponentAsDouble</span><span class="p">(</span><span class="n">ijk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">radiusNeedle</span><span class="p">,</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">g2</span> <span class="o">=</span> <span class="n">imageData</span><span class="o">.</span><span class="n">GetScalarComponentAsDouble</span><span class="p">(</span><span class="n">ijk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">radiusNeedle</span><span class="p">,</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">g3</span> <span class="o">=</span> <span class="n">imageData</span><span class="o">.</span><span class="n">GetScalarComponentAsDouble</span><span class="p">(</span><span class="n">ijk</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">radiusNeedle</span><span class="p">,</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">g4</span> <span class="o">=</span> <span class="n">imageData</span><span class="o">.</span><span class="n">GetScalarComponentAsDouble</span><span class="p">(</span><span class="n">ijk</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">radiusNeedle</span><span class="p">,</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">g5</span> <span class="o">=</span> <span class="n">imageData</span><span class="o">.</span><span class="n">GetScalarComponentAsDouble</span><span class="p">(</span><span class="n">ijk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">radiusNeedleCorner</span><span class="p">,</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">radiusNeedleCorner</span><span class="p">,</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>                    
                <span class="n">g6</span> <span class="o">=</span> <span class="n">imageData</span><span class="o">.</span><span class="n">GetScalarComponentAsDouble</span><span class="p">(</span><span class="n">ijk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">radiusNeedleCorner</span><span class="p">,</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">radiusNeedleCorner</span><span class="p">,</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">g7</span> <span class="o">=</span> <span class="n">imageData</span><span class="o">.</span><span class="n">GetScalarComponentAsDouble</span><span class="p">(</span><span class="n">ijk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">radiusNeedleCorner</span><span class="p">,</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">radiusNeedleCorner</span><span class="p">,</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">g8</span> <span class="o">=</span> <span class="n">imageData</span><span class="o">.</span><span class="n">GetScalarComponentAsDouble</span><span class="p">(</span><span class="n">ijk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">radiusNeedleCorner</span><span class="p">,</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">radiusNeedleCorner</span><span class="p">,</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
                
                <span class="c">#total += (center - ((g1+g2+g3+g4+g5+g6+g7+g8)/float(8))*gradientPonderation)/float(tIter)</span>
                <span class="n">total</span> <span class="o">+=</span> <span class="p">((</span><span class="n">center</span> <span class="o">-</span> <span class="n">g1</span><span class="p">)</span><span class="o">**</span><span class="n">gradientPonderation</span><span class="p">)</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">tIter</span><span class="p">)</span>
                <span class="n">total</span> <span class="o">+=</span> <span class="p">((</span><span class="n">center</span> <span class="o">-</span> <span class="n">g2</span><span class="p">)</span><span class="o">**</span><span class="n">gradientPonderation</span><span class="p">)</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">tIter</span><span class="p">)</span>
                <span class="n">total</span> <span class="o">+=</span> <span class="p">((</span><span class="n">center</span> <span class="o">-</span> <span class="n">g3</span><span class="p">)</span><span class="o">**</span><span class="n">gradientPonderation</span><span class="p">)</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">tIter</span><span class="p">)</span>
                <span class="n">total</span> <span class="o">+=</span> <span class="p">((</span><span class="n">center</span> <span class="o">-</span> <span class="n">g4</span><span class="p">)</span><span class="o">**</span><span class="n">gradientPonderation</span><span class="p">)</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">tIter</span><span class="p">)</span>
                <span class="n">total</span> <span class="o">+=</span> <span class="p">((</span><span class="n">center</span> <span class="o">-</span> <span class="n">g5</span><span class="p">)</span><span class="o">**</span><span class="n">gradientPonderation</span><span class="p">)</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">tIter</span><span class="p">)</span>
                <span class="n">total</span> <span class="o">+=</span> <span class="p">((</span><span class="n">center</span> <span class="o">-</span> <span class="n">g6</span><span class="p">)</span><span class="o">**</span><span class="n">gradientPonderation</span><span class="p">)</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">tIter</span><span class="p">)</span>
                <span class="n">total</span> <span class="o">+=</span> <span class="p">((</span><span class="n">center</span> <span class="o">-</span> <span class="n">g7</span><span class="p">)</span><span class="o">**</span><span class="n">gradientPonderation</span><span class="p">)</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">tIter</span><span class="p">)</span>
                <span class="n">total</span> <span class="o">+=</span> <span class="p">((</span><span class="n">center</span> <span class="o">-</span> <span class="n">g8</span><span class="p">)</span><span class="o">**</span><span class="n">gradientPonderation</span><span class="p">)</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">tIter</span><span class="p">)</span>
               
                <span class="c"># total = self.objectiveFunctionLOG(imageData, ijk, radiusNeedleParameter, spacing, 1)</span>

              <span class="k">if</span> <span class="n">lookNeighborhood</span> <span class="o">==</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">mode</span> <span class="o">==</span> <span class="s">&quot;square&quot;</span> <span class="p">:</span>
                
                <span class="n">g1</span> <span class="o">=</span> <span class="n">imageData</span><span class="o">.</span><span class="n">GetScalarComponentAsDouble</span><span class="p">(</span><span class="n">ijk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">radiusNeedle</span><span class="p">,</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">g2</span> <span class="o">=</span> <span class="n">imageData</span><span class="o">.</span><span class="n">GetScalarComponentAsDouble</span><span class="p">(</span><span class="n">ijk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">radiusNeedle</span><span class="p">,</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">g3</span> <span class="o">=</span> <span class="n">imageData</span><span class="o">.</span><span class="n">GetScalarComponentAsDouble</span><span class="p">(</span><span class="n">ijk</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">radiusNeedle</span><span class="p">,</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">g4</span> <span class="o">=</span> <span class="n">imageData</span><span class="o">.</span><span class="n">GetScalarComponentAsDouble</span><span class="p">(</span><span class="n">ijk</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">radiusNeedle</span><span class="p">,</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
                
                <span class="n">total</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="n">center</span> <span class="o">-</span> <span class="p">((</span><span class="n">g1</span><span class="o">+</span><span class="n">g2</span><span class="o">+</span><span class="n">g3</span><span class="o">+</span><span class="n">g4</span><span class="p">)</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span><span class="o">*</span><span class="n">gradientPonderation</span><span class="p">)</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">tIter</span><span class="p">)</span>
               
                <span class="c"># total = self.objectiveFunctionLOG(imageData, ijk, radiusNeedleParameter, spacing, 1)</span>

          <span class="k">if</span> <span class="n">R</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            
            <span class="n">initialIntensity</span>    <span class="o">=</span> <span class="n">total</span>
            <span class="n">estimator</span>           <span class="o">=</span> <span class="n">total</span>
            
          <span class="k">if</span> <span class="n">gaussianAttenuationChecked</span><span class="o">==</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">step</span><span class="o">&gt;=</span><span class="mi">2</span> <span class="p">:</span>
            <span class="k">if</span> <span class="n">step</span> <span class="o">==</span> <span class="n">NbStepsNeedle</span><span class="p">:</span>
                <span class="n">sigmaValue</span> <span class="o">=</span> <span class="mi">100</span>
            
            <span class="k">if</span> <span class="n">Vz</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
              <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">              stepSize    =(A[2] - C0[2])</span>
<span class="sd">              K           =stepSize/float(tip0[2]-A[2])</span>

<span class="sd">              X           = [ A[0] + K * (A[0]-tip0[0]),</span>
<span class="sd">                              A[1] + K * (A[1]-tip0[1]),</span>
<span class="sd">                              A[2] + K * (A[2]-tip0[2]) ]</span>
<span class="sd">              &quot;&quot;&quot;</span>

              <span class="n">rgauss</span>      <span class="o">=</span> <span class="p">(</span>  <span class="p">(</span><span class="n">C</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">C0</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> 
                              <span class="o">+</span><span class="p">(</span><span class="n">C</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">C0</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>
                              <span class="o">+</span><span class="p">(</span><span class="n">C</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">C0</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="p">)</span><span class="o">**</span><span class="mf">0.5</span>

              <span class="n">gaussianAttenuation</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">rgauss</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">rMax</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="nb">float</span><span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">sigmaValue</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)))</span>   <span class="c"># 1 for x=0, 0.2 for x=5</span>
              <span class="n">estimator</span>           <span class="o">=</span> <span class="p">(</span><span class="n">total</span><span class="p">)</span><span class="o">*</span><span class="n">gaussianAttenuation</span>
            <span class="k">else</span><span class="p">:</span>
              <span class="n">estimator</span> <span class="o">=</span> <span class="n">total</span>


          <span class="k">else</span><span class="p">:</span>
            <span class="n">estimator</span> <span class="o">=</span> <span class="p">(</span><span class="n">total</span><span class="p">)</span>
       
          <span class="k">if</span> <span class="n">estimator</span><span class="o">&lt;</span><span class="n">initialIntensity</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">estimator</span><span class="o">&lt;</span><span class="n">minEstimator</span> <span class="ow">or</span> <span class="n">minEstimator</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
              <span class="n">minEstimator</span>  <span class="o">=</span> <span class="n">estimator</span>
              <span class="k">if</span> <span class="n">minEstimator</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>  
                <span class="n">bestPoint</span>   <span class="o">=</span> <span class="n">C</span>
        
           
      <span class="n">tip0</span>  <span class="o">=</span> <span class="n">A</span>
      <span class="k">if</span> <span class="n">bestPoint</span><span class="o">==</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">A</span>   <span class="o">=</span> <span class="n">C0</span>
      <span class="k">elif</span> <span class="n">bestPoint</span><span class="o">!=</span><span class="n">tip0</span><span class="p">:</span> 
        <span class="n">A</span>   <span class="o">=</span> <span class="n">bestPoint</span>

      <span class="c"># save the value of the objective function for the initial step.</span>
      <span class="c"># will be used as reference for the initial step of the ascending tracking</span>
      <span class="k">if</span> <span class="n">step</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">estimatorReference</span> <span class="o">=</span> <span class="n">minEstimator</span>  
 

      <span class="k">if</span> <span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">&lt;</span><span class="n">axialSegmentationLimit</span> <span class="ow">and</span> <span class="n">A</span><span class="o">!=</span><span class="n">A0</span><span class="p">:</span>
        
        <span class="n">asl</span> <span class="o">=</span> <span class="n">axialSegmentationLimit</span>
        <span class="n">l</span>   <span class="o">=</span> <span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">asl</span><span class="p">)</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">tip0</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

        <span class="n">A</span>   <span class="o">=</span><span class="p">[</span>  <span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">l</span><span class="o">*</span><span class="p">(</span><span class="n">tip0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                <span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">l</span><span class="o">*</span><span class="p">(</span><span class="n">tip0</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                <span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">l</span><span class="o">*</span><span class="p">(</span><span class="n">tip0</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="p">])]</span>

      <span class="bp">self</span><span class="o">.</span><span class="n">controlPoints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ijk2ras</span><span class="p">(</span><span class="n">A</span><span class="p">))</span>
      <span class="n">controlPointsIJK</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
      <span class="c">#print(&#39;step:&#39;,step,&#39;:&#39;,minEstimator )</span>
      <span class="k">if</span> <span class="n">drawFiducialPoints</span><span class="p">:</span>
        <span class="n">fiducial</span> <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">mrmlScene</span><span class="o">.</span><span class="n">CreateNodeByClass</span><span class="p">(</span><span class="s">&#39;vtkMRMLAnnotationFiducialNode&#39;</span><span class="p">)</span>
        <span class="n">fiducial</span><span class="o">.</span><span class="n">Initialize</span><span class="p">(</span><span class="n">slicer</span><span class="o">.</span><span class="n">mrmlScene</span><span class="p">)</span>
        <span class="n">fiducial</span><span class="o">.</span><span class="n">SetName</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">minEstimator</span><span class="p">))</span>
        <span class="n">fiducial</span><span class="o">.</span><span class="n">SetFiducialCoordinates</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">controlPoints</span><span class="p">[</span><span class="n">step</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>

      <span class="k">if</span> <span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">&lt;=</span><span class="n">axialSegmentationLimit</span> <span class="ow">and</span> <span class="n">A</span><span class="o">!=</span><span class="n">A0</span><span class="p">:</span>
        <span class="k">break</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">autoStopTip</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">addNeedleToScene</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">controlPoints</span><span class="p">,</span><span class="n">colorVar</span><span class="p">)</span>
    



  <span class="c">#------------------------------------------------------------------------------ </span>
  <span class="c">#</span>
  <span class="c">#</span>
  <span class="c">## TRACKING NEEDLE IN +Z DIRECTION</span>
  <span class="c">#</span>
  <span class="c">#</span>
  <span class="c">#------------------------------------------------------------------------------</span>
</div>
<div class="viewcode-block" id="NeedleFinderLogic.needleDetectionUPThread"><a class="viewcode-back" href="../NeedleFinder.html#NeedleFinder.NeedleFinderLogic.needleDetectionUPThread">[docs]</a>  <span class="k">def</span> <span class="nf">needleDetectionUPThread</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">A</span><span class="p">,</span> <span class="n">imageData</span><span class="p">,</span><span class="n">colorVar</span><span class="p">,</span><span class="n">spacing</span><span class="p">):</span>
    <span class="k">print</span> <span class="s">&quot;needleDetectionUPThread&quot;</span>
    <span class="n">msgbox</span><span class="p">(</span><span class="s">&#39;needleDetectionUPThread&#39;</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    From the needle tip, the algorithm looks for a direction maximizing the &quot;needle likelihood&quot; of a small segment in a conic region. </span>
<span class="sd">    The second extremity of this segment is saved as a control point (in controlPoints), used later. </span>
<span class="sd">    Then, this step is iterated, replacing the needle tip by the latest control point. </span>
<span class="sd">    The height of the new conic region (stepsize) is increased as well as its base diameter (rMax) and its normal is collinear to the previous computed segment. (cf. C0) </span>
<span class="sd">    NbStepsNeedle iterations give NbStepsNeedle-1 control points, the last one being used as an extremity as well as the needle tip. </span>
<span class="sd">    From these NbStepsNeedle-1 control points and 2 extremities a Bezier curve is computed, approximating the needle path.</span>
<span class="sd">    ??? is this a threaded function</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">widget</span> <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">NeedleFinderWidget</span>

    <span class="c">### initialisation of the parameters</span>
    <span class="n">ijk</span>         <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">bestPoint</span>   <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>

    <span class="c">### load parameters from GUI</span>
    <span class="n">distanceMax</span>                 <span class="o">=</span> <span class="n">widget</span><span class="o">.</span><span class="n">distanceMax</span><span class="o">.</span><span class="n">value</span>
    <span class="n">gradientPonderation</span>         <span class="o">=</span> <span class="n">widget</span><span class="o">.</span><span class="n">gradientPonderation</span><span class="o">.</span><span class="n">value</span>
    <span class="n">sigmaValue</span>                  <span class="o">=</span> <span class="n">widget</span><span class="o">.</span><span class="n">sigmaValue</span><span class="o">.</span><span class="n">value</span>
    <span class="n">stepsize</span>                    <span class="o">=</span> <span class="n">widget</span><span class="o">.</span><span class="n">stepsize</span><span class="o">.</span><span class="n">value</span>
    <span class="n">gaussianAttenuationChecked</span>  <span class="o">=</span> <span class="n">widget</span><span class="o">.</span><span class="n">gaussianAttenuationButton</span><span class="o">.</span><span class="n">isChecked</span><span class="p">()</span>
    <span class="n">lookNeighborhood</span>            <span class="o">=</span> <span class="n">widget</span><span class="o">.</span><span class="n">gradient</span><span class="o">.</span><span class="n">isChecked</span><span class="p">()</span>
    <span class="n">numberOfPointsPerNeedle</span>     <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">widget</span><span class="o">.</span><span class="n">numberOfPointsPerNeedle</span><span class="o">.</span><span class="n">value</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">nbRotatingIterations</span>        <span class="o">=</span> <span class="n">widget</span><span class="o">.</span><span class="n">nbRotatingIterations</span><span class="o">.</span><span class="n">value</span>
    <span class="n">radiusNeedleParameter</span>       <span class="o">=</span> <span class="n">widget</span><span class="o">.</span><span class="n">radiusNeedleParameter</span><span class="o">.</span><span class="n">value</span>
    <span class="c"># radiusNeedleParameter       = 1</span>
    <span class="n">axialSegmentationLimit</span>      <span class="o">=</span> <span class="n">widget</span><span class="o">.</span><span class="n">axialSegmentationLimit</span>
    <span class="n">lenghtNeedleParameter</span>       <span class="o">=</span> <span class="n">widget</span><span class="o">.</span><span class="n">lenghtNeedleParameter</span><span class="o">.</span><span class="n">value</span><span class="o">/</span><span class="p">(</span><span class="n">spacing</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

    <span class="c">### length needle = distance Aijk[2]*0.9</span>
    <span class="c"># lenghtNeedle = abs(self.ijk2ras(A)[2]*0.9)</span>

    <span class="k">if</span> <span class="n">axialSegmentationLimit</span><span class="o">!=</span><span class="bp">None</span><span class="p">:</span>
      <span class="n">lenghtNeedle</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">axialSegmentationLimit</span><span class="p">)</span><span class="o">*</span><span class="mf">1.15</span><span class="o">*</span><span class="n">spacing</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">axialSegmentationLimit</span><span class="o">==</span><span class="bp">None</span> <span class="ow">and</span> <span class="n">widget</span><span class="o">.</span><span class="n">maxLength</span><span class="o">.</span><span class="n">isChecked</span><span class="p">():</span>
      <span class="n">axialSegmentationLimit</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="n">lenghtNeedle</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">axialSegmentationLimit</span><span class="p">)</span><span class="o">*</span><span class="mf">1.15</span><span class="o">*</span><span class="n">spacing</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">lenghtNeedle</span> <span class="o">=</span> <span class="n">lenghtNeedleParameter</span>
    
    <span class="n">rMax</span>            <span class="o">=</span> <span class="n">distanceMax</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">spacing</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">NbStepsNeedle</span>   <span class="o">=</span> <span class="n">numberOfPointsPerNeedle</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">nbRotatingStep</span>  <span class="o">=</span> <span class="n">nbRotatingIterations</span>

    <span class="n">dims</span>            <span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">imageData</span><span class="o">.</span><span class="n">GetDimensions</span><span class="p">(</span><span class="n">dims</span><span class="p">)</span>
    <span class="n">pixelValue</span>      <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">dims</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    
    <span class="n">A0</span>              <span class="o">=</span> <span class="n">A</span>
    <span class="c">#print A0</span>
    
    <span class="n">controlPointsUP</span>       <span class="o">=</span> <span class="p">[]</span>
    <span class="n">controlPointsIJK</span>    <span class="o">=</span> <span class="p">[]</span>
    <span class="n">bestControlPoints</span>   <span class="o">=</span> <span class="p">[]</span>
    <span class="n">minEstimator0</span>       <span class="o">=</span> <span class="bp">None</span>
    <span class="n">stopTracking</span>        <span class="o">=</span> <span class="mi">0</span>
    
    <span class="n">controlPointsUP</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ijk2ras</span><span class="p">(</span><span class="n">A</span><span class="p">))</span>
    <span class="n">controlPointsIJK</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="n">bestControlPoints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ijk2ras</span><span class="p">(</span><span class="n">A</span><span class="p">))</span>
    
    <span class="n">radiusNeedle</span>        <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">radiusNeedleParameter</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">spacing</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
    <span class="n">radiusNeedleCorner</span>  <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="n">radiusNeedleParameter</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">spacing</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="mf">1.414</span><span class="p">)))</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    #---------------------------------------------------------------------------------</span>
<span class="sd">    # look for the best tip in the neighboorhood of the mouse click</span>
<span class="sd">    X=10/float(spacing[0])</span>
<span class="sd">    Y=10/float(spacing[1])</span>
<span class="sd">    Z=10/float(spacing[2])</span>
<span class="sd">    #print &quot;X,Y,Z&quot;,X,Y,Z</span>
<span class="sd">    minTotalTip=0</span>
<span class="sd">       </span>
<span class="sd">    for i in range(-3,3):</span>
<span class="sd">      for j in range(-3,3):</span>
<span class="sd">          for k in range(-3,3):</span>
<span class="sd">            for l in range (-3,1):</span>
<span class="sd">                v0 = 8 * imageData.GetScalarComponentAsDouble(ijk[0]+i, ijk[1]+j, ijk[2]+k+l, 0)</span>
<span class="sd">                v1 = imageData.GetScalarComponentAsDouble(ijk[0]+radiusNeedle+i, ijk[1]+j, ijk[2]+k+l, 0)</span>
<span class="sd">                v2 = imageData.GetScalarComponentAsDouble(ijk[0]-radiusNeedle+i, ijk[1]+j, ijk[2]+k+l, 0)</span>
<span class="sd">                v3 = imageData.GetScalarComponentAsDouble(ijk[0]+i, ijk[1]+radiusNeedle+j, ijk[2]+k+l, 0)</span>
<span class="sd">                v4 = imageData.GetScalarComponentAsDouble(ijk[0]+i, ijk[1]-radiusNeedle+j, ijk[2]+k+l, 0)</span>
<span class="sd">                v5 = imageData.GetScalarComponentAsDouble(ijk[0]+radiusNeedleCorner+i, ijk[1]+radiusNeedleCorner+j, ijk[2]+k+l, 0)                    </span>
<span class="sd">                v6 = imageData.GetScalarComponentAsDouble(ijk[0]-radiusNeedleCorner+i, ijk[1]-radiusNeedleCorner+j, ijk[2]+k+l, 0)</span>
<span class="sd">                v7 = imageData.GetScalarComponentAsDouble(ijk[0]-radiusNeedleCorner+i, ijk[1]+radiusNeedleCorner+j, ijk[2]+k+l, 0)</span>
<span class="sd">                v8 = imageData.GetScalarComponentAsDouble(ijk[0]+radiusNeedleCorner+i, ijk[1]-radiusNeedleCorner+j, ijk[2]+k+l, 0)</span>
<span class="sd">            totalTip = v0-(v1+v2+v3+v4+v5+v6+v7+v8/float(8))*gradientPonderation</span>
<span class="sd">            if totalTip&lt;minTotalTip or minTotalTip==0:</span>
<span class="sd">              minTotalTip = totalTip</span>
<span class="sd">              IBest = ijk[0]+i</span>
<span class="sd">              JBest = ijk[1]+j</span>
<span class="sd">              KBest = ijk[2]+k</span>

<span class="sd">    </span>
<span class="sd">    #print &quot;bestTip:&quot;,IBest,JBest,KBest, minTotalTip</span>
<span class="sd">    #print &quot;initialtip:&quot;, A</span>
<span class="sd">    #---------------------------------------------------------------------------------</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">NbStepsNeedle</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
      
      <span class="c">#step 0</span>
      <span class="c">#------------------------------------------------------------------------------</span>
      <span class="k">if</span> <span class="n">step</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>

        <span class="n">stepSize</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stepSize</span><span class="p">(</span><span class="n">step</span><span class="p">,</span><span class="n">NbStepsNeedle</span><span class="p">)</span><span class="o">*</span><span class="n">lenghtNeedle</span>

        <span class="n">Vx</span>        <span class="o">=</span> <span class="mi">0</span>
        <span class="n">Vy</span>        <span class="o">=</span> <span class="mi">0</span>
        <span class="n">Vz</span>        <span class="o">=</span> <span class="n">stepSize</span>

        <span class="n">C0</span>        <span class="o">=</span> <span class="p">[</span><span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span> <span class="n">stepSize</span><span class="p">]</span>
        <span class="n">rMax</span>      <span class="o">=</span> <span class="n">stepSize</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">spacing</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">rIter</span>     <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">rMax</span><span class="p">))</span>
        <span class="n">tIter</span>     <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">stepSize</span><span class="p">)))</span>

        <span class="c">#print &quot;stepsize 0:&quot;,stepSize</span>
        
        <span class="c"># tot     = stepSize</span>

      <span class="c">#step 1,2,...</span>
      <span class="c">#------------------------------------------------------------------------------</span>
      <span class="k">else</span><span class="p">:</span>

        <span class="n">stepSize</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stepSize</span><span class="p">(</span><span class="n">step</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">NbStepsNeedle</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">lenghtNeedle</span>
      
        <span class="n">Vx</span>        <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">tip0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">Vy</span>        <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">tip0</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">Vz</span>        <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">tip0</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

      <span class="n">coeffSize</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">stepSize</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">Vz</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">:</span>
        <span class="n">K</span>         <span class="o">=</span> <span class="n">coeffSize</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">Vz</span><span class="p">))</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="k">break</span>

      <span class="n">P0</span>        <span class="o">=</span> <span class="n">A</span>
      <span class="n">P1</span>        <span class="o">=</span> <span class="p">[</span> <span class="n">P0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">K</span> <span class="o">*</span> <span class="n">Vx</span><span class="p">,</span>
                    <span class="n">P0</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">K</span> <span class="o">*</span> <span class="n">Vy</span><span class="p">,</span>
                    <span class="n">P0</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">K</span> <span class="o">*</span> <span class="n">Vz</span> <span class="p">]</span>

      <span class="c"># value of the objective function. We want to minimize it.</span>
      <span class="n">dichoStep</span>     <span class="o">=</span> <span class="mi">0</span>
      <span class="n">continueDichotomy</span>   <span class="o">=</span> <span class="mi">1</span>

      <span class="c"># In order to find the tip, if the last point is beyond the tip (tested function of </span>
      <span class="c"># the relative value of the objective function), we start a dichotomy</span>
      <span class="c"># the dichotomy runs until a) point below the tip  or b) more than 7 loops</span>

      <span class="k">while</span> <span class="n">continueDichotomy</span><span class="o">==</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">dichoStep</span> <span class="o">&lt;=</span><span class="mi">7</span> <span class="ow">and</span> <span class="n">stopTracking</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">:</span>
        <span class="c"># reset values</span>
        <span class="n">estimator</span>     <span class="o">=</span> <span class="mi">0</span>
        <span class="n">minEstimator</span>  <span class="o">=</span> <span class="mi">0</span>
        <span class="n">dichoStep</span>     <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">step</span> <span class="o">!=</span> <span class="mi">100</span><span class="p">:</span>
          
          <span class="k">if</span> <span class="n">dichoStep</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>

            <span class="n">K</span>         <span class="o">/=</span> <span class="nb">float</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">stepSize</span>  <span class="o">/=</span> <span class="nb">float</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">testSuccess</span> <span class="o">==</span><span class="mi">1</span><span class="p">:</span>
              <span class="n">P0</span> <span class="o">=</span> <span class="n">P1</span>
            <span class="k">else</span><span class="p">:</span>
              <span class="n">P0</span> <span class="o">=</span> <span class="n">P0</span>

            <span class="n">P1</span>    <span class="o">=</span> <span class="p">[</span> <span class="n">P0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">K</span> <span class="o">*</span> <span class="n">Vx</span><span class="p">,</span>
                      <span class="n">P0</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">K</span> <span class="o">*</span> <span class="n">Vy</span><span class="p">,</span>
                      <span class="n">P0</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">K</span> <span class="o">*</span> <span class="n">Vz</span> <span class="p">]</span>
          <span class="c">#print &quot;\t----------------------------------------&quot;</span>
          <span class="c">#print &#39;\nstepsize&#39;,step, &#39;:&#39;, stepSize</span>
          <span class="c"># tot     += stepSize</span>

          <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">          C0      = [ 2*A[0]-tip0[0],</span>
<span class="sd">                      2*A[1]-tip0[1],</span>
<span class="sd">                      A[2]+stepSize   ]</span>
<span class="sd">          &quot;&quot;&quot;</span>


          <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">          coeffSize   = abs(stepSize)</span>
<span class="sd">          K           = coeffSize/float(abs(Vz))</span>

<span class="sd">          </span>
<span class="sd">          C0           = [ A[0] + K * Vx,</span>
<span class="sd">                          A[1] + K * Vy,</span>
<span class="sd">                          A[2] + K * Vz ]</span>
<span class="sd">          &quot;&quot;&quot;</span>

          <span class="n">C0</span>      <span class="o">=</span> <span class="n">P1</span>

          <span class="n">rMax</span>    <span class="o">=</span> <span class="n">stepSize</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">spacing</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
          <span class="n">rIter</span>   <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="nb">min</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="n">rMax</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">spacing</span><span class="p">[</span><span class="mi">0</span><span class="p">]))))</span>
          <span class="n">tIter</span>   <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">stepSize</span><span class="p">)))</span>
          <span class="c">#print &quot;\trMax:&quot;,rMax, &quot;rIter:&quot;,rIter, &quot;tIter&quot;,tIter</span>
          <span class="c">#print &quot;\tP1:&quot;,P1[2]</span>
      
        <span class="c">#radius variation</span>
        <span class="k">for</span> <span class="n">R</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rIter</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>

          <span class="n">r</span><span class="o">=</span><span class="n">R</span><span class="o">*</span><span class="p">(</span><span class="n">rMax</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">rIter</span><span class="p">))</span>
          
          <span class="c">### angle variation from 0 to 360</span>
          <span class="k">for</span> <span class="n">thetaStep</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">nbRotatingStep</span> <span class="p">):</span>
            
            <span class="n">angleInDegree</span> <span class="o">=</span> <span class="p">(</span><span class="n">thetaStep</span><span class="o">*</span><span class="mi">360</span><span class="p">)</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">nbRotatingStep</span><span class="p">)</span>
            <span class="n">theta</span>         <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">angleInDegree</span><span class="p">)</span>

            <span class="n">C</span>             <span class="o">=</span> <span class="p">[</span> <span class="n">C0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">r</span><span class="o">*</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)),</span>
                              <span class="n">C0</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">r</span><span class="o">*</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)),</span>
                              <span class="n">C0</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>

            <span class="n">total</span>     <span class="o">=</span> <span class="mi">0</span>
            <span class="n">M</span>         <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">tIter</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>
            
            <span class="c"># calculates tIter = number of points per segment </span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">tIter</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>

              <span class="n">tt</span>  <span class="o">=</span> <span class="n">t</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">tIter</span><span class="p">)</span>
              
              <span class="c"># x,y,z coordinates</span>
              <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                
                <span class="n">M</span><span class="p">[</span><span class="n">t</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>   <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">tt</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">tt</span><span class="o">*</span><span class="n">C</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">ijk</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>    <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="n">t</span><span class="p">][</span><span class="n">i</span><span class="p">]))</span>
                
              <span class="c"># first, test if points are in the image space </span>
              <span class="k">if</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span> <span class="ow">and</span>  <span class="n">ijk</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">&lt;</span><span class="n">dims</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">and</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                
                <span class="n">center</span>    <span class="o">=</span> <span class="n">imageData</span><span class="o">.</span><span class="n">GetScalarComponentAsDouble</span><span class="p">(</span><span class="n">ijk</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">total</span>     <span class="o">+=</span> <span class="n">center</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">tIter</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">lookNeighborhood</span> <span class="o">==</span><span class="mi">1</span> <span class="p">:</span>

                  
                  
                  <span class="n">g1</span> <span class="o">=</span> <span class="n">imageData</span><span class="o">.</span><span class="n">GetScalarComponentAsDouble</span><span class="p">(</span><span class="n">ijk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">radiusNeedle</span><span class="p">,</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
                  <span class="n">g2</span> <span class="o">=</span> <span class="n">imageData</span><span class="o">.</span><span class="n">GetScalarComponentAsDouble</span><span class="p">(</span><span class="n">ijk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">radiusNeedle</span><span class="p">,</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
                  <span class="n">g3</span> <span class="o">=</span> <span class="n">imageData</span><span class="o">.</span><span class="n">GetScalarComponentAsDouble</span><span class="p">(</span><span class="n">ijk</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">radiusNeedle</span><span class="p">,</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
                  <span class="n">g4</span> <span class="o">=</span> <span class="n">imageData</span><span class="o">.</span><span class="n">GetScalarComponentAsDouble</span><span class="p">(</span><span class="n">ijk</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">radiusNeedle</span><span class="p">,</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
                  <span class="n">g5</span> <span class="o">=</span> <span class="n">imageData</span><span class="o">.</span><span class="n">GetScalarComponentAsDouble</span><span class="p">(</span><span class="n">ijk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">radiusNeedleCorner</span><span class="p">,</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">radiusNeedleCorner</span><span class="p">,</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>                    
                  <span class="n">g6</span> <span class="o">=</span> <span class="n">imageData</span><span class="o">.</span><span class="n">GetScalarComponentAsDouble</span><span class="p">(</span><span class="n">ijk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">radiusNeedleCorner</span><span class="p">,</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">radiusNeedleCorner</span><span class="p">,</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
                  <span class="n">g7</span> <span class="o">=</span> <span class="n">imageData</span><span class="o">.</span><span class="n">GetScalarComponentAsDouble</span><span class="p">(</span><span class="n">ijk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">radiusNeedleCorner</span><span class="p">,</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">radiusNeedleCorner</span><span class="p">,</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
                  <span class="n">g8</span> <span class="o">=</span> <span class="n">imageData</span><span class="o">.</span><span class="n">GetScalarComponentAsDouble</span><span class="p">(</span><span class="n">ijk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">radiusNeedleCorner</span><span class="p">,</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">radiusNeedleCorner</span><span class="p">,</span> <span class="n">ijk</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
                  
                  <span class="n">total</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="n">center</span> <span class="o">-</span> <span class="p">((</span><span class="n">g1</span><span class="o">+</span><span class="n">g2</span><span class="o">+</span><span class="n">g3</span><span class="o">+</span><span class="n">g4</span><span class="o">+</span><span class="n">g5</span><span class="o">+</span><span class="n">g6</span><span class="o">+</span><span class="n">g7</span><span class="o">+</span><span class="n">g8</span><span class="p">)</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span><span class="o">*</span><span class="n">gradientPonderation</span><span class="p">)</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">tIter</span><span class="p">)</span>
                
            <span class="k">if</span> <span class="n">R</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
              
              <span class="n">initialIntensity</span>    <span class="o">=</span> <span class="n">total</span>
              <span class="n">estimator</span>           <span class="o">=</span> <span class="n">total</span>
              
            <span class="k">if</span> <span class="n">gaussianAttenuationChecked</span><span class="o">==</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">step</span><span class="o">&gt;=</span><span class="mi">1</span> <span class="p">:</span>
              
              <span class="k">if</span> <span class="n">Vz</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>

                  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                  coeffSize    =abs((A[2] - C0[2]))</span>
<span class="sd">                  K           =coeffSize/float(abs(tip0[2]-A[2]))</span>

<span class="sd">                  X           = [ A[0] + K * (A[0]-tip0[0]),</span>
<span class="sd">                                  A[1] + K * (A[1]-tip0[1]),</span>
<span class="sd">                                  A[2] + K * (A[2]-tip0[2]) ]</span>
<span class="sd">                  &quot;&quot;&quot;</span>

                  <span class="n">rgauss</span>      <span class="o">=</span> <span class="p">(</span>  <span class="p">(</span><span class="n">C</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">C0</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> 
                                  <span class="o">+</span><span class="p">(</span><span class="n">C</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">C0</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>
                                  <span class="o">+</span><span class="p">(</span><span class="n">C</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">C0</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="p">)</span><span class="o">**</span><span class="mf">0.5</span>

                  <span class="n">gaussianAttenuation</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">rgauss</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">rMax</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="nb">float</span><span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">sigmaValue</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)))</span>   <span class="c"># 1 for x=0, 0.2 for x=5</span>
                  <span class="n">estimator</span>           <span class="o">=</span> <span class="p">(</span><span class="n">total</span><span class="p">)</span><span class="o">*</span><span class="n">gaussianAttenuation</span>
              <span class="k">else</span><span class="p">:</span>
                  <span class="n">estimator</span> <span class="o">=</span> <span class="n">total</span>

            <span class="k">else</span><span class="p">:</span>
              <span class="n">estimator</span> <span class="o">=</span> <span class="p">(</span><span class="n">total</span><span class="p">)</span>
         
            <span class="k">if</span> <span class="n">estimator</span><span class="o">&lt;</span><span class="n">initialIntensity</span><span class="p">:</span>

              <span class="k">if</span> <span class="n">estimator</span><span class="o">&lt;</span><span class="n">minEstimator</span> <span class="ow">or</span> <span class="n">minEstimator</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">minEstimator</span>  <span class="o">=</span> <span class="n">estimator</span>
                
                <span class="k">if</span> <span class="n">minEstimator</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>  
                  <span class="n">bestPoint</span>   <span class="o">=</span> <span class="n">C</span>
          
        <span class="c">#print &quot;\tInitial Intensity:&quot;,initialIntensity</span>
        <span class="c">#print &quot;\tMin Estimator:&quot;,minEstimator</span>
        
        <span class="k">if</span> <span class="n">step</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
          <span class="n">minEstimator0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimatorReference</span>

        <span class="k">if</span> <span class="n">minEstimator0</span> <span class="o">!=</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">minEstimator0</span> <span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
          <span class="n">RelMinEstimator</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">((</span><span class="n">minEstimator</span><span class="o">-</span><span class="n">minEstimator0</span><span class="p">)</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">minEstimator0</span><span class="p">))</span>
          
          <span class="c">#print &quot;\tmin Estimator 0 :&quot;,minEstimator0,&quot;\n&quot;</span>
          <span class="c">#print &quot;\tRel Estimator :&quot;,RelMinEstimator,&quot;\n&quot;</span>
          <span class="n">valCtrPt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">objectiveFunction</span><span class="p">(</span><span class="n">imageData</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">spacing</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
          <span class="c">#print &quot;\tObjective function Ctl Pt: &quot;, valCtrPt</span>

          <span class="k">if</span> <span class="n">dichoStep</span> <span class="o">&gt;=</span> <span class="mi">8</span><span class="p">:</span>
            <span class="n">stopTracking</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">bestPoint</span> <span class="o">=</span> <span class="n">A</span>
            <span class="k">break</span>
          <span class="k">if</span> <span class="p">((</span><span class="n">RelMinEstimator</span> <span class="o">&lt;</span> <span class="mf">0.6</span><span class="p">)</span> <span class="ow">and</span> <span class="n">valCtrPt</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">minEstimator0</span> <span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">minEstimator</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">80</span> <span class="ow">and</span> <span class="n">valCtrPt</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">testSuccess</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">dichoStep</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
              <span class="n">continueDichotomy</span> <span class="o">=</span> <span class="mi">0</span>
              <span class="n">stopTracking</span> <span class="o">=</span> <span class="mi">1</span>
              <span class="k">break</span>
            <span class="k">elif</span> <span class="n">dichoStep</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
              <span class="n">continueDichotomy</span> <span class="o">=</span> <span class="mi">0</span>
          <span class="k">else</span><span class="p">:</span>
            <span class="n">testSuccess</span> <span class="o">=</span> <span class="mi">0</span>

      <span class="n">minEstimator0</span> <span class="o">=</span> <span class="n">minEstimator</span>
      <span class="n">tip0</span>  <span class="o">=</span> <span class="n">A</span>
      <span class="k">if</span> <span class="n">bestPoint</span><span class="o">==</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]:</span>    <span class="c"># if the initial point (center of the cone) is indeed the optimal ctrl point</span>
        <span class="n">A</span>   <span class="o">=</span> <span class="n">C0</span>
      <span class="k">elif</span> <span class="n">bestPoint</span><span class="o">!=</span><span class="n">tip0</span><span class="p">:</span> 
        <span class="n">A</span>   <span class="o">=</span> <span class="n">bestPoint</span>
 
      <span class="n">controlPointsUP</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ijk2ras</span><span class="p">(</span><span class="n">A</span><span class="p">))</span>
      <span class="n">controlPointsIJK</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>

      <span class="k">if</span> <span class="n">widget</span><span class="o">.</span><span class="n">drawFiducialPoints</span><span class="o">.</span><span class="n">isChecked</span><span class="p">():</span>
        <span class="n">fiducial</span> <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">mrmlScene</span><span class="o">.</span><span class="n">CreateNodeByClass</span><span class="p">(</span><span class="s">&#39;vtkMRMLAnnotationFiducialNode&#39;</span><span class="p">)</span>
        <span class="n">fiducial</span><span class="o">.</span><span class="n">Initialize</span><span class="p">(</span><span class="n">slicer</span><span class="o">.</span><span class="n">mrmlScene</span><span class="p">)</span>
        <span class="n">fiducial</span><span class="o">.</span><span class="n">SetName</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">step</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;.&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">objectiveFunction</span><span class="p">(</span><span class="n">imageData</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">spacing</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
        <span class="n">fiducial</span><span class="o">.</span><span class="n">SetFiducialCoordinates</span><span class="p">(</span><span class="n">controlPointsUP</span><span class="p">[</span><span class="n">step</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>

      <span class="k">if</span> <span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">&lt;=</span><span class="n">axialSegmentationLimit</span> <span class="ow">and</span> <span class="n">A</span><span class="o">!=</span><span class="n">A0</span><span class="p">:</span>
        <span class="k">break</span>
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">controlPointsUP</span><span class="p">)):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">controlPoints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">controlPointsUP</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">addNeedleToScene</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">controlPoints</span><span class="p">,</span><span class="n">colorVar</span><span class="p">)</span>
    <span class="c"># print &#39;length:&#39;,tot</span>
</div>
<div class="viewcode-block" id="NeedleFinderLogic.drawObturatorNeedles"><a class="viewcode-back" href="../NeedleFinder.html#NeedleFinder.NeedleFinderLogic.drawObturatorNeedles">[docs]</a>  <span class="k">def</span> <span class="nf">drawObturatorNeedles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Draw needles around the obturator of length realNeedleLength</span>
<span class="sd">    Draw straigth lines, parallel to the one defined by two control points</span>
<span class="sd">    given by the first two clicks</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#productive</span>
    <span class="k">if</span> <span class="n">profiling</span><span class="p">:</span> <span class="k">print</span> <span class="s">&quot;drawObturatorNeedles&quot;</span><span class="p">;</span>
    <span class="n">widget</span>            <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">NeedleFinderWidget</span>
    <span class="n">realNeedleLength</span>  <span class="o">=</span> <span class="n">widget</span><span class="o">.</span><span class="n">realNeedleLength</span><span class="o">.</span><span class="n">value</span>

    <span class="c"># reset report table</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">table</span> <span class="o">=</span><span class="bp">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">row</span><span class="o">=</span><span class="mi">0</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">initTableView</span><span class="p">()</span>
    <span class="k">while</span> <span class="n">slicer</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">getNodes</span><span class="p">(</span><span class="s">&#39;obturator-seg*&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="p">{}:</span>
      <span class="n">nodes</span> <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">getNodes</span><span class="p">(</span><span class="s">&#39;obturator-seg*&#39;</span><span class="p">)</span>
      <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="n">slicer</span><span class="o">.</span><span class="n">mrmlScene</span><span class="o">.</span><span class="n">RemoveNode</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">obtuNeedleValueCtrPt</span><span class="o">==</span><span class="p">[[[]]]:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">obtuNeedleValueCtrPt</span> <span class="o">=</span> <span class="p">[[[</span><span class="mi">999</span><span class="p">,</span><span class="mi">999</span><span class="p">,</span><span class="mi">999</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)]</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">obtuNeedlePt</span><span class="o">==</span><span class="p">[[[]]]:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">obtuNeedlePt</span> <span class="o">=</span> <span class="p">[[[</span><span class="mi">999</span><span class="p">,</span><span class="mi">999</span><span class="p">,</span><span class="mi">999</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)]</span>
    <span class="n">modelNodes</span> <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">mrmlScene</span><span class="o">.</span><span class="n">GetNodesByClass</span><span class="p">(</span><span class="s">&#39;vtkMRMLAnnotationFiducialNode&#39;</span><span class="p">)</span>
    <span class="n">nbNode</span><span class="o">=</span><span class="n">modelNodes</span><span class="o">.</span><span class="n">GetNumberOfItems</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">nthNode</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nbNode</span><span class="p">):</span>
      <span class="n">modelNode</span><span class="o">=</span><span class="n">slicer</span><span class="o">.</span><span class="n">mrmlScene</span><span class="o">.</span><span class="n">GetNthNodeByClass</span><span class="p">(</span><span class="n">nthNode</span><span class="p">,</span><span class="s">&#39;vtkMRMLAnnotationFiducialNode&#39;</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">modelNode</span><span class="o">.</span><span class="n">GetAttribute</span><span class="p">(</span><span class="s">&quot;ObturatorNeedle&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&quot;1&quot;</span><span class="p">:</span>
        <span class="n">needleNumber</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">modelNode</span><span class="o">.</span><span class="n">GetAttribute</span><span class="p">(</span><span class="s">&quot;NeedleNumber&quot;</span><span class="p">))</span>
        <span class="n">needleStep</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">modelNode</span><span class="o">.</span><span class="n">GetAttribute</span><span class="p">(</span><span class="s">&quot;NeedleStep&quot;</span><span class="p">))</span>
        <span class="n">coord</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">modelNode</span><span class="o">.</span><span class="n">GetFiducialCoordinates</span><span class="p">(</span><span class="n">coord</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">needleNumber</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">obtuNeedleValueCtrPt</span><span class="p">[</span><span class="n">needleNumber</span><span class="p">][</span><span class="n">needleStep</span><span class="p">]</span><span class="o">=</span><span class="n">coord</span>
        
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obtuNeedleValueCtrPt</span><span class="p">)):</span>

      <span class="n">sign</span> <span class="o">=</span> <span class="nb">cmp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obtuNeedleValueCtrPt</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">obtuNeedleValueCtrPt</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">==</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">sign</span> <span class="o">&lt;=-</span><span class="mi">1</span> <span class="p">):</span>
        <span class="n">AA</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">obtuNeedleValueCtrPt</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">BB</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">obtuNeedleValueCtrPt</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">obtuNeedleValueCtrPt</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">BB</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">obtuNeedleValueCtrPt</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">AA</span>

      <span class="c"># As we give the tip of the obturator needles, we only want to g in the increasing z direction.</span>

      <span class="n">Vx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">obtuNeedleValueCtrPt</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">obtuNeedleValueCtrPt</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
      <span class="n">Vy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">obtuNeedleValueCtrPt</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">obtuNeedleValueCtrPt</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
      <span class="n">Vz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">obtuNeedleValueCtrPt</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">obtuNeedleValueCtrPt</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>

      <span class="n">L</span><span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">Vx</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">Vy</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">Vz</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span>

      <span class="n">E</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">obtuNeedleValueCtrPt</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
      <span class="n">Ex</span> <span class="o">=</span> <span class="n">E</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">realNeedleLength</span><span class="o">*</span><span class="n">Vx</span><span class="o">/</span><span class="n">L</span>
      <span class="n">Ey</span> <span class="o">=</span> <span class="n">E</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">realNeedleLength</span><span class="o">*</span><span class="n">Vy</span><span class="o">/</span><span class="n">L</span>
      <span class="n">Ez</span> <span class="o">=</span> <span class="n">E</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">realNeedleLength</span><span class="o">*</span><span class="n">Vz</span><span class="o">/</span><span class="n">L</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">obtuNeedlePt</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">Ex</span><span class="p">,</span><span class="n">Ey</span><span class="p">,</span><span class="n">Ez</span><span class="p">]</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">obtuNeedlePt</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">E</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">E</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">E</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
          <span class="c">#print needleNumber,needleStep,coord</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obtuNeedlePt</span><span class="p">)):</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">obtuNeedlePt</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">!=</span><span class="mi">999</span><span class="p">:</span>
          <span class="n">colorVar</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
          <span class="n">controlPointsUnsorted</span> <span class="o">=</span> <span class="p">[</span><span class="n">val</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">obtuNeedlePt</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">if</span> <span class="n">val</span> <span class="o">!=</span><span class="p">[</span><span class="mi">999</span><span class="p">,</span><span class="mi">999</span><span class="p">,</span><span class="mi">999</span><span class="p">]]</span>
          <span class="n">controlPoints</span><span class="o">=</span><span class="n">controlPointsUnsorted</span>
          <span class="c">#controlPoins = self.obtuNeedlePt[i]</span>
          <span class="k">if</span> <span class="p">((</span><span class="n">i</span><span class="o">==</span><span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">controlPoints</span><span class="p">)</span><span class="o">&gt;=</span><span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="n">i</span><span class="o">&gt;=</span><span class="mi">1</span><span class="p">)</span> <span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">addNeedleToScene</span><span class="p">(</span><span class="n">controlPoints</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&#39;Obturator&#39;</span><span class="p">)</span>
      </div>
<div class="viewcode-block" id="NeedleFinderLogic.drawValidationNeedles"><a class="viewcode-back" href="../NeedleFinder.html#NeedleFinder.NeedleFinderLogic.drawValidationNeedles">[docs]</a>  <span class="k">def</span> <span class="nf">drawValidationNeedles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function takes the values inside the table tableValueCtrPt and add attributes such as color, name ,.. for every</span>
<span class="sd">     validation needle.</span>
<span class="sd">     * To add the needle to the scene, the points given for every needle has to be sorted sagitally,so they can be used as</span>
<span class="sd">     control points in a Beziers curve</span>
<span class="sd">     * For each sets of needle points, the function addNeedleToScene fits a Bezier curve and render it as a</span>
<span class="sd">     tube (vtkMRMLModelNode)</span>
<span class="sd">    &quot;&quot;&quot;</span> 
    <span class="c">#productive #onButton</span>
    <span class="k">if</span> <span class="n">profiling</span><span class="p">:</span> <span class="k">print</span> <span class="s">&quot;drawValidationNeedles&quot;</span><span class="p">;</span>
    <span class="c"># reset report table</span>
    <span class="c"># print &quot;Draw manually segmented needles...&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">table</span> <span class="o">=</span><span class="bp">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">row</span><span class="o">=</span><span class="mi">0</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">initTableView</span><span class="p">()</span>
    <span class="k">while</span> <span class="n">slicer</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">getNodes</span><span class="p">(</span><span class="s">&#39;manual-seg*&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="p">{}:</span>
        <span class="n">nodes</span> <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">getNodes</span><span class="p">(</span><span class="s">&#39;manual-seg*&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
          <span class="n">slicer</span><span class="o">.</span><span class="n">mrmlScene</span><span class="o">.</span><span class="n">RemoveNode</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tableValueCtrPt</span><span class="o">==</span><span class="p">[[]]:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tableValueCtrPt</span> <span class="o">=</span> <span class="p">[[[</span><span class="mi">999</span><span class="p">,</span><span class="mi">999</span><span class="p">,</span><span class="mi">999</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">)]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">)]</span>
    <span class="n">modelNodes</span> <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">mrmlScene</span><span class="o">.</span><span class="n">GetNodesByClass</span><span class="p">(</span><span class="s">&#39;vtkMRMLAnnotationFiducialNode&#39;</span><span class="p">)</span>
    <span class="n">nbNode</span><span class="o">=</span><span class="n">modelNodes</span><span class="o">.</span><span class="n">GetNumberOfItems</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">nthNode</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nbNode</span><span class="p">):</span>
        <span class="n">modelNode</span><span class="o">=</span><span class="n">slicer</span><span class="o">.</span><span class="n">mrmlScene</span><span class="o">.</span><span class="n">GetNthNodeByClass</span><span class="p">(</span><span class="n">nthNode</span><span class="p">,</span><span class="s">&#39;vtkMRMLAnnotationFiducialNode&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">modelNode</span><span class="o">.</span><span class="n">GetAttribute</span><span class="p">(</span><span class="s">&quot;ValidationNeedle&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&quot;1&quot;</span><span class="p">:</span>
          <span class="n">needleNumber</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">modelNode</span><span class="o">.</span><span class="n">GetAttribute</span><span class="p">(</span><span class="s">&quot;NeedleNumber&quot;</span><span class="p">))</span>
          <span class="n">needleStep</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">modelNode</span><span class="o">.</span><span class="n">GetAttribute</span><span class="p">(</span><span class="s">&quot;NeedleStep&quot;</span><span class="p">))</span>
          <span class="n">coord</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
          <span class="n">modelNode</span><span class="o">.</span><span class="n">GetFiducialCoordinates</span><span class="p">(</span><span class="n">coord</span><span class="p">)</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">tableValueCtrPt</span><span class="p">[</span><span class="n">needleNumber</span><span class="p">][</span><span class="n">needleStep</span><span class="p">]</span><span class="o">=</span><span class="n">coord</span>
          <span class="k">print</span> <span class="n">needleNumber</span><span class="p">,</span><span class="n">needleStep</span><span class="p">,</span><span class="n">coord</span>
          <span class="c"># print self.tableValueCtrPt[needleNumber][needleStep]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tableValueCtrPt</span><span class="p">)):</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tableValueCtrPt</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">!=</span><span class="p">[</span><span class="mi">999</span><span class="p">,</span><span class="mi">999</span><span class="p">,</span><span class="mi">999</span><span class="p">]:</span>
        <span class="k">print</span> <span class="s">&#39;suite2&#39;</span> <span class="c">#???</span>
        <span class="n">colorVar</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
        <span class="n">controlPointsUnsorted</span> <span class="o">=</span> <span class="p">[</span><span class="n">val</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tableValueCtrPt</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">if</span> <span class="n">val</span> <span class="o">!=</span><span class="p">[</span><span class="mi">999</span><span class="p">,</span><span class="mi">999</span><span class="p">,</span><span class="mi">999</span><span class="p">]]</span>
        <span class="n">controlPoints</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sortTable</span><span class="p">(</span><span class="n">controlPointsUnsorted</span><span class="p">,(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
        <span class="k">print</span> <span class="s">&quot;unsorted&quot;</span> <span class="c">#???</span>
        <span class="k">print</span> <span class="n">controlPointsUnsorted</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addNeedleToScene</span><span class="p">(</span><span class="n">controlPoints</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&#39;Validation&#39;</span><span class="p">)</span> 
      <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span> <span class="n">i</span>  
</div>
<div class="viewcode-block" id="NeedleFinderLogic.addNeedleToScene"><a class="viewcode-back" href="../NeedleFinder.html#NeedleFinder.NeedleFinderLogic.addNeedleToScene">[docs]</a>  <span class="k">def</span> <span class="nf">addNeedleToScene</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">controlPoint</span><span class="p">,</span><span class="n">colorVar</span><span class="p">,</span> <span class="n">needleType</span><span class="o">=</span><span class="s">&#39;Detection&#39;</span><span class="p">):</span> 
    <span class="sd">&quot;&quot;&quot;Computes the Bezier&#39;s curve and adds visual representation of a needle to the scene</span>

<span class="sd">    :param controlPoint: array of RAS coordinates of points of a needle (used as control point for the Bezier&#39;s curve</span>
<span class="sd">    :param colorVar: color of the needle</span>
<span class="sd">    :param needleType: &#39;validation&#39; for a manually segmentated needle, &#39;detection&#39; for an automatically segmented needle,</span>
<span class="sd">    &#39;obturator&#39; for an obturator needle</span>
<span class="sd">    :return: needle added to the scene</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c">#productive</span>
    <span class="k">if</span> <span class="n">profiling</span><span class="p">:</span> <span class="k">print</span> <span class="s">&quot;addNeedleToScene&quot;</span><span class="p">;</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a model of the needle from its equation (Beziers curve fitting the control points)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">widget</span>              <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">NeedleFinderWidget</span>

    <span class="n">realNeedleLength</span>    <span class="o">=</span> <span class="n">widget</span><span class="o">.</span><span class="n">realNeedleLength</span><span class="o">.</span><span class="n">value</span>
    <span class="n">extendNeedle</span>        <span class="o">=</span> <span class="n">widget</span><span class="o">.</span><span class="n">extendNeedle</span><span class="o">.</span><span class="n">isChecked</span><span class="p">()</span>
    
    <span class="c"># sort the points in a decreasing order (from tip to bottom)</span>
    <span class="n">controlPointListSorted</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sortTableReverse</span><span class="p">(</span><span class="n">controlPoint</span><span class="p">,(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>

    <span class="c"># calculate the length of the list of ctr points</span>
    <span class="n">lenghtTotal</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">controlPoint</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">lenghtTotal</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">distanceTwoPoints</span><span class="p">(</span><span class="n">controlPointListSorted</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span><span class="n">controlPointListSorted</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="k">print</span> <span class="s">&quot;Needle added to scene, &quot;</span><span class="p">,</span>
    <span class="k">print</span> <span class="s">&#39;lenght tube: &#39;</span><span class="p">,</span> <span class="n">lenghtTotal</span>
    
    <span class="c"># in case we want to extend the needle to the wanted length</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The extension is currently done by adding a point to the control point list.</span>
<span class="sd">    TODO: only append a straight tube, so it doesn&#39;t add a control point and modify</span>
<span class="sd">    the initial Bezier curve</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">lenghtTotal</span> <span class="o">&lt;</span> <span class="n">realNeedleLength</span> <span class="ow">and</span> <span class="n">extendNeedle</span><span class="p">:</span>
      <span class="n">lastPoint</span> <span class="o">=</span> <span class="p">[</span><span class="n">controlPointListSorted</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">controlPointListSorted</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">controlPointListSorted</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="p">(</span><span class="n">realNeedleLength</span> <span class="o">-</span> <span class="n">lenghtTotal</span><span class="p">)]</span>
      <span class="n">controlPointListSorted</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lastPoint</span><span class="p">)</span>

    <span class="n">label</span><span class="o">=</span><span class="bp">None</span>
    <span class="n">scene</span> <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">mrmlScene</span>
    <span class="n">points</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkPoints</span><span class="p">()</span>
    <span class="n">polyData</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkPolyData</span><span class="p">()</span>
    <span class="n">polyData</span><span class="o">.</span><span class="n">SetPoints</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkCellArray</span><span class="p">()</span>
    <span class="n">polyData</span><span class="o">.</span><span class="n">SetLines</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
    <span class="n">linesIDArray</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">GetData</span><span class="p">()</span>
    <span class="n">linesIDArray</span><span class="o">.</span><span class="n">Reset</span><span class="p">()</span>
    <span class="n">linesIDArray</span><span class="o">.</span><span class="n">InsertNextTuple1</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">polygons</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkCellArray</span><span class="p">()</span>
    <span class="n">polyData</span><span class="o">.</span><span class="n">SetPolys</span><span class="p">(</span> <span class="n">polygons</span> <span class="p">)</span>
    <span class="n">idArray</span> <span class="o">=</span> <span class="n">polygons</span><span class="o">.</span><span class="n">GetData</span><span class="p">()</span>
    <span class="n">idArray</span><span class="o">.</span><span class="n">Reset</span><span class="p">()</span>
    <span class="n">idArray</span><span class="o">.</span><span class="n">InsertNextTuple1</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">nbEvaluationPoints</span><span class="o">=</span><span class="mi">50</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">controlPointListSorted</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
    <span class="n">Q</span><span class="o">=</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nbEvaluationPoints</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>
    <span class="c"># start calculation</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nbEvaluationPoints</span><span class="p">):</span>
      <span class="n">tt</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">*</span><span class="n">nbEvaluationPoints</span><span class="p">)</span>
      <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
          <span class="n">Q</span><span class="p">[</span><span class="n">t</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">+=</span><span class="bp">self</span><span class="o">.</span><span class="n">binomial</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">tt</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="n">tt</span><span class="o">**</span><span class="n">i</span><span class="o">*</span><span class="n">controlPointListSorted</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
          
      <span class="n">pointIndex</span> <span class="o">=</span> <span class="n">points</span><span class="o">.</span><span class="n">InsertNextPoint</span><span class="p">(</span><span class="o">*</span><span class="n">Q</span><span class="p">[</span><span class="n">t</span><span class="p">])</span>
      <span class="n">linesIDArray</span><span class="o">.</span><span class="n">InsertNextTuple1</span><span class="p">(</span><span class="n">pointIndex</span><span class="p">)</span>
      <span class="n">linesIDArray</span><span class="o">.</span><span class="n">SetTuple1</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="n">linesIDArray</span><span class="o">.</span><span class="n">GetNumberOfTuples</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">)</span>
      <span class="n">lines</span><span class="o">.</span><span class="n">SetNumberOfCells</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="c">### Create model node</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">vtkMRMLModelNode</span><span class="p">()</span>
    <span class="n">model</span><span class="o">.</span><span class="n">SetScene</span><span class="p">(</span><span class="n">scene</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">SetAndObservePolyData</span><span class="p">(</span><span class="n">polyData</span><span class="p">)</span>
    <span class="c">### Create display node</span>
    <span class="n">modelDisplay</span> <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">vtkMRMLModelDisplayNode</span><span class="p">()</span>

    <span class="n">modelDisplay</span><span class="o">.</span><span class="n">SetScene</span><span class="p">(</span><span class="n">scene</span><span class="p">)</span>
    <span class="n">scene</span><span class="o">.</span><span class="n">AddNode</span><span class="p">(</span><span class="n">modelDisplay</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">SetAndObserveDisplayNodeID</span><span class="p">(</span><span class="n">modelDisplay</span><span class="o">.</span><span class="n">GetID</span><span class="p">())</span>
    <span class="c">### Add to scene</span>
    <span class="n">modelDisplay</span><span class="o">.</span><span class="n">SetInputPolyDataConnection</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">GetPolyDataConnection</span><span class="p">())</span>
    <span class="n">scene</span><span class="o">.</span><span class="n">AddNode</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
    <span class="c">###Create Tube around the line</span>
    <span class="n">tube</span><span class="o">=</span><span class="n">vtk</span><span class="o">.</span><span class="n">vtkTubeFilter</span><span class="p">()</span>
    <span class="n">polyData</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">GetPolyData</span><span class="p">()</span>
    <span class="n">tube</span><span class="o">.</span><span class="n">SetInputData</span><span class="p">(</span><span class="n">polyData</span><span class="p">)</span>
    <span class="n">tube</span><span class="o">.</span><span class="n">SetRadius</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">tube</span><span class="o">.</span><span class="n">SetNumberOfSides</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>
    <span class="n">tube</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>
    
    <span class="n">model</span><span class="o">.</span><span class="n">SetAndObservePolyData</span><span class="p">(</span><span class="n">tube</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">())</span>
    <span class="n">model</span><span class="o">.</span><span class="n">GetDisplayNode</span><span class="p">()</span><span class="o">.</span><span class="n">SliceIntersectionVisibilityOn</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">needleType</span><span class="o">==</span><span class="s">&#39;Validation&#39;</span><span class="p">:</span>
      <span class="n">model</span><span class="o">.</span><span class="n">SetName</span><span class="p">(</span><span class="s">&#39;manual-seg_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">colorVar</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">needleType</span><span class="o">==</span><span class="s">&#39;Obturator&#39;</span><span class="p">:</span>
      <span class="n">model</span><span class="o">.</span><span class="n">SetName</span><span class="p">(</span><span class="s">&#39;obturator-seg_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">colorVar</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">model</span><span class="o">.</span><span class="n">SetName</span><span class="p">(</span><span class="s">&#39;python-catch-round_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">round</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;-ID-&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">GetID</span><span class="p">()))</span>
    <span class="n">model</span><span class="o">.</span><span class="n">SetAttribute</span><span class="p">(</span><span class="s">&#39;type&#39;</span><span class="p">,</span><span class="n">needleType</span><span class="p">)</span>
    
    <span class="c"># evaluate and print the processing time</span>
    <span class="n">processingTime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">clock</span><span class="p">()</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">t0</span>
    <span class="c"># print processingTime</span>
    
    <span class="k">if</span> <span class="n">needleType</span><span class="o">==</span><span class="s">&#39;Validation&#39;</span><span class="p">:</span>
      <span class="n">nth</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">colorVar</span><span class="p">)</span><span class="o">%</span><span class="mi">64</span>
      <span class="n">modelDisplay</span><span class="o">.</span><span class="n">SetColor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">color</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">nth</span><span class="p">)][</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">color</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">nth</span><span class="p">)][</span><span class="mi">1</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">color</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">nth</span><span class="p">)][</span><span class="mi">2</span><span class="p">])</span>
      <span class="n">model</span><span class="o">.</span><span class="n">SetAttribute</span><span class="p">(</span><span class="s">&quot;nth&quot;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">nth</span><span class="p">))</span> 
    
    <span class="k">else</span><span class="p">:</span>
      <span class="n">nth</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">GetID</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39;vtkMRMLModelNode&#39;</span><span class="p">))</span><span class="o">%</span><span class="mi">64</span>
      <span class="n">modelDisplay</span><span class="o">.</span><span class="n">SetColor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">color</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">nth</span><span class="p">)][</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">color</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">nth</span><span class="p">)][</span><span class="mi">1</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">color</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">nth</span><span class="p">)][</span><span class="mi">2</span><span class="p">])</span>
      <span class="n">model</span><span class="o">.</span><span class="n">SetAttribute</span><span class="p">(</span><span class="s">&quot;nth&quot;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">nth</span><span class="p">))</span>
    
    <span class="k">if</span> <span class="n">needleType</span><span class="o">==</span><span class="s">&#39;Validation&#39;</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">addSegmentedNeedleToTable</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">colorVar</span><span class="p">),</span><span class="n">label</span><span class="p">,</span><span class="s">&#39;Validation&#39;</span><span class="p">)</span>
    
    <span class="k">else</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">addSegmentedNeedleToTable</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">GetID</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39;vtkMRMLModelNode&#39;</span><span class="p">)),</span><span class="n">label</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="NeedleFinderLogic.deleteSegmentedNeedle"><a class="viewcode-back" href="../NeedleFinder.html#NeedleFinder.NeedleFinderLogic.deleteSegmentedNeedle">[docs]</a>  <span class="k">def</span> <span class="nf">deleteSegmentedNeedle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Delete every segmented needles of the current round</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">print</span> <span class="s">&quot;deleteSegmentedNeedle&quot;</span><span class="p">;</span> <span class="n">msgbox</span><span class="p">(</span><span class="s">&#39;deleteSegmentedNeedle&#39;</span><span class="p">)</span>
    <span class="k">while</span> <span class="n">slicer</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">getNodes</span><span class="p">(</span><span class="s">&#39;python-catch-round_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">round</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;*&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="p">{}:</span>
      <span class="n">nodes</span> <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">getNodes</span><span class="p">(</span><span class="s">&#39;python-catch-round_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">round</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;*&#39;</span><span class="p">)</span>
      <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="n">slicer</span><span class="o">.</span><span class="n">mrmlScene</span><span class="o">.</span><span class="n">RemoveNode</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="NeedleFinderLogic.newInsertionNeedle"><a class="viewcode-back" href="../NeedleFinder.html#NeedleFinder.NeedleFinderLogic.newInsertionNeedle">[docs]</a>  <span class="k">def</span> <span class="nf">newInsertionNeedle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Start a new round</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">print</span> <span class="s">&#39;newInsertionNeedle&#39;</span><span class="p">;</span> <span class="n">msgbox</span><span class="p">(</span><span class="s">&#39;newInsertionNeedle&#39;</span><span class="p">)</span>
    <span class="n">widget</span>      <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">NeedleFinderWidget</span>
    <span class="n">dialog</span>      <span class="o">=</span> <span class="n">qt</span><span class="o">.</span><span class="n">QDialog</span><span class="p">()</span>
    <span class="n">messageBox</span>  <span class="o">=</span> <span class="n">qt</span><span class="o">.</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">information</span><span class="p">(</span> <span class="n">dialog</span><span class="p">,</span> <span class="s">&#39;Information&#39;</span><span class="p">,</span><span class="s">&#39;You are creating a new set of needles&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">round</span> <span class="o">+=</span><span class="mi">1</span>
    <span class="n">widget</span><span class="o">.</span><span class="n">newInsertionButton</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="s">&#39;Start a new set of needles - Round &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">round</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;?&#39;</span><span class="p">)</span>
    <span class="n">widget</span><span class="o">.</span><span class="n">deleteNeedleButton</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="s">&#39;Delete Needles from round &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">round</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="NeedleFinderLogic.resetNeedleDetection"><a class="viewcode-back" href="../NeedleFinder.html#NeedleFinder.NeedleFinderLogic.resetNeedleDetection">[docs]</a>  <span class="k">def</span> <span class="nf">resetNeedleDetection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reset the needle detection to completely start over.</span>
<span class="sd">    ??? this fx does not delete the obtu&#39; needles from the scene</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#productive #onButton</span>
    <span class="k">if</span> <span class="n">profiling</span><span class="p">:</span> <span class="k">print</span> <span class="s">&quot;resetNeedleDetection&quot;</span><span class="p">;</span>
    <span class="n">widget</span>      <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">NeedleFinderWidget</span>
    <span class="n">dialog</span>      <span class="o">=</span> <span class="n">qt</span><span class="o">.</span><span class="n">QDialog</span><span class="p">()</span>
    <span class="n">ret</span>         <span class="o">=</span> <span class="n">messageBox</span> <span class="o">=</span> <span class="n">qt</span><span class="o">.</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">question</span><span class="p">(</span> <span class="n">dialog</span><span class="p">,</span> <span class="s">&#39;Attention&#39;</span><span class="p">,</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">      Are you sure that you want to reset the needle detection? </span>
<span class="s">      It will delete every segmented needles...</span>
<span class="s">      &quot;&quot;&quot;</span><span class="p">,</span><span class="n">qt</span><span class="o">.</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Ok</span><span class="p">,</span> <span class="n">qt</span><span class="o">.</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Cancel</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ret</span> <span class="o">==</span> <span class="n">qt</span><span class="o">.</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Ok</span><span class="p">:</span>
      <span class="k">while</span> <span class="n">slicer</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">getNodes</span><span class="p">(</span><span class="s">&#39;python-catch*&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="p">{}:</span>
        <span class="n">nodes</span> <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">getNodes</span><span class="p">(</span><span class="s">&#39;python-catch*&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
          <span class="n">slicer</span><span class="o">.</span><span class="n">mrmlScene</span><span class="o">.</span><span class="n">RemoveNode</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">previousValues</span><span class="o">=</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]]</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">round</span><span class="o">=</span><span class="mi">1</span>
      <span class="n">widget</span><span class="o">.</span><span class="n">newInsertionButton</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="s">&#39;Start a new set of needles - Round &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">round</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;?&#39;</span><span class="p">)</span>
      <span class="n">widget</span><span class="o">.</span><span class="n">deleteNeedleButton</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="s">&#39;Delete Needles from round &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">round</span><span class="p">))</span>
      <span class="c"># reset report table</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">table</span> <span class="o">=</span><span class="bp">None</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">row</span><span class="o">=</span><span class="mi">0</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">initTableView</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="NeedleFinderLogic.resetNeedleValidation"><a class="viewcode-back" href="../NeedleFinder.html#NeedleFinder.NeedleFinderLogic.resetNeedleValidation">[docs]</a>  <span class="k">def</span> <span class="nf">resetNeedleValidation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reset the needle detection to completely start over.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#productive #onButton</span>
    <span class="k">if</span> <span class="n">profiling</span><span class="p">:</span> <span class="k">print</span> <span class="s">&quot;resetNeedleValidation&quot;</span><span class="p">;</span>
    <span class="n">widget</span>      <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">NeedleFinderWidget</span>
    <span class="n">dialog</span>      <span class="o">=</span> <span class="n">qt</span><span class="o">.</span><span class="n">QDialog</span><span class="p">()</span>
    <span class="n">ret</span>         <span class="o">=</span> <span class="n">messageBox</span> <span class="o">=</span> <span class="n">qt</span><span class="o">.</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">question</span><span class="p">(</span> <span class="n">dialog</span><span class="p">,</span> <span class="s">&#39;Attention&#39;</span><span class="p">,</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">      Are you sure that you want to reset the needle validation? </span>
<span class="s">      It will delete every segmented needles and the control points...</span>
<span class="s">      &quot;&quot;&quot;</span><span class="p">,</span><span class="n">qt</span><span class="o">.</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Ok</span><span class="p">,</span> <span class="n">qt</span><span class="o">.</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Cancel</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ret</span> <span class="o">==</span> <span class="n">qt</span><span class="o">.</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Ok</span><span class="p">:</span>
      <span class="k">while</span> <span class="n">slicer</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">getNodes</span><span class="p">(</span><span class="s">&#39;manual-seg*&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="p">{}:</span>
        <span class="n">nodes</span> <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">getNodes</span><span class="p">(</span><span class="s">&#39;manual-seg*&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
          <span class="n">slicer</span><span class="o">.</span><span class="n">mrmlScene</span><span class="o">.</span><span class="n">RemoveNode</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

      <span class="k">while</span> <span class="n">slicer</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">getNodes</span><span class="p">(</span><span class="s">&#39;.*&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="p">{}:</span>
        <span class="n">nodes</span> <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">getNodes</span><span class="p">(</span><span class="s">&#39;.*&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
          <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">GetAttribute</span><span class="p">(</span><span class="s">&quot;ValidationNeedle&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&quot;1&quot;</span><span class="p">:</span>
            <span class="n">slicer</span><span class="o">.</span><span class="n">mrmlScene</span><span class="o">.</span><span class="n">RemoveNode</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

      <span class="c"># reset report table</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">table</span> <span class="o">=</span> <span class="bp">None</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">row</span>  <span class="o">=</span> <span class="mi">0</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">initTableView</span><span class="p">()</span>
    
      <span class="n">widget</span><span class="o">.</span><span class="n">validationNeedleNumber</span> <span class="o">=</span> <span class="mi">1</span>
      <span class="n">widget</span><span class="o">.</span><span class="n">stepNeedle</span>             <span class="o">=</span> <span class="mi">0</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">tableValueCtrPt</span>        <span class="o">=</span><span class="p">[[[</span><span class="mi">999</span><span class="p">,</span><span class="mi">999</span><span class="p">,</span><span class="mi">999</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">)]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">)]</span>
      <span class="k">print</span> <span class="s">&quot;Manual needle segmentation resetted!&quot;</span> 
      </div>
<div class="viewcode-block" id="NeedleFinderLogic.changeCursor"><a class="viewcode-back" href="../NeedleFinder.html#NeedleFinder.NeedleFinderLogic.changeCursor">[docs]</a>  <span class="k">def</span> <span class="nf">changeCursor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cursorNumber</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    changes the cursor</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#productive</span>
    <span class="k">if</span> <span class="n">profiling</span><span class="p">:</span> <span class="k">print</span> <span class="s">&quot;changeCursor&quot;</span><span class="p">;</span>
    <span class="n">appLogic</span> <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">applicationLogic</span><span class="p">()</span>
    <span class="n">interactionNode</span> <span class="o">=</span> <span class="n">appLogic</span><span class="o">.</span><span class="n">GetInteractionNode</span><span class="p">()</span>
    <span class="n">interactionNode</span><span class="o">.</span><span class="n">SetCurrentInteractionMode</span><span class="p">(</span><span class="n">interactionNode</span><span class="o">.</span><span class="n">ViewTransform</span><span class="p">)</span>
    <span class="c"># baseImage = qt.QImage(&quot;:/Icons/AnnotationPointWithArrow.png&quot;)</span>
    <span class="c"># width =  baseImage.width()</span>
    <span class="c"># height = width</span>
    <span class="c"># center= int(width/2)</span>
    <span class="c"># cursorImage = qt.QImage(width, height, qt.QImage().Format_ARGB32)</span>
    <span class="c"># cursorImage.fill(0)</span>
    <span class="c"># cursorPixmap = qt.QPixmap()</span>
    <span class="c"># cursorPixmap = cursorPixmap.fromImage(cursorImage)</span>
    <span class="c"># cursor = qt.QCursor(cursorPixmap,center,0)</span>

    <span class="n">layoutManager</span> <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">layoutManager</span><span class="p">()</span>
    <span class="n">sliceNodeCount</span> <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">mrmlScene</span><span class="o">.</span><span class="n">GetNumberOfNodesByClass</span><span class="p">(</span><span class="s">&#39;vtkMRMLSliceNode&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">nodeIndex</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">sliceNodeCount</span><span class="p">):</span>
      <span class="c"># find the widget for each node in scene</span>
      <span class="n">sliceNode</span> <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">mrmlScene</span><span class="o">.</span><span class="n">GetNthNodeByClass</span><span class="p">(</span><span class="n">nodeIndex</span><span class="p">,</span> <span class="s">&#39;vtkMRMLSliceNode&#39;</span><span class="p">)</span>
      <span class="n">sliceWidget</span> <span class="o">=</span> <span class="n">layoutManager</span><span class="o">.</span><span class="n">sliceWidget</span><span class="p">(</span><span class="n">sliceNode</span><span class="o">.</span><span class="n">GetLayoutName</span><span class="p">())</span>
      <span class="c"># sliceWidget.setCursor(cursor)    # doesn&#39;t work. Why?</span>
      <span class="n">sliceWidget</span><span class="o">.</span><span class="n">setCursor</span><span class="p">(</span><span class="n">qt</span><span class="o">.</span><span class="n">QCursor</span><span class="p">(</span><span class="n">cursorNumber</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="NeedleFinderLogic.changeValue"><a class="viewcode-back" href="../NeedleFinder.html#NeedleFinder.NeedleFinderLogic.changeValue">[docs]</a>  <span class="k">def</span> <span class="nf">changeValue</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read the value of the Qt widget and select this needle. It is then possible to display sequentially the points used as</span>
<span class="sd">     control points of this needle</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#productive #onUpDnArrow</span>
    <span class="k">if</span> <span class="n">profiling</span><span class="p">:</span> <span class="k">print</span> <span class="s">&quot;changeValue&quot;</span><span class="p">;</span>
    <span class="n">widget</span>      <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">NeedleFinderWidget</span>
    <span class="n">widget</span><span class="o">.</span><span class="n">scrollPointButton</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="s">&#39;Scroll Point for Needle &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">widget</span><span class="o">.</span><span class="n">editNeedleTxtBox</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="o">+</span> <span class="s">&#39; (pt: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ptNumber</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;)&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="NeedleFinderLogic.scrollPoint"><a class="viewcode-back" href="../NeedleFinder.html#NeedleFinder.NeedleFinderLogic.scrollPoint">[docs]</a>  <span class="k">def</span> <span class="nf">scrollPoint</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Reformat the axial view to display the slice containing the currently selected point.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#productive #onButton</span>
    <span class="k">if</span> <span class="n">profiling</span><span class="p">:</span> <span class="k">print</span> <span class="s">&quot;scrollPoint&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">changeValue</span><span class="p">()</span>
    <span class="n">widget</span>      <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">NeedleFinderWidget</span>
    <span class="n">needle</span>      <span class="o">=</span> <span class="n">widget</span><span class="o">.</span><span class="n">editNeedleTxtBox</span><span class="o">.</span><span class="n">value</span>
    <span class="c">#print self.ptNumber</span>
    <span class="c">#print needle</span>
    <span class="n">coord</span>       <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">ptName</span>      <span class="o">=</span> <span class="s">&#39;.&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">needle</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;-&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ptNumber</span><span class="p">)</span>
    <span class="c">#print ptName</span>
    <span class="n">modelNode</span>   <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">getNode</span><span class="p">(</span><span class="n">ptName</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">modelNode</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ptNumber</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ptNumber</span><span class="o">+</span><span class="mi">1</span>
        <span class="k">if</span> <span class="n">modelNode</span><span class="o">.</span><span class="n">GetAttribute</span><span class="p">(</span><span class="s">&quot;ValidationNeedle&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&quot;1&quot;</span><span class="p">:</span>
          <span class="n">modelNode</span><span class="o">.</span><span class="n">GetFiducialCoordinates</span><span class="p">(</span><span class="n">coord</span><span class="p">)</span>
          <span class="n">X</span> <span class="o">=</span> <span class="n">coord</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
          <span class="n">Y</span> <span class="o">=</span> <span class="n">coord</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
          <span class="n">Z</span> <span class="o">=</span> <span class="n">coord</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    
        <span class="n">sRed</span> <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">mrmlScene</span><span class="o">.</span><span class="n">GetNodeByID</span><span class="p">(</span><span class="s">&quot;vtkMRMLSliceNodeRed&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sRed</span> <span class="o">==</span><span class="bp">None</span> <span class="p">:</span>
          <span class="n">sRed</span> <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">mrmlScene</span><span class="o">.</span><span class="n">GetNodeByID</span><span class="p">(</span><span class="s">&quot;vtkMRMLSliceNode1&quot;</span><span class="p">)</span>

        <span class="n">sYellow</span> <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">mrmlScene</span><span class="o">.</span><span class="n">GetNodeByID</span><span class="p">(</span><span class="s">&quot;vtkMRMLSliceNodeYellow&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sYellow</span> <span class="o">==</span><span class="bp">None</span> <span class="p">:</span>
          <span class="n">sYellow</span> <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">mrmlScene</span><span class="o">.</span><span class="n">GetNodeByID</span><span class="p">(</span><span class="s">&quot;vtkMRMLSliceNode2&quot;</span><span class="p">)</span>
        
        <span class="n">sGreen</span> <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">mrmlScene</span><span class="o">.</span><span class="n">GetNodeByID</span><span class="p">(</span><span class="s">&quot;vtkMRMLSliceNodeGreen&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sGreen</span> <span class="o">==</span><span class="bp">None</span> <span class="p">:</span>
          <span class="n">sGreen</span> <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">mrmlScene</span><span class="o">.</span><span class="n">GetNodeByID</span><span class="p">(</span><span class="s">&quot;vtkMRMLSliceNode3&quot;</span><span class="p">)</span>           

        <span class="n">mYellow</span><span class="o">=</span> <span class="n">sYellow</span><span class="o">.</span><span class="n">GetSliceToRAS</span><span class="p">()</span>
        <span class="n">mYellow</span><span class="o">.</span><span class="n">SetElement</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">X</span><span class="p">)</span>
        <span class="n">sYellow</span><span class="o">.</span><span class="n">Modified</span><span class="p">()</span>
        <span class="n">sYellow</span><span class="o">.</span><span class="n">UpdateMatrices</span><span class="p">()</span>

        <span class="n">mGreen</span><span class="o">=</span> <span class="n">sGreen</span><span class="o">.</span><span class="n">GetSliceToRAS</span><span class="p">()</span>
        <span class="n">mGreen</span><span class="o">.</span><span class="n">SetElement</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">Y</span><span class="p">)</span>
        <span class="n">sGreen</span><span class="o">.</span><span class="n">Modified</span><span class="p">()</span>
        <span class="n">sGreen</span><span class="o">.</span><span class="n">UpdateMatrices</span><span class="p">()</span>

        <span class="n">mRed</span><span class="o">=</span> <span class="n">sRed</span><span class="o">.</span><span class="n">GetSliceToRAS</span><span class="p">()</span>
        <span class="n">mRed</span><span class="o">.</span><span class="n">SetElement</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">Z</span><span class="p">)</span>
        <span class="n">sRed</span><span class="o">.</span><span class="n">Modified</span><span class="p">()</span>
        <span class="n">sRed</span><span class="o">.</span><span class="n">UpdateMatrices</span><span class="p">()</span>
    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">ptNumber</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ptNumber</span><span class="o">=</span><span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scrollPoint</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="NeedleFinderLogic.validationNeedle"><a class="viewcode-back" href="../NeedleFinder.html#NeedleFinder.NeedleFinderLogic.validationNeedle">[docs]</a>  <span class="k">def</span> <span class="nf">validationNeedle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; When the button &#39;new validation needle&#39; is pressed, the needle number is incremented, the needle step is reset to</span>
<span class="sd">     0</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#productive #onButton</span>
    <span class="k">if</span> <span class="n">profiling</span><span class="p">:</span> <span class="k">print</span> <span class="s">&quot;validationNeedle&quot;</span><span class="p">;</span>
    <span class="n">widget</span>      <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">NeedleFinderWidget</span>
    <span class="n">widget</span><span class="o">.</span><span class="n">validationNeedleNumber</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">widget</span><span class="o">.</span><span class="n">validationNeedleButton</span><span class="o">.</span><span class="n">text</span><span class="o">=</span> <span class="s">&quot;New Validation Needle: (&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">widget</span><span class="o">.</span><span class="n">validationNeedleNumber</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;)-&gt;(&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">widget</span><span class="o">.</span><span class="n">validationNeedleNumber</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;)&quot;</span>
    <span class="c"># self.tableValueCtrPt.append([])</span>
    <span class="n">widget</span><span class="o">.</span><span class="n">stepNeedle</span> <span class="o">=</span> <span class="mi">0</span>     

  <span class="c">#----------------------------------------------------------------------------------------------</span></div>
  <span class="sd">&quot;&quot;&quot; Needle segmentation report&quot;&quot;&quot;</span>
  <span class="c">#---------------------------------------------------------------------------------------------- </span>
  
<div class="viewcode-block" id="NeedleFinderLogic.initTableView"><a class="viewcode-back" href="../NeedleFinder.html#NeedleFinder.NeedleFinderLogic.initTableView">[docs]</a>  <span class="k">def</span> <span class="nf">initTableView</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initialize a table gathering information on segmented needles</span>
<span class="sd">    Model and view for stats table</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#productive</span>
    <span class="k">if</span> <span class="n">profiling</span><span class="p">:</span> <span class="k">print</span> <span class="s">&quot;initTableView&quot;</span><span class="p">;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">==</span><span class="bp">None</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">keys</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;Label&quot;</span><span class="p">,</span><span class="s">&quot;Round&quot;</span> <span class="p">,</span><span class="s">&quot;Reliability&quot;</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">labelStats</span> <span class="o">=</span> <span class="p">{}</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">labelStats</span><span class="p">[</span><span class="s">&#39;Labels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">qt</span><span class="o">.</span><span class="n">QStandardItemModel</span><span class="p">()</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">setColumnCount</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">setHeaderData</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">setHeaderData</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="s">&quot;Label&quot;</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">setHeaderData</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="s">&quot;R.&quot;</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">setHeaderData</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="s">&quot;Reliability&quot;</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">setHeaderData</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="s">&quot;Display&quot;</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">setHeaderData</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="s">&quot;Reformat&quot;</span><span class="p">)</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">view</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">view</span> <span class="o">=</span> <span class="n">qt</span><span class="o">.</span><span class="n">QTableView</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">setMinimumHeight</span><span class="p">(</span><span class="mi">300</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">sortingEnabled</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">verticalHeader</span><span class="p">()</span><span class="o">.</span><span class="n">visible</span> <span class="o">=</span> <span class="bp">False</span>
      <span class="c"># col = 1</span>
      <span class="c"># for k in self.keys:</span>
      <span class="c">#   # self.view.setColumnWidth(col,15*len(k))</span>
      <span class="c">#   # self.model.setHeaderData(col,1,k)</span>
      <span class="c">#   col += 1 </span>
      <span class="bp">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">setModel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">setColumnWidth</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">18</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">setColumnWidth</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">58</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">setColumnWidth</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">28</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">table</span> <span class="o">=</span> <span class="mi">1</span>
</div>
<div class="viewcode-block" id="NeedleFinderLogic.addSegmentedNeedleToTable"><a class="viewcode-back" href="../NeedleFinder.html#NeedleFinder.NeedleFinderLogic.addSegmentedNeedleToTable">[docs]</a>  <span class="k">def</span> <span class="nf">addSegmentedNeedleToTable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">needleType</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add last segmented needle to the table</span>
<span class="sd">    The color icon corresponds to the color of the needle, which corresponds to its label (color code)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#productive</span>
    <span class="k">if</span> <span class="n">profiling</span><span class="p">:</span> <span class="k">print</span> <span class="s">&quot;addSegmentedNeedleToTable&quot;</span><span class="p">;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">initTableView</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">label</span> <span class="o">!=</span><span class="bp">None</span><span class="p">:</span>
      <span class="n">ref</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">label</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">%</span> <span class="mi">60</span>
      <span class="n">needleLabel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">option</span><span class="p">[</span><span class="n">ref</span><span class="p">]</span>
      <span class="n">reliability</span> <span class="o">=</span> <span class="n">label</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">needleLabel</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">ID</span><span class="p">)</span>
      <span class="n">ref</span> <span class="o">=</span> <span class="n">ID</span> <span class="o">%</span> <span class="mi">60</span>
      <span class="n">reliability</span> <span class="o">=</span> <span class="s">&#39;-&#39;</span>
    <span class="c"># ref = int(modelNode.GetAttribute(&quot;nth&quot;))</span>
    
    <span class="bp">self</span><span class="o">.</span><span class="n">labelStats</span><span class="p">[</span><span class="s">&quot;Labels&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ref</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">labelStats</span><span class="p">[</span><span class="n">ref</span><span class="p">,</span><span class="s">&quot;Label&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">needleLabel</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">labelStats</span><span class="p">[</span><span class="n">ref</span><span class="p">,</span><span class="s">&quot;Round&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">round</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">labelStats</span><span class="p">[</span><span class="n">ref</span><span class="p">,</span><span class="s">&quot;Reliability&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">reliability</span><span class="p">)</span> 
      
    <span class="n">color</span> <span class="o">=</span> <span class="n">qt</span><span class="o">.</span><span class="n">QColor</span><span class="p">()</span>
    <span class="n">color</span><span class="o">.</span><span class="n">setRgb</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="n">ref</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="n">ref</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="n">ref</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">item</span> <span class="o">=</span> <span class="n">qt</span><span class="o">.</span><span class="n">QStandardItem</span><span class="p">()</span>
    <span class="n">item</span><span class="o">.</span><span class="n">setData</span><span class="p">(</span><span class="n">color</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">setItem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">row</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">item</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
    <span class="n">col</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">:</span>
      <span class="n">item</span> <span class="o">=</span> <span class="n">qt</span><span class="o">.</span><span class="n">QStandardItem</span><span class="p">()</span>
      <span class="n">item</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labelStats</span><span class="p">[</span><span class="n">ref</span><span class="p">,</span><span class="n">k</span><span class="p">])</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">setItem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">row</span><span class="p">,</span><span class="n">col</span><span class="p">,</span><span class="n">item</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
      <span class="n">col</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">displayButton</span> <span class="o">=</span> <span class="n">qt</span><span class="o">.</span><span class="n">QPushButton</span><span class="p">(</span><span class="s">&quot;Display&quot;</span><span class="p">)</span>
    <span class="n">displayButton</span><span class="o">.</span><span class="n">checked</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">displayButton</span><span class="o">.</span><span class="n">checkable</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">if</span> <span class="n">needleType</span><span class="o">==</span><span class="s">&#39;Validation&#39;</span><span class="p">:</span>
      <span class="n">ID</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">slicer</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">getNode</span><span class="p">(</span><span class="s">&#39;manual-seg_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ID</span><span class="p">))</span><span class="o">.</span><span class="n">GetID</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39;vtkMRMLModelNode&#39;</span><span class="p">))</span>
    <span class="n">displayButton</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&quot;clicked()&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">who</span><span class="o">=</span><span class="n">ID</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">displayNeedleTube</span><span class="p">(</span><span class="n">who</span><span class="p">))</span>
    <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">row</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">setIndexWidget</span><span class="p">(</span><span class="n">index</span><span class="p">,</span><span class="n">displayButton</span><span class="p">)</span>
    <span class="n">reformatButton</span> <span class="o">=</span> <span class="n">qt</span><span class="o">.</span><span class="n">QPushButton</span><span class="p">(</span><span class="s">&quot;Reformat&quot;</span><span class="p">)</span>
    <span class="n">reformatButton</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&quot;clicked()&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">who</span><span class="o">=</span><span class="n">ID</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">reformatSagittalView4Needle</span><span class="p">(</span><span class="n">who</span><span class="p">))</span>
    <span class="n">index2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">row</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">setIndexWidget</span><span class="p">(</span><span class="n">index2</span><span class="p">,</span><span class="n">reformatButton</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">row</span> <span class="o">+=</span> <span class="mi">1</span>  
  
    <span class="n">slicer</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">NeedleFinderWidget</span><span class="o">.</span><span class="n">analysisGroupBoxLayout</span><span class="o">.</span><span class="n">addRow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">view</span><span class="p">)</span>

  <span class="c">#-----------------------------------------------------------</span>
  <span class="c"># Radiation</span>
</div>
<div class="viewcode-block" id="NeedleFinderLogic.AddRadiation"><a class="viewcode-back" href="../NeedleFinder.html#NeedleFinder.NeedleFinderLogic.AddRadiation">[docs]</a>  <span class="k">def</span> <span class="nf">AddRadiation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">needleID</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Goal of this function is to draw quadrics simulating the dose radiation.</span>
<span class="sd">    Currently, ellipse is a too naive model.</span>
<span class="sd">    This project might be continued later</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">print</span> <span class="s">&quot;AddRadiation&quot;</span><span class="p">;</span> <span class="n">msgbox</span><span class="p">(</span><span class="s">&#39;AddRadiation&#39;</span><span class="p">)</span>
    <span class="k">pass</span>
    <span class="c"># needleNode = slicer.mrmlScene.GetNodeByID(needleID)</span>
    <span class="c"># polyData = needleNode.GetPolyData()</span>
    <span class="c"># nb = polyData.GetNumberOfPoints()</span>
    <span class="c"># base = [0,0,0]</span>
    <span class="c"># tip = [[0,0,0] for k in range(11)]</span>
    <span class="c"># if nb&gt;100:</span>
      
      <span class="c"># polyData.GetPoint(nb-1,tip[10])</span>
      <span class="c"># polyData.GetPoint(0,base)</span>
    
    <span class="c"># a = tip[10][0]-base[0]</span>
    <span class="c"># b = tip[10][1]-base[1]</span>
    <span class="c"># c = tip[10][2]-base[2]</span>
    
    <span class="c"># for l in range(7):</span>
      <span class="c"># tip[9-l][0] = tip[10][0]-0.1*a*(l+1)</span>
      <span class="c"># tip[9-l][1] = tip[10][1]-0.1*b*(l+1)</span>
      <span class="c"># tip[9-l][2] = tip[10][2]-0.1*c*(l+1)</span>
    <span class="c"># for l in range(1,3):</span>
      <span class="c"># tip[l][0] = tip[10][0]+0.1*a*l</span>
      <span class="c"># tip[l][1] = tip[10][1]+0.1*b*l</span>
      <span class="c"># tip[l][2] = tip[10][2]+0.1*c*l</span>
         
    <span class="c"># rad = vtk.vtkAppendPolyData()  </span>
    
    <span class="c"># for l in range(1,11):</span>
      <span class="c"># TransformPolyDataFilter=vtk.vtkTransformPolyDataFilter()</span>
      <span class="c"># Transform=vtk.vtkTransform()        </span>
      <span class="c"># TransformPolyDataFilter.SetInput(self.m_polyRadiation)</span>

      <span class="c"># vtkmat = Transform.GetMatrix()</span>
      <span class="c"># vtkmat.SetElement(0,3,tip[l][0])</span>
      <span class="c"># vtkmat.SetElement(1,3,tip[l][1])</span>
      <span class="c"># vtkmat.SetElement(2,3,tip[l][2])</span>
      <span class="c"># TransformPolyDataFilter.SetTransform(Transform)</span>
      <span class="c"># TransformPolyDataFilter.Update()</span>
    
      <span class="c"># rad.AddInput(TransformPolyDataFilter.GetOutput())</span>
    
    <span class="c"># modelNode = slicer.vtkMRMLModelNode()</span>
    <span class="c"># displayNode = slicer.vtkMRMLModelDisplayNode()</span>
    <span class="c"># storageNode = slicer.vtkMRMLModelStorageNode()</span>
 
    <span class="c"># fileName = &#39;Rad&#39;+self.option[i]+&#39;.vtk&#39;</span>

    <span class="c"># mrmlScene = slicer.mrmlScene</span>
    <span class="c"># modelNode.SetName(fileName)</span>
    <span class="c"># modelNode.SetAttribute(&quot;radiation&quot;,&quot;segmented&quot;)</span>
    <span class="c"># modelNode.SetAttribute(&quot;needleID&quot;,str(needleID))    </span>
    <span class="c"># modelNode.SetAndObservePolyData(rad.GetOutput()) </span>

    <span class="c"># modelNode.SetScene(mrmlScene)</span>
    <span class="c"># storageNode.SetScene(mrmlScene)</span>
    <span class="c"># storageNode.SetFileName(fileName)  </span>
    <span class="c"># displayNode.SetScene(mrmlScene)</span>
    <span class="c"># displayNode.SetVisibility(0)</span>
    <span class="c"># mrmlScene.AddNode(storageNode)</span>
    <span class="c"># mrmlScene.AddNode(displayNode)</span>
    <span class="c"># mrmlScene.AddNode(modelNode)</span>
    <span class="c"># modelNode.SetAndObserveStorageNodeID(storageNode.GetID())</span>
    <span class="c"># modelNode.SetAndObserveDisplayNodeID(displayNode.GetID())</span>
    
    <span class="c"># displayNode.SetPolyData(modelNode.GetPolyData())</span>

    <span class="c"># displayNode.SetSliceIntersectionVisibility(0)</span>
    <span class="c"># displayNode.SetScalarVisibility(1)</span>
    <span class="c"># displayNode.SetActiveScalarName(&#39;scalars&#39;)</span>
    <span class="c"># displayNode.SetScalarRange(0,230)</span>
    <span class="c"># displayNode.SetOpacity(0.06)</span>
    <span class="c"># displayNode.SetAndObserveColorNodeID(&#39;vtkMRMLColorTableNodeFileHotToColdRainbow.txt&#39;)</span>
    <span class="c"># displayNode.SetBackfaceCulling(0)</span>
    <span class="c"># pNode= self.parameterNode()</span>
    <span class="c"># pNode.SetParameter(fileName,modelNode.GetID())</span>
    <span class="c"># mrmlScene.AddNode(modelNode)</span>
    
  <span class="c">#----------------------------------------------------------------------------------------------</span></div>
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  The purpose of the following functions is to process the results of the needle segmentation from </span>
<span class="sd">  Yi Gao&#39;s CLI module.</span>
<span class="sd">  Currently, another solution has been chosen but this could be usefull again later.</span>
<span class="sd">  To use it, simply uncommented the corresponding buttons in &quot;createUserInterface&quot;</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="c">#----------------------------------------------------------------------------------------------</span>
  
<div class="viewcode-block" id="NeedleFinderLogic.needleSegmentation"><a class="viewcode-back" href="../NeedleFinder.html#NeedleFinder.NeedleFinderLogic.needleSegmentation">[docs]</a>  <span class="k">def</span> <span class="nf">needleSegmentation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ???</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">print</span> <span class="s">&quot;needleSegmentation&quot;</span><span class="p">;</span> <span class="n">msgbox</span><span class="p">(</span><span class="s">&#39;needleSegmentation&#39;</span><span class="p">)</span>
    <span class="n">widget</span> <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">NeedleFinderWidget</span>
    <span class="n">scene</span> <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">mrmlScene</span>
    <span class="n">pNode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameterNode</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">slicer</span><span class="o">.</span><span class="n">mrmlScene</span><span class="o">.</span><span class="n">GetNodeByID</span><span class="p">(</span><span class="n">pNode</span><span class="o">.</span><span class="n">GetParameter</span><span class="p">(</span><span class="s">&quot;baselineVolumeID&quot;</span><span class="p">))</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">inputVolume</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__volumeSelector</span><span class="o">.</span><span class="n">currentNode</span><span class="p">()</span>
      <span class="n">inputVolumeID</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__volumeSelector</span><span class="o">.</span><span class="n">currentNode</span><span class="p">()</span><span class="o">.</span><span class="n">GetID</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">inputVolume</span> <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">mrmlScene</span><span class="o">.</span><span class="n">GetNodeByID</span><span class="p">(</span><span class="n">pNode</span><span class="o">.</span><span class="n">GetParameter</span><span class="p">(</span><span class="s">&quot;baselineVolumeID&quot;</span><span class="p">))</span>
      <span class="n">inputVolumeID</span> <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">mrmlScene</span><span class="o">.</span><span class="n">GetNodeByID</span><span class="p">(</span><span class="n">pNode</span><span class="o">.</span><span class="n">GetParameter</span><span class="p">(</span><span class="s">&quot;baselineVolumeID&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">GetID</span><span class="p">()</span>
    <span class="n">inputLabelID</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__needleLabelSelector</span><span class="o">.</span><span class="n">currentNode</span><span class="p">()</span><span class="o">.</span><span class="n">GetID</span><span class="p">()</span>
    
    <span class="n">datetime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%Y-%m-</span><span class="si">%d</span><span class="s">-%H_%M_%S&quot;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">())</span>
    
    <span class="n">inputVolume</span><span class="o">.</span><span class="n">SetAttribute</span><span class="p">(</span><span class="s">&quot;foldername&quot;</span><span class="p">,</span><span class="n">datetime</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">outputVolumeNode</span> <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">mrmlScene</span><span class="o">.</span><span class="n">CreateNodeByClass</span><span class="p">(</span><span class="s">&#39;vtkMRMLModelNode&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">outputVolumeNode</span><span class="o">.</span><span class="n">SetName</span><span class="p">(</span><span class="s">&quot;Output Needle Model&quot;</span><span class="p">)</span>
    <span class="n">outputVolumeStorageNode</span> <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">mrmlScene</span><span class="o">.</span><span class="n">CreateNodeByClass</span><span class="p">(</span><span class="s">&#39;vtkMRMLModelStorageNode&#39;</span><span class="p">)</span>
    <span class="n">slicer</span><span class="o">.</span><span class="n">mrmlScene</span><span class="o">.</span><span class="n">AddNode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outputVolumeNode</span><span class="p">)</span>
    <span class="n">slicer</span><span class="o">.</span><span class="n">mrmlScene</span><span class="o">.</span><span class="n">AddNode</span><span class="p">(</span><span class="n">outputVolumeStorageNode</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">outputVolumeNode</span><span class="o">.</span><span class="n">AddAndObserveStorageNodeID</span><span class="p">(</span><span class="n">outputVolumeStorageNode</span><span class="o">.</span><span class="n">GetID</span><span class="p">())</span>
    <span class="n">outputVolumeStorageNode</span><span class="o">.</span><span class="n">WriteData</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outputVolumeNode</span><span class="p">)</span>
    
    <span class="n">outputID</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputVolumeNode</span><span class="o">.</span><span class="n">GetID</span><span class="p">()</span>
    
    <span class="bp">self</span><span class="o">.</span><span class="n">foldername</span> <span class="o">=</span> <span class="s">&#39;/NeedleModels/&#39;</span> <span class="o">+</span> <span class="n">datetime</span>
    
    <span class="c"># Set the parameters for the CLI module    </span>
    <span class="n">parameters</span> <span class="o">=</span> <span class="p">{}</span> 
    <span class="n">parameters</span><span class="p">[</span><span class="s">&#39;inputVolume&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">inputVolumeID</span>
    <span class="n">parameters</span><span class="p">[</span><span class="s">&#39;inputLabel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">inputLabelID</span>
    <span class="n">parameters</span><span class="p">[</span><span class="s">&#39;outputVtk&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">outputID</span>
    <span class="n">parameters</span><span class="p">[</span><span class="s">&#39;outputFolderName&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">foldername</span>
    <span class="n">parameters</span><span class="p">[</span><span class="s">&#39;nbPointsPerLine&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nbPointsPerLine</span><span class="o">.</span><span class="n">value</span>
    <span class="n">parameters</span><span class="p">[</span><span class="s">&#39;nbRadiusIterations&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nbRadiusIterations</span><span class="o">.</span><span class="n">value</span>
    <span class="n">parameters</span><span class="p">[</span><span class="s">&#39;distanceMax&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">distanceMax</span><span class="o">.</span><span class="n">value</span>
    <span class="n">parameters</span><span class="p">[</span><span class="s">&#39;numberOfPointsPerNeedle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">numberOfPointsPerNeedle</span><span class="o">.</span><span class="n">value</span>
    <span class="n">parameters</span><span class="p">[</span><span class="s">&#39;nbRotatingIterations&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nbRotatingIterations</span><span class="o">.</span><span class="n">value</span>
    
    <span class="n">module</span> <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">mainlabelneedletrackingcli</span> 
    <span class="bp">self</span><span class="o">.</span><span class="n">__cliNode</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__cliNode</span> <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">wait_for_completion</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        
    <span class="c">##### match the needles ######</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">setNeedleCoordinates</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">computerPolydataAndMatrix</span><span class="p">()</span>
    <span class="n">xmin</span>        <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">xmax</span>        <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">ymin</span>        <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">ymax</span>        <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">xdelta</span>      <span class="o">=</span> <span class="n">xmax</span> <span class="o">-</span> <span class="n">xmin</span>
    <span class="n">ydelta</span>      <span class="o">=</span> <span class="n">ymax</span> <span class="o">-</span> <span class="n">ymin</span>
    <span class="n">k</span>           <span class="o">=</span> <span class="mi">0</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">base</span>           <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">63</span><span class="p">)]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">tip</span>            <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">63</span><span class="p">)]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">needlenode</span>     <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">)]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">63</span><span class="p">)]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">bentNeedleNode</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">)]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">63</span><span class="p">)]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">displaynode</span>    <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">63</span><span class="p">)]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">displaynodeB</span>   <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">63</span><span class="p">)]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fiducialnode</span>   <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">63</span><span class="p">)]</span>
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">63</span><span class="p">):</span>

      <span class="n">pathneedle</span>                <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">foldername</span><span class="o">+</span><span class="s">&#39;/&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;.vtp&#39;</span>
      <span class="n">pathBentNeedle</span>            <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">foldername</span><span class="o">+</span><span class="s">&#39;/&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;_bent.vtp&#39;</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">needlenode</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>        <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">loadModel</span><span class="p">(</span><span class="n">pathneedle</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">bentNeedleNode</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>    <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">loadModel</span><span class="p">(</span><span class="n">pathBentNeedle</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>

      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">needlenode</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="bp">True</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">needlenode</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">displaynode</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>     <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">needlenode</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">GetDisplayNode</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">displaynodeB</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>    <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bentNeedleNode</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">GetDisplayNode</span><span class="p">()</span>

         
        <span class="n">polydata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">needlenode</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">GetPolyData</span><span class="p">()</span>
        <span class="n">polydata</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>        
      
        <span class="bp">self</span><span class="o">.</span><span class="n">displaynode</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">SliceIntersectionVisibilityOn</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">displaynodeB</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">SliceIntersectionVisibilityOn</span><span class="p">()</span>
        <span class="n">bestmatch</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">mindist</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">63</span><span class="p">):</span>
          <span class="n">delta</span> <span class="o">=</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">-</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
          <span class="k">if</span> <span class="n">delta</span> <span class="o">&lt;</span> <span class="n">mindist</span> <span class="ow">or</span> <span class="n">mindist</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">bestmatch</span> <span class="o">=</span> <span class="n">j</span>
            <span class="n">mindist</span> <span class="o">=</span> <span class="n">delta</span>
        
        <span class="n">bestmatch</span>   <span class="o">=</span> <span class="n">k</span>
        <span class="n">k</span>           <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">displaynode</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">SetColor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">color</span><span class="p">[</span><span class="n">bestmatch</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">displaynodeB</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">SetColor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">color</span><span class="p">[</span><span class="n">bestmatch</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">needlenode</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">SetName</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">option</span><span class="p">[</span><span class="n">bestmatch</span><span class="p">]</span><span class="o">+</span><span class="s">&quot;_segmented&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bentNeedleNode</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">SetName</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">option</span><span class="p">[</span><span class="n">bestmatch</span><span class="p">]</span><span class="o">+</span><span class="s">&quot;_optimized&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">needlenode</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">SetAttribute</span><span class="p">(</span><span class="s">&quot;segmented&quot;</span><span class="p">,</span><span class="s">&quot;1&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bentNeedleNode</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">SetAttribute</span><span class="p">(</span><span class="s">&quot;optimized&quot;</span><span class="p">,</span><span class="s">&quot;1&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">needlenode</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">SetAttribute</span><span class="p">(</span><span class="s">&quot;nth&quot;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">bestmatch</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bentNeedleNode</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">SetAttribute</span><span class="p">(</span><span class="s">&quot;nth&quot;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">bestmatch</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">needlenode</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">SetAttribute</span><span class="p">(</span><span class="s">&quot;needleID&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">needlenode</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">GetID</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bentNeedleNode</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">SetAttribute</span><span class="p">(</span><span class="s">&quot;needleID&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">bentNeedleNode</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">GetID</span><span class="p">())</span>
 
    <span class="k">if</span> <span class="n">widget</span><span class="o">.</span><span class="n">removeDuplicates</span><span class="o">.</span><span class="n">isChecked</span><span class="p">():</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">positionFilteringNeedles</span><span class="p">()</span>

    <span class="n">d</span> <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">mrmlScene</span><span class="o">.</span><span class="n">GetNodeByID</span><span class="p">(</span><span class="n">outputID</span><span class="p">)</span><span class="o">.</span><span class="n">GetDisplayNode</span><span class="p">()</span>
    <span class="n">d</span><span class="o">.</span><span class="n">SetVisibility</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    
    <span class="bp">self</span><span class="o">.</span><span class="n">__editorFrame</span><span class="o">.</span><span class="n">collapsed</span> <span class="o">=</span> <span class="mi">1</span>
    
    <span class="bp">self</span><span class="o">.</span><span class="n">addButtons</span><span class="p">()</span>
  </div>
<div class="viewcode-block" id="NeedleFinderLogic.addButtons"><a class="viewcode-back" href="../NeedleFinder.html#NeedleFinder.NeedleFinderLogic.addButtons">[docs]</a>  <span class="k">def</span> <span class="nf">addButtons</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Buttons for the reporting widget, displaying information of the segmented needles</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">print</span> <span class="s">&quot;addButtons&quot;</span><span class="p">;</span> <span class="n">msgbox</span><span class="p">(</span><span class="s">&#39;addButtons&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">buttonsGroupBox</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">removeWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buttonsGroupBox</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">buttonsGroupBox</span><span class="o">.</span><span class="n">deleteLater</span><span class="p">()</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">buttonsGroupBox</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">buttonsGroupBox</span> <span class="o">=</span> <span class="n">qt</span><span class="o">.</span><span class="n">QGroupBox</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">buttonsGroupBox</span><span class="o">.</span><span class="n">setTitle</span><span class="p">(</span> <span class="s">&#39;Manage Needles&#39;</span> <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">addRow</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">buttonsGroupBox</span> <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">buttonsGroupBoxLayout</span> <span class="o">=</span> <span class="n">qt</span><span class="o">.</span><span class="n">QFormLayout</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">buttonsGroupBox</span> <span class="p">)</span>
    
    <span class="n">modelNodes</span> <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">getNodes</span><span class="p">(</span><span class="s">&#39;vtkMRMLModelNode*&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">modelNode</span> <span class="ow">in</span> <span class="n">modelNodes</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
      <span class="k">if</span> <span class="n">modelNode</span><span class="o">.</span><span class="n">GetAttribute</span><span class="p">(</span><span class="s">&quot;segmented&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&quot;1&quot;</span><span class="p">:</span>
        <span class="n">i</span>                           <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">modelNode</span><span class="o">.</span><span class="n">GetAttribute</span><span class="p">(</span><span class="s">&quot;nth&quot;</span><span class="p">))</span>
        <span class="n">buttonDisplay</span>               <span class="o">=</span> <span class="n">qt</span><span class="o">.</span><span class="n">QPushButton</span><span class="p">(</span><span class="s">&quot;Hide &quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">option</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">buttonBentDisplay</span>           <span class="o">=</span> <span class="n">qt</span><span class="o">.</span><span class="n">QPushButton</span><span class="p">(</span><span class="s">&quot;Hide Bent &quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">option</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">buttonDisplay</span><span class="o">.</span><span class="n">checkable</span>     <span class="o">=</span> <span class="bp">True</span>
        <span class="n">buttonBentDisplay</span><span class="o">.</span><span class="n">checkable</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="k">if</span> <span class="n">modelNode</span><span class="o">.</span><span class="n">GetDisplayVisibility</span><span class="p">()</span> <span class="o">==</span><span class="mi">0</span><span class="p">:</span>
          <span class="n">buttonDisplay</span><span class="o">.</span><span class="n">setChecked</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">buttonDisplay</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&quot;clicked()&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">who</span><span class="o">=</span><span class="n">i</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">displayNeedle</span><span class="p">(</span><span class="n">who</span><span class="p">))</span>
        <span class="n">buttonBentDisplay</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&quot;clicked()&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">who</span><span class="o">=</span><span class="n">i</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">displayBentNeedle</span><span class="p">(</span><span class="n">who</span><span class="p">))</span>
        <span class="n">buttonReformat</span> <span class="o">=</span> <span class="n">qt</span><span class="o">.</span><span class="n">QPushButton</span><span class="p">(</span><span class="s">&quot;Reformat &quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">option</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">buttonReformat</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&quot;clicked()&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">who</span><span class="o">=</span><span class="n">i</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">reformatNeedle</span><span class="p">(</span><span class="n">who</span><span class="p">))</span>
        <span class="n">widgets</span> <span class="o">=</span> <span class="n">qt</span><span class="o">.</span><span class="n">QWidget</span><span class="p">()</span>
        <span class="n">hlay</span>    <span class="o">=</span> <span class="n">qt</span><span class="o">.</span><span class="n">QHBoxLayout</span><span class="p">(</span><span class="n">widgets</span><span class="p">)</span>
        <span class="n">hlay</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">buttonDisplay</span><span class="p">)</span>
        <span class="n">hlay</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">buttonBentDisplay</span><span class="p">)</span>
        <span class="n">hlay</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">buttonReformat</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buttonsGroupBoxLayout</span><span class="o">.</span><span class="n">addRow</span><span class="p">(</span><span class="n">widgets</span><span class="p">)</span>
  </div>
<div class="viewcode-block" id="NeedleFinderLogic.displayBentNeedle"><a class="viewcode-back" href="../NeedleFinder.html#NeedleFinder.NeedleFinderLogic.displayBentNeedle">[docs]</a>  <span class="k">def</span> <span class="nf">displayBentNeedle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">i</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ??? not used anymore. works with Yi Gao CLI module for straight needle detection + bending post-computed</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">print</span> <span class="s">&quot;displayBentNeedle&quot;</span><span class="p">;</span> <span class="n">msgbox</span><span class="p">(</span><span class="s">&#39;displayBentNeedle&#39;</span><span class="p">)</span>
    <span class="n">modelNodes</span> <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">getNodes</span><span class="p">(</span><span class="s">&#39;vtkMRMLModelNode*&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">modelNode</span> <span class="ow">in</span> <span class="n">modelNodes</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
      <span class="k">if</span> <span class="n">modelNode</span><span class="o">.</span><span class="n">GetAttribute</span><span class="p">(</span><span class="s">&quot;nth&quot;</span><span class="p">)</span><span class="o">==</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="ow">and</span> <span class="n">modelNode</span><span class="o">.</span><span class="n">GetAttribute</span><span class="p">(</span><span class="s">&quot;optimized&quot;</span><span class="p">)</span><span class="o">==</span><span class="s">&#39;1&#39;</span> <span class="p">:</span>
        <span class="n">displayNode</span> <span class="o">=</span> <span class="n">modelNode</span><span class="o">.</span><span class="n">GetModelDisplayNode</span><span class="p">()</span>
        <span class="n">nVisibility</span> <span class="o">=</span> <span class="n">displayNode</span><span class="o">.</span><span class="n">GetVisibility</span><span class="p">()</span>
        <span class="c"># print nVisibility</span>
        <span class="k">if</span> <span class="n">nVisibility</span><span class="p">:</span>
          <span class="n">displayNode</span><span class="o">.</span><span class="n">SliceIntersectionVisibilityOff</span><span class="p">()</span>
          <span class="n">displayNode</span><span class="o">.</span><span class="n">SetVisibility</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">displayNode</span><span class="o">.</span><span class="n">SliceIntersectionVisibilityOn</span><span class="p">()</span>
          <span class="n">displayNode</span><span class="o">.</span><span class="n">SetVisibility</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
  </div>
<div class="viewcode-block" id="NeedleFinderLogic.displayNeedle"><a class="viewcode-back" href="../NeedleFinder.html#NeedleFinder.NeedleFinderLogic.displayNeedle">[docs]</a>  <span class="k">def</span> <span class="nf">displayNeedle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">i</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ??? not used anymore. works with Yi Gao CLI module for straight needle detection + bending post-computed</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">print</span> <span class="s">&quot;displayNeedle&quot;</span><span class="p">;</span> <span class="n">msgbox</span><span class="p">(</span><span class="s">&#39;displayNeedle&#39;</span><span class="p">)</span>
    <span class="n">modelNodes</span> <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">getNodes</span><span class="p">(</span><span class="s">&#39;vtkMRMLModelNode*&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">modelNode</span> <span class="ow">in</span> <span class="n">modelNodes</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
      <span class="k">if</span> <span class="n">modelNode</span><span class="o">.</span><span class="n">GetAttribute</span><span class="p">(</span><span class="s">&quot;nth&quot;</span><span class="p">)</span><span class="o">==</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="ow">and</span> <span class="n">modelNode</span><span class="o">.</span><span class="n">GetAttribute</span><span class="p">(</span><span class="s">&quot;segmented&quot;</span><span class="p">)</span><span class="o">==</span><span class="s">&#39;1&#39;</span> <span class="p">:</span>
        <span class="n">displayNode</span> <span class="o">=</span> <span class="n">modelNode</span><span class="o">.</span><span class="n">GetModelDisplayNode</span><span class="p">()</span>
        <span class="n">nVisibility</span> <span class="o">=</span> <span class="n">displayNode</span><span class="o">.</span><span class="n">GetVisibility</span><span class="p">()</span>
       
        <span class="k">if</span> <span class="n">nVisibility</span><span class="p">:</span>
          <span class="n">displayNode</span><span class="o">.</span><span class="n">SliceIntersectionVisibilityOff</span><span class="p">()</span>
          <span class="n">displayNode</span><span class="o">.</span><span class="n">SetVisibility</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">displayNode</span><span class="o">.</span><span class="n">SliceIntersectionVisibilityOn</span><span class="p">()</span>
          <span class="n">displayNode</span><span class="o">.</span><span class="n">SetVisibility</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
      </div>
<div class="viewcode-block" id="NeedleFinderLogic.showOneNeedle"><a class="viewcode-back" href="../NeedleFinder.html#NeedleFinder.NeedleFinderLogic.showOneNeedle">[docs]</a>  <span class="k">def</span> <span class="nf">showOneNeedle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">visibility</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ??? Not used anymore. But can be usefull later</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">print</span> <span class="s">&quot;showOneNeedle&quot;</span><span class="p">;</span> <span class="n">msgbox</span><span class="p">(</span><span class="s">&#39;showOneNeedle&#39;</span><span class="p">)</span>
    <span class="n">fidname</span> <span class="o">=</span> <span class="s">&quot;fid&quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">option</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">pNode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameterNode</span><span class="p">()</span>
    <span class="n">needleID</span> <span class="o">=</span> <span class="n">pNode</span><span class="o">.</span><span class="n">GetParameter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">option</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="s">&#39;.vtp&#39;</span><span class="p">)</span>
    <span class="n">fidID</span> <span class="o">=</span> <span class="n">pNode</span><span class="o">.</span><span class="n">GetParameter</span><span class="p">(</span><span class="n">fidname</span><span class="p">)</span>    
    <span class="n">NeedleNode</span> <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">mrmlScene</span><span class="o">.</span><span class="n">GetNodeByID</span><span class="p">(</span><span class="n">needleID</span><span class="p">)</span>
    <span class="n">fiducialNode</span> <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">mrmlScene</span><span class="o">.</span><span class="n">GetNodeByID</span><span class="p">(</span><span class="n">fidID</span><span class="p">)</span>    
    
    <span class="k">if</span> <span class="n">NeedleNode</span> <span class="o">!=</span><span class="bp">None</span><span class="p">:</span>
      <span class="n">displayNode</span> <span class="o">=</span><span class="n">NeedleNode</span><span class="o">.</span><span class="n">GetModelDisplayNode</span><span class="p">()</span>
      <span class="n">nVisibility</span><span class="o">=</span><span class="n">displayNode</span><span class="o">.</span><span class="n">GetVisibility</span><span class="p">()</span>  

      <span class="k">if</span> <span class="n">fiducialNode</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">displayNode</span><span class="o">.</span><span class="n">SetVisibility</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>    
        <span class="n">displayNode</span><span class="o">.</span><span class="n">SetOpacity</span><span class="p">(</span><span class="mf">0.9</span><span class="p">)</span>
        <span class="n">polyData</span> <span class="o">=</span> <span class="n">NeedleNode</span><span class="o">.</span><span class="n">GetPolyData</span><span class="p">()</span>
        <span class="n">polyData</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>
        <span class="n">nb</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">polyData</span><span class="o">.</span><span class="n">GetNumberOfPoints</span><span class="p">()</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">coord</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">nb</span><span class="o">&gt;</span><span class="mi">100</span><span class="p">:</span>
          <span class="n">fiducialNode</span> <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">vtkMRMLAnnotationFiducialNode</span><span class="p">()</span>
          <span class="n">polyData</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="n">nb</span><span class="p">,</span><span class="n">coord</span><span class="p">)</span>    
          <span class="n">fiducialNode</span><span class="o">.</span><span class="n">SetName</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">option</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
          <span class="n">fiducialNode</span><span class="o">.</span><span class="n">SetFiducialCoordinates</span><span class="p">(</span><span class="n">coord</span><span class="p">)</span>         
          <span class="n">fiducialNode</span><span class="o">.</span><span class="n">Initialize</span><span class="p">(</span><span class="n">slicer</span><span class="o">.</span><span class="n">mrmlScene</span><span class="p">)</span>
          <span class="n">fiducialNode</span><span class="o">.</span><span class="n">SetLocked</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
          <span class="n">fiducialNode</span><span class="o">.</span><span class="n">SetSelectable</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
          <span class="n">fidDN</span> <span class="o">=</span> <span class="n">fiducialNode</span><span class="o">.</span><span class="n">GetDisplayNode</span><span class="p">()</span>
          <span class="n">fidDN</span><span class="o">.</span><span class="n">SetColor</span><span class="p">(</span><span class="n">NeedleNode</span><span class="o">.</span><span class="n">GetDisplayNode</span><span class="p">()</span><span class="o">.</span><span class="n">GetColor</span><span class="p">())</span>
          <span class="n">fidDN</span><span class="o">.</span><span class="n">SetGlyphScale</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
          <span class="n">fidTN</span> <span class="o">=</span> <span class="n">fiducialNode</span><span class="o">.</span><span class="n">GetAnnotationTextDisplayNode</span><span class="p">()</span>
          <span class="n">fidTN</span><span class="o">.</span><span class="n">SetTextScale</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
          <span class="n">fidTN</span><span class="o">.</span><span class="n">SetColor</span><span class="p">(</span><span class="n">NeedleNode</span><span class="o">.</span><span class="n">GetDisplayNode</span><span class="p">()</span><span class="o">.</span><span class="n">GetColor</span><span class="p">())</span>
          <span class="n">fiducialNode</span><span class="o">.</span><span class="n">SetDisplayVisibility</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
          <span class="n">pNode</span><span class="o">.</span><span class="n">SetParameter</span><span class="p">(</span><span class="n">fidname</span><span class="p">,</span><span class="n">fiducialNode</span><span class="o">.</span><span class="n">GetID</span><span class="p">())</span>
          <span class="n">fiducialNode</span><span class="o">.</span><span class="n">SetDisplayVisibility</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

      <span class="k">if</span> <span class="n">visibility</span> <span class="o">==</span><span class="mi">0</span><span class="p">:</span>

        <span class="n">displayNode</span><span class="o">.</span><span class="n">SetVisibility</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">displayNode</span><span class="o">.</span><span class="n">SetSliceIntersectionVisibility</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fiducialNode</span><span class="o">!=</span><span class="bp">None</span><span class="p">:</span>
          <span class="n">fiducialNode</span><span class="o">.</span><span class="n">SetDisplayVisibility</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

      <span class="k">else</span><span class="p">:</span>

        <span class="n">displayNode</span><span class="o">.</span><span class="n">SetVisibility</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">displayNode</span><span class="o">.</span><span class="n">SetSliceIntersectionVisibility</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fiducialNode</span><span class="o">!=</span><span class="bp">None</span><span class="p">:</span>
          <span class="n">fiducialNode</span><span class="o">.</span><span class="n">SetDisplayVisibility</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
      <span class="n">vtkmat</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkMatrix4x4</span><span class="p">()</span>
      <span class="n">vtkmat</span><span class="o">.</span><span class="n">DeepCopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m_vtkmat</span><span class="p">)</span>
      <span class="n">vtkmat</span><span class="o">.</span><span class="n">SetElement</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">m_vtkmat</span><span class="o">.</span><span class="n">GetElement</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
      <span class="n">vtkmat</span><span class="o">.</span><span class="n">SetElement</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">m_vtkmat</span><span class="o">.</span><span class="n">GetElement</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
      <span class="n">vtkmat</span><span class="o">.</span><span class="n">SetElement</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">m_vtkmat</span><span class="o">.</span><span class="n">GetElement</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="mf">30.0</span><span class="o">-</span><span class="mf">150.0</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)</span>

      <span class="n">TransformPolyDataFilter</span><span class="o">=</span><span class="n">vtk</span><span class="o">.</span><span class="n">vtkTransformPolyDataFilter</span><span class="p">()</span>
      <span class="n">Transform</span><span class="o">=</span><span class="n">vtk</span><span class="o">.</span><span class="n">vtkTransform</span><span class="p">()</span>        
      <span class="n">TransformPolyDataFilter</span><span class="o">.</span><span class="n">SetInput</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m_polyCylinder</span><span class="p">)</span>
      <span class="n">Transform</span><span class="o">.</span><span class="n">SetMatrix</span><span class="p">(</span><span class="n">vtkmat</span><span class="p">)</span>
      <span class="n">TransformPolyDataFilter</span><span class="o">.</span><span class="n">SetTransform</span><span class="p">(</span><span class="n">Transform</span><span class="p">)</span>
      <span class="n">TransformPolyDataFilter</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>

      <span class="n">triangles</span><span class="o">=</span><span class="n">vtk</span><span class="o">.</span><span class="n">vtkTriangleFilter</span><span class="p">()</span>
      <span class="n">triangles</span><span class="o">.</span><span class="n">SetInput</span><span class="p">(</span><span class="n">TransformPolyDataFilter</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">())</span>  
      <span class="bp">self</span><span class="o">.</span><span class="n">AddModel</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">triangles</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">())</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">showOneNeedle</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">visibility</span><span class="p">)</span>
            </div>
<div class="viewcode-block" id="NeedleFinderLogic.AddModel"><a class="viewcode-back" href="../NeedleFinder.html#NeedleFinder.NeedleFinderLogic.AddModel">[docs]</a>  <span class="k">def</span> <span class="nf">AddModel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">polyData</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Not used. Check if can be removed</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">print</span> <span class="s">&quot;AddModel&quot;</span><span class="p">;</span> <span class="n">msgbox</span><span class="p">(</span><span class="s">&#39;AddModel&#39;</span><span class="p">)</span>
    <span class="n">modelNode</span> <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">vtkMRMLModelNode</span><span class="p">()</span>
    <span class="n">displayNode</span> <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">vtkMRMLModelDisplayNode</span><span class="p">()</span>
    <span class="n">storageNode</span> <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">vtkMRMLModelStorageNode</span><span class="p">()</span>
 
    <span class="n">fileName</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">option</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="s">&#39;.vtp&#39;</span>

    <span class="n">mrmlScene</span> <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">mrmlScene</span>
    <span class="n">modelNode</span><span class="o">.</span><span class="n">SetName</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>  
    <span class="n">modelNode</span><span class="o">.</span><span class="n">SetAndObservePolyData</span><span class="p">(</span><span class="n">polyData</span><span class="p">)</span>
    <span class="n">modelNode</span><span class="o">.</span><span class="n">SetAttribute</span><span class="p">(</span><span class="s">&quot;planned&quot;</span><span class="p">,</span><span class="s">&quot;1&quot;</span><span class="p">)</span>
    
    <span class="n">mrmlScene</span><span class="o">.</span><span class="n">SaveStateForUndo</span><span class="p">()</span>
    <span class="n">modelNode</span><span class="o">.</span><span class="n">SetScene</span><span class="p">(</span><span class="n">mrmlScene</span><span class="p">)</span>
    <span class="n">storageNode</span><span class="o">.</span><span class="n">SetScene</span><span class="p">(</span><span class="n">mrmlScene</span><span class="p">)</span>
    <span class="n">storageNode</span><span class="o">.</span><span class="n">SetFileName</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>  
    <span class="n">displayNode</span><span class="o">.</span><span class="n">SetScene</span><span class="p">(</span><span class="n">mrmlScene</span><span class="p">)</span>
    <span class="n">displayNode</span><span class="o">.</span><span class="n">SetVisibility</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">mrmlScene</span><span class="o">.</span><span class="n">AddNode</span><span class="p">(</span><span class="n">storageNode</span><span class="p">)</span>
    <span class="n">mrmlScene</span><span class="o">.</span><span class="n">AddNode</span><span class="p">(</span><span class="n">displayNode</span><span class="p">)</span>
    <span class="n">mrmlScene</span><span class="o">.</span><span class="n">AddNode</span><span class="p">(</span><span class="n">modelNode</span><span class="p">)</span>
    <span class="n">modelNode</span><span class="o">.</span><span class="n">SetAndObserveStorageNodeID</span><span class="p">(</span><span class="n">storageNode</span><span class="o">.</span><span class="n">GetID</span><span class="p">())</span>
    <span class="n">modelNode</span><span class="o">.</span><span class="n">SetAndObserveDisplayNodeID</span><span class="p">(</span><span class="n">displayNode</span><span class="o">.</span><span class="n">GetID</span><span class="p">())</span>
    
    <span class="n">displayNode</span><span class="o">.</span><span class="n">SetColor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">color</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">displayNode</span><span class="o">.</span><span class="n">SetSliceIntersectionVisibility</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">pNode</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameterNode</span><span class="p">()</span>
    <span class="n">pNode</span><span class="o">.</span><span class="n">SetParameter</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span><span class="n">modelNode</span><span class="o">.</span><span class="n">GetID</span><span class="p">())</span>
    <span class="n">mrmlScene</span><span class="o">.</span><span class="n">AddNode</span><span class="p">(</span><span class="n">modelNode</span><span class="p">)</span>
    <span class="n">displayNode</span><span class="o">.</span><span class="n">SetVisibility</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="NeedleFinderLogic.displayRadPlanned"><a class="viewcode-back" href="../NeedleFinder.html#NeedleFinder.NeedleFinderLogic.displayRadPlanned">[docs]</a>  <span class="k">def</span> <span class="nf">displayRadPlanned</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Display &#39;radiation&#39; of planned needle -&gt; cf iGyne / not used anymore</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">print</span> <span class="s">&quot;displayRadPlanned&quot;</span><span class="p">;</span> <span class="n">msgbox</span><span class="p">(</span><span class="s">&#39;displayRadPlanned&#39;</span><span class="p">)</span>
    <span class="n">modelNodes</span> <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">getNodes</span><span class="p">(</span><span class="s">&#39;vtkMRMLModelNode*&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">modelNode</span> <span class="ow">in</span> <span class="n">modelNodes</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
      <span class="n">displayNode</span> <span class="o">=</span> <span class="n">modelNode</span><span class="o">.</span><span class="n">GetDisplayNode</span><span class="p">()</span>
      <span class="k">if</span> <span class="n">modelNode</span><span class="o">.</span><span class="n">GetAttribute</span><span class="p">(</span><span class="s">&quot;radiation&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&quot;planned&quot;</span><span class="p">:</span>
        <span class="n">needleNode</span> <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">mrmlScene</span><span class="o">.</span><span class="n">GetNodeByID</span><span class="p">(</span><span class="n">modelNode</span><span class="o">.</span><span class="n">GetAttribute</span><span class="p">(</span><span class="s">&quot;needleID&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">needleNode</span><span class="o">.</span><span class="n">GetDisplayVisibility</span><span class="p">()</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
          <span class="n">modelNode</span><span class="o">.</span><span class="n">SetDisplayVisibility</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">slicer</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">NeedleFinderWidget</span><span class="o">.</span><span class="n">displayRadPlannedButton</span><span class="o">.</span><span class="n">checked</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
            </div>
<div class="viewcode-block" id="NeedleFinderLogic.displayRadSegmented"><a class="viewcode-back" href="../NeedleFinder.html#NeedleFinder.NeedleFinderLogic.displayRadSegmented">[docs]</a>  <span class="k">def</span> <span class="nf">displayRadSegmented</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Display &#39;radiation&#39; of segmented needles</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">print</span> <span class="s">&quot;displayRadSegmented&quot;</span><span class="p">;</span> <span class="n">msgbox</span><span class="p">(</span><span class="s">&#39;displayRadSegmented&#39;</span><span class="p">)</span>
    <span class="n">modelNodes</span> <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">getNodes</span><span class="p">(</span><span class="s">&#39;vtkMRMLModelNode*&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">modelNode</span> <span class="ow">in</span> <span class="n">modelNodes</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
      <span class="k">if</span> <span class="n">modelNode</span><span class="o">.</span><span class="n">GetAttribute</span><span class="p">(</span><span class="s">&quot;radiation&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&quot;segmented&quot;</span><span class="p">:</span>
        <span class="n">needleNode</span> <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">mrmlScene</span><span class="o">.</span><span class="n">GetNodeByID</span><span class="p">(</span><span class="n">modelNode</span><span class="o">.</span><span class="n">GetAttribute</span><span class="p">(</span><span class="s">&quot;needleID&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">needleNode</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
          <span class="k">if</span> <span class="n">needleNode</span><span class="o">.</span><span class="n">GetDisplayVisibility</span><span class="p">()</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">modelNode</span><span class="o">.</span><span class="n">SetDisplayVisibility</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">slicer</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">NeedleFinderWidget</span><span class="o">.</span><span class="n">displayRadSegmentedButton</span><span class="o">.</span><span class="n">checked</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">modelNode</span><span class="o">.</span><span class="n">GetDisplayNode</span><span class="p">()</span>
            <span class="n">d</span><span class="o">.</span><span class="n">SetSliceIntersectionVisibility</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">slicer</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">NeedleFinderWidget</span><span class="o">.</span><span class="n">displayRadSegmentedButton</span><span class="o">.</span><span class="n">checked</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
            </div>
<div class="viewcode-block" id="NeedleFinderLogic.displayContour"><a class="viewcode-back" href="../NeedleFinder.html#NeedleFinder.NeedleFinderLogic.displayContour">[docs]</a>  <span class="k">def</span> <span class="nf">displayContour</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">visibility</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Display the iso-contour of needle i</span>

<span class="sd">    :param i: nth value of needle</span>
<span class="sd">    :param visibility: boolean to set the visibility state of the needle</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">print</span> <span class="s">&quot;displayContour&quot;</span><span class="p">;</span> <span class="n">msgbox</span><span class="p">(</span><span class="s">&#39;displayContour&#39;</span><span class="p">)</span>
    <span class="n">modelNodes</span> <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">getNodes</span><span class="p">(</span><span class="s">&#39;vtkMRMLModelNode*&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">modelNode</span> <span class="ow">in</span> <span class="n">modelNodes</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
      <span class="k">if</span> <span class="n">modelNode</span><span class="o">.</span><span class="n">GetAttribute</span><span class="p">(</span><span class="s">&quot;contour&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&quot;1&quot;</span> <span class="ow">and</span> <span class="n">modelNode</span><span class="o">.</span><span class="n">GetAttribute</span><span class="p">(</span><span class="s">&quot;nth&quot;</span><span class="p">)</span><span class="o">==</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">:</span>
        <span class="n">needleNode</span> <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">mrmlScene</span><span class="o">.</span><span class="n">GetNodeByID</span><span class="p">(</span><span class="n">modelNode</span><span class="o">.</span><span class="n">GetAttribute</span><span class="p">(</span><span class="s">&quot;needleID&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">needleNode</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
          <span class="k">if</span> <span class="n">needleNode</span><span class="o">.</span><span class="n">GetDisplayVisibility</span><span class="p">()</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">modelNode</span><span class="o">.</span><span class="n">SetDisplayVisibility</span><span class="p">(</span><span class="n">visibility</span><span class="p">)</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">modelNode</span><span class="o">.</span><span class="n">GetDisplayNode</span><span class="p">()</span>
            <span class="n">d</span><span class="o">.</span><span class="n">SetSliceIntersectionVisibility</span><span class="p">(</span><span class="n">visibility</span><span class="p">)</span>
            </div>
<div class="viewcode-block" id="NeedleFinderLogic.displayContours"><a class="viewcode-back" href="../NeedleFinder.html#NeedleFinder.NeedleFinderLogic.displayContours">[docs]</a>  <span class="k">def</span> <span class="nf">displayContours</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Display or hide the iso-contours of every needles</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">print</span> <span class="s">&quot;displayContours&quot;</span><span class="p">;</span> <span class="n">msgbox</span><span class="p">(</span><span class="s">&#39;displayContours&#39;</span><span class="p">)</span>
    <span class="n">modelNodes</span> <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">getNodes</span><span class="p">(</span><span class="s">&#39;vtkMRMLModelNode*&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">modelNode</span> <span class="ow">in</span> <span class="n">modelNodes</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
      <span class="k">if</span> <span class="n">modelNode</span><span class="o">.</span><span class="n">GetAttribute</span><span class="p">(</span><span class="s">&quot;contour&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&quot;1&quot;</span><span class="p">:</span>
        <span class="n">needleNode</span> <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">mrmlScene</span><span class="o">.</span><span class="n">GetNodeByID</span><span class="p">(</span><span class="n">modelNode</span><span class="o">.</span><span class="n">GetAttribute</span><span class="p">(</span><span class="s">&quot;needleID&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">needleNode</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
          <span class="k">if</span> <span class="n">needleNode</span><span class="o">.</span><span class="n">GetDisplayVisibility</span><span class="p">()</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">modelNode</span><span class="o">.</span><span class="n">SetDisplayVisibility</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">slicer</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">NeedleFinderWidget</span><span class="o">.</span><span class="n">displayContourButton</span><span class="o">.</span><span class="n">checked</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">modelNode</span><span class="o">.</span><span class="n">GetDisplayNode</span><span class="p">()</span>
            <span class="n">d</span><span class="o">.</span><span class="n">SetSliceIntersectionVisibility</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">slicer</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">NeedleFinderWidget</span><span class="o">.</span><span class="n">displayContourButton</span><span class="o">.</span><span class="n">checked</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> 
</div>
<div class="viewcode-block" id="NeedleFinderLogic.displayFiducial"><a class="viewcode-back" href="../NeedleFinder.html#NeedleFinder.NeedleFinderLogic.displayFiducial">[docs]</a>  <span class="k">def</span> <span class="nf">displayFiducial</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ??? used? show labels of the needles by adding a fiducial point at the tip</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">print</span> <span class="s">&quot;displayFiducial&quot;</span><span class="p">;</span> <span class="n">msgbox</span><span class="p">(</span><span class="s">&#39;displayFiducial&#39;</span><span class="p">)</span>
    <span class="n">modelNodes</span> <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">getNodes</span><span class="p">(</span><span class="s">&#39;vtkMRMLModelNode*&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">modelNode</span> <span class="ow">in</span> <span class="n">modelNodes</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
      <span class="n">displayNode</span> <span class="o">=</span> <span class="n">modelNode</span><span class="o">.</span><span class="n">GetDisplayNode</span><span class="p">()</span>
      <span class="k">if</span> <span class="n">modelNode</span><span class="o">.</span><span class="n">GetAttribute</span><span class="p">(</span><span class="s">&quot;segmented&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&quot;1&quot;</span> <span class="ow">and</span> <span class="n">modelNode</span><span class="o">.</span><span class="n">GetAttribute</span><span class="p">(</span><span class="s">&quot;nth&quot;</span><span class="p">)</span><span class="o">!=</span><span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="mi">1</span><span class="p">:</span>
          <span class="n">i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">modelNode</span><span class="o">.</span><span class="n">GetAttribute</span><span class="p">(</span><span class="s">&quot;nth&quot;</span><span class="p">))</span>
          <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fiducialnode</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>    
            <span class="n">polyData</span> <span class="o">=</span> <span class="n">modelNode</span><span class="o">.</span><span class="n">GetPolyData</span><span class="p">()</span>
            <span class="n">nb</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">polyData</span><span class="o">.</span><span class="n">GetNumberOfPoints</span><span class="p">()</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">coord</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">nb</span><span class="o">&gt;</span><span class="mi">10</span><span class="p">:</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">fiducialnode</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">vtkMRMLAnnotationFiducialNode</span><span class="p">()</span>
              <span class="n">polyData</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="n">nb</span><span class="p">,</span><span class="n">coord</span><span class="p">)</span>    
              <span class="bp">self</span><span class="o">.</span><span class="n">fiducialnode</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">SetName</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">option</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">fiducialnode</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">SetFiducialCoordinates</span><span class="p">(</span><span class="n">coord</span><span class="p">)</span>         
              <span class="bp">self</span><span class="o">.</span><span class="n">fiducialnode</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">Initialize</span><span class="p">(</span><span class="n">slicer</span><span class="o">.</span><span class="n">mrmlScene</span><span class="p">)</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">fiducialnode</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">SetLocked</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">fiducialnode</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">SetSelectable</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
              <span class="n">fidDN</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fiducialnode</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">GetDisplayNode</span><span class="p">()</span>
              <span class="n">fidDN</span><span class="o">.</span><span class="n">SetColor</span><span class="p">(</span><span class="n">modelNode</span><span class="o">.</span><span class="n">GetDisplayNode</span><span class="p">()</span><span class="o">.</span><span class="n">GetColor</span><span class="p">())</span>
              <span class="n">fidDN</span><span class="o">.</span><span class="n">SetGlyphScale</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
              <span class="n">fidTN</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fiducialnode</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">GetAnnotationTextDisplayNode</span><span class="p">()</span>
              <span class="n">fidTN</span><span class="o">.</span><span class="n">SetTextScale</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
              <span class="n">fidTN</span><span class="o">.</span><span class="n">SetColor</span><span class="p">(</span><span class="n">modelNode</span><span class="o">.</span><span class="n">GetDisplayNode</span><span class="p">()</span><span class="o">.</span><span class="n">GetColor</span><span class="p">())</span>
              
              <span class="bp">self</span><span class="o">.</span><span class="n">fiducialnode</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">SetDisplayVisibility</span><span class="p">(</span><span class="n">modelNode</span><span class="o">.</span><span class="n">GetDisplayNode</span><span class="p">()</span><span class="o">.</span><span class="n">GetVisibility</span><span class="p">())</span>
          <span class="k">else</span><span class="p">:</span>    
            <span class="k">if</span> <span class="n">modelNode</span><span class="o">.</span><span class="n">GetDisplayNode</span><span class="p">()</span><span class="o">.</span><span class="n">GetVisibility</span><span class="p">():</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">fiducialnode</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">SetDisplayVisibility</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fiducialnode</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">GetDisplayVisibility</span><span class="p">()</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fiducialnode</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">GetDisplayVisibility</span><span class="p">()</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">displayFiducialButton</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s">&quot;Hide Labels on Needles&quot;</span>
            <span class="k">else</span><span class="p">:</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">displayFiducialButton</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s">&quot;Display Labels on Needles&quot;</span> 
</div>
<div class="viewcode-block" id="NeedleFinderLogic.reformatNeedle"><a class="viewcode-back" href="../NeedleFinder.html#NeedleFinder.NeedleFinderLogic.reformatNeedle">[docs]</a>  <span class="k">def</span> <span class="nf">reformatNeedle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">i</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reformat the sagittal view to be tangent to the needle</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">print</span> <span class="s">&quot;reformatNeedle&quot;</span><span class="p">;</span> <span class="n">msgbox</span><span class="p">(</span><span class="s">&#39;reformatNeedle&#39;</span><span class="p">)</span>
    <span class="n">modelNodes</span> <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">getNodes</span><span class="p">(</span><span class="s">&#39;vtkMRMLModelNode*&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>  
      <span class="k">for</span> <span class="n">modelNode</span> <span class="ow">in</span> <span class="n">modelNodes</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">modelNode</span><span class="o">.</span><span class="n">GetAttribute</span><span class="p">(</span><span class="s">&quot;nth&quot;</span><span class="p">)</span><span class="o">==</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
          <span class="n">polyData</span> <span class="o">=</span> <span class="n">modelNode</span><span class="o">.</span><span class="n">GetPolyData</span><span class="p">()</span>
          <span class="n">nb</span> <span class="o">=</span> <span class="n">polyData</span><span class="o">.</span><span class="n">GetNumberOfPoints</span><span class="p">()</span>
          <span class="n">base</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
          <span class="n">tip</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
          <span class="n">polyData</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="n">nb</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">tip</span><span class="p">)</span>
          <span class="n">polyData</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">base</span><span class="p">)</span>
          <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span> <span class="o">=</span> <span class="n">tip</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">base</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">tip</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">base</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">tip</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">base</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
          
          <span class="n">sYellow</span> <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">mrmlScene</span><span class="o">.</span><span class="n">GetNodeByID</span><span class="p">(</span><span class="s">&quot;vtkMRMLSliceNodeYellow&quot;</span><span class="p">)</span>
          <span class="k">if</span> <span class="n">sYellow</span> <span class="o">==</span><span class="bp">None</span> <span class="p">:</span>
            <span class="n">sYellow</span> <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">mrmlScene</span><span class="o">.</span><span class="n">GetNodeByID</span><span class="p">(</span><span class="s">&quot;vtkMRMLSliceNode2&quot;</span><span class="p">)</span>        
          <span class="n">reformatLogic</span> <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">vtkSlicerReformatLogic</span><span class="p">()</span>
          <span class="n">sYellow</span><span class="o">.</span><span class="n">SetSliceVisible</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
          <span class="n">reformatLogic</span><span class="o">.</span><span class="n">SetSliceNormal</span><span class="p">(</span><span class="n">sYellow</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="n">a</span><span class="o">/</span><span class="n">b</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
          <span class="n">m</span><span class="o">=</span> <span class="n">sYellow</span><span class="o">.</span><span class="n">GetSliceToRAS</span><span class="p">()</span>
          <span class="n">m</span><span class="o">.</span><span class="n">SetElement</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">base</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
          <span class="n">m</span><span class="o">.</span><span class="n">SetElement</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">base</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
          <span class="n">m</span><span class="o">.</span><span class="n">SetElement</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">base</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
          <span class="n">sYellow</span><span class="o">.</span><span class="n">Modified</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="NeedleFinderLogic.drawIsoSurfaces0"><a class="viewcode-back" href="../NeedleFinder.html#NeedleFinder.NeedleFinderLogic.drawIsoSurfaces0">[docs]</a>  <span class="k">def</span> <span class="nf">drawIsoSurfaces0</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ??? used? for development purposes.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">print</span> <span class="s">&quot;drawIsoSurfaces0&quot;</span><span class="p">;</span> <span class="n">msgbox</span><span class="p">(</span><span class="s">&#39;drawIsoSurfaces0&#39;</span><span class="p">)</span>
    <span class="n">modelNodes</span> <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">getNodes</span><span class="p">(</span><span class="s">&#39;vtkMRMLModelNode*&#39;</span><span class="p">)</span>
    <span class="n">v</span><span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkAppendPolyData</span><span class="p">()</span>
    
    <span class="k">for</span> <span class="n">modelNode</span> <span class="ow">in</span> <span class="n">modelNodes</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
      <span class="k">if</span> <span class="n">modelNode</span><span class="o">.</span><span class="n">GetAttribute</span><span class="p">(</span><span class="s">&quot;nth&quot;</span><span class="p">)</span><span class="o">!=</span><span class="bp">None</span> <span class="ow">and</span> <span class="n">modelNode</span><span class="o">.</span><span class="n">GetDisplayVisibility</span><span class="p">()</span><span class="o">==</span><span class="mi">1</span> <span class="p">:</span>
        <span class="n">v</span><span class="o">.</span><span class="n">AddInput</span><span class="p">(</span><span class="n">modelNode</span><span class="o">.</span><span class="n">GetPolyData</span><span class="p">())</span>
       
    <span class="n">modeller</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkImplicitModeller</span><span class="p">()</span>
    <span class="n">modeller</span><span class="o">.</span><span class="n">SetInput</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">())</span>
    <span class="n">modeller</span><span class="o">.</span><span class="n">SetSampleDimensions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="o">.</span><span class="n">value</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="o">.</span><span class="n">value</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
    <span class="n">modeller</span><span class="o">.</span><span class="n">SetCapping</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">modeller</span><span class="o">.</span><span class="n">SetAdjustBounds</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">abonds</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
    <span class="n">modeller</span><span class="o">.</span><span class="n">SetProcessModeToPerVoxel</span><span class="p">()</span> 
    <span class="n">modeller</span><span class="o">.</span><span class="n">SetAdjustDistance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">adist</span><span class="o">.</span><span class="n">value</span><span class="o">/</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">modeller</span><span class="o">.</span><span class="n">SetMaximumDistance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">maxdist</span><span class="o">.</span><span class="n">value</span><span class="o">/</span><span class="mi">100</span><span class="p">)</span>    
    
    <span class="n">contourFilter</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkContourFilter</span><span class="p">()</span>
    <span class="n">contourFilter</span><span class="o">.</span><span class="n">SetNumberOfContours</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nb</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
    <span class="n">contourFilter</span><span class="o">.</span><span class="n">SetInputConnection</span><span class="p">(</span><span class="n">modeller</span><span class="o">.</span><span class="n">GetOutputPort</span><span class="p">())</span>    
    <span class="n">contourFilter</span><span class="o">.</span><span class="n">ComputeNormalsOn</span><span class="p">()</span>
    <span class="n">contourFilter</span><span class="o">.</span><span class="n">ComputeScalarsOn</span><span class="p">()</span>
    <span class="n">contourFilter</span><span class="o">.</span><span class="n">UseScalarTreeOn</span><span class="p">()</span>
    <span class="n">contourFilter</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">contour</span><span class="o">.</span><span class="n">value</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">contourValue</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
    <span class="n">contourFilter</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">contour2</span><span class="o">.</span><span class="n">value</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">contourValue2</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
    <span class="n">contourFilter</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">contour3</span><span class="o">.</span><span class="n">value</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">contourValue3</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
    <span class="n">contourFilter</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">contour4</span><span class="o">.</span><span class="n">value</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">contourValue4</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
    <span class="n">contourFilter</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">contour5</span><span class="o">.</span><span class="n">value</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">contourValue5</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

    <span class="n">isoSurface</span> <span class="o">=</span> <span class="n">contourFilter</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">AddContour</span><span class="p">(</span><span class="n">isoSurface</span><span class="p">)</span>
  
  <span class="c">#----------------------------------------------------------------------------------------------</span></div>
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  End of the functions used with the Yi&#39;s CLI module</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="c">#----------------------------------------------------------------------------------------------</span>
  <span class="c">#----------------------------------------------------------------------------------------------</span>
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Functions for validation study </span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="c">#----------------------------------------------------------------------------------------------</span>
  
<div class="viewcode-block" id="NeedleFinderLogic.returnTips"><a class="viewcode-back" href="../NeedleFinder.html#NeedleFinder.NeedleFinderLogic.returnTips">[docs]</a>  <span class="k">def</span> <span class="nf">returnTips</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Returns the IJK coordinates of the tips of manually segmented needles</span>

<span class="sd">    :return: array of IJK coordinates of validation needle tips</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#productive</span>
    <span class="k">if</span> <span class="n">profiling</span><span class="p">:</span> <span class="k">print</span> <span class="s">&quot;returnTips&quot;</span><span class="p">;</span>
    <span class="n">returnTips</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">modelNodes</span><span class="o">=</span><span class="n">slicer</span><span class="o">.</span><span class="n">mrmlScene</span><span class="o">.</span><span class="n">GetNodesByClass</span><span class="p">(</span><span class="s">&#39;vtkMRMLModelNode&#39;</span><span class="p">)</span>
    <span class="n">nbNode</span><span class="o">=</span><span class="n">modelNodes</span><span class="o">.</span><span class="n">GetNumberOfItems</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">nthNode</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nbNode</span><span class="p">):</span>
        <span class="c"># print nthNode</span>
        <span class="n">node</span><span class="o">=</span><span class="n">slicer</span><span class="o">.</span><span class="n">mrmlScene</span><span class="o">.</span><span class="n">GetNthNodeByClass</span><span class="p">(</span><span class="n">nthNode</span><span class="p">,</span><span class="s">&#39;vtkMRMLModelNode&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">GetAttribute</span><span class="p">(</span><span class="s">&#39;type&#39;</span><span class="p">)</span><span class="o">==</span><span class="s">&#39;Validation&#39;</span><span class="p">:</span>
            <span class="n">polydata</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">GetPolyData</span><span class="p">()</span>
            <span class="n">p</span><span class="p">,</span><span class="n">pbis</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">polydata</span><span class="o">.</span><span class="n">GetNumberOfPoints</span><span class="p">()</span><span class="o">&gt;</span><span class="mi">100</span><span class="p">:</span>
                <span class="n">polydata</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">p</span><span class="p">)</span>
                <span class="n">polydata</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">polydata</span><span class="o">.</span><span class="n">GetNumberOfPoints</span><span class="p">()</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="n">pbis</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">pbis</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">&gt;</span><span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
                    <span class="n">p</span><span class="o">=</span><span class="n">pbis</span>
                
                <span class="n">returnTips</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ras2ijk</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">returnTips</span>
</div>
<div class="viewcode-block" id="NeedleFinderLogic.startValidation"><a class="viewcode-back" href="../NeedleFinder.html#NeedleFinder.NeedleFinderLogic.startValidation">[docs]</a>  <span class="k">def</span> <span class="nf">startValidation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Start the evaluation process:</span>
<span class="sd">    * Calls returnTips() to build an array of the tip of manually segmented needles</span>
<span class="sd">    * Use theses tips to generate auto segmented needles</span>
<span class="sd">    * Calls evaluate() to compute the Hausdorff&#39;s distance between every pair of needles</span>

<span class="sd">    :return: print the results in the python interactor (CMD+3 or CTRL+3)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#productive #button</span>
    <span class="k">if</span> <span class="n">profiling</span><span class="p">:</span> <span class="k">print</span> <span class="s">&quot;startValidation&quot;</span><span class="p">;</span>
    <span class="n">tips</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">returnTips</span><span class="p">()</span>
    <span class="c"># select the image node from the Red slice viewer</span>
    <span class="n">m</span><span class="o">=</span><span class="n">vtk</span><span class="o">.</span><span class="n">vtkMatrix4x4</span><span class="p">()</span>
    <span class="n">volumeNode</span> <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">layoutManager</span><span class="p">()</span><span class="o">.</span><span class="n">sliceWidget</span><span class="p">(</span><span class="s">&quot;Red&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sliceLogic</span><span class="p">()</span><span class="o">.</span><span class="n">GetBackgroundLayer</span><span class="p">()</span><span class="o">.</span><span class="n">GetVolumeNode</span><span class="p">()</span>
    <span class="n">volumeNode</span><span class="o">.</span><span class="n">GetIJKToRASMatrix</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
    <span class="n">imageData</span> <span class="o">=</span> <span class="n">volumeNode</span><span class="o">.</span><span class="n">GetImageData</span><span class="p">()</span>
    <span class="n">spacing</span> <span class="o">=</span> <span class="n">volumeNode</span><span class="o">.</span><span class="n">GetSpacing</span><span class="p">()</span>
    <span class="c"># chrono starts</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">clock</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">I</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tips</span><span class="p">)):</span>
      <span class="n">A</span><span class="o">=</span><span class="n">tips</span><span class="p">[</span><span class="n">I</span><span class="p">]</span>
      <span class="n">colorVar</span> <span class="o">=</span> <span class="n">I</span><span class="o">/</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tips</span><span class="p">))</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">needleDetectionThread</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">imageData</span><span class="p">,</span> <span class="n">colorVar</span><span class="p">,</span><span class="n">spacing</span><span class="p">)</span>

    <span class="c">#print tips</span>
    <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluate</span><span class="p">()</span>
    <span class="k">print</span> <span class="s">&#39;#######################&#39;</span>
    <span class="k">print</span> <span class="s">&#39;New Validation Results:&#39;</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)):</span>
        <span class="k">print</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="NeedleFinderLogic.selectCurrentAxialSlice"><a class="viewcode-back" href="../NeedleFinder.html#NeedleFinder.NeedleFinderLogic.selectCurrentAxialSlice">[docs]</a>  <span class="k">def</span> <span class="nf">selectCurrentAxialSlice</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the K (of IJK) value of the current axial slice. </span>
<span class="sd">    Used to define the slice containing the template</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#productive #onButton</span>
    <span class="k">if</span> <span class="n">profiling</span><span class="p">:</span> <span class="k">print</span> <span class="s">&quot;selectCurrentAxialSlice&quot;</span><span class="p">;</span>
    <span class="n">widget</span> <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">NeedleFinderWidget</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fiducialNode</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">slicer</span><span class="o">.</span><span class="n">mrmlScene</span><span class="o">.</span><span class="n">RemoveNode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fiducialNode</span><span class="p">)</span>

    <span class="n">s</span>           <span class="o">=</span>   <span class="n">slicer</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">layoutManager</span><span class="p">()</span><span class="o">.</span><span class="n">sliceWidget</span><span class="p">(</span><span class="s">&quot;Red&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sliceLogic</span><span class="p">()</span><span class="o">.</span><span class="n">GetBackgroundLayer</span><span class="p">()</span><span class="o">.</span><span class="n">GetSliceNode</span><span class="p">()</span>
    <span class="n">offSet</span>      <span class="o">=</span>   <span class="n">s</span><span class="o">.</span><span class="n">GetSliceOffset</span><span class="p">()</span>
    <span class="n">rasVector</span>   <span class="o">=</span>   <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">offSet</span><span class="p">]</span>
    <span class="n">widget</span><span class="o">.</span><span class="n">templateSliceButton</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s">&quot;Select Current Axial Slice as seg. limit (current: &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">offSet</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;)&quot;</span>

    <span class="n">widget</span><span class="o">.</span><span class="n">axialSegmentationLimit</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ras2ijk</span><span class="p">(</span><span class="n">rasVector</span><span class="p">)[</span><span class="mi">2</span><span class="p">]))</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">fiducialNode</span> <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">mrmlScene</span><span class="o">.</span><span class="n">CreateNodeByClass</span><span class="p">(</span><span class="s">&#39;vtkMRMLAnnotationFiducialNode&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fiducialNode</span><span class="o">.</span><span class="n">Initialize</span><span class="p">(</span><span class="n">slicer</span><span class="o">.</span><span class="n">mrmlScene</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fiducialNode</span><span class="o">.</span><span class="n">SetName</span><span class="p">(</span><span class="s">&#39;template slice position&#39;</span><span class="p">)</span>        
    <span class="bp">self</span><span class="o">.</span><span class="n">fiducialNode</span><span class="o">.</span><span class="n">SetFiducialCoordinates</span><span class="p">(</span><span class="n">rasVector</span><span class="p">)</span>
    <span class="n">fd</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fiducialNode</span><span class="o">.</span><span class="n">GetDisplayNode</span><span class="p">()</span>
    <span class="n">fd</span><span class="o">.</span><span class="n">SetVisibility</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">fd</span><span class="o">.</span><span class="n">SetColor</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
</div>
<div class="viewcode-block" id="NeedleFinderLogic.exportEvaluation"><a class="viewcode-back" href="../NeedleFinder.html#NeedleFinder.NeedleFinderLogic.exportEvaluation">[docs]</a>  <span class="k">def</span> <span class="nf">exportEvaluation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">results</span><span class="p">,</span><span class="n">url</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Export evaluation results to a CSV file</span>

<span class="sd">    :param results: array containing the results of the evaluation</span>
<span class="sd">    :param url: url for saving the file</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">print</span> <span class="s">&quot;exportEvaluation&quot;</span><span class="p">;</span> <span class="n">msgbox</span><span class="p">(</span><span class="s">&#39;exportEvaluation&#39;</span><span class="p">)</span>
    <span class="n">widget</span> <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">NeedleFinderWidget</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">valuesExperience</span><span class="o">=</span><span class="p">[</span> <span class="n">widget</span><span class="o">.</span><span class="n">radiusNeedleParameter</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                            <span class="n">widget</span><span class="o">.</span><span class="n">lenghtNeedleParameter</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                            <span class="n">widget</span><span class="o">.</span><span class="n">distanceMax</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                            <span class="n">widget</span><span class="o">.</span><span class="n">numberOfPointsPerNeedle</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> 
                            <span class="n">widget</span><span class="o">.</span><span class="n">nbRotatingIterations</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                            <span class="n">widget</span><span class="o">.</span><span class="n">stepsize</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                            <span class="n">widget</span><span class="o">.</span><span class="n">gradientPonderation</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                            <span class="n">widget</span><span class="o">.</span><span class="n">gaussianAttenuationChecked</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                            <span class="n">widget</span><span class="o">.</span><span class="n">sigmaValue</span><span class="o">.</span><span class="n">value</span><span class="p">]</span>
    <span class="n">myfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="s">&#39;a&#39;</span><span class="p">)</span>
    <span class="n">wr</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">myfile</span><span class="p">,</span> <span class="n">quoting</span><span class="o">=</span><span class="n">csv</span><span class="o">.</span><span class="n">QUOTE_ALL</span><span class="p">)</span>
    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valuesExperience</span><span class="p">)</span>
    <span class="n">wr</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="NeedleFinderLogic.hausdorffDistance"><a class="viewcode-back" href="../NeedleFinder.html#NeedleFinder.NeedleFinderLogic.hausdorffDistance">[docs]</a>  <span class="k">def</span> <span class="nf">hausdorffDistance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">id1</span><span class="p">,</span><span class="n">id2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the Hausdorff&#39;s distance [HD]_ of two needles. Both needles are truncated to start and end at the same slices.</span>

<span class="sd">    :param id1: vtkMRMLModelNodeID of Needle 1</span>
<span class="sd">    :param id2: vtkMRMLModelNodeID of Needle 2</span>
<span class="sd">    :return: Hausdorff&#39;s distance in millimeters</span>

<span class="sd">    .. math::  d_{\mathrm H}(X,Y) = \max\{\,\sup_{x \in X} \inf_{y \in Y} d(x,y),\, \sup_{y \in Y} \inf_{x \in X} d(x,y)\,\}</span>

<span class="sd">    .. image:: http://upload.wikimedia.org/wikipedia/commons/2/21/Hausdorff_distance_sample.svg</span>
<span class="sd">           :height: 300px</span>
<span class="sd">           :width: 500 px</span>
<span class="sd">           :scale: 100 %</span>
<span class="sd">           :alt: alternate text</span>
<span class="sd">           :align: center</span>

<span class="sd">    .. [HD] http://en.wikipedia.org/wiki/Hausdorff_distance</span>



<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#productive #math</span>
    <span class="k">if</span> <span class="n">profiling</span><span class="p">:</span> <span class="k">print</span> <span class="s">&quot;hausdorffDistance&quot;</span><span class="p">;</span>
    <span class="n">node1</span> <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">mrmlScene</span><span class="o">.</span><span class="n">GetNodeByID</span><span class="p">(</span><span class="n">id1</span><span class="p">)</span>
    <span class="n">polydata1</span><span class="o">=</span><span class="n">node1</span><span class="o">.</span><span class="n">GetPolyData</span><span class="p">()</span>
    <span class="n">node2</span> <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">mrmlScene</span><span class="o">.</span><span class="n">GetNodeByID</span><span class="p">(</span><span class="n">id2</span><span class="p">)</span>
    <span class="n">polydata2</span><span class="o">=</span><span class="n">node2</span><span class="o">.</span><span class="n">GetPolyData</span><span class="p">()</span>
    <span class="n">nb1</span> <span class="o">=</span> <span class="n">polydata1</span><span class="o">.</span><span class="n">GetNumberOfPoints</span><span class="p">()</span>
    <span class="n">nb2</span> <span class="o">=</span> <span class="n">polydata2</span><span class="o">.</span><span class="n">GetNumberOfPoints</span><span class="p">()</span>
    <span class="n">minimum</span><span class="o">=</span><span class="bp">None</span>
    <span class="n">maximum</span><span class="o">=</span><span class="bp">None</span>
    <span class="n">JJ</span><span class="p">,</span><span class="n">jj</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span>
    <span class="n">II</span><span class="p">,</span><span class="n">ii</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span>
    <span class="n">pt1</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">pt2</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">polydata1</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">pt1</span><span class="p">)</span>
    <span class="n">polydata1</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="n">nb1</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">pt2</span><span class="p">)</span>
    <span class="n">minVal1</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">pt1</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">pt2</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">maxVal1</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="n">pt1</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">pt2</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">pt1</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">pt2</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">pt1b</span><span class="p">,</span><span class="n">pt2b</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span>
    <span class="n">polydata2</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">pt1</span><span class="p">)</span>
    <span class="n">polydata2</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="n">nb2</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">pt2</span><span class="p">)</span>
    <span class="n">minVal2</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">pt1</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">pt2</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">maxVal2</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">pt1</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">pt2</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">valueBase</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="n">minVal1</span><span class="p">,</span><span class="n">minVal2</span><span class="p">)</span>
    <span class="n">valueTip</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">maxVal1</span><span class="p">,</span><span class="n">maxVal2</span><span class="p">)</span>

    <span class="c"># truncate polydatas</span>
    <span class="n">truncatedPolydata1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clipPolyData</span><span class="p">(</span><span class="n">node1</span><span class="p">,</span><span class="n">valueBase</span><span class="p">)</span>
    <span class="n">truncatedPolydata2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clipPolyData</span><span class="p">(</span><span class="n">node2</span><span class="p">,</span><span class="n">valueBase</span><span class="p">)</span>

    <span class="n">cellId</span><span class="o">=</span><span class="n">vtk</span><span class="o">.</span><span class="n">mutable</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">subid</span><span class="o">=</span><span class="n">vtk</span><span class="o">.</span><span class="n">mutable</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">dist</span><span class="o">=</span><span class="n">vtk</span><span class="o">.</span><span class="n">mutable</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">cl2</span><span class="o">=</span><span class="n">vtk</span><span class="o">.</span><span class="n">vtkCellLocator</span><span class="p">()</span>
    <span class="n">cl2</span><span class="o">.</span><span class="n">SetDataSet</span><span class="p">(</span><span class="n">truncatedPolydata2</span><span class="p">)</span>
    <span class="n">cl2</span><span class="o">.</span><span class="n">BuildLocator</span><span class="p">()</span>
    <span class="c"># Hausforff 1 -&gt; 2</span>
    <span class="n">minima</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">nb1</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="mi">10</span><span class="p">))):</span>
      <span class="n">pt</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
      <span class="n">polydata1</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="mi">10</span><span class="o">*</span><span class="n">i</span><span class="p">,</span><span class="n">pt</span><span class="p">)</span>
      <span class="n">closest</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
      <span class="n">cl2</span><span class="o">.</span><span class="n">FindClosestPoint</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span><span class="n">closest</span><span class="p">,</span><span class="n">cellId</span><span class="p">,</span><span class="n">subid</span><span class="p">,</span><span class="n">dist</span><span class="p">)</span>
      <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">closest</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">pt</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">&lt;=</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">minima</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">distance</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span><span class="n">closest</span><span class="p">))</span>
      <span class="k">else</span><span class="p">:</span>
          <span class="n">minima</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">hausdorff12</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">minima</span><span class="p">)</span>
    
    <span class="c"># Hausforff 2 -&gt; 1</span>
    <span class="n">minima</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">cl1</span><span class="o">=</span><span class="n">vtk</span><span class="o">.</span><span class="n">vtkCellLocator</span><span class="p">()</span>
    <span class="n">cl1</span><span class="o">.</span><span class="n">SetDataSet</span><span class="p">(</span><span class="n">truncatedPolydata1</span><span class="p">)</span>
    <span class="n">cl1</span><span class="o">.</span><span class="n">BuildLocator</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">nb2</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="mi">10</span><span class="p">))):</span>
      <span class="n">pt</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
      <span class="n">polydata2</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="mi">10</span><span class="o">*</span><span class="n">i</span><span class="p">,</span><span class="n">pt</span><span class="p">)</span>
      <span class="n">closest</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
      <span class="n">cl1</span><span class="o">.</span><span class="n">FindClosestPoint</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span><span class="n">closest</span><span class="p">,</span><span class="n">cellId</span><span class="p">,</span><span class="n">subid</span><span class="p">,</span><span class="n">dist</span><span class="p">)</span>
      <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">closest</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">pt</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">&lt;=</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">minima</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">distance</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span><span class="n">closest</span><span class="p">))</span>
      <span class="k">else</span><span class="p">:</span>
          <span class="n">minima</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">hausdorff21</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">minima</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">hausdorff12</span><span class="p">,</span><span class="n">hausdorff21</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="NeedleFinderLogic.evaluate"><a class="viewcode-back" href="../NeedleFinder.html#NeedleFinder.NeedleFinderLogic.evaluate">[docs]</a>  <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function first invokes needleMatching() with, for each automatically segmented needle in the vtkMRMLScene,</span>
<span class="sd">    associates it with its manually segmented version.</span>
<span class="sd">    Then, the HD is computed between each pairs of needle and the results are reported in a numpy array</span>

<span class="sd">    :return numpy array of [ value , ID needle 1, ID needle 2 ]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#productive</span>
    <span class="k">if</span> <span class="n">profiling</span><span class="p">:</span> <span class="k">print</span> <span class="s">&quot;evaluate&quot;</span><span class="p">;</span>
    <span class="n">result</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">needleMatching</span><span class="p">()</span>
    <span class="n">HD</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)):</span>
      <span class="n">val</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hausdorffDistance</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span>
      <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">val</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39;vtkMRMLModelNode&#39;</span><span class="p">)),</span><span class="nb">int</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39;vtkMRMLModelNode&#39;</span><span class="p">))]</span>
      <span class="n">HD</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">HD</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">longdouble</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="NeedleFinderLogic.distTip"><a class="viewcode-back" href="../NeedleFinder.html#NeedleFinder.NeedleFinderLogic.distTip">[docs]</a>  <span class="k">def</span> <span class="nf">distTip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">id1</span><span class="p">,</span><span class="n">id2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Returns the axial distance between the tip of two needles</span>

<span class="sd">    :param id1: ID number for the needle 1 (vtkMRMLModelNode)</span>
<span class="sd">    :param id2: ID number for the needle 2 (vtkMRMLModelNode)</span>
<span class="sd">    :return: distance in millimeters between the tip of both needles</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#productive #math</span>
    <span class="k">if</span> <span class="n">profiling</span><span class="p">:</span> <span class="k">print</span> <span class="s">&quot;distTip&quot;</span><span class="p">;</span>
    <span class="n">node</span> <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">mrmlScene</span><span class="o">.</span><span class="n">GetNodeByID</span><span class="p">(</span><span class="s">&#39;vtkMRMLModelNode&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">id1</span><span class="p">))</span>
    <span class="n">polydata</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">GetPolyData</span><span class="p">()</span>
    <span class="n">node2</span> <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">mrmlScene</span><span class="o">.</span><span class="n">GetNodeByID</span><span class="p">(</span><span class="s">&#39;vtkMRMLModelNode&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">id2</span><span class="p">))</span>
    <span class="n">polydata2</span><span class="o">=</span><span class="n">node2</span><span class="o">.</span><span class="n">GetPolyData</span><span class="p">()</span>
    <span class="n">p</span><span class="p">,</span><span class="n">pbis</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">p2</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">p2bis</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">axialDistance</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
        <span class="n">polydata</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">p</span><span class="p">)</span>
        <span class="n">polydata</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="mi">2499</span><span class="o">-</span><span class="n">i</span><span class="p">,</span><span class="n">pbis</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pbis</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">&gt;</span><span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
          <span class="n">p</span><span class="o">=</span><span class="n">pbis</span>
        <span class="n">polydata2</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="mi">2499</span><span class="o">-</span><span class="n">i</span><span class="p">,</span><span class="n">p2</span><span class="p">)</span>
        <span class="n">polydata2</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">p2bis</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">p2bis</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">&gt;</span><span class="n">p2</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
          <span class="n">p2</span><span class="o">=</span><span class="n">p2bis</span>
        <span class="n">axialDistance</span><span class="o">.</span><span class="n">append</span><span class="p">(((</span> <span class="n">p2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span>  <span class="p">(</span> <span class="n">p2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">axialDistance</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="NeedleFinderLogic.needleMatching"><a class="viewcode-back" href="../NeedleFinder.html#NeedleFinder.NeedleFinderLogic.needleMatching">[docs]</a>  <span class="k">def</span> <span class="nf">needleMatching</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This functions associates manually segmented needles to their automatically segmented version. To do so,</span>
<span class="sd">    each manually segmented needle has a &#39;type&#39; attribute named &#39;validation&#39;. For each manually segmented needle, an axial</span>
<span class="sd">    distance between the tip of this needle, and the tip of every auto segmented needle is computed. The auto needle that</span>
<span class="sd">    offers the minimal tip axial distance is considered as corresponding needle</span>

<span class="sd">    :return: array of tuple of corresponding needles</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#productive</span>
    <span class="k">if</span> <span class="n">profiling</span><span class="p">:</span> <span class="k">print</span> <span class="s">&quot;needleMatching&quot;</span><span class="p">;</span>
    <span class="n">modelNodes</span><span class="o">=</span><span class="n">slicer</span><span class="o">.</span><span class="n">mrmlScene</span><span class="o">.</span><span class="n">GetNodesByClass</span><span class="p">(</span><span class="s">&#39;vtkMRMLModelNode&#39;</span><span class="p">)</span>
    <span class="n">nbNode</span><span class="o">=</span><span class="n">modelNodes</span><span class="o">.</span><span class="n">GetNumberOfItems</span><span class="p">()</span>
    <span class="n">result</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">found</span><span class="o">=</span><span class="p">[]</span>
    <span class="c">#print nbNode</span>
    <span class="k">for</span> <span class="n">nthNode</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nbNode</span><span class="p">):</span>
      <span class="n">node</span><span class="o">=</span><span class="n">slicer</span><span class="o">.</span><span class="n">mrmlScene</span><span class="o">.</span><span class="n">GetNthNodeByClass</span><span class="p">(</span><span class="n">nthNode</span><span class="p">,</span><span class="s">&#39;vtkMRMLModelNode&#39;</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">GetID</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">found</span> <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">GetAttribute</span><span class="p">(</span><span class="s">&#39;type&#39;</span><span class="p">)</span><span class="o">!=</span><span class="s">&#39;Validation&#39;</span><span class="p">:</span>
        <span class="n">dist</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">polydata</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">GetPolyData</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">polydata</span><span class="o">!=</span><span class="bp">None</span><span class="p">:</span>
          <span class="n">bounds</span> <span class="o">=</span> <span class="n">polydata</span><span class="o">.</span><span class="n">GetBounds</span><span class="p">()</span>
          <span class="k">for</span> <span class="n">nthNode2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nbNode</span><span class="p">):</span>
            <span class="n">node2</span><span class="o">=</span><span class="n">slicer</span><span class="o">.</span><span class="n">mrmlScene</span><span class="o">.</span><span class="n">GetNthNodeByClass</span><span class="p">(</span><span class="n">nthNode2</span><span class="p">,</span><span class="s">&#39;vtkMRMLModelNode&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">node2</span><span class="o">.</span><span class="n">GetID</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">found</span> <span class="ow">and</span> <span class="n">node2</span><span class="o">.</span><span class="n">GetAttribute</span><span class="p">(</span><span class="s">&#39;type&#39;</span><span class="p">)</span><span class="o">==</span><span class="s">&#39;Validation&#39;</span><span class="p">:</span>
              <span class="n">polydata2</span> <span class="o">=</span> <span class="n">node2</span><span class="o">.</span><span class="n">GetPolyData</span><span class="p">()</span>
              <span class="k">if</span> <span class="n">polydata2</span><span class="o">!=</span><span class="bp">None</span> <span class="ow">and</span> <span class="n">polydata2</span><span class="o">.</span><span class="n">GetNumberOfPoints</span><span class="p">()</span><span class="o">&gt;</span><span class="mi">100</span> <span class="ow">and</span> <span class="n">polydata</span><span class="o">.</span><span class="n">GetNumberOfPoints</span><span class="p">()</span><span class="o">&gt;</span><span class="mi">100</span><span class="p">:</span>
                <span class="n">bounds2</span> <span class="o">=</span> <span class="n">polydata2</span><span class="o">.</span><span class="n">GetBounds</span><span class="p">()</span>
                <span class="n">tot</span><span class="o">=</span><span class="mi">0</span>
                <span class="n">p</span><span class="p">,</span><span class="n">pbis</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">p2</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">p2bis</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">polydata</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">p</span><span class="p">)</span>
                <span class="n">polydata</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">pbis</span><span class="p">)</span>
                <span class="n">polydata2</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="mi">2499</span><span class="p">,</span><span class="n">p2</span><span class="p">)</span>
                <span class="n">polydata2</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">p2bis</span><span class="p">)</span>
                
                <span class="n">axialDistance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">distTip</span><span class="p">(</span> <span class="nb">int</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">GetID</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39;vtkMRMLModelNode&#39;</span><span class="p">))</span> <span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">node2</span><span class="o">.</span><span class="n">GetID</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39;vtkMRMLModelNode&#39;</span><span class="p">)))</span>
                
                <span class="n">dist</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">axialDistance</span><span class="p">,</span><span class="n">node2</span><span class="o">.</span><span class="n">GetID</span><span class="p">()])</span>
                <span class="c"># print axialDistance</span>
                
          <span class="k">if</span> <span class="n">dist</span><span class="o">!=</span><span class="p">[]:</span>
            <span class="n">match</span><span class="o">=</span><span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">dist</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span><span class="nb">min</span><span class="p">(</span><span class="n">dist</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span><span class="n">node</span><span class="o">.</span><span class="n">GetID</span><span class="p">()]</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">match</span><span class="p">)</span>
            <span class="n">found</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">dist</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">found</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">GetID</span><span class="p">())</span> 
            <span class="n">node</span><span class="o">.</span><span class="n">GetDisplayNode</span><span class="p">()</span><span class="o">.</span><span class="n">SetSliceIntersectionVisibility</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="c"># print result</span>
    <span class="k">return</span> <span class="n">result</span>
</div>
<div class="viewcode-block" id="NeedleFinderLogic.distance"><a class="viewcode-back" href="../NeedleFinder.html#NeedleFinder.NeedleFinderLogic.distance">[docs]</a>  <span class="k">def</span> <span class="nf">distance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">pt1</span><span class="p">,</span><span class="n">pt2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;3D distance between two points</span>

<span class="sd">    :param pt1: point 1 [x,y,z]</span>
<span class="sd">    :param pt2: point 2 [x,y,z</span>
<span class="sd">    :return: Euclidian&#39;s distance</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#productive #frequent</span>
    <span class="k">if</span> <span class="n">profiling</span><span class="p">:</span> <span class="k">print</span> <span class="s">&quot;distance&quot;</span><span class="p">;</span>
    <span class="n">d</span> <span class="o">=</span> <span class="p">(</span> <span class="p">(</span>  <span class="nb">float</span><span class="p">(</span><span class="n">pt1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="nb">float</span><span class="p">(</span><span class="n">pt2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>  <span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span>  <span class="nb">float</span><span class="p">(</span><span class="n">pt1</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="nb">float</span><span class="p">(</span><span class="n">pt2</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>  <span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span>  <span class="nb">float</span><span class="p">(</span><span class="n">pt1</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">-</span> <span class="nb">float</span><span class="p">(</span><span class="n">pt2</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>  <span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="p">)</span><span class="o">**</span><span class="mf">0.5</span>
    <span class="k">return</span> <span class="n">d</span>
</div>
<div class="viewcode-block" id="NeedleFinderLogic.addManualTip"><a class="viewcode-back" href="../NeedleFinder.html#NeedleFinder.NeedleFinderLogic.addManualTip">[docs]</a>  <span class="k">def</span> <span class="nf">addManualTip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">A</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Add fiducial node to the scene (called by processEventAddManualTips). Used as starting point for needle segmentation</span>

<span class="sd">    :param A: RAS coordinates</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">print</span> <span class="s">&quot;addManualTip&quot;</span><span class="p">;</span> <span class="n">msgbox</span><span class="p">(</span><span class="s">&#39;addManualTip&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fiducialNode</span> <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">mrmlScene</span><span class="o">.</span><span class="n">CreateNodeByClass</span><span class="p">(</span><span class="s">&#39;vtkMRMLAnnotationFiducialNode&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fiducialNode</span><span class="o">.</span><span class="n">Initialize</span><span class="p">(</span><span class="n">slicer</span><span class="o">.</span><span class="n">mrmlScene</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fiducialNode</span><span class="o">.</span><span class="n">SetName</span><span class="p">(</span><span class="s">&#39;tip&#39;</span><span class="p">)</span>        
    <span class="bp">self</span><span class="o">.</span><span class="n">fiducialNode</span><span class="o">.</span><span class="n">SetFiducialCoordinates</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="n">fd</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fiducialNode</span><span class="o">.</span><span class="n">GetDisplayNode</span><span class="p">()</span>
    <span class="n">fd</span><span class="o">.</span><span class="n">SetVisibility</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">fd</span><span class="o">.</span><span class="n">SetColor</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
</div>
<div class="viewcode-block" id="NeedleFinderLogic.distanceTwoPoints"><a class="viewcode-back" href="../NeedleFinder.html#NeedleFinder.NeedleFinderLogic.distanceTwoPoints">[docs]</a>  <span class="k">def</span> <span class="nf">distanceTwoPoints</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;3D distance between two points</span>

<span class="sd">    :param pt1: point 1 [x,y,z]</span>
<span class="sd">    :param pt2: point 2 [x,y,z</span>
<span class="sd">    :return: Euclidian&#39;s distance</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#productive</span>
    <span class="c"># used by addNeedleToScene</span>
    <span class="k">if</span> <span class="n">profiling</span><span class="p">:</span> <span class="k">print</span> <span class="s">&quot;distanceTwoPoints&quot;</span><span class="p">;</span>
    <span class="n">length</span> <span class="o">=</span> <span class="p">(</span> <span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">B</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">B</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">B</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span>
    <span class="k">return</span> <span class="n">length</span>
  </div>
<div class="viewcode-block" id="NeedleFinderLogic.clipPolyData"><a class="viewcode-back" href="../NeedleFinder.html#NeedleFinder.NeedleFinderLogic.clipPolyData">[docs]</a>  <span class="k">def</span> <span class="nf">clipPolyData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">node</span><span class="p">,</span><span class="n">value</span><span class="p">,</span><span class="n">visible</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Function used to truncate needle models to evaluate the Hausdorff&#39;s distance.</span>

<span class="sd">    :param node: vtkMRMLModelNode</span>
<span class="sd">    :param value: axial slice where to cut the model</span>
<span class="sd">    :return: vtkPolyData of the cutted model</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#productive</span>
    <span class="k">if</span> <span class="n">profiling</span><span class="p">:</span> <span class="k">print</span> <span class="s">&quot;clipPolyData&quot;</span><span class="p">;</span>
    <span class="c"># We clip with an implicit function. Here we use a plane positioned near</span>
    <span class="c"># the center of the cow model and oriented at an arbitrary angle.</span>
    <span class="n">plane</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkPlane</span><span class="p">()</span>
    <span class="n">plane</span><span class="o">.</span><span class="n">SetOrigin</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">plane</span><span class="o">.</span><span class="n">SetNormal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="c"># vtkClipPolyData requires an implicit function to define what it is to</span>
    <span class="c"># clip with. Any implicit function, including complex boolean combinations</span>
    <span class="c"># can be used. Notice that we can specify the value of the implicit function</span>
    <span class="c"># with the SetValue method.</span>
    <span class="n">clipper</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkClipPolyData</span><span class="p">()</span>
    <span class="n">clipper</span><span class="o">.</span><span class="n">SetInputData</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">GetPolyData</span><span class="p">())</span>
    <span class="n">clipper</span><span class="o">.</span><span class="n">SetClipFunction</span><span class="p">(</span><span class="n">plane</span><span class="p">)</span>
    <span class="n">clipper</span><span class="o">.</span><span class="n">GenerateClipScalarsOn</span><span class="p">()</span>
    <span class="n">clipper</span><span class="o">.</span><span class="n">GenerateClippedOutputOn</span><span class="p">()</span>
    <span class="n">clipper</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="n">clipper</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>
    <span class="n">polyData</span> <span class="o">=</span> <span class="n">clipper</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span>
    <span class="k">if</span> <span class="mi">1</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">scene</span>   <span class="o">=</span>   <span class="n">slicer</span><span class="o">.</span><span class="n">mrmlScene</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">vtkMRMLModelNode</span><span class="p">()</span>
        <span class="n">model</span><span class="o">.</span><span class="n">SetScene</span><span class="p">(</span><span class="n">scene</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">SetAndObservePolyData</span><span class="p">(</span><span class="n">polyData</span><span class="p">)</span>
        <span class="c">### Create display node</span>
        <span class="n">modelDisplay</span> <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">vtkMRMLModelDisplayNode</span><span class="p">()</span>
        <span class="n">modelDisplay</span><span class="o">.</span><span class="n">SetScene</span><span class="p">(</span><span class="n">scene</span><span class="p">)</span>
        <span class="n">scene</span><span class="o">.</span><span class="n">AddNode</span><span class="p">(</span><span class="n">modelDisplay</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">SetAndObserveDisplayNodeID</span><span class="p">(</span><span class="n">modelDisplay</span><span class="o">.</span><span class="n">GetID</span><span class="p">())</span>
        <span class="c">### Add to scene</span>
        <span class="n">modelDisplay</span><span class="o">.</span><span class="n">SetInputPolyDataConnection</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">GetPolyDataConnection</span><span class="p">())</span>
        <span class="n">scene</span><span class="o">.</span><span class="n">AddNode</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">visible</span><span class="o">!=</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">scene</span><span class="o">.</span><span class="n">RemoveNode</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">polyData</span>
</div>
<div class="viewcode-block" id="NeedleFinderLogic.setWL"><a class="viewcode-back" href="../NeedleFinder.html#NeedleFinder.NeedleFinderLogic.setWL">[docs]</a>  <span class="k">def</span> <span class="nf">setWL</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dn</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">l</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set window/level in mpr slice view</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#productive #frequent #onDrag</span>
    <span class="k">if</span> <span class="n">profiling</span> <span class="ow">and</span> <span class="n">frequent</span><span class="p">:</span> <span class="k">print</span> <span class="s">&quot;setWL&quot;</span><span class="p">;</span>
    <span class="n">dn</span><span class="o">.</span><span class="n">SetWindow</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
    <span class="n">dn</span><span class="o">.</span><span class="n">SetLevel</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="NeedleFinderLogic.setColors255"><a class="viewcode-back" href="../NeedleFinder.html#NeedleFinder.NeedleFinderLogic.setColors255">[docs]</a>  <span class="k">def</span> <span class="nf">setColors255</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Set color map with colors encoded in RGB between 0 and 255</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#productive</span>
    <span class="k">if</span> <span class="n">profiling</span><span class="p">:</span> <span class="k">print</span> <span class="s">&quot;setColors255&quot;</span><span class="p">;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">205</span><span class="p">)]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">221</span><span class="p">,</span><span class="mi">108</span><span class="p">,</span><span class="mi">158</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">128</span><span class="p">,</span><span class="mi">174</span><span class="p">,</span><span class="mi">128</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">241</span><span class="p">,</span><span class="mi">214</span><span class="p">,</span><span class="mi">145</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">177</span><span class="p">,</span><span class="mi">122</span><span class="p">,</span><span class="mi">101</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">111</span><span class="p">,</span><span class="mi">184</span><span class="p">,</span><span class="mi">210</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">216</span><span class="p">,</span><span class="mi">101</span><span class="p">,</span><span class="mi">79</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">221</span><span class="p">,</span><span class="mi">130</span><span class="p">,</span><span class="mi">101</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">144</span><span class="p">,</span><span class="mi">238</span><span class="p">,</span><span class="mi">144</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">192</span><span class="p">,</span><span class="mi">104</span><span class="p">,</span><span class="mi">88</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">220</span><span class="p">,</span><span class="mi">245</span><span class="p">,</span><span class="mi">20</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">78</span><span class="p">,</span><span class="mi">63</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">255</span><span class="p">,</span><span class="mi">250</span><span class="p">,</span><span class="mi">220</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">230</span><span class="p">,</span><span class="mi">220</span><span class="p">,</span><span class="mi">70</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">200</span><span class="p">,</span><span class="mi">200</span><span class="p">,</span><span class="mi">235</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">250</span><span class="p">,</span><span class="mi">250</span><span class="p">,</span><span class="mi">210</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">244</span><span class="p">,</span><span class="mi">214</span><span class="p">,</span><span class="mi">49</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">151</span><span class="p">,</span><span class="mi">206</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">17</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">183</span><span class="p">,</span><span class="mi">156</span><span class="p">,</span><span class="mi">220</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">18</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">183</span><span class="p">,</span><span class="mi">214</span><span class="p">,</span><span class="mi">211</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">19</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">152</span><span class="p">,</span><span class="mi">189</span><span class="p">,</span><span class="mi">207</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">20</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">178</span><span class="p">,</span><span class="mi">212</span><span class="p">,</span><span class="mi">242</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">21</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">68</span><span class="p">,</span><span class="mi">172</span><span class="p">,</span><span class="mi">100</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">22</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">111</span><span class="p">,</span><span class="mi">197</span><span class="p">,</span><span class="mi">131</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">23</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">85</span><span class="p">,</span><span class="mi">188</span><span class="p">,</span><span class="mi">255</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">24</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">145</span><span class="p">,</span><span class="mi">30</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">25</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">214</span><span class="p">,</span><span class="mi">230</span><span class="p">,</span><span class="mi">130</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">26</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">218</span><span class="p">,</span><span class="mi">255</span><span class="p">,</span><span class="mi">255</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">27</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">170</span><span class="p">,</span><span class="mi">250</span><span class="p">,</span><span class="mi">250</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">28</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">140</span><span class="p">,</span><span class="mi">224</span><span class="p">,</span><span class="mi">228</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">29</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">188</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">28</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">30</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">216</span><span class="p">,</span><span class="mi">191</span><span class="p">,</span><span class="mi">216</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">31</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">145</span><span class="p">,</span><span class="mi">60</span><span class="p">,</span><span class="mi">66</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">32</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">150</span><span class="p">,</span><span class="mi">98</span><span class="p">,</span><span class="mi">83</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">33</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">250</span><span class="p">,</span><span class="mi">250</span><span class="p">,</span><span class="mi">225</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">34</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">200</span><span class="p">,</span><span class="mi">200</span><span class="p">,</span><span class="mi">215</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">35</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">68</span><span class="p">,</span><span class="mi">131</span><span class="p">,</span><span class="mi">98</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">36</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">83</span><span class="p">,</span><span class="mi">146</span><span class="p">,</span><span class="mi">164</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">37</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">162</span><span class="p">,</span><span class="mi">115</span><span class="p">,</span><span class="mi">105</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">38</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">141</span><span class="p">,</span><span class="mi">93</span><span class="p">,</span><span class="mi">137</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">39</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">182</span><span class="p">,</span><span class="mi">166</span><span class="p">,</span><span class="mi">110</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">40</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">188</span><span class="p">,</span><span class="mi">135</span><span class="p">,</span><span class="mi">166</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">41</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">154</span><span class="p">,</span><span class="mi">150</span><span class="p">,</span><span class="mi">201</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">42</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">177</span><span class="p">,</span><span class="mi">140</span><span class="p">,</span><span class="mi">190</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">43</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">30</span><span class="p">,</span><span class="mi">111</span><span class="p">,</span><span class="mi">85</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">44</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">210</span><span class="p">,</span><span class="mi">157</span><span class="p">,</span><span class="mi">166</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">45</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">48</span><span class="p">,</span><span class="mi">129</span><span class="p">,</span><span class="mi">126</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">46</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">98</span><span class="p">,</span><span class="mi">153</span><span class="p">,</span><span class="mi">112</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">47</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">69</span><span class="p">,</span><span class="mi">110</span><span class="p">,</span><span class="mi">53</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">48</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">166</span><span class="p">,</span><span class="mi">113</span><span class="p">,</span><span class="mi">137</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">49</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">122</span><span class="p">,</span><span class="mi">101</span><span class="p">,</span><span class="mi">38</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">50</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">253</span><span class="p">,</span><span class="mi">135</span><span class="p">,</span><span class="mi">192</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">51</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">145</span><span class="p">,</span><span class="mi">92</span><span class="p">,</span><span class="mi">109</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">52</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">46</span><span class="p">,</span><span class="mi">101</span><span class="p">,</span><span class="mi">131</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">53</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">108</span><span class="p">,</span><span class="mi">112</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">54</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">127</span><span class="p">,</span><span class="mi">150</span><span class="p">,</span><span class="mi">88</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">55</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">159</span><span class="p">,</span><span class="mi">116</span><span class="p">,</span><span class="mi">163</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">56</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">125</span><span class="p">,</span><span class="mi">102</span><span class="p">,</span><span class="mi">154</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">57</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">106</span><span class="p">,</span><span class="mi">174</span><span class="p">,</span><span class="mi">155</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">58</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">154</span><span class="p">,</span><span class="mi">146</span><span class="p">,</span><span class="mi">83</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">59</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">126</span><span class="p">,</span><span class="mi">126</span><span class="p">,</span><span class="mi">55</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">60</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">201</span><span class="p">,</span><span class="mi">160</span><span class="p">,</span><span class="mi">133</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">61</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">78</span><span class="p">,</span><span class="mi">152</span><span class="p">,</span><span class="mi">141</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">62</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">174</span><span class="p">,</span><span class="mi">140</span><span class="p">,</span><span class="mi">103</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">63</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">139</span><span class="p">,</span><span class="mi">126</span><span class="p">,</span><span class="mi">177</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">64</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">148</span><span class="p">,</span><span class="mi">120</span><span class="p">,</span><span class="mi">72</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">65</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">186</span><span class="p">,</span><span class="mi">135</span><span class="p">,</span><span class="mi">135</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">66</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">99</span><span class="p">,</span><span class="mi">106</span><span class="p">,</span><span class="mi">24</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">67</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">156</span><span class="p">,</span><span class="mi">171</span><span class="p">,</span><span class="mi">108</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">68</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">64</span><span class="p">,</span><span class="mi">123</span><span class="p">,</span><span class="mi">147</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">69</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">138</span><span class="p">,</span><span class="mi">95</span><span class="p">,</span><span class="mi">74</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">70</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">97</span><span class="p">,</span><span class="mi">113</span><span class="p">,</span><span class="mi">158</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">71</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">126</span><span class="p">,</span><span class="mi">161</span><span class="p">,</span><span class="mi">197</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">72</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">194</span><span class="p">,</span><span class="mi">195</span><span class="p">,</span><span class="mi">164</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">73</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">88</span><span class="p">,</span><span class="mi">106</span><span class="p">,</span><span class="mi">215</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">74</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">82</span><span class="p">,</span><span class="mi">174</span><span class="p">,</span><span class="mi">128</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">75</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">57</span><span class="p">,</span><span class="mi">157</span><span class="p">,</span><span class="mi">110</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">76</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">60</span><span class="p">,</span><span class="mi">143</span><span class="p">,</span><span class="mi">83</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">77</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">92</span><span class="p">,</span><span class="mi">162</span><span class="p">,</span><span class="mi">109</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">78</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">255</span><span class="p">,</span><span class="mi">244</span><span class="p">,</span><span class="mi">209</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">79</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">201</span><span class="p">,</span><span class="mi">121</span><span class="p">,</span><span class="mi">77</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">80</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">70</span><span class="p">,</span><span class="mi">163</span><span class="p">,</span><span class="mi">117</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">81</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">188</span><span class="p">,</span><span class="mi">91</span><span class="p">,</span><span class="mi">95</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">82</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">166</span><span class="p">,</span><span class="mi">84</span><span class="p">,</span><span class="mi">94</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">83</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">182</span><span class="p">,</span><span class="mi">105</span><span class="p">,</span><span class="mi">107</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">84</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">229</span><span class="p">,</span><span class="mi">147</span><span class="p">,</span><span class="mi">118</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">85</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">174</span><span class="p">,</span><span class="mi">122</span><span class="p">,</span><span class="mi">90</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">86</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">201</span><span class="p">,</span><span class="mi">112</span><span class="p">,</span><span class="mi">73</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">87</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">194</span><span class="p">,</span><span class="mi">142</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">88</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">241</span><span class="p">,</span><span class="mi">213</span><span class="p">,</span><span class="mi">144</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">89</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">203</span><span class="p">,</span><span class="mi">179</span><span class="p">,</span><span class="mi">77</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">90</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">229</span><span class="p">,</span><span class="mi">204</span><span class="p">,</span><span class="mi">109</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">91</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">255</span><span class="p">,</span><span class="mi">243</span><span class="p">,</span><span class="mi">152</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">92</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">209</span><span class="p">,</span><span class="mi">185</span><span class="p">,</span><span class="mi">85</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">93</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">248</span><span class="p">,</span><span class="mi">223</span><span class="p">,</span><span class="mi">131</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">94</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">255</span><span class="p">,</span><span class="mi">230</span><span class="p">,</span><span class="mi">138</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">95</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">196</span><span class="p">,</span><span class="mi">172</span><span class="p">,</span><span class="mi">68</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">96</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">255</span><span class="p">,</span><span class="mi">255</span><span class="p">,</span><span class="mi">167</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">97</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">255</span><span class="p">,</span><span class="mi">250</span><span class="p">,</span><span class="mi">160</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">98</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">255</span><span class="p">,</span><span class="mi">237</span><span class="p">,</span><span class="mi">145</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">99</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">242</span><span class="p">,</span><span class="mi">217</span><span class="p">,</span><span class="mi">123</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">100</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">222</span><span class="p">,</span><span class="mi">198</span><span class="p">,</span><span class="mi">101</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">101</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">213</span><span class="p">,</span><span class="mi">124</span><span class="p">,</span><span class="mi">109</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">102</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">184</span><span class="p">,</span><span class="mi">105</span><span class="p">,</span><span class="mi">108</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">103</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">150</span><span class="p">,</span><span class="mi">208</span><span class="p">,</span><span class="mi">243</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">104</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">62</span><span class="p">,</span><span class="mi">162</span><span class="p">,</span><span class="mi">114</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">105</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">242</span><span class="p">,</span><span class="mi">206</span><span class="p">,</span><span class="mi">142</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">106</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">250</span><span class="p">,</span><span class="mi">210</span><span class="p">,</span><span class="mi">139</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">107</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">255</span><span class="p">,</span><span class="mi">255</span><span class="p">,</span><span class="mi">207</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">108</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">182</span><span class="p">,</span><span class="mi">228</span><span class="p">,</span><span class="mi">255</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">109</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">175</span><span class="p">,</span><span class="mi">216</span><span class="p">,</span><span class="mi">244</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">110</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">197</span><span class="p">,</span><span class="mi">165</span><span class="p">,</span><span class="mi">145</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">111</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">172</span><span class="p">,</span><span class="mi">138</span><span class="p">,</span><span class="mi">115</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">112</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">202</span><span class="p">,</span><span class="mi">164</span><span class="p">,</span><span class="mi">140</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">113</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">224</span><span class="p">,</span><span class="mi">186</span><span class="p">,</span><span class="mi">162</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">114</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">255</span><span class="p">,</span><span class="mi">245</span><span class="p">,</span><span class="mi">217</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">115</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">206</span><span class="p">,</span><span class="mi">110</span><span class="p">,</span><span class="mi">84</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">116</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">210</span><span class="p">,</span><span class="mi">115</span><span class="p">,</span><span class="mi">89</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">117</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">203</span><span class="p">,</span><span class="mi">108</span><span class="p">,</span><span class="mi">81</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">118</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">233</span><span class="p">,</span><span class="mi">138</span><span class="p">,</span><span class="mi">112</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">119</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">195</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="mi">73</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">120</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">181</span><span class="p">,</span><span class="mi">85</span><span class="p">,</span><span class="mi">57</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">121</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">152</span><span class="p">,</span><span class="mi">55</span><span class="p">,</span><span class="mi">13</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">122</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">159</span><span class="p">,</span><span class="mi">63</span><span class="p">,</span><span class="mi">27</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">123</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">166</span><span class="p">,</span><span class="mi">70</span><span class="p">,</span><span class="mi">38</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">124</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">218</span><span class="p">,</span><span class="mi">123</span><span class="p">,</span><span class="mi">97</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">125</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">225</span><span class="p">,</span><span class="mi">130</span><span class="p">,</span><span class="mi">104</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">126</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">224</span><span class="p">,</span><span class="mi">97</span><span class="p">,</span><span class="mi">76</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">127</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">184</span><span class="p">,</span><span class="mi">122</span><span class="p">,</span><span class="mi">154</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">128</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">211</span><span class="p">,</span><span class="mi">171</span><span class="p">,</span><span class="mi">143</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">129</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">47</span><span class="p">,</span><span class="mi">150</span><span class="p">,</span><span class="mi">103</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">130</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">173</span><span class="p">,</span><span class="mi">121</span><span class="p">,</span><span class="mi">88</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">131</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">188</span><span class="p">,</span><span class="mi">95</span><span class="p">,</span><span class="mi">76</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">132</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">255</span><span class="p">,</span><span class="mi">239</span><span class="p">,</span><span class="mi">172</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">133</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">226</span><span class="p">,</span><span class="mi">202</span><span class="p">,</span><span class="mi">134</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">134</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">253</span><span class="p">,</span><span class="mi">232</span><span class="p">,</span><span class="mi">158</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">135</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">244</span><span class="p">,</span><span class="mi">217</span><span class="p">,</span><span class="mi">154</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">136</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">205</span><span class="p">,</span><span class="mi">179</span><span class="p">,</span><span class="mi">108</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">137</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">186</span><span class="p">,</span><span class="mi">124</span><span class="p">,</span><span class="mi">161</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">138</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">255</span><span class="p">,</span><span class="mi">255</span><span class="p">,</span><span class="mi">220</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">139</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">234</span><span class="p">,</span><span class="mi">234</span><span class="p">,</span><span class="mi">194</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">140</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">204</span><span class="p">,</span><span class="mi">142</span><span class="p">,</span><span class="mi">178</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">141</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">180</span><span class="p">,</span><span class="mi">119</span><span class="p">,</span><span class="mi">153</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">142</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">216</span><span class="p">,</span><span class="mi">132</span><span class="p">,</span><span class="mi">105</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">143</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">255</span><span class="p">,</span><span class="mi">253</span><span class="p">,</span><span class="mi">229</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">144</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">205</span><span class="p">,</span><span class="mi">167</span><span class="p">,</span><span class="mi">142</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">145</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">204</span><span class="p">,</span><span class="mi">168</span><span class="p">,</span><span class="mi">143</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">146</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">255</span><span class="p">,</span><span class="mi">224</span><span class="p">,</span><span class="mi">199</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">147</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">139</span><span class="p">,</span><span class="mi">150</span><span class="p">,</span><span class="mi">98</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">148</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">249</span><span class="p">,</span><span class="mi">180</span><span class="p">,</span><span class="mi">111</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">149</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">157</span><span class="p">,</span><span class="mi">108</span><span class="p">,</span><span class="mi">162</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">150</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">203</span><span class="p">,</span><span class="mi">136</span><span class="p">,</span><span class="mi">116</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">151</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">185</span><span class="p">,</span><span class="mi">102</span><span class="p">,</span><span class="mi">83</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">152</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">247</span><span class="p">,</span><span class="mi">182</span><span class="p">,</span><span class="mi">164</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">153</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">222</span><span class="p">,</span><span class="mi">154</span><span class="p">,</span><span class="mi">132</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">154</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">124</span><span class="p">,</span><span class="mi">186</span><span class="p">,</span><span class="mi">223</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">155</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">249</span><span class="p">,</span><span class="mi">186</span><span class="p">,</span><span class="mi">150</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">156</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">244</span><span class="p">,</span><span class="mi">170</span><span class="p">,</span><span class="mi">147</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">157</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">255</span><span class="p">,</span><span class="mi">181</span><span class="p">,</span><span class="mi">158</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">158</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">255</span><span class="p">,</span><span class="mi">190</span><span class="p">,</span><span class="mi">165</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">159</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">227</span><span class="p">,</span><span class="mi">153</span><span class="p">,</span><span class="mi">130</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">160</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">213</span><span class="p">,</span><span class="mi">141</span><span class="p">,</span><span class="mi">113</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">161</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">193</span><span class="p">,</span><span class="mi">123</span><span class="p">,</span><span class="mi">103</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">162</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">216</span><span class="p">,</span><span class="mi">146</span><span class="p">,</span><span class="mi">127</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">163</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">230</span><span class="p">,</span><span class="mi">158</span><span class="p">,</span><span class="mi">140</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">164</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">245</span><span class="p">,</span><span class="mi">172</span><span class="p">,</span><span class="mi">147</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">165</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">241</span><span class="p">,</span><span class="mi">172</span><span class="p">,</span><span class="mi">151</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">166</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">177</span><span class="p">,</span><span class="mi">124</span><span class="p">,</span><span class="mi">92</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">167</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">171</span><span class="p">,</span><span class="mi">85</span><span class="p">,</span><span class="mi">68</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">168</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">217</span><span class="p">,</span><span class="mi">198</span><span class="p">,</span><span class="mi">131</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">169</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">212</span><span class="p">,</span><span class="mi">188</span><span class="p">,</span><span class="mi">102</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">170</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">185</span><span class="p">,</span><span class="mi">135</span><span class="p">,</span><span class="mi">134</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">171</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">198</span><span class="p">,</span><span class="mi">175</span><span class="p">,</span><span class="mi">125</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">172</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">194</span><span class="p">,</span><span class="mi">98</span><span class="p">,</span><span class="mi">79</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">173</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">255</span><span class="p">,</span><span class="mi">238</span><span class="p">,</span><span class="mi">170</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">174</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">206</span><span class="p">,</span><span class="mi">111</span><span class="p">,</span><span class="mi">93</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">175</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">216</span><span class="p">,</span><span class="mi">186</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">176</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">255</span><span class="p">,</span><span class="mi">226</span><span class="p">,</span><span class="mi">77</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">177</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">255</span><span class="p">,</span><span class="mi">243</span><span class="p">,</span><span class="mi">106</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">178</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">255</span><span class="p">,</span><span class="mi">234</span><span class="p">,</span><span class="mi">92</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">179</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">240</span><span class="p">,</span><span class="mi">210</span><span class="p">,</span><span class="mi">35</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">180</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">224</span><span class="p">,</span><span class="mi">194</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">181</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">213</span><span class="p">,</span><span class="mi">99</span><span class="p">,</span><span class="mi">79</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">182</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">217</span><span class="p">,</span><span class="mi">102</span><span class="p">,</span><span class="mi">81</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">183</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">147</span><span class="p">,</span><span class="mi">202</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">184</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">122</span><span class="p">,</span><span class="mi">171</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">185</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">186</span><span class="p">,</span><span class="mi">77</span><span class="p">,</span><span class="mi">64</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">186</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">240</span><span class="p">,</span><span class="mi">255</span><span class="p">,</span><span class="mi">30</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">187</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">185</span><span class="p">,</span><span class="mi">232</span><span class="p">,</span><span class="mi">61</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">188</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">226</span><span class="p">,</span><span class="mi">255</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">189</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">251</span><span class="p">,</span><span class="mi">159</span><span class="p">,</span><span class="mi">255</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">190</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">230</span><span class="p">,</span><span class="mi">169</span><span class="p">,</span><span class="mi">29</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">191</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">194</span><span class="p">,</span><span class="mi">113</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">192</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">104</span><span class="p">,</span><span class="mi">160</span><span class="p">,</span><span class="mi">249</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">193</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">221</span><span class="p">,</span><span class="mi">108</span><span class="p">,</span><span class="mi">158</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">194</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">137</span><span class="p">,</span><span class="mi">142</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">195</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">230</span><span class="p">,</span><span class="mi">70</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">196</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">147</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">197</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">147</span><span class="p">,</span><span class="mi">248</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">198</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">231</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">206</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">199</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">129</span><span class="p">,</span><span class="mi">78</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">200</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">116</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">201</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">255</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">202</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">157</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">203</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">100</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="mi">130</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="mi">204</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">205</span><span class="p">,</span><span class="mi">205</span><span class="p">,</span><span class="mi">100</span><span class="p">]</span>
    
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">color255</span>
</div>
<div class="viewcode-block" id="NeedleFinderLogic.setColors"><a class="viewcode-back" href="../NeedleFinder.html#NeedleFinder.NeedleFinderLogic.setColors">[docs]</a>  <span class="k">def</span> <span class="nf">setColors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Sets color map with colors encoded in RGB between 0 and 1</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#productive</span>
    <span class="k">if</span> <span class="n">profiling</span><span class="p">:</span> <span class="k">print</span> <span class="s">&quot;setColors&quot;</span><span class="p">;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color</span><span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">205</span><span class="p">)]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setColors255</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">205</span><span class="p">):</span>
      <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">color</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">color255</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">color</span>
</div>
<div class="viewcode-block" id="NeedleFinderLogic.setHolesCoordinates"><a class="viewcode-back" href="../NeedleFinder.html#NeedleFinder.NeedleFinderLogic.setHolesCoordinates">[docs]</a>  <span class="k">def</span> <span class="nf">setHolesCoordinates</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Coordinates of the 63 holes in the obturator</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#productive</span>
    <span class="k">if</span> <span class="n">profiling</span><span class="p">:</span> <span class="k">print</span> <span class="s">&quot;setHolesCoordinates&quot;</span><span class="p">;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">63</span><span class="p">)]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="mi">35</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="mi">34</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="mi">25</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="mf">36.679</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="mf">17.679</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="mi">44</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="mi">15</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="mi">54</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="mf">17.679</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="mi">64</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">5</span><span class="p">]</span><span class="o">=</span><span class="mi">25</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">5</span><span class="p">]</span><span class="o">=</span><span class="mf">71.321</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">6</span><span class="p">]</span><span class="o">=</span><span class="mi">35</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">6</span><span class="p">]</span><span class="o">=</span><span class="mi">74</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">7</span><span class="p">]</span><span class="o">=</span><span class="mi">45</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">7</span><span class="p">]</span><span class="o">=</span><span class="mf">71.321</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">8</span><span class="p">]</span><span class="o">=</span><span class="mf">52.321</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">8</span><span class="p">]</span><span class="o">=</span><span class="mi">64</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">9</span><span class="p">]</span><span class="o">=</span><span class="mi">55</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">9</span><span class="p">]</span><span class="o">=</span><span class="mi">54</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">10</span><span class="p">]</span><span class="o">=</span><span class="mf">52.321</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">10</span><span class="p">]</span><span class="o">=</span><span class="mi">44</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">11</span><span class="p">]</span><span class="o">=</span><span class="mi">45</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">11</span><span class="p">]</span><span class="o">=</span><span class="mf">36.679</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">12</span><span class="p">]</span><span class="o">=</span><span class="mf">29.791</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">12</span><span class="p">]</span><span class="o">=</span><span class="mf">24.456</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">13</span><span class="p">]</span><span class="o">=</span><span class="mi">20</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">13</span><span class="p">]</span><span class="o">=</span><span class="mf">28.019</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">14</span><span class="p">]</span><span class="o">=</span><span class="mf">12.019</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">14</span><span class="p">]</span><span class="o">=</span><span class="mf">34.716</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">15</span><span class="p">]</span><span class="o">=</span><span class="mf">6.809</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">15</span><span class="p">]</span><span class="o">=</span><span class="mf">43.739</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">16</span><span class="p">]</span><span class="o">=</span><span class="mi">5</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">16</span><span class="p">]</span><span class="o">=</span><span class="mi">54</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">17</span><span class="p">]</span><span class="o">=</span><span class="mf">6.809</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">17</span><span class="p">]</span><span class="o">=</span><span class="mf">64.261</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">18</span><span class="p">]</span><span class="o">=</span><span class="mf">12.019</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">18</span><span class="p">]</span><span class="o">=</span><span class="mf">73.284</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">19</span><span class="p">]</span><span class="o">=</span><span class="mi">20</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">19</span><span class="p">]</span><span class="o">=</span><span class="mf">79.981</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">20</span><span class="p">]</span><span class="o">=</span><span class="mf">29.791</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">20</span><span class="p">]</span><span class="o">=</span><span class="mf">83.544</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">21</span><span class="p">]</span><span class="o">=</span><span class="mf">40.209</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">21</span><span class="p">]</span><span class="o">=</span><span class="mf">83.544</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">22</span><span class="p">]</span><span class="o">=</span><span class="mi">50</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">22</span><span class="p">]</span><span class="o">=</span><span class="mf">79.981</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">23</span><span class="p">]</span><span class="o">=</span><span class="mf">57.981</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">23</span><span class="p">]</span><span class="o">=</span><span class="mf">73.284</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">24</span><span class="p">]</span><span class="o">=</span><span class="mf">63.191</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">24</span><span class="p">]</span><span class="o">=</span><span class="mf">64.262</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">25</span><span class="p">]</span><span class="o">=</span><span class="mi">65</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">25</span><span class="p">]</span><span class="o">=</span><span class="mi">54</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">26</span><span class="p">]</span><span class="o">=</span><span class="mf">63.191</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">26</span><span class="p">]</span><span class="o">=</span><span class="mf">43.739</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">27</span><span class="p">]</span><span class="o">=</span><span class="mf">57.981</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">27</span><span class="p">]</span><span class="o">=</span><span class="mf">34.716</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">28</span><span class="p">]</span><span class="o">=</span><span class="mi">50</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">28</span><span class="p">]</span><span class="o">=</span><span class="mf">28.019</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">29</span><span class="p">]</span><span class="o">=</span><span class="mf">40.209</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">29</span><span class="p">]</span><span class="o">=</span><span class="mf">24.456</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">30</span><span class="p">]</span><span class="o">=</span><span class="mi">35</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">30</span><span class="p">]</span><span class="o">=</span><span class="mi">14</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">31</span><span class="p">]</span><span class="o">=</span><span class="mf">24.647</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">31</span><span class="p">]</span><span class="o">=</span><span class="mf">15.363</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">32</span><span class="p">]</span><span class="o">=</span><span class="mi">15</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">32</span><span class="p">]</span><span class="o">=</span><span class="mf">19.359</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">33</span><span class="p">]</span><span class="o">=</span><span class="mi">15</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">33</span><span class="p">]</span><span class="o">=</span><span class="mf">88.641</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">34</span><span class="p">]</span><span class="o">=</span><span class="mf">24.647</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">34</span><span class="p">]</span><span class="o">=</span><span class="mf">92.637</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">35</span><span class="p">]</span><span class="o">=</span><span class="mi">35</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">35</span><span class="p">]</span><span class="o">=</span><span class="mi">94</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">36</span><span class="p">]</span><span class="o">=</span><span class="mf">45.353</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">36</span><span class="p">]</span><span class="o">=</span><span class="mf">92.637</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">37</span><span class="p">]</span><span class="o">=</span><span class="mi">55</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">37</span><span class="p">]</span><span class="o">=</span><span class="mf">88.641</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">38</span><span class="p">]</span><span class="o">=</span><span class="mi">55</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">38</span><span class="p">]</span><span class="o">=</span><span class="mf">19.359</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">39</span><span class="p">]</span><span class="o">=</span><span class="mf">45.353</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">39</span><span class="p">]</span><span class="o">=</span><span class="mf">15.363</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">40</span><span class="p">]</span><span class="o">=</span><span class="mf">30.642</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">40</span><span class="p">]</span><span class="o">=</span><span class="mf">4.19</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">41</span><span class="p">]</span><span class="o">=</span><span class="mf">22.059</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">41</span><span class="p">]</span><span class="o">=</span><span class="mf">5.704</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">42</span><span class="p">]</span><span class="o">=</span><span class="mf">22.059</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">42</span><span class="p">]</span><span class="o">=</span><span class="mf">102.296</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">43</span><span class="p">]</span><span class="o">=</span><span class="mf">30.642</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">43</span><span class="p">]</span><span class="o">=</span><span class="mf">103.81</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">44</span><span class="p">]</span><span class="o">=</span><span class="mf">39.358</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">44</span><span class="p">]</span><span class="o">=</span><span class="mf">103.81</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">45</span><span class="p">]</span><span class="o">=</span><span class="mf">47.941</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">45</span><span class="p">]</span><span class="o">=</span><span class="mf">102.296</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">46</span><span class="p">]</span><span class="o">=</span><span class="mf">47.941</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">46</span><span class="p">]</span><span class="o">=</span><span class="mf">5.704</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">47</span><span class="p">]</span><span class="o">=</span><span class="mf">39.358</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">47</span><span class="p">]</span><span class="o">=</span><span class="mf">4.19</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">48</span><span class="p">]</span><span class="o">=</span><span class="mf">29.7</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">48</span><span class="p">]</span><span class="o">=</span><span class="mf">44.82</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">49</span><span class="p">]</span><span class="o">=</span><span class="mf">24.4</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">49</span><span class="p">]</span><span class="o">=</span><span class="mi">54</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">50</span><span class="p">]</span><span class="o">=</span><span class="mf">29.7</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">50</span><span class="p">]</span><span class="o">=</span><span class="mf">63.18</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">51</span><span class="p">]</span><span class="o">=</span><span class="mf">40.3</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">51</span><span class="p">]</span><span class="o">=</span><span class="mf">63.18</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">52</span><span class="p">]</span><span class="o">=</span><span class="mf">45.6</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">52</span><span class="p">]</span><span class="o">=</span><span class="mi">54</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">53</span><span class="p">]</span><span class="o">=</span><span class="mf">40.3</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">53</span><span class="p">]</span><span class="o">=</span><span class="mf">44.82</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">54</span><span class="p">]</span><span class="o">=</span><span class="mi">35</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">54</span><span class="p">]</span><span class="o">=</span><span class="mi">54</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">55</span><span class="p">]</span><span class="o">=</span><span class="mi">9</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">55</span><span class="p">]</span><span class="o">=</span><span class="mi">12</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">56</span><span class="p">]</span><span class="o">=</span><span class="mi">5</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">56</span><span class="p">]</span><span class="o">=</span><span class="mi">18</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">57</span><span class="p">]</span><span class="o">=</span><span class="mi">5</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">57</span><span class="p">]</span><span class="o">=</span><span class="mi">90</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">58</span><span class="p">]</span><span class="o">=</span><span class="mi">9</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">58</span><span class="p">]</span><span class="o">=</span><span class="mi">96</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">59</span><span class="p">]</span><span class="o">=</span><span class="mi">61</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">59</span><span class="p">]</span><span class="o">=</span><span class="mi">96</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">60</span><span class="p">]</span><span class="o">=</span><span class="mi">65</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">60</span><span class="p">]</span><span class="o">=</span><span class="mi">90</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">61</span><span class="p">]</span><span class="o">=</span><span class="mi">65</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">61</span><span class="p">]</span><span class="o">=</span><span class="mi">18</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">62</span><span class="p">]</span><span class="o">=</span><span class="mi">61</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">62</span><span class="p">]</span><span class="o">=</span><span class="mi">12</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">p</span>
</div>
<div class="viewcode-block" id="NeedleFinderLogic.setLabels"><a class="viewcode-back" href="../NeedleFinder.html#NeedleFinder.NeedleFinderLogic.setLabels">[docs]</a>  <span class="k">def</span> <span class="nf">setLabels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set the list of labels corresponding of the 63 holes of the obturator</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#productive</span>
    <span class="k">if</span> <span class="n">profiling</span><span class="p">:</span> <span class="k">print</span> <span class="s">&quot;setLabels&quot;</span><span class="p">;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">option</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span><span class="s">&#39;Ba&#39;</span><span class="p">,</span>
       <span class="mi">1</span><span class="p">:</span><span class="s">&#39;Bb&#39;</span><span class="p">,</span>
       <span class="mi">2</span><span class="p">:</span><span class="s">&#39;Bc&#39;</span><span class="p">,</span>
       <span class="mi">3</span><span class="p">:</span><span class="s">&#39;Bd&#39;</span><span class="p">,</span>
       <span class="mi">4</span><span class="p">:</span><span class="s">&#39;Be&#39;</span><span class="p">,</span>
       <span class="mi">5</span><span class="p">:</span><span class="s">&#39;Bf&#39;</span><span class="p">,</span>
       <span class="mi">6</span><span class="p">:</span><span class="s">&#39;Bg&#39;</span><span class="p">,</span>
       <span class="mi">7</span><span class="p">:</span><span class="s">&#39;Bh&#39;</span><span class="p">,</span>
       <span class="mi">8</span><span class="p">:</span><span class="s">&#39;Bi&#39;</span><span class="p">,</span>
       <span class="mi">9</span><span class="p">:</span><span class="s">&#39;Bj&#39;</span><span class="p">,</span>
       <span class="mi">10</span><span class="p">:</span><span class="s">&#39;Bk&#39;</span><span class="p">,</span>
       <span class="mi">11</span><span class="p">:</span><span class="s">&#39;Bl&#39;</span><span class="p">,</span>
       <span class="mi">12</span><span class="p">:</span><span class="s">&#39;Ca&#39;</span><span class="p">,</span>
       <span class="mi">13</span><span class="p">:</span><span class="s">&#39;Cb&#39;</span><span class="p">,</span>
       <span class="mi">14</span><span class="p">:</span><span class="s">&#39;Cc&#39;</span><span class="p">,</span>
       <span class="mi">15</span><span class="p">:</span><span class="s">&#39;Cd&#39;</span><span class="p">,</span>
       <span class="mi">16</span><span class="p">:</span><span class="s">&#39;Ce&#39;</span><span class="p">,</span>
       <span class="mi">17</span><span class="p">:</span><span class="s">&#39;Cf&#39;</span><span class="p">,</span>
       <span class="mi">18</span><span class="p">:</span><span class="s">&#39;Cg&#39;</span><span class="p">,</span>
       <span class="mi">19</span><span class="p">:</span><span class="s">&#39;Ch&#39;</span><span class="p">,</span>
       <span class="mi">20</span><span class="p">:</span><span class="s">&#39;Ci&#39;</span><span class="p">,</span>
       <span class="mi">21</span><span class="p">:</span><span class="s">&#39;Cj&#39;</span><span class="p">,</span>
       <span class="mi">22</span><span class="p">:</span><span class="s">&#39;Ck&#39;</span><span class="p">,</span>
       <span class="mi">23</span><span class="p">:</span><span class="s">&#39;Cl&#39;</span><span class="p">,</span>
       <span class="mi">24</span><span class="p">:</span><span class="s">&#39;Cm&#39;</span><span class="p">,</span>
       <span class="mi">25</span><span class="p">:</span><span class="s">&#39;Cn&#39;</span><span class="p">,</span>
       <span class="mi">26</span><span class="p">:</span><span class="s">&#39;Co&#39;</span><span class="p">,</span>
       <span class="mi">27</span><span class="p">:</span><span class="s">&#39;Cp&#39;</span><span class="p">,</span>
       <span class="mi">28</span><span class="p">:</span><span class="s">&#39;Cq&#39;</span><span class="p">,</span>
       <span class="mi">29</span><span class="p">:</span><span class="s">&#39;Cr&#39;</span><span class="p">,</span>
       <span class="mi">30</span><span class="p">:</span><span class="s">&#39;Da&#39;</span><span class="p">,</span>
       <span class="mi">31</span><span class="p">:</span><span class="s">&#39;Db&#39;</span><span class="p">,</span>
       <span class="mi">32</span><span class="p">:</span><span class="s">&#39;Dc&#39;</span><span class="p">,</span>
       <span class="mi">33</span><span class="p">:</span><span class="s">&#39;Dd&#39;</span><span class="p">,</span>
       <span class="mi">34</span><span class="p">:</span><span class="s">&#39;De&#39;</span><span class="p">,</span>
       <span class="mi">35</span><span class="p">:</span><span class="s">&#39;Df&#39;</span><span class="p">,</span>
       <span class="mi">36</span><span class="p">:</span><span class="s">&#39;Dg&#39;</span><span class="p">,</span>
       <span class="mi">37</span><span class="p">:</span><span class="s">&#39;Dh&#39;</span><span class="p">,</span>
       <span class="mi">38</span><span class="p">:</span><span class="s">&#39;Di&#39;</span><span class="p">,</span>
       <span class="mi">39</span><span class="p">:</span><span class="s">&#39;Dj&#39;</span><span class="p">,</span>
       <span class="mi">40</span><span class="p">:</span><span class="s">&#39;Ea&#39;</span><span class="p">,</span>
       <span class="mi">41</span><span class="p">:</span><span class="s">&#39;Eb&#39;</span><span class="p">,</span>
       <span class="mi">42</span><span class="p">:</span><span class="s">&#39;Ec&#39;</span><span class="p">,</span>
       <span class="mi">43</span><span class="p">:</span><span class="s">&#39;Ed&#39;</span><span class="p">,</span>
       <span class="mi">44</span><span class="p">:</span><span class="s">&#39;Ee&#39;</span><span class="p">,</span>
       <span class="mi">45</span><span class="p">:</span><span class="s">&#39;Ef&#39;</span><span class="p">,</span>
       <span class="mi">46</span><span class="p">:</span><span class="s">&#39;Eg&#39;</span><span class="p">,</span>
       <span class="mi">47</span><span class="p">:</span><span class="s">&#39;Eh&#39;</span><span class="p">,</span>
       <span class="mi">48</span><span class="p">:</span><span class="s">&#39;Aa&#39;</span><span class="p">,</span>
       <span class="mi">49</span><span class="p">:</span><span class="s">&#39;Ab&#39;</span><span class="p">,</span>
       <span class="mi">50</span><span class="p">:</span><span class="s">&#39;Ac&#39;</span><span class="p">,</span>
       <span class="mi">51</span><span class="p">:</span><span class="s">&#39;Ad&#39;</span><span class="p">,</span>
       <span class="mi">52</span><span class="p">:</span><span class="s">&#39;Ae&#39;</span><span class="p">,</span>
       <span class="mi">53</span><span class="p">:</span><span class="s">&#39;Af&#39;</span><span class="p">,</span>
       <span class="mi">54</span><span class="p">:</span><span class="s">&#39;Iu&#39;</span><span class="p">,</span> 
       <span class="mi">55</span><span class="p">:</span><span class="s">&#39;Fa&#39;</span><span class="p">,</span>
       <span class="mi">56</span><span class="p">:</span><span class="s">&#39;Fb&#39;</span><span class="p">,</span>
       <span class="mi">57</span><span class="p">:</span><span class="s">&#39;Fc&#39;</span><span class="p">,</span>
       <span class="mi">58</span><span class="p">:</span><span class="s">&#39;Fd&#39;</span><span class="p">,</span>
       <span class="mi">59</span><span class="p">:</span><span class="s">&#39;Fe&#39;</span><span class="p">,</span>
       <span class="mi">60</span><span class="p">:</span><span class="s">&#39;Ff&#39;</span><span class="p">,</span>
       <span class="mi">61</span><span class="p">:</span><span class="s">&#39;Fg&#39;</span><span class="p">,</span>
       <span class="mi">62</span><span class="p">:</span><span class="s">&#39;Fh&#39;</span><span class="p">,</span>
       <span class="mi">63</span><span class="p">:</span><span class="s">&#39;--&#39;</span><span class="p">}</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">option</span>
  </div>
<div class="viewcode-block" id="NeedleFinderLogic.setParameterNode"><a class="viewcode-back" href="../NeedleFinder.html#NeedleFinder.NeedleFinderLogic.setParameterNode">[docs]</a>  <span class="k">def</span> <span class="nf">setParameterNode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameterNode</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Set Parameter Node (to save parameters from one step to the other)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">print</span> <span class="s">&quot;setParameterNode&quot;</span><span class="p">;</span> <span class="n">msgbox</span><span class="p">(</span><span class="s">&#39;setParameterNode&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">parameterNode</span> <span class="o">=</span> <span class="n">parameterNode</span>
</div>
<div class="viewcode-block" id="NeedleFinderLogic.parameterNode"><a class="viewcode-back" href="../NeedleFinder.html#NeedleFinder.NeedleFinderLogic.parameterNode">[docs]</a>  <span class="k">def</span> <span class="nf">parameterNode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns parameter node</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">print</span> <span class="s">&quot;parameterNode&quot;</span><span class="p">;</span> <span class="n">msgbox</span><span class="p">(</span><span class="s">&#39;parameterNode&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameterNode</span>
</div>
<div class="viewcode-block" id="NeedleFinderLogic.getBoldFont"><a class="viewcode-back" href="../NeedleFinder.html#NeedleFinder.NeedleFinderLogic.getBoldFont">[docs]</a>  <span class="k">def</span> <span class="nf">getBoldFont</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get a Qt bold font</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">print</span> <span class="s">&quot;getBoldFont&quot;</span><span class="p">;</span> <span class="n">msgbox</span><span class="p">(</span><span class="s">&#39;getBoldFont&#39;</span><span class="p">)</span>
    <span class="n">boldFont</span> <span class="o">=</span> <span class="n">qt</span><span class="o">.</span><span class="n">QFont</span><span class="p">(</span> <span class="s">&quot;Sans Serif&quot;</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="n">qt</span><span class="o">.</span><span class="n">QFont</span><span class="o">.</span><span class="n">Bold</span> <span class="p">)</span>
    <span class="k">return</span> <span class="n">boldFont</span> 
  </div>
<div class="viewcode-block" id="NeedleFinderLogic.saveParameters"><a class="viewcode-back" href="../NeedleFinder.html#NeedleFinder.NeedleFinderLogic.saveParameters">[docs]</a>  <span class="k">def</span> <span class="nf">saveParameters</span> <span class="p">(</span><span class="bp">self</span> <span class="p">,</span><span class="n">filePath</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    save the current needle detection parameters to file</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#productive #onButton</span>
    <span class="k">if</span> <span class="n">profiling</span><span class="p">:</span> <span class="k">print</span> <span class="s">&quot;saveParameters&quot;</span><span class="p">;</span>
    <span class="n">widget</span> <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">NeedleFinderWidget</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">ConfigParser</span><span class="o">.</span><span class="n">RawConfigParser</span><span class="p">()</span>
    <span class="n">config</span><span class="o">.</span><span class="n">add_section</span><span class="p">(</span><span class="s">&#39;NeedleFinder Parameters&#39;</span><span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">add_section</span><span class="p">(</span><span class="s">&#39;BooleanSection&#39;</span><span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">add_section</span><span class="p">(</span><span class="s">&#39;IntegerSection&#39;</span><span class="p">)</span>

    <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;BooleanSection&#39;</span><span class="p">,</span> <span class="s">&#39;autoCorrectTip&#39;</span><span class="p">,</span> <span class="n">widget</span><span class="o">.</span><span class="n">autoCorrectTip</span><span class="o">.</span><span class="n">isChecked</span><span class="p">())</span>
    <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;BooleanSection&#39;</span><span class="p">,</span> <span class="s">&#39;invertedContrast&#39;</span><span class="p">,</span> <span class="n">widget</span><span class="o">.</span><span class="n">invertedContrast</span><span class="o">.</span><span class="n">isChecked</span><span class="p">())</span>
    <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;BooleanSection&#39;</span><span class="p">,</span> <span class="s">&#39;gradient&#39;</span><span class="p">,</span> <span class="n">widget</span><span class="o">.</span><span class="n">gradient</span><span class="o">.</span><span class="n">isChecked</span><span class="p">())</span>
    <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;BooleanSection&#39;</span><span class="p">,</span> <span class="s">&#39;filterControlPoints&#39;</span><span class="p">,</span> <span class="n">widget</span><span class="o">.</span><span class="n">filterControlPoints</span><span class="o">.</span><span class="n">isChecked</span><span class="p">())</span>
    <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;BooleanSection&#39;</span><span class="p">,</span> <span class="s">&#39;drawFiducialPoints&#39;</span><span class="p">,</span> <span class="n">widget</span><span class="o">.</span><span class="n">drawFiducialPoints</span><span class="o">.</span><span class="n">isChecked</span><span class="p">())</span>
    <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;BooleanSection&#39;</span><span class="p">,</span> <span class="s">&#39;autoStopTip&#39;</span><span class="p">,</span> <span class="n">widget</span><span class="o">.</span><span class="n">autoStopTip</span><span class="o">.</span><span class="n">isChecked</span><span class="p">())</span>
    <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;BooleanSection&#39;</span><span class="p">,</span> <span class="s">&#39;extendNeedle&#39;</span><span class="p">,</span> <span class="n">widget</span><span class="o">.</span><span class="n">extendNeedle</span><span class="o">.</span><span class="n">isChecked</span><span class="p">())</span>
    <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;BooleanSection&#39;</span><span class="p">,</span> <span class="s">&#39;maxLength&#39;</span><span class="p">,</span> <span class="n">widget</span><span class="o">.</span><span class="n">maxLength</span><span class="o">.</span><span class="n">isChecked</span><span class="p">())</span>
    <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;BooleanSection&#39;</span><span class="p">,</span> <span class="s">&#39;gaussianAttenuationButton&#39;</span><span class="p">,</span> <span class="n">widget</span><span class="o">.</span><span class="n">gaussianAttenuationButton</span><span class="o">.</span><span class="n">isChecked</span><span class="p">())</span>

    <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;IntegerSection&#39;</span><span class="p">,</span> <span class="s">&#39;realNeedleLength&#39;</span><span class="p">,</span> <span class="n">widget</span><span class="o">.</span><span class="n">realNeedleLength</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;IntegerSection&#39;</span><span class="p">,</span> <span class="s">&#39;sigmaValue&#39;</span><span class="p">,</span> <span class="n">widget</span><span class="o">.</span><span class="n">sigmaValue</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;IntegerSection&#39;</span><span class="p">,</span> <span class="s">&#39;gradientPonderation&#39;</span><span class="p">,</span> <span class="n">widget</span><span class="o">.</span><span class="n">gradientPonderation</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;IntegerSection&#39;</span><span class="p">,</span> <span class="s">&#39;exponent&#39;</span><span class="p">,</span> <span class="n">widget</span><span class="o">.</span><span class="n">exponent</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;IntegerSection&#39;</span><span class="p">,</span> <span class="s">&#39;distanceMax&#39;</span><span class="p">,</span> <span class="n">widget</span><span class="o">.</span><span class="n">distanceMax</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;IntegerSection&#39;</span><span class="p">,</span> <span class="s">&#39;nbRotatingIterations&#39;</span><span class="p">,</span> <span class="n">widget</span><span class="o">.</span><span class="n">nbRotatingIterations</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;IntegerSection&#39;</span><span class="p">,</span> <span class="s">&#39;numberOfPointsPerNeedle&#39;</span><span class="p">,</span> <span class="n">widget</span><span class="o">.</span><span class="n">numberOfPointsPerNeedle</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;IntegerSection&#39;</span><span class="p">,</span> <span class="s">&#39;lenghtNeedleParameter&#39;</span><span class="p">,</span> <span class="n">widget</span><span class="o">.</span><span class="n">lenghtNeedleParameter</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;IntegerSection&#39;</span><span class="p">,</span> <span class="s">&#39;radiusNeedleParameter&#39;</span><span class="p">,</span> <span class="n">widget</span><span class="o">.</span><span class="n">radiusNeedleParameter</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

    <span class="c"># Writing our configuration file to &#39;example.cfg&#39;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filePath</span><span class="p">,</span> <span class="s">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">configfile</span><span class="p">:</span>
        <span class="n">config</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">configfile</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="NeedleFinderLogic.loadParameters"><a class="viewcode-back" href="../NeedleFinder.html#NeedleFinder.NeedleFinderLogic.loadParameters">[docs]</a>  <span class="k">def</span> <span class="nf">loadParameters</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filePath</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    load the parameters from parameter text file</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#productive #onButton</span>
    <span class="k">if</span> <span class="n">profiling</span><span class="p">:</span> <span class="k">print</span> <span class="s">&quot;loadParameters&quot;</span><span class="p">;</span>
    <span class="n">widget</span> <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">NeedleFinderWidget</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">ConfigParser</span><span class="o">.</span><span class="n">RawConfigParser</span><span class="p">()</span>
    <span class="n">config</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">filePath</span><span class="p">)</span>

    <span class="n">autoCorrectTip</span>            <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getboolean</span><span class="p">(</span><span class="s">&#39;BooleanSection&#39;</span><span class="p">,</span> <span class="s">&#39;autoCorrectTip&#39;</span><span class="p">)</span>
    <span class="n">invertedContrast</span>          <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getboolean</span><span class="p">(</span><span class="s">&#39;BooleanSection&#39;</span><span class="p">,</span> <span class="s">&#39;invertedContrast&#39;</span><span class="p">)</span>
    <span class="n">gradient</span>                  <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getboolean</span><span class="p">(</span><span class="s">&#39;BooleanSection&#39;</span><span class="p">,</span> <span class="s">&#39;gradient&#39;</span><span class="p">)</span>
    <span class="n">filterControlPoints</span>       <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getboolean</span><span class="p">(</span><span class="s">&#39;BooleanSection&#39;</span><span class="p">,</span> <span class="s">&#39;filterControlPoints&#39;</span><span class="p">)</span>
    <span class="n">drawFiducialPoints</span>        <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getboolean</span><span class="p">(</span><span class="s">&#39;BooleanSection&#39;</span><span class="p">,</span> <span class="s">&#39;drawFiducialPoints&#39;</span><span class="p">)</span>
    <span class="n">autoStopTip</span>               <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getboolean</span><span class="p">(</span><span class="s">&#39;BooleanSection&#39;</span><span class="p">,</span> <span class="s">&#39;autoStopTip&#39;</span><span class="p">)</span>
    <span class="n">extendNeedle</span>              <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getboolean</span><span class="p">(</span><span class="s">&#39;BooleanSection&#39;</span><span class="p">,</span> <span class="s">&#39;extendNeedle&#39;</span><span class="p">)</span>
    <span class="n">maxLength</span>                 <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getboolean</span><span class="p">(</span><span class="s">&#39;BooleanSection&#39;</span><span class="p">,</span> <span class="s">&#39;maxLength&#39;</span><span class="p">)</span>
    <span class="n">gaussianAttenuationButton</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getboolean</span><span class="p">(</span><span class="s">&#39;BooleanSection&#39;</span><span class="p">,</span> <span class="s">&#39;gaussianAttenuationButton&#39;</span><span class="p">)</span>

    <span class="n">realNeedleLength</span>          <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s">&#39;IntegerSection&#39;</span><span class="p">,</span> <span class="s">&#39;realNeedleLength&#39;</span><span class="p">)</span>
    <span class="n">sigmaValue</span>                <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s">&#39;IntegerSection&#39;</span><span class="p">,</span> <span class="s">&#39;sigmaValue&#39;</span><span class="p">)</span>
    <span class="n">gradientPonderation</span>       <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s">&#39;IntegerSection&#39;</span><span class="p">,</span> <span class="s">&#39;gradientPonderation&#39;</span><span class="p">)</span>
    <span class="n">exponent</span>                  <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s">&#39;IntegerSection&#39;</span><span class="p">,</span> <span class="s">&#39;exponent&#39;</span><span class="p">)</span>
    <span class="n">distanceMax</span>               <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s">&#39;IntegerSection&#39;</span><span class="p">,</span> <span class="s">&#39;distanceMax&#39;</span><span class="p">)</span>
    <span class="n">nbRotatingIterations</span>      <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s">&#39;IntegerSection&#39;</span><span class="p">,</span> <span class="s">&#39;nbRotatingIterations&#39;</span><span class="p">)</span>
    <span class="n">numberOfPointsPerNeedle</span>   <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s">&#39;IntegerSection&#39;</span><span class="p">,</span> <span class="s">&#39;numberOfPointsPerNeedle&#39;</span><span class="p">)</span>
    <span class="n">lenghtNeedleParameter</span>     <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s">&#39;IntegerSection&#39;</span><span class="p">,</span> <span class="s">&#39;lenghtNeedleParameter&#39;</span><span class="p">)</span>
    <span class="n">radiusNeedleParameter</span>     <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s">&#39;IntegerSection&#39;</span><span class="p">,</span> <span class="s">&#39;radiusNeedleParameter&#39;</span><span class="p">)</span>
    
    <span class="n">widget</span><span class="o">.</span><span class="n">autoCorrectTip</span><span class="o">.</span><span class="n">checked</span>       <span class="o">=</span> <span class="n">autoCorrectTip</span>
    <span class="n">widget</span><span class="o">.</span><span class="n">invertedContrast</span><span class="o">.</span><span class="n">checked</span>     <span class="o">=</span> <span class="n">invertedContrast</span>
    <span class="n">widget</span><span class="o">.</span><span class="n">gradient</span><span class="o">.</span><span class="n">checked</span>             <span class="o">=</span> <span class="n">gradient</span> 
    <span class="n">widget</span><span class="o">.</span><span class="n">filterControlPoints</span><span class="o">.</span><span class="n">checked</span>  <span class="o">=</span> <span class="n">filterControlPoints</span>
    <span class="n">widget</span><span class="o">.</span><span class="n">drawFiducialPoints</span><span class="o">.</span><span class="n">checked</span>   <span class="o">=</span> <span class="n">drawFiducialPoints</span>
    <span class="n">widget</span><span class="o">.</span><span class="n">autoStopTip</span><span class="o">.</span><span class="n">checked</span>          <span class="o">=</span> <span class="n">autoStopTip</span>
    <span class="n">widget</span><span class="o">.</span><span class="n">extendNeedle</span><span class="o">.</span><span class="n">checked</span>         <span class="o">=</span> <span class="n">extendNeedle</span>
    <span class="n">widget</span><span class="o">.</span><span class="n">maxLength</span><span class="o">.</span><span class="n">checked</span>            <span class="o">=</span> <span class="n">maxLength</span>
    <span class="n">widget</span><span class="o">.</span><span class="n">gaussianAttenuationButton</span><span class="o">.</span><span class="n">checked</span> <span class="o">=</span>  <span class="n">gaussianAttenuationButton</span>

    <span class="n">widget</span><span class="o">.</span><span class="n">realNeedleLength</span><span class="o">.</span><span class="n">value</span>         <span class="o">=</span> <span class="n">realNeedleLength</span>
    <span class="n">widget</span><span class="o">.</span><span class="n">sigmaValue</span><span class="o">.</span><span class="n">value</span>               <span class="o">=</span> <span class="n">sigmaValue</span>
    <span class="n">widget</span><span class="o">.</span><span class="n">gradientPonderation</span><span class="o">.</span><span class="n">value</span>      <span class="o">=</span> <span class="n">gradientPonderation</span>
    <span class="n">widget</span><span class="o">.</span><span class="n">exponent</span><span class="o">.</span><span class="n">value</span>                 <span class="o">=</span> <span class="n">exponent</span>
    <span class="n">widget</span><span class="o">.</span><span class="n">distanceMax</span><span class="o">.</span><span class="n">value</span>              <span class="o">=</span> <span class="n">distanceMax</span>
    <span class="n">widget</span><span class="o">.</span><span class="n">nbRotatingIterations</span><span class="o">.</span><span class="n">value</span>     <span class="o">=</span> <span class="n">nbRotatingIterations</span>
    <span class="n">widget</span><span class="o">.</span><span class="n">numberOfPointsPerNeedle</span><span class="o">.</span><span class="n">value</span>  <span class="o">=</span> <span class="n">numberOfPointsPerNeedle</span>
    <span class="n">widget</span><span class="o">.</span><span class="n">lenghtNeedleParameter</span><span class="o">.</span><span class="n">value</span>    <span class="o">=</span> <span class="n">lenghtNeedleParameter</span>
    <span class="n">widget</span><span class="o">.</span><span class="n">radiusNeedleParameter</span><span class="o">.</span><span class="n">value</span>    <span class="o">=</span> <span class="n">radiusNeedleParameter</span>

    <span class="k">print</span> <span class="s">&quot;Parameters successfully loaded!&quot;</span>
    </div></div>
<span class="sd">&quot;&quot;&quot;</span>

<span class="sd">########################################################################################################################</span>
<span class="sd">TESTS</span>
<span class="sd">########################################################################################################################</span>

<span class="sd">&quot;&quot;&quot;</span>

<div class="viewcode-block" id="NeedleFinderTest"><a class="viewcode-back" href="../NeedleFinder.html#NeedleFinder.NeedleFinderTest">[docs]</a><span class="k">class</span> <span class="nc">NeedleFinderTest</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  This is the test case for your scripted module.</span>
<span class="sd">  &quot;&quot;&quot;</span>

<div class="viewcode-block" id="NeedleFinderTest.delayDisplay"><a class="viewcode-back" href="../NeedleFinder.html#NeedleFinder.NeedleFinderTest.delayDisplay">[docs]</a>  <span class="k">def</span> <span class="nf">delayDisplay</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">message</span><span class="p">,</span><span class="n">msec</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ??? used?</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">print</span> <span class="s">&quot;delayDisplay&quot;</span><span class="p">;</span> <span class="n">msgbox</span><span class="p">(</span><span class="s">&#39;delayDisplay&#39;</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This utility method displays a small dialog and waits.</span>
<span class="sd">    This does two things: 1) it lets the event loop catch up</span>
<span class="sd">    to the state of the test so that rendering and widget updates</span>
<span class="sd">    have all taken place before the test continues and 2) it</span>
<span class="sd">    shows the user/developer/tester the state of the test</span>
<span class="sd">    so that we&#39;ll know when it breaks.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">print</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">qt</span><span class="o">.</span><span class="n">QDialog</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">infoLayout</span> <span class="o">=</span> <span class="n">qt</span><span class="o">.</span><span class="n">QVBoxLayout</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">setLayout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">infoLayout</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">qt</span><span class="o">.</span><span class="n">QLabel</span><span class="p">(</span><span class="n">message</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">infoLayout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
    <span class="n">qt</span><span class="o">.</span><span class="n">QTimer</span><span class="o">.</span><span class="n">singleShot</span><span class="p">(</span><span class="n">msec</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">exec_</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="NeedleFinderTest.setUp"><a class="viewcode-back" href="../NeedleFinder.html#NeedleFinder.NeedleFinderTest.setUp">[docs]</a>  <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Do whatever is needed to reset the state - typically a scene clear will be enough.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#productive</span>
    <span class="k">if</span> <span class="n">profiling</span><span class="p">:</span> <span class="k">print</span> <span class="s">&quot;setUp&quot;</span><span class="p">;</span>
    <span class="n">slicer</span><span class="o">.</span><span class="n">mrmlScene</span><span class="o">.</span><span class="n">Clear</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="NeedleFinderTest.runTest"><a class="viewcode-back" href="../NeedleFinder.html#NeedleFinder.NeedleFinderTest.runTest">[docs]</a>  <span class="k">def</span> <span class="nf">runTest</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">print</span> <span class="s">&quot;runTest&quot;</span><span class="p">;</span> <span class="n">msgbox</span><span class="p">(</span><span class="s">&#39;runTest&#39;</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run as few or as many tests as needed here.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">setUp</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">test_NeedleFinder1</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="NeedleFinderTest.test_NeedleFinder1"><a class="viewcode-back" href="../NeedleFinder.html#NeedleFinder.NeedleFinderTest.test_NeedleFinder1">[docs]</a>  <span class="k">def</span> <span class="nf">test_NeedleFinder1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">print</span> <span class="s">&quot;test_NeedleFinder1&quot;</span><span class="p">;</span> <span class="n">msgbox</span><span class="p">(</span><span class="s">&#39;test_NeedleFinder1&#39;</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Ideally you should have several levels of tests.  At the lowest level</span>
<span class="sd">    tests sould exercise the functionality of the logic with different inputs</span>
<span class="sd">    (both valid and invalid).  At higher levels your tests should emulate the</span>
<span class="sd">    way the user would interact with your code and confirm that it still works</span>
<span class="sd">    the way you intended.</span>
<span class="sd">    One of the most important features of the tests is that it should alert other</span>
<span class="sd">    developers when their changes will have an impact on the behavior of your</span>
<span class="sd">    module.  For example, if a developer removes a feature that you depend on,</span>
<span class="sd">    your test should break so they know that the feature is needed.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">delayDisplay</span><span class="p">(</span><span class="s">&quot;Starting the test&quot;</span><span class="p">)</span>
    <span class="c">#</span>
    <span class="c"># first, get some data</span>
    <span class="c">#</span>
    <span class="kn">import</span> <span class="nn">urllib</span>
    <span class="n">downloads</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="s">&#39;http://slicer.kitware.com/midas3/download?items=5767&#39;</span><span class="p">,</span> <span class="s">&#39;FA.nrrd&#39;</span><span class="p">,</span> <span class="n">slicer</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">loadVolume</span><span class="p">),</span>
        <span class="p">)</span>

    <span class="k">for</span> <span class="n">url</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">loader</span> <span class="ow">in</span> <span class="n">downloads</span><span class="p">:</span>
      <span class="n">filePath</span> <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">temporaryPath</span> <span class="o">+</span> <span class="s">&#39;/&#39;</span> <span class="o">+</span> <span class="n">name</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filePath</span><span class="p">)</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">filePath</span><span class="p">)</span><span class="o">.</span><span class="n">st_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;Requesting download </span><span class="si">%s</span><span class="s"> from </span><span class="si">%s</span><span class="s">...</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">url</span><span class="p">))</span>
        <span class="n">urllib</span><span class="o">.</span><span class="n">urlretrieve</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">filePath</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">loader</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;Loading </span><span class="si">%s</span><span class="s">...</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,))</span>
        <span class="n">loader</span><span class="p">(</span><span class="n">filePath</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">delayDisplay</span><span class="p">(</span><span class="s">&#39;Finished with download and loading</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>

    <span class="n">volumeNode</span> <span class="o">=</span> <span class="n">slicer</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">getNode</span><span class="p">(</span><span class="n">pattern</span><span class="o">=</span><span class="s">&quot;FA&quot;</span><span class="p">)</span>
    <span class="n">logic</span> <span class="o">=</span> <span class="n">NeedleFinderLogic</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span> <span class="n">logic</span><span class="o">.</span><span class="n">hasImageData</span><span class="p">(</span><span class="n">volumeNode</span><span class="p">)</span> <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">delayDisplay</span><span class="p">(</span><span class="s">&#39;Test passed!&#39;</span><span class="p">)</span>
</pre></div></div></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../index.html">NeedleFinder 1.0 documentation</a> &raquo;</li>
          <li><a href="index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright 2014, Guillaume Pernelle, Andre Mastmeyer.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3b1.
    </div>
  </body>
</html>